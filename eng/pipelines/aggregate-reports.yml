trigger: none
pr: none

jobs:
  - job: Generate
    steps:
    # Generate the Maven site report, including SpotBugs, JavaDoc, CheckStyle, Jacoco, etc only when we are not
    # running as a PR check.
    - task: Maven@3
      displayName: 'Generate Maven project site, including JavaDocs, SpotBugs, and CheckStyle reports'
      condition: and(succeeded(), in(variables['Build.Reason'], 'Schedule', 'Manual'))
      inputs:
        mavenPomFile: pom.client.xml
        options: '$(DefaultOptions) -DskipTests -Dgpg.skip'
        mavenOptions: '$(MemoryOptions) $(LoggingOptions)'
        javaHomeOption: 'JDKVersion'
        jdkVersionOption: '1.11'
        jdkArchitectureOption: 'x64'
        publishJUnitResults: false
        goals: 'install site:site site:stage'

    - script: |
        git clone https://github.com/JonathanGiles/DependencyChecker.git
        mkdir input && cp dependencies.json input/
      displayName: 'Download dependency checker'
      condition: and(succeeded(), in(variables['Build.Reason'], 'Schedule', 'Manual'))

    - task: Maven@3
      displayName: 'Analyze dependencies'
      condition: and(succeeded(), in(variables['Build.Reason'], 'Schedule', 'Manual'))
      inputs:
        mavenPomFile: 'DependencyChecker/pom.xml'
        options: '-Dexec.args="-showall -dependencymanagement"'
        mavenOptions: '$(MemoryOptions) $(LoggingOptions)'
        javaHomeOption: 'JDKVersion'
        jdkVersionOption: '1.11'
        jdkArchitectureOption: 'x64'
        publishJUnitResults: false
        goals: 'clean package exec:java'

    - pwsh: |   
        copy -r target/staging $(Build.ArtifactStagingDirectory)
        copy eng/code-quality-reports/src/main/resources/index.html $(Build.ArtifactStagingDirectory)
        copy output/dependencies.html (Join-Path $(Build.ArtifactStagingDirectory) "staging")
      displayName: 'Copy reports to artifact staging'
      condition: and(succeeded(), in(variables['Build.Reason'], 'Schedule', 'Manual'))

    - publish: $(Build.ArtifactStagingDirectory)
      condition: succeededOrFailed()
      displayName: 'Publish Report Artifacts'
      artifact: reports