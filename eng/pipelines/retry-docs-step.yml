parameters:
- name: BuildId
  type: string
  default: <buildid>
- name: ServiceDirectory
  type: string
  default: <servicedirectory>
- name: Artifacts
  type: object
  default:
  - name: <packagename>
    groupId: com.azure
    safeName: safename
    skipVerifyReleaseVersion: true
    skipTagRepository: true
    skipPublishPackage: true
    skipPublishDocMs: true
    skipPublishDocGithubIo: true
    skipUpdatePackageVersion: true
- name: SDKType
  type: string
  default: client
- name: TargetDocRepoOwner
  type: string
  default: Azure
- name: TargetDocRepoName
  type: string
  default: azure-docs-sdk-java

resources:
  repositories:
    - repository: azure-sdk-build-tools
      type: git
      name: internal/azure-sdk-build-tools
      ref: refs/tags/azure-sdk-build-tools_20200916.1

stages:
  - stage: SetupArtifacts
    jobs:
    - job: SetupArtifacts
      displayName: Setup Artifacts from broken build
      variables:
        - template: templates/variables/globals.yml
      pool:
        vmImage: 'ubuntu-18.04'
      steps:
        - checkout: none
        - task: DownloadPipelineArtifact@2
          displayName: Download artifacts from build ${{ parameters.BuildId }}
          inputs:
            source: 'specific'
            artifact: 'packages-signed'
            path: $(Build.ArtifactStagingDirectory)
            project: 'internal'
            buildVersionToDownload: 'specific'
            buildId: ${{ parameters.BuildId }}
        - task: PublishPipelineArtifact@1
          displayName: Upload artifacts
          inputs:
            artifactName: packages-signed
            path: $(Build.ArtifactStagingDirectory)

  # The Prerelease and Release stages are conditioned on whether we are building a pull request and the branch.
  - ${{if and(ne(variables['Build.Reason'], 'PullRequest'), eq(variables['System.TeamProject'], 'internal'))}}:
    - template: /eng/pipelines/templates/stages/archetype-java-release.yml
      parameters:
        DependsOn:
          - SetupArtifacts
        ServiceDirectory: ${{ parameters.ServiceDirectory }}
        SDKType: ${{ parameters.SDKType }}
        Artifacts: ${{ parameters.Artifacts }}
        ${{ if eq(parameters.ServiceDirectory, 'template') }}:
          TestPipeline: true
        ArtifactName: packages
        TargetDocRepoOwner: ${{ parameters.TargetDocRepoOwner }}
        TargetDocRepoName: ${{ parameters.TargetDocRepoName }}
        EnableSigningStage: false
        EnableAllDependsOn: false