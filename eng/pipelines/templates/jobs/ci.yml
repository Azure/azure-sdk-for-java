parameters:
  - name: SDKType
    type: string
    default: client
  - name: ServiceDirectory
    type: string
    default: 'not-specified' # Set a default that breaks in obvious ways.
  - name: TestPipeline
    type: boolean
    default: false
  - name: Artifacts
    type: object
    default: []
  - name: ExcludePaths
    type: object
    default: []
  - name: ReleaseArtifacts
    type: object
    default: []
  - name: PreTestSteps
    type: object
    default: []
  - name: MatrixConfigs
    type: object
  - name: AdditionalMatrixConfigs
    type: object
    default: []
  - name: MatrixFilters
    type: object
    default: []
  - name: MatrixReplace
    type: object
    default: []
  - name: PreBuildSteps
    type: object
    default: []
  - name: AdditionalLintingOptions
    type: string
    default: ''
  - name: BuildParallelization
    type: string
    default: '2C'
  - name: TestGoals
    type: string
    default: $(TestGoals)
  - name: TestOptions
    type: string
    default: $(TestOptions)
  - name: TestParallelization
    type: string
    default: '1C'
  - name: JavaBuildVersion
    type: string
    default: $(JavaBuildVersion)
  - name: IgnoreVerifyTypeSpecCodeGenerationError
    type: boolean
    default: false
  - name: TimeoutInMinutes
    type: number
    default: 60
  - name: EnvVars
    type: object
    default: {}
  - name: VersionOverride
    type: string
    default: $(VersionOverride)

jobs:
  - job: 'Build'

    variables:
      ArtifactName: 'packages'
      Codeql.Enabled: true
      Codeql.BuildIdentifier: ${{ parameters.ServiceDirectory }}
      Codeql.SkipTaskAutoInjection: false
      SDKType: ${{ parameters.SDKType }}

    pool:
      name: $(LINUXPOOL)
      image: $(LINUXVMIMAGE)
      os: linux

    steps:
      # Skip sparse checkout for the `azure-sdk-for-<lang>-pr` private mirrored repositories
      # as we require the GitHub service connection to be loaded.
      - ${{ if not(contains(variables['Build.DefinitionName'], 'java-pr')) }}:
        - template: /eng/common/pipelines/templates/steps/sparse-checkout.yml
          parameters:
            Paths:
              - '**/*.xml'
              - '**/*.md'
              - '!sdk/**/test-recordings'
              - '!sdk/**/session-records'

      - task: Powershell@2
        displayName: Test Step
        inputs:
          targetType: inline
          pwsh: true
          script: >
            $(Build.SourcesDirectory)/eng/scripts/test_script.ps1
            -ServiceDirectory 'test'
            -ExcludePaths ('${{ convertToJson(parameters.ExcludePaths) }}' | convertFrom-Json)
