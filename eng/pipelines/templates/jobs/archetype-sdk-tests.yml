parameters:
  ServiceDirectory: ''
  EnvVars: {}
  MaxParallel: 0
  Matrix:
    Win2016:
      OSVmImage: 'vs2017-win2016'
      DisplayName: 'Run Live tests'
  PreRunSteps: []
  TestName: LiveTest
  TimeoutInMinutes: 60 # TODO: USE WHATEVER THE DEVOPS DEFAULT IS
  TestStepMavenInputs:
    options: '--batch-mode -Dmaven.wagon.http.pool=false -Dsurefire.rerunFailingTestsCount=3'
    mavenOptions: '-Xmx3072m -Dorg.slf4j.simpleLogger.defaultLogLevel=error -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn'
    javaHomeOption: 'JDKVersion'
    jdkVersionOption: '1.8'
    jdkArchitectureOption: 'x64'
    publishJUnitResults: false
    goals: 'test'
  TestResultsFiles: ''

jobs:
  - job: ${{ parameters.TestName }}
    timeoutInMinutes: ${{ parameters.TimeoutInMinutes }}

    strategy:
      matrix: ${{ parameters.Matrix }}
      maxParallel: ${{ parameters.MaxParallel }}

    pool:
      vmImage: $(OSVmImage)

    steps:
      - ${{ parameters.PreRunSteps }}

      - task: Maven@3
        displayName: $(DisplayName)
        inputs:
          # TODO: use pom.service.xml when it's ready
          mavenPomFile: sdk/${{parameters.ServiceDirectory}}/pom.xml
          ${{ insert }}: ${{ parameters.TestStepMavenInputs }}
        env: ${{ parameters.EnvVars }}

      - task: PublishTestResults@2
        condition: succeededOrFailed()
        inputs:
          mergeTestResults: true
          testResultsFiles: ${{ parameters.TestResultsFiles }}
          testRunTitle: 'Live tests for ${{ parameters.ServiceDirectory }} $(DisplayName)'