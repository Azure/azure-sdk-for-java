steps:
  - task: Cache@2
    inputs:
      key: 'jdk | "1.8" | "$(CacheSalt)" | "$(Agent.OS)"'
      path: $(Agent.BuildDirectory)/jdk-8
    displayName: 'Cache Java 8 JDK'
    condition: and(eq(variables['JavaTestVersion'], '1.8'), eq(variables['Agent.OS'], 'Darwin'))

  - task: PowerShell@2
    displayName: 'Install Java 8 JDK on macOS 15'
    inputs:
      pwsh: true
      targetType: 'inline'
      script: |
        # Check macOS version
        $osVersion = sw_vers -productVersion 2>$null
        Write-Host "Current macOS version: $osVersion"

        if ($osVersion -match '^(\d+)\.') {
          $majorVersion = [int]$matches[1]
          Write-Host "Detected macOS major version: $majorVersion"

          if ($majorVersion -ge 15) {
            Write-Host "macOS $majorVersion detected (15 or higher). Proceeding with Java 8 installation."

            # Call the existing installation script
            & "$(Build.SourcesDirectory)/eng/scripts/Install-Latest-JDK.ps1" -JdkFeatureVersion 8
          } else {
            Write-Host "macOS version is $osVersion (major version $majorVersion), which is lower than 15. Skipping Java 8 installation."
          }
        } else {
          Write-Error "Failed parse macOS version '$osVersion'."
        }

      workingDirectory: $(Agent.BuildDirectory)
    condition: and(eq(variables['JavaTestVersion'], '1.8'), eq(variables['Agent.OS'], 'Darwin'))

  - pwsh: |
      Write-Host "Java 8 JDK: $Env:JAVA_HOME_8_X64"
    displayName: 'Verify Latest JDK Install'
    condition: eq(variables['IsLatestNonLtsJdk'], 'true')
