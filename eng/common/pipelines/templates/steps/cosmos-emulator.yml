parameters:
  EmulatorMsiUrl: "https://aka.ms/cosmosdb-emulator"
  StartParameters: '-EnablePreview'

steps:
  - powershell: |
      $targetDir = $env:temp
      Write-Host "Downloading and extracting Cosmos DB Emulator - ${{ parameters.EmulatorMsiUrl }}"
      Write-Host "Target Dir: $targetDir"
      msiexec /a ${{ parameters.EmulatorMsiUrl }} TARGETDIR=$targetDir /qn | wait-process
    displayName: Download and Extract Public Cosmos DB Emulator
  - powershell: |
      Write-Host "Deleting Cosmos DB Emulator data"
      if (Test-Path $Env:LOCALAPPDATA\CosmosDbEmulator) { Remove-Item -Recurse -Force $Env:LOCALAPPDATA\CosmosDbEmulator }
    displayName: Delete Cosmos DB Emulator data
  - powershell: |
      Write-Host "Overriding Cosmos DB Emulator install location"
      Set-Variable ProductName -Option Constant -Value "Azure Cosmos DB Emulator"
      $targetDir = $env:temp
      $cosmosEmulatorRegistryKeys = Get-ItemProperty "HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\*" | Where-Object { $_.DisplayName -eq $ProductName } | Select-Object -First 1
      if ($cosmosEmulatorRegistryKeys) {
        Write-Host "Before changing install location"
        Write-Host $cosmosEmulatorRegistryKeys
        Set-ItemProperty -Path $cosmosEmulatorRegistryKeys.PSPath -Name "InstallLocation" -Value ((Join-Path $targetDir $ProductName) + "\")
        $cosmosEmulatorRegistryKeys = Get-ItemProperty "HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\*" | Where-Object { $_.DisplayName -eq $ProductName } | Select-Object -First 1
        Write-Host "After changing install location"
        Write-Host $cosmosEmulatorRegistryKeys
      }
    displayName: Override Cosmos DB Emulator install location
  - powershell: |
      Write-Host "Getting Cosmos DB Emulator Version"
      $ProductName = "Azure Cosmos DB Emulator"
      $Emulator = (Join-Path $env:temp (Join-Path $ProductName "CosmosDB.Emulator.exe"))
      $fileVersion = Get-ChildItem $Emulator
      Write-Host $Emulator $fileVersion.VersionInfo
    displayName: Get Cosmos DB Emulator Version
  - powershell: |
      Write-Host "Launching Cosmos DB Emulator"
      Import-Module "$env:temp\Azure Cosmos DB Emulator\PSModules\Microsoft.Azure.CosmosDB.Emulator"
      Start-CosmosDbEmulator -NoUI ${{ parameters.StartParameters }}
    displayName: Start Cosmos DB Emulator