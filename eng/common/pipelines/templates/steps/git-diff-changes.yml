parameters:
  SourceCommittish: "${env:BUILD_SOURCEVERSION}"
  TargetCommittish: ("origin/${env:SYSTEM_PULLREQUEST_TARGETBRANCH}" -replace "refs/heads/")
  TargetVar: "Diff"
steps:  
- pwsh: |
    # Git PR diff: https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/about-comparing-branches-in-pull-requests#three-dot-and-two-dot-git-diff-comparisons
    Write-Host "git -c core.quotepath=off -c i18n.logoutputencoding=utf-8 diff ${{parameters.TargetCommittish}}...${{parameters.SourceCommittish}} --name-only --diff-filter=d"
    $a = "${{parameters.TargetCommittish}}".Trim()
    $b = "${{parameters.SourceCommittish}}".Trim()
    Write-Host "This is source commit: $a"
    Write-Host "This is target commit: $b"
    git diff $a...$b --name-only --diff-filter=d
    $changedFiles = (git -c core.quotepath=off -c i18n.logoutputencoding=utf-8 diff 4169a431eea99f4759470a1c21574d74a5f3e55f...85817f5dfd1c0d08aaff39e2e0c51b69ea99673b --name-only --diff-filter=d)
    if(!$changedFiles) {
      Write-Host "No changed files in git diff between ${{parameters.TargetCommittish}} and ${{parameters.SourceCommittish}}"
    }
    Write-Host "##vso[task.setvariable variable=${{ parameters.TargetVar }}]$changedFiles"
    foreach ($file in $changedFiles) {
      Write-Host "The diff file is: $file"
    }
  displayName: git diff changes
  condition: eq(variables['Build.Reason'], 'PullRequest')