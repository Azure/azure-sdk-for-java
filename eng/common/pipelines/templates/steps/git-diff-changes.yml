parameters:
  Sourcecommittish: "${env:SYSTEM_PULLREQUEST_SOURCECOMMITID}"
  Targetcommittish: "${env:BUILD_SOURCEVERSION}"
  TargetVar: "Diff"
steps:  
- pwsh: |
    # Git PR diff: https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/about-comparing-branches-in-pull-requests#three-dot-and-two-dot-git-diff-comparisons
    Write-Host "git -c core.quotepath=off -c i18n.logoutputencoding=utf-8 diff ${{parameters.Targetcommittish}}...${{parameters.Sourcecommittish}} --name-only --diff-filter=d"
    $a = "${{parameters.Targetcommittish}}".Trim()
    $b = "${{parameters.Sourcecommittish}}".Trim()
    Write-Host "This is source commit: $a"
    Write-Host "This is target commit: $b"
    git diff $a...$b --name-only --diff-filter=d
    $changedFiles = (git diff $a...$b --name-only --diff-filter=d)
    if(!$changedFiles) {
      Write-Host "No changed files in git diff between ${{parameters.Targetcommittish}} and ${{parameters.Sourcecommittish}}"
    }
    Write-Host "##vso[task.setvariable variable=${{ parameters.TargetVar }}]$changedFiles"
    foreach ($file in $changedFiles) {
      Write-Host "The diff file is: $file"
    }
  displayName: git diff changes
  condition: eq(variables['Build.Reason'], 'PullRequest')