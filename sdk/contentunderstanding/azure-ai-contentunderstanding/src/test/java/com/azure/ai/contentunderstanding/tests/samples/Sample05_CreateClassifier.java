// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
// Code generated by Microsoft (R) TypeSpec Code Generator.

package com.azure.ai.contentunderstanding.tests.samples;

import com.azure.ai.contentunderstanding.models.ContentAnalyzer;
import com.azure.ai.contentunderstanding.models.ContentAnalyzerConfig;
import com.azure.ai.contentunderstanding.models.ContentAnalyzerOperationStatus;
import com.azure.ai.contentunderstanding.models.ContentCategoryDefinition;
import com.azure.core.util.polling.SyncPoller;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.Test;

import static org.junit.jupiter.api.Assertions.*;

import java.util.HashMap;
import java.util.Map;

/**
 * Sample demonstrating how to create a classifier analyzer.
 *
 * This sample shows how to create a classifier that categorizes documents into predefined
 * custom categories using ContentCategories. Classifiers are useful for:
 * - Content organization: Organize large document collections by type through categorization
 * - Data routing (optional): Route data to specific custom analyzers based on category
 * - Multi-document processing: Process files containing multiple document types by automatically
 *   segmenting them
 */
public class Sample05_CreateClassifier extends ContentUnderstandingClientTestBase {

    private String createdAnalyzerId;

    @AfterEach
    public void cleanup() {
        if (createdAnalyzerId != null) {
            try {
                contentUnderstandingClient.deleteAnalyzer(createdAnalyzerId);
                System.out.println("Classifier analyzer '" + createdAnalyzerId + "' deleted successfully.");
            } catch (Exception e) {
                // Ignore cleanup errors
            }
        }
    }

    @Test
    public void testCreateClassifier() {

        // BEGIN:ContentUnderstandingCreateClassifier
        // Generate a unique classifier analyzer ID
        String analyzerId = testResourceNamer.randomName("document_classifier_", 50);

        System.out.println("Creating classifier analyzer '" + analyzerId + "'...");

        // Define content categories for classification
        // Each category has a description that helps the AI model understand what documents belong to it
        Map<String, ContentCategoryDefinition> categories = new HashMap<>();

        categories.put("Loan_Application",
            new ContentCategoryDefinition()
                .setDescription("Documents submitted by individuals or businesses to request funding, "
                    + "typically including personal or business details, financial history, loan amount, "
                    + "purpose, and supporting documentation."));

        categories.put("Invoice",
            new ContentCategoryDefinition()
                .setDescription("Billing documents issued by sellers or service providers to request payment "
                    + "for goods or services, detailing items, prices, taxes, totals, and payment terms."));

        categories.put("Bank_Statement",
            new ContentCategoryDefinition()
                .setDescription("Official statements issued by banks that summarize account activity over a period, "
                    + "including deposits, withdrawals, fees, and balances."));

        // Create analyzer configuration with content categories
        ContentAnalyzerConfig config = new ContentAnalyzerConfig().setReturnDetails(true)
            .setEnableSegment(true) // Enable automatic segmentation by category
            .setContentCategories(categories);

        // Create the classifier analyzer
        // Note: models are specified using model names, not deployment names
        Map<String, String> models = new HashMap<>();
        models.put("completion", "gpt-4.1");

        ContentAnalyzer classifier = new ContentAnalyzer().setBaseAnalyzerId("prebuilt-document")
            .setDescription("Custom classifier for financial document categorization")
            .setConfig(config)
            .setModels(models);

        // Create the classifier
        SyncPoller<ContentAnalyzerOperationStatus, ContentAnalyzer> operation
            = contentUnderstandingClient.beginCreateAnalyzer(analyzerId, classifier, true);

        ContentAnalyzer result = operation.getFinalResult();
        System.out.println("Classifier '" + analyzerId + "' created successfully!");
        // END:ContentUnderstandingCreateClassifier

        createdAnalyzerId = analyzerId; // Track for cleanup

        // BEGIN:Assertion_ContentUnderstandingCreateClassifier
        // Verify basic properties
        assertNotNull(analyzerId, "Analyzer ID should not be null");
        assertFalse(analyzerId.trim().isEmpty(), "Analyzer ID should not be empty");
        assertNotNull(operation, "Create analyzer operation should not be null");
        assertTrue(operation.waitForCompletion().getStatus().isComplete(), "Operation should be completed");
        System.out.println("✓ Create classifier operation completed successfully");

        assertNotNull(result, "Analyzer result should not be null");
        System.out.println("✓ Classifier analyzer created: " + analyzerId);

        // Verify base analyzer
        assertNotNull(result.getBaseAnalyzerId(), "Base analyzer ID should not be null");
        assertEquals("prebuilt-document", result.getBaseAnalyzerId(), "Base analyzer ID should match");
        System.out.println("✓ Base analyzer ID verified: " + result.getBaseAnalyzerId());

        // Verify description
        assertNotNull(result.getDescription(), "Description should not be null");
        assertEquals("Custom classifier for financial document categorization", result.getDescription(),
            "Description should match");
        System.out.println("✓ Description verified: " + result.getDescription());

        // Verify analyzer config
        assertNotNull(result.getConfig(), "Analyzer config should not be null");
        System.out.println("✓ Analyzer config present");

        // Verify content categories
        assertNotNull(result.getConfig().getContentCategories(), "Content categories should not be null");
        assertEquals(3, result.getConfig().getContentCategories().size(), "Should have 3 content categories");
        System.out.println("✓ Content categories count verified: " + result.getConfig().getContentCategories().size());

        // Verify Loan_Application category
        assertTrue(result.getConfig().getContentCategories().containsKey("Loan_Application"),
            "Should contain Loan_Application category");
        ContentCategoryDefinition loanAppCategory = result.getConfig().getContentCategories().get("Loan_Application");
        assertNotNull(loanAppCategory.getDescription(), "Loan_Application description should not be null");
        assertTrue(loanAppCategory.getDescription().contains("funding"),
            "Loan_Application description should mention funding");
        System.out.println("  ✓ Loan_Application category verified");

        // Verify Invoice category
        assertTrue(result.getConfig().getContentCategories().containsKey("Invoice"), "Should contain Invoice category");
        ContentCategoryDefinition invoiceCategory = result.getConfig().getContentCategories().get("Invoice");
        assertNotNull(invoiceCategory.getDescription(), "Invoice description should not be null");
        assertTrue(invoiceCategory.getDescription().contains("payment"), "Invoice description should mention payment");
        System.out.println("  ✓ Invoice category verified");

        // Verify Bank_Statement category
        assertTrue(result.getConfig().getContentCategories().containsKey("Bank_Statement"),
            "Should contain Bank_Statement category");
        ContentCategoryDefinition bankCategory = result.getConfig().getContentCategories().get("Bank_Statement");
        assertNotNull(bankCategory.getDescription(), "Bank_Statement description should not be null");
        assertTrue(bankCategory.getDescription().contains("account activity"),
            "Bank_Statement description should mention account activity");
        System.out.println("  ✓ Bank_Statement category verified");

        // Verify enableSegment is set
        assertNotNull(result.getConfig().isEnableSegment(), "EnableSegment should not be null");
        assertTrue(result.getConfig().isEnableSegment(), "EnableSegment should be true");
        System.out.println("✓ EnableSegment verified: " + result.getConfig().isEnableSegment());

        // Verify returnDetails is set
        assertNotNull(result.getConfig().isReturnDetails(), "ReturnDetails should not be null");
        assertTrue(result.getConfig().isReturnDetails(), "ReturnDetails should be true");
        System.out.println("✓ ReturnDetails verified: " + result.getConfig().isReturnDetails());

        // Verify models
        assertNotNull(result.getModels(), "Models should not be null");
        assertTrue(result.getModels().containsKey("completion"), "Should contain 'completion' model mapping");
        System.out.println("✓ Model mappings verified: " + result.getModels().size() + " model(s)");

        System.out.println("\n════════════════════════════════════════════════════════════");
        System.out.println("✓ CLASSIFIER CREATION VERIFIED SUCCESSFULLY");
        System.out.println("════════════════════════════════════════════════════════════");
        System.out.println("  Analyzer ID: " + analyzerId);
        System.out.println("  Base Analyzer: " + result.getBaseAnalyzerId());
        System.out.println("  Categories: " + result.getConfig().getContentCategories().size());
        System.out.println("  Segmentation: " + result.getConfig().isEnableSegment());
        System.out.println("════════════════════════════════════════════════════════════");
        // END:Assertion_ContentUnderstandingCreateClassifier
    }
}
