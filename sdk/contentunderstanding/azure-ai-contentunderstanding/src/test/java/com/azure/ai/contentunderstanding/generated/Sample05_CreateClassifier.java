// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
// Code generated by Microsoft (R) TypeSpec Code Generator.

package com.azure.ai.contentunderstanding.generated;

import com.azure.ai.contentunderstanding.ContentUnderstandingClient;
import com.azure.ai.contentunderstanding.ContentUnderstandingClientBuilder;
import com.azure.ai.contentunderstanding.models.ContentAnalyzer;
import com.azure.ai.contentunderstanding.models.ContentAnalyzerConfig;
import com.azure.ai.contentunderstanding.models.ContentAnalyzerOperationStatus;
import com.azure.ai.contentunderstanding.models.ContentFieldDefinition;
import com.azure.ai.contentunderstanding.models.ContentFieldSchema;
import com.azure.ai.contentunderstanding.models.ContentFieldType;
import com.azure.ai.contentunderstanding.models.GenerationMethod;
import com.azure.core.credential.AzureKeyCredential;
import com.azure.core.util.Configuration;
import com.azure.core.util.polling.SyncPoller;
import com.azure.identity.DefaultAzureCredentialBuilder;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;

import static org.junit.jupiter.api.Assertions.*;

import java.util.Arrays;
import java.util.HashMap;
import java.util.Map;

/**
 * Sample demonstrating how to create a classifier analyzer.
 * This sample shows:
 * 1. Defining a classifier with predefined categories
 * 2. Creating an analyzer specifically for classification tasks
 * 3. Using the Classify method for document type classification
 */
public class Sample05_CreateClassifier {

    private String createdAnalyzerId;

    @AfterEach
    public void cleanup() {
        if (createdAnalyzerId != null) {
            try {
                String endpoint = Configuration.getGlobalConfiguration().get("CONTENTUNDERSTANDING_ENDPOINT");
                String key = System.getenv("AZURE_CONTENT_UNDERSTANDING_KEY");

                ContentUnderstandingClientBuilder builder = new ContentUnderstandingClientBuilder().endpoint(endpoint);

                ContentUnderstandingClient client;
                if (key != null && !key.trim().isEmpty()) {
                    client = builder.credential(new AzureKeyCredential(key)).buildClient();
                } else {
                    client = builder.credential(new DefaultAzureCredentialBuilder().build()).buildClient();
                }

                client.deleteAnalyzer(createdAnalyzerId);
                System.out.println("Classifier analyzer '" + createdAnalyzerId + "' deleted successfully.");
            } catch (Exception e) {
                // Ignore cleanup errors
            }
        }
    }

    @Test
    public void testCreateClassifierAsync() {
        // BEGIN: com.azure.ai.contentunderstanding.buildClient
        String endpoint = Configuration.getGlobalConfiguration().get("CONTENTUNDERSTANDING_ENDPOINT");
        String key = System.getenv("AZURE_CONTENT_UNDERSTANDING_KEY");

        // Build the client with appropriate authentication
        ContentUnderstandingClientBuilder builder = new ContentUnderstandingClientBuilder().endpoint(endpoint);

        ContentUnderstandingClient client;
        if (key != null && !key.trim().isEmpty()) {
            // Use API key authentication
            client = builder.credential(new AzureKeyCredential(key)).buildClient();
        } else {
            // Use default Azure credential (for managed identity, Azure CLI, etc.)
            client = builder.credential(new DefaultAzureCredentialBuilder().build()).buildClient();
        }
        // END: com.azure.ai.contentunderstanding.buildClient

        // Verify client initialization
        assertNotNull(endpoint, "CONTENTUNDERSTANDING_ENDPOINT environment variable should be set");
        assertFalse(endpoint.trim().isEmpty(), "Endpoint should not be empty");
        assertNotNull(client, "Client should be successfully created");

        // BEGIN:ContentUnderstandingCreateClassifier
        // Generate a unique classifier analyzer ID
        String analyzerId = "document_classifier_" + System.currentTimeMillis();

        // Define field schema with classification fields
        // Classifiers use the Classify method to categorize documents into predefined types
        Map<String, ContentFieldDefinition> fields = new HashMap<>();

        // Document type classifier
        ContentFieldDefinition documentTypeDef = new ContentFieldDefinition();
        documentTypeDef.setType(ContentFieldType.STRING);
        documentTypeDef.setMethod(GenerationMethod.CLASSIFY);
        documentTypeDef.setDescription("Type of document");
        documentTypeDef
            .setEnumProperty(Arrays.asList("invoice", "receipt", "contract", "report", "letter", "form", "other"));
        fields.put("document_type", documentTypeDef);

        // Industry classifier
        ContentFieldDefinition industryDef = new ContentFieldDefinition();
        industryDef.setType(ContentFieldType.STRING);
        industryDef.setMethod(GenerationMethod.CLASSIFY);
        industryDef.setDescription("Industry category of the document");
        industryDef.setEnumProperty(Arrays.asList("finance", "healthcare", "legal", "retail", "technology", "other"));
        fields.put("industry", industryDef);

        // Urgency classifier
        ContentFieldDefinition urgencyDef = new ContentFieldDefinition();
        urgencyDef.setType(ContentFieldType.STRING);
        urgencyDef.setMethod(GenerationMethod.CLASSIFY);
        urgencyDef.setDescription("Urgency level of the document");
        urgencyDef.setEnumProperty(Arrays.asList("urgent", "normal", "low"));
        fields.put("urgency", urgencyDef);

        ContentFieldSchema fieldSchema = new ContentFieldSchema();
        fieldSchema.setName("document_classifier_schema");
        fieldSchema.setDescription("Schema for classifying document types, industries, and urgency");
        fieldSchema.setFields(fields);

        // Create analyzer configuration
        ContentAnalyzerConfig config = new ContentAnalyzerConfig();
        config.setEnableFormula(false);
        config.setEnableLayout(true);
        config.setEnableOcr(true);
        config.setEstimateFieldSourceAndConfidence(true);
        config.setReturnDetails(false);

        // Create the classifier analyzer
        ContentAnalyzer classifierAnalyzer = new ContentAnalyzer();
        classifierAnalyzer.setBaseAnalyzerId("prebuilt-document");
        classifierAnalyzer.setDescription("Document classifier for type, industry, and urgency detection");
        classifierAnalyzer.setConfig(config);
        classifierAnalyzer.setFieldSchema(fieldSchema);

        // Add model mappings (required for custom analyzers)
        Map<String, String> models = new HashMap<>();
        models.put("completion", "gpt-4.1");
        models.put("embedding", "text-embedding-3-large");
        classifierAnalyzer.setModels(models);

        // Create the analyzer
        SyncPoller<ContentAnalyzerOperationStatus, ContentAnalyzer> operation
            = client.beginCreateAnalyzer(analyzerId, classifierAnalyzer, true);

        ContentAnalyzer result = operation.getFinalResult();
        System.out.println("Classifier analyzer '" + analyzerId + "' created successfully!");
        // END:ContentUnderstandingCreateClassifier

        createdAnalyzerId = analyzerId; // Track for cleanup

        // BEGIN:Assertion_ContentUnderstandingCreateClassifier
        Assertions.assertNotNull(analyzerId, "Analyzer ID should not be null");
        Assertions.assertFalse(analyzerId.trim().isEmpty(), "Analyzer ID should not be empty");
        Assertions.assertNotNull(fieldSchema, "Field schema should not be null");
        Assertions.assertNotNull(classifierAnalyzer, "Classifier analyzer should not be null");
        Assertions.assertNotNull(operation, "Create analyzer operation should not be null");
        Assertions.assertTrue(operation.waitForCompletion().getStatus().isComplete(), "Operation should be completed");
        System.out.println("Create classifier operation properties verified");

        Assertions.assertNotNull(result, "Analyzer result should not be null");
        System.out.println("Classifier analyzer '" + analyzerId + "' created successfully");

        // Verify base analyzer
        Assertions.assertNotNull(result.getBaseAnalyzerId(), "Base analyzer ID should not be null");
        Assertions.assertEquals("prebuilt-document", result.getBaseAnalyzerId(), "Base analyzer ID should match");
        System.out.println("Base analyzer ID verified: " + result.getBaseAnalyzerId());

        // Verify analyzer config
        Assertions.assertNotNull(result.getConfig(), "Analyzer config should not be null");
        Assertions.assertFalse(result.getConfig().isEnableFormula(), "EnableFormula should be false for classifier");
        Assertions.assertTrue(result.getConfig().isEnableLayout(), "EnableLayout should be true");
        Assertions.assertTrue(result.getConfig().isEnableOcr(), "EnableOcr should be true");
        Assertions.assertTrue(result.getConfig().isEstimateFieldSourceAndConfidence(),
            "EstimateFieldSourceAndConfidence should be true");
        System.out.println("Analyzer config verified");

        // Verify field schema
        Assertions.assertNotNull(result.getFieldSchema(), "Field schema should not be null");
        Assertions.assertFalse(result.getFieldSchema().getName().trim().isEmpty(),
            "Field schema name should not be empty");
        Assertions.assertEquals("document_classifier_schema", result.getFieldSchema().getName(),
            "Field schema name should match");
        Assertions.assertFalse(result.getFieldSchema().getDescription().trim().isEmpty(),
            "Field schema description should not be empty");
        System.out.println("Field schema verified: " + result.getFieldSchema().getName());

        // Verify field schema fields
        Assertions.assertNotNull(result.getFieldSchema().getFields(), "Field schema fields should not be null");
        Assertions.assertEquals(3, result.getFieldSchema().getFields().size(), "Should have 3 classifier fields");
        System.out.println("Field schema contains " + result.getFieldSchema().getFields().size() + " fields");

        // Verify document_type field
        Assertions.assertTrue(result.getFieldSchema().getFields().containsKey("document_type"),
            "Should contain document_type field");
        ContentFieldDefinition documentTypeDefResult = result.getFieldSchema().getFields().get("document_type");
        Assertions.assertEquals(ContentFieldType.STRING, documentTypeDefResult.getType(),
            "document_type should be String type");
        Assertions.assertEquals(GenerationMethod.CLASSIFY, documentTypeDefResult.getMethod(),
            "document_type should use Classify method");
        Assertions.assertNotNull(documentTypeDefResult.getEnumProperty(), "document_type should have enum values");
        Assertions.assertEquals(7, documentTypeDefResult.getEnumProperty().size(),
            "document_type should have 7 enum values");
        System.out.println("  document_type field verified (String, Classify, 7 enum values)");

        // Verify industry field
        Assertions.assertTrue(result.getFieldSchema().getFields().containsKey("industry"),
            "Should contain industry field");
        ContentFieldDefinition industryDefResult = result.getFieldSchema().getFields().get("industry");
        Assertions.assertEquals(ContentFieldType.STRING, industryDefResult.getType(), "industry should be String type");
        Assertions.assertEquals(GenerationMethod.CLASSIFY, industryDefResult.getMethod(),
            "industry should use Classify method");
        Assertions.assertNotNull(industryDefResult.getEnumProperty(), "industry should have enum values");
        Assertions.assertEquals(6, industryDefResult.getEnumProperty().size(), "industry should have 6 enum values");
        System.out.println("  industry field verified (String, Classify, 6 enum values)");

        // Verify urgency field
        Assertions.assertTrue(result.getFieldSchema().getFields().containsKey("urgency"),
            "Should contain urgency field");
        ContentFieldDefinition urgencyDefResult = result.getFieldSchema().getFields().get("urgency");
        Assertions.assertEquals(ContentFieldType.STRING, urgencyDefResult.getType(), "urgency should be String type");
        Assertions.assertEquals(GenerationMethod.CLASSIFY, urgencyDefResult.getMethod(),
            "urgency should use Classify method");
        Assertions.assertNotNull(urgencyDefResult.getEnumProperty(), "urgency should have enum values");
        Assertions.assertEquals(3, urgencyDefResult.getEnumProperty().size(), "urgency should have 3 enum values");
        System.out.println("  urgency field verified (String, Classify, 3 enum values)");

        // Verify models
        Assertions.assertNotNull(result.getModels(), "Models should not be null");
        Assertions.assertTrue(result.getModels().size() >= 2, "Should have at least 2 model mappings");
        Assertions.assertTrue(result.getModels().containsKey("completion"),
            "Should contain 'completion' model mapping");
        Assertions.assertTrue(result.getModels().containsKey("embedding"), "Should contain 'embedding' model mapping");
        System.out.println("Model mappings verified: " + result.getModels().size() + " model(s)");

        System.out.println("All classifier creation properties validated successfully");
        // END:Assertion_ContentUnderstandingCreateClassifier
    }
}
