// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
// Code generated by Microsoft (R) TypeSpec Code Generator.

package com.azure.ai.contentunderstanding.tests.samples;

import com.azure.ai.contentunderstanding.models.ContentUnderstandingDefaults;
import org.junit.jupiter.api.Test;

import java.util.HashMap;
import java.util.Map;

import static org.junit.jupiter.api.Assertions.*;

/**
 * Async test class demonstrating how to configure and manage default settings for Content Understanding service.
 * This test shows:
 * 1. Getting current default configuration asynchronously
 * 2. Updating default configuration with model deployments asynchronously
 * 3. Verifying the updated configuration
 */
public class Sample00_UpdateDefaultsAsync extends ContentUnderstandingClientTestBase {

    @Test
    public void testUpdateDefaultsAsync() {
        // BEGIN:ContentUnderstandingGetDefaultsAsync
        // Step 1: Get current defaults to see what's configured
        System.out.println("Getting current default configuration...");
        ContentUnderstandingDefaults currentDefaults = contentUnderstandingAsyncClient.getDefaults().block();
        System.out.println("Current defaults retrieved successfully.");
        System.out.println("Current model deployments: " + currentDefaults.getModelDeployments());
        // END:ContentUnderstandingGetDefaultsAsync

        // BEGIN:Assertion_ContentUnderstandingGetDefaultsAsync
        assertNotNull(currentDefaults, "Current defaults should not be null");
        assertNotNull(currentDefaults.getModelDeployments(), "Model deployments should not be null");
        // END:Assertion_ContentUnderstandingGetDefaultsAsync

        // Step 2: Configure model deployments from environment variables
        // These map model names to your deployed model names in Azure AI Foundry
        System.out.println("\nConfiguring model deployments from environment variables...");

        // Get deployment names from environment variables (with defaults)
        String gpt41Deployment = getEnvOrDefault("GPT_4_1_DEPLOYMENT", "gpt-4.1");
        String gpt41MiniDeployment = getEnvOrDefault("GPT_4_1_MINI_DEPLOYMENT", "gpt-4.1-mini");
        String textEmbedding3LargeDeployment
            = getEnvOrDefault("TEXT_EMBEDDING_3_LARGE_DEPLOYMENT", "text-embedding-3-large");

        // Create model deployments map
        Map<String, String> modelDeployments = new HashMap<>();
        modelDeployments.put("gpt-4.1", gpt41Deployment);
        modelDeployments.put("gpt-4.1-mini", gpt41MiniDeployment);
        modelDeployments.put("text-embedding-3-large", textEmbedding3LargeDeployment);

        System.out.println("Model deployments to configure:");
        System.out.println("  gpt-4.1 -> " + gpt41Deployment);
        System.out.println("  gpt-4.1-mini -> " + gpt41MiniDeployment);
        System.out.println("  text-embedding-3-large -> " + textEmbedding3LargeDeployment);

        // BEGIN:ContentUnderstandingUpdateDefaultsAsync
        // Step 3: Update defaults with the new configuration
        System.out.println("\nUpdating default configuration...");

        // Update defaults with the configuration using the typed convenience method
        ContentUnderstandingDefaults updatedConfig
            = contentUnderstandingAsyncClient.updateDefaults(modelDeployments).block();
        System.out.println("Defaults updated successfully.");
        System.out.println("Updated model deployments: " + updatedConfig.getModelDeployments());
        // END:ContentUnderstandingUpdateDefaultsAsync

        // BEGIN:Assertion_ContentUnderstandingUpdateDefaultsAsync
        assertNotNull(updatedConfig, "Updated config should not be null");
        assertNotNull(updatedConfig.getModelDeployments(), "Updated model deployments should not be null");
        assertFalse(updatedConfig.getModelDeployments().isEmpty(), "Updated model deployments should not be empty");
        // END:Assertion_ContentUnderstandingUpdateDefaultsAsync

        // BEGIN:ContentUnderstandingVerifyDefaultsAsync
        // Step 4: Verify the updated configuration
        System.out.println("\nVerifying updated configuration...");
        ContentUnderstandingDefaults updatedDefaults = contentUnderstandingAsyncClient.getDefaults().block();
        System.out.println("Updated defaults verified successfully.");
        System.out.println("Updated model deployments: " + updatedDefaults.getModelDeployments());
        // END:ContentUnderstandingVerifyDefaultsAsync

        // BEGIN:Assertion_ContentUnderstandingVerifyDefaultsAsync
        assertNotNull(updatedDefaults, "Verified defaults should not be null");
        assertNotNull(updatedDefaults.getModelDeployments(), "Verified model deployments should not be null");
        assertFalse(updatedDefaults.getModelDeployments().isEmpty(), "Verified model deployments should not be empty");

        // Verify the model deployments contain the expected keys
        assertTrue(updatedDefaults.getModelDeployments().containsKey("gpt-4.1"),
            "Model deployments should contain gpt-4.1");
        assertTrue(updatedDefaults.getModelDeployments().containsKey("gpt-4.1-mini"),
            "Model deployments should contain gpt-4.1-mini");
        assertTrue(updatedDefaults.getModelDeployments().containsKey("text-embedding-3-large"),
            "Model deployments should contain text-embedding-3-large");

        // Verify the values match what we set
        assertEquals(gpt41Deployment, updatedDefaults.getModelDeployments().get("gpt-4.1"),
            "gpt-4.1 deployment should match configured value");
        assertEquals(gpt41MiniDeployment, updatedDefaults.getModelDeployments().get("gpt-4.1-mini"),
            "gpt-4.1-mini deployment should match configured value");
        assertEquals(textEmbedding3LargeDeployment, updatedDefaults.getModelDeployments().get("text-embedding-3-large"),
            "text-embedding-3-large deployment should match configured value");
        // END:Assertion_ContentUnderstandingVerifyDefaultsAsync

        System.out.println("\nConfiguration management completed.");
    }

    /**
     * Gets an environment variable value or returns a default value if not set.
     *
     * @param envVar the environment variable name
     * @param defaultValue the default value to return if the environment variable is not set
     * @return the environment variable value or the default value
     */
    private static String getEnvOrDefault(String envVar, String defaultValue) {
        String value = System.getenv(envVar);
        return (value != null && !value.trim().isEmpty()) ? value : defaultValue;
    }
}
