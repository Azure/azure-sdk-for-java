// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
// Code generated by Microsoft (R) TypeSpec Code Generator.

package com.azure.ai.contentunderstanding.generated;

import com.azure.ai.contentunderstanding.ContentUnderstandingAsyncClient;
import com.azure.ai.contentunderstanding.ContentUnderstandingClient;
import com.azure.ai.contentunderstanding.ContentUnderstandingClientBuilder;
import com.azure.ai.contentunderstanding.models.ContentAnalyzer;
import com.azure.ai.contentunderstanding.models.ContentAnalyzerConfig;
import com.azure.ai.contentunderstanding.models.ContentFieldDefinition;
import com.azure.ai.contentunderstanding.models.ContentFieldSchema;
import com.azure.ai.contentunderstanding.models.ContentFieldType;
import com.azure.ai.contentunderstanding.models.GenerationMethod;
import com.azure.core.credential.AzureKeyCredential;
import com.azure.core.http.rest.Response;
import com.azure.core.util.polling.SyncPoller;
import com.azure.identity.DefaultAzureCredentialBuilder;
import org.junit.jupiter.api.Test;

import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

import static org.junit.jupiter.api.Assertions.*;

/**
 * Sample demonstrates how to copy an analyzer within the same resource.
 * For cross-resource copying, see Sample15_GrantCopyAuth.
 */
public class Sample14_CopyAnalyzer {

    private ContentUnderstandingClient client;
    private ContentUnderstandingAsyncClient asyncClient;

    /**
     * Synchronous sample for copying an analyzer.
     */
    @Test
    public void testCopyAnalyzer() {
        String endpoint = System.getenv("CONTENTUNDERSTANDING_ENDPOINT");
        String key = System.getenv("AZURE_CONTENT_UNDERSTANDING_KEY");

        ContentUnderstandingClientBuilder builder = new ContentUnderstandingClientBuilder().endpoint(endpoint);

        // Use DefaultAzureCredential if key is not provided, otherwise use AzureKeyCredential
        if (key == null || key.trim().isEmpty()) {
            client = builder.credential(new DefaultAzureCredentialBuilder().build()).buildClient();
        } else {
            client = builder.credential(new AzureKeyCredential(key)).buildClient();
        }

        // Generate unique analyzer IDs
        String sourceAnalyzerId = "test_analyzer_source_" + UUID.randomUUID().toString().replace("-", "");
        String targetAnalyzerId = "test_analyzer_target_" + UUID.randomUUID().toString().replace("-", "");

        try {
            // BEGIN: com.azure.ai.contentunderstanding.copyAnalyzer
            // Step 1: Create the source analyzer
            ContentAnalyzerConfig sourceConfig = new ContentAnalyzerConfig();
            sourceConfig.setEnableFormula(false);
            sourceConfig.setEnableLayout(true);
            sourceConfig.setEnableOcr(true);
            sourceConfig.setEstimateFieldSourceAndConfidence(true);
            sourceConfig.setReturnDetails(true);

            Map<String, ContentFieldDefinition> fields = new HashMap<>();

            ContentFieldDefinition companyNameField = new ContentFieldDefinition();
            companyNameField.setType(ContentFieldType.STRING);
            companyNameField.setMethod(GenerationMethod.EXTRACT);
            companyNameField.setDescription("Name of the company");
            fields.put("company_name", companyNameField);

            ContentFieldDefinition totalAmountField = new ContentFieldDefinition();
            totalAmountField.setType(ContentFieldType.NUMBER);
            totalAmountField.setMethod(GenerationMethod.EXTRACT);
            totalAmountField.setDescription("Total amount on the document");
            fields.put("total_amount", totalAmountField);

            ContentFieldSchema sourceFieldSchema = new ContentFieldSchema();
            sourceFieldSchema.setName("company_schema");
            sourceFieldSchema.setDescription("Schema for extracting company information");
            sourceFieldSchema.setFields(fields);

            ContentAnalyzer sourceAnalyzer = new ContentAnalyzer();
            sourceAnalyzer.setBaseAnalyzerId("prebuilt-document");
            sourceAnalyzer.setDescription("Source analyzer for copying");
            sourceAnalyzer.setConfig(sourceConfig);
            sourceAnalyzer.setFieldSchema(sourceFieldSchema);

            Map<String, String> models = new HashMap<>();
            models.put("completion", "gpt-4.1");
            sourceAnalyzer.setModels(models);

            Map<String, String> tags = new HashMap<>();
            tags.put("modelType", "in_development");
            sourceAnalyzer.setTags(tags);

            // Create source analyzer
            SyncPoller<com.azure.ai.contentunderstanding.models.ContentAnalyzerOperationStatus, ContentAnalyzer> createPoller
                = client.beginCreateAnalyzer(sourceAnalyzerId, sourceAnalyzer, true);
            ContentAnalyzer sourceResult = createPoller.getFinalResult();
            System.out.println("Source analyzer '" + sourceAnalyzerId + "' created successfully!");

            // Step 2: Copy the source analyzer to target
            // Note: This copies within the same resource
            SyncPoller<com.azure.ai.contentunderstanding.models.ContentAnalyzerOperationStatus, ContentAnalyzer> copyPoller
                = client.beginCopyAnalyzer(targetAnalyzerId, sourceAnalyzerId);
            ContentAnalyzer copiedAnalyzer = copyPoller.getFinalResult();
            System.out.println("Analyzer copied to '" + targetAnalyzerId + "' successfully!");
            // END: com.azure.ai.contentunderstanding.copyAnalyzer

            // Verify source analyzer creation
            System.out.println("\nðŸ“‹ Source Analyzer Creation Verification:");
            assertNotNull(sourceAnalyzerId, "Source analyzer ID should not be null");
            assertFalse(sourceAnalyzerId.trim().isEmpty(), "Source analyzer ID should not be empty");
            assertNotNull(targetAnalyzerId, "Target analyzer ID should not be null");
            assertFalse(targetAnalyzerId.trim().isEmpty(), "Target analyzer ID should not be empty");
            assertNotEquals(sourceAnalyzerId, targetAnalyzerId, "Source and target IDs should be different");
            System.out.println("Source analyzer ID: " + sourceAnalyzerId);
            System.out.println("Target analyzer ID: " + targetAnalyzerId);

            assertNotNull(sourceResult, "Source analyzer result should not be null");
            assertEquals("prebuilt-document", sourceResult.getBaseAnalyzerId(), "Base analyzer ID should match");
            assertEquals("Source analyzer for copying", sourceResult.getDescription(), "Description should match");
            System.out.println(
                "Source analyzer created with " + sourceResult.getFieldSchema().getFields().size() + " fields");

            // Verify copied analyzer
            System.out.println("\nðŸ“‹ Analyzer Copy Verification:");
            assertNotNull(copiedAnalyzer, "Copied analyzer should not be null");

            // Verify base properties
            assertEquals(sourceResult.getBaseAnalyzerId(), copiedAnalyzer.getBaseAnalyzerId(),
                "Copied analyzer should have same base analyzer ID");
            assertEquals(sourceResult.getDescription(), copiedAnalyzer.getDescription(),
                "Copied analyzer should have same description");
            System.out.println("Base analyzer ID: " + copiedAnalyzer.getBaseAnalyzerId());
            System.out.println("Description: '" + copiedAnalyzer.getDescription() + "'");

            // Verify field schema
            assertNotNull(copiedAnalyzer.getFieldSchema(), "Copied analyzer should have field schema");
            assertEquals(sourceResult.getFieldSchema().getName(), copiedAnalyzer.getFieldSchema().getName(),
                "Field schema name should match");
            assertEquals(sourceResult.getFieldSchema().getFields().size(),
                copiedAnalyzer.getFieldSchema().getFields().size(), "Field count should match");
            System.out.println("Field schema: " + copiedAnalyzer.getFieldSchema().getName() + " ("
                + copiedAnalyzer.getFieldSchema().getFields().size() + " fields)");

            // Verify individual fields
            assertTrue(copiedAnalyzer.getFieldSchema().getFields().containsKey("company_name"),
                "Copied analyzer should contain company_name field");
            assertTrue(copiedAnalyzer.getFieldSchema().getFields().containsKey("total_amount"),
                "Copied analyzer should contain total_amount field");
            System.out.println("  company_name field copied correctly");
            System.out.println("  total_amount field copied correctly");

            // Verify tags
            assertNotNull(copiedAnalyzer.getTags(), "Copied analyzer should have tags");
            assertTrue(copiedAnalyzer.getTags().containsKey("modelType"),
                "Copied analyzer should contain modelType tag");
            assertEquals("in_development", copiedAnalyzer.getTags().get("modelType"),
                "Copied analyzer should have same tag value");
            System.out.println("Tags copied: modelType=" + copiedAnalyzer.getTags().get("modelType"));

            // Verify config
            assertNotNull(copiedAnalyzer.getConfig(), "Copied analyzer should have config");
            assertEquals(sourceResult.getConfig().isEnableLayout(), copiedAnalyzer.getConfig().isEnableLayout(),
                "EnableLayout should match");
            assertEquals(sourceResult.getConfig().isEnableOcr(), copiedAnalyzer.getConfig().isEnableOcr(),
                "EnableOcr should match");
            System.out.println("Config copied correctly");

            // Verify models
            assertNotNull(copiedAnalyzer.getModels(), "Copied analyzer should have models");
            assertEquals(sourceResult.getModels().size(), copiedAnalyzer.getModels().size(),
                "Model count should match");
            if (copiedAnalyzer.getModels().containsKey("completion")) {
                assertEquals("gpt-4.1", copiedAnalyzer.getModels().get("completion"), "Completion model should match");
                System.out.println("Models copied: completion=" + copiedAnalyzer.getModels().get("completion"));
            }

            // Summary
            System.out.println("\nâœ… Analyzer copy verification completed successfully:");
            System.out.println("  Source: " + sourceAnalyzerId);
            System.out.println("  Target: " + targetAnalyzerId);
            System.out.println("  Base analyzer: " + copiedAnalyzer.getBaseAnalyzerId());
            System.out.println("  Description: " + copiedAnalyzer.getDescription());
            System.out.println("  Fields: " + copiedAnalyzer.getFieldSchema().getFields().size());
            System.out.println("  Tags: " + copiedAnalyzer.getTags().size());
            System.out.println("  Models: " + copiedAnalyzer.getModels().size());

        } finally {
            // Cleanup: Delete the analyzers
            try {
                client.deleteAnalyzer(sourceAnalyzerId);
                System.out.println("\nSource analyzer deleted: " + sourceAnalyzerId);
            } catch (Exception e) {
                System.out.println("Note: Failed to delete source analyzer (may not exist): " + e.getMessage());
            }

            try {
                client.deleteAnalyzer(targetAnalyzerId);
                System.out.println("Target analyzer deleted: " + targetAnalyzerId);
            } catch (Exception e) {
                System.out.println("Note: Failed to delete target analyzer (may not exist): " + e.getMessage());
            }
        }
    }

    /**
     * Asynchronous sample for copying an analyzer.
     */
    @Test
    public void testCopyAnalyzerAsync() {
        String endpoint = System.getenv("CONTENTUNDERSTANDING_ENDPOINT");
        String key = System.getenv("AZURE_CONTENT_UNDERSTANDING_KEY");

        ContentUnderstandingClientBuilder builder = new ContentUnderstandingClientBuilder().endpoint(endpoint);

        // Use DefaultAzureCredential if key is not provided, otherwise use AzureKeyCredential
        if (key == null || key.trim().isEmpty()) {
            asyncClient = builder.credential(new DefaultAzureCredentialBuilder().build()).buildAsyncClient();
        } else {
            asyncClient = builder.credential(new AzureKeyCredential(key)).buildAsyncClient();
        }

        String sourceAnalyzerId = "test_analyzer_source_async_" + UUID.randomUUID().toString().replace("-", "");
        String targetAnalyzerId = "test_analyzer_target_async_" + UUID.randomUUID().toString().replace("-", "");

        try {
            // Create source analyzer
            ContentAnalyzerConfig config = new ContentAnalyzerConfig();
            config.setEnableLayout(true);
            config.setEnableOcr(true);

            Map<String, ContentFieldDefinition> fields = new HashMap<>();
            ContentFieldDefinition field = new ContentFieldDefinition();
            field.setType(ContentFieldType.STRING);
            field.setMethod(GenerationMethod.EXTRACT);
            field.setDescription("Test field");
            fields.put("test_field", field);

            ContentFieldSchema fieldSchema = new ContentFieldSchema();
            fieldSchema.setName("test_schema");
            fieldSchema.setFields(fields);

            ContentAnalyzer analyzer = new ContentAnalyzer();
            analyzer.setBaseAnalyzerId("prebuilt-document");
            analyzer.setDescription("Test analyzer for async copy");
            analyzer.setConfig(config);
            analyzer.setFieldSchema(fieldSchema);

            // Set model configurations (required for custom analyzers)
            Map<String, String> models = new HashMap<>();
            models.put("completion", "gpt-4.1");
            models.put("embedding", "text-embedding-3-large");
            analyzer.setModels(models);

            ContentAnalyzer sourceResult
                = asyncClient.beginCreateAnalyzer(sourceAnalyzerId, analyzer, true).getSyncPoller().getFinalResult();
            System.out.println("Source analyzer created: " + sourceAnalyzerId);

            // Copy analyzer asynchronously
            ContentAnalyzer copiedAnalyzer
                = asyncClient.beginCopyAnalyzer(targetAnalyzerId, sourceAnalyzerId).getSyncPoller().getFinalResult();

            assertNotNull(copiedAnalyzer, "Copied analyzer should not be null");
            assertEquals(sourceResult.getBaseAnalyzerId(), copiedAnalyzer.getBaseAnalyzerId(),
                "Base analyzer ID should match");
            System.out.println("Analyzer copied successfully to: " + targetAnalyzerId);

            System.out.println("âœ… Async CopyAnalyzer test completed");

        } finally {
            // Cleanup
            try {
                asyncClient.deleteAnalyzer(sourceAnalyzerId).block();
                asyncClient.deleteAnalyzer(targetAnalyzerId).block();
            } catch (Exception e) {
                // Ignore cleanup errors
            }
        }
    }
}
