// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
// Code generated by Microsoft (R) TypeSpec Code Generator.

package com.azure.ai.contentunderstanding.generated;

import com.azure.ai.contentunderstanding.ContentUnderstandingClient;
import com.azure.ai.contentunderstanding.ContentUnderstandingClientBuilder;
import com.azure.ai.contentunderstanding.models.ContentAnalyzer;
import com.azure.ai.contentunderstanding.models.ContentAnalyzerConfig;
import com.azure.ai.contentunderstanding.models.ContentAnalyzerOperationStatus;
import com.azure.ai.contentunderstanding.models.ContentFieldDefinition;
import com.azure.ai.contentunderstanding.models.ContentFieldSchema;
import com.azure.ai.contentunderstanding.models.ContentFieldType;
import com.azure.ai.contentunderstanding.models.GenerationMethod;
import com.azure.core.util.Configuration;
import com.azure.core.util.polling.SyncPoller;
import com.azure.identity.DefaultAzureCredentialBuilder;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import java.util.HashMap;
import java.util.Map;

/**
 * Sample demonstrating how to update an existing analyzer.
 * This sample shows:
 * 1. Creating an analyzer
 * 2. Updating analyzer description
 * 3. Updating analyzer configuration
 * 4. Updating field schema
 */
public class Sample08_UpdateAnalyzer {

    private String analyzerId;
    private ContentUnderstandingClient client;

    @BeforeEach
    public void setup() {
        String endpoint = Configuration.getGlobalConfiguration().get("ENDPOINT");
        client = new ContentUnderstandingClientBuilder().credential(new DefaultAzureCredentialBuilder().build())
            .endpoint(endpoint)
            .buildClient();

        // Create an analyzer for testing
        analyzerId = "update_test_analyzer_" + System.currentTimeMillis();

        Map<String, ContentFieldDefinition> fields = new HashMap<>();
        ContentFieldDefinition titleDef = new ContentFieldDefinition();
        titleDef.setType(ContentFieldType.STRING);
        titleDef.setMethod(GenerationMethod.EXTRACT);
        titleDef.setDescription("Document title");
        fields.put("title", titleDef);

        ContentFieldSchema fieldSchema = new ContentFieldSchema();
        fieldSchema.setName("basic_schema");
        fieldSchema.setDescription("Basic document schema");
        fieldSchema.setFields(fields);

        ContentAnalyzerConfig config = new ContentAnalyzerConfig();
        config.setEnableOcr(true);
        config.setEnableLayout(true);

        ContentAnalyzer analyzer = new ContentAnalyzer();
        analyzer.setBaseAnalyzerId("prebuilt-document");
        analyzer.setDescription("Original analyzer for update testing");
        analyzer.setConfig(config);
        analyzer.setFieldSchema(fieldSchema);

        Map<String, String> models = new HashMap<>();
        models.put("completion", "gpt-4.1");
        models.put("embedding", "text-embedding-3-large");
        analyzer.setModels(models);

        client.beginCreateAnalyzer(analyzerId, analyzer, true).getFinalResult();
        System.out.println("Test analyzer created: " + analyzerId);
    }

    @AfterEach
    public void cleanup() {
        if (analyzerId != null && client != null) {
            try {
                client.deleteAnalyzer(analyzerId);
                System.out.println("Test analyzer deleted: " + analyzerId);
            } catch (Exception e) {
                // Ignore cleanup errors
            }
        }
    }

    @Test
    public void testUpdateAnalyzerAsync() {
        // BEGIN:ContentUnderstandingUpdateAnalyzer
        // Get the current analyzer
        ContentAnalyzer currentAnalyzer = client.getAnalyzer(analyzerId);
        System.out.println("Current description: " + currentAnalyzer.getDescription());

        // Update the analyzer with new configuration
        Map<String, ContentFieldDefinition> updatedFields = new HashMap<>();

        // Keep the original field
        ContentFieldDefinition titleDef = new ContentFieldDefinition();
        titleDef.setType(ContentFieldType.STRING);
        titleDef.setMethod(GenerationMethod.EXTRACT);
        titleDef.setDescription("Document title");
        updatedFields.put("title", titleDef);

        // Add a new field
        ContentFieldDefinition authorDef = new ContentFieldDefinition();
        authorDef.setType(ContentFieldType.STRING);
        authorDef.setMethod(GenerationMethod.EXTRACT);
        authorDef.setDescription("Document author");
        updatedFields.put("author", authorDef);

        ContentFieldSchema updatedFieldSchema = new ContentFieldSchema();
        updatedFieldSchema.setName("enhanced_schema");
        updatedFieldSchema.setDescription("Enhanced document schema with author");
        updatedFieldSchema.setFields(updatedFields);

        ContentAnalyzerConfig updatedConfig = new ContentAnalyzerConfig();
        updatedConfig.setEnableOcr(true);
        updatedConfig.setEnableLayout(true);
        updatedConfig.setEnableFormula(true); // Enable formula extraction

        ContentAnalyzer updatedAnalyzer = new ContentAnalyzer();
        updatedAnalyzer.setBaseAnalyzerId("prebuilt-document");
        updatedAnalyzer.setDescription("Updated analyzer with enhanced schema");
        updatedAnalyzer.setConfig(updatedConfig);
        updatedAnalyzer.setFieldSchema(updatedFieldSchema);

        Map<String, String> models = new HashMap<>();
        models.put("completion", "gpt-4.1");
        models.put("embedding", "text-embedding-3-large");
        updatedAnalyzer.setModels(models);

        // Update the analyzer (delete and recreate with same ID)
        // Note: In production, you might want to use updateAnalyzerWithResponse for atomic updates
        client.deleteAnalyzer(analyzerId);
        System.out.println("Existing analyzer deleted for update");

        SyncPoller<ContentAnalyzerOperationStatus, ContentAnalyzer> operation
            = client.beginCreateAnalyzer(analyzerId, updatedAnalyzer, true);

        ContentAnalyzer result = operation.getFinalResult();
        System.out.println("Analyzer updated successfully!");
        System.out.println("New description: " + result.getDescription());
        // END:ContentUnderstandingUpdateAnalyzer

        // BEGIN:Assertion_ContentUnderstandingUpdateAnalyzer
        Assertions.assertNotNull(result, "Updated analyzer should not be null");
        Assertions.assertEquals(analyzerId, result.getAnalyzerId(), "Analyzer ID should match");
        Assertions.assertEquals("Updated analyzer with enhanced schema", result.getDescription(),
            "Description should be updated");
        System.out.println("Analyzer description verified");

        // Verify field schema was updated
        Assertions.assertNotNull(result.getFieldSchema(), "Field schema should not be null");
        Assertions.assertEquals("enhanced_schema", result.getFieldSchema().getName(),
            "Field schema name should be updated");
        Assertions.assertEquals(2, result.getFieldSchema().getFields().size(), "Should have 2 fields after update");
        Assertions.assertTrue(result.getFieldSchema().getFields().containsKey("title"),
            "Should still contain title field");
        Assertions.assertTrue(result.getFieldSchema().getFields().containsKey("author"),
            "Should contain new author field");
        System.out.println("Field schema update verified: " + result.getFieldSchema().getFields().size() + " fields");

        // Verify config was updated
        Assertions.assertNotNull(result.getConfig(), "Config should not be null");
        Assertions.assertTrue(result.getConfig().isEnableFormula(), "EnableFormula should now be true");
        System.out.println("Config update verified");

        System.out.println("All analyzer update properties validated successfully");
        // END:Assertion_ContentUnderstandingUpdateAnalyzer
    }
}
