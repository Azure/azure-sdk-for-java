// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
// Code generated by Microsoft (R) TypeSpec Code Generator.

package com.azure.ai.contentunderstanding.tests.samples;

import com.azure.ai.contentunderstanding.models.AnalyzeInput;
import com.azure.ai.contentunderstanding.models.AnalyzeResult;
import com.azure.ai.contentunderstanding.models.ContentAnalyzer;
import com.azure.ai.contentunderstanding.models.ContentAnalyzerConfig;

import com.azure.ai.contentunderstanding.models.ContentAnalyzerAnalyzeOperationStatus;
import com.azure.ai.contentunderstanding.models.ContentAnalyzerOperationStatus;
import com.azure.ai.contentunderstanding.models.ContentFieldDefinition;
import com.azure.ai.contentunderstanding.models.ContentFieldSchema;
import com.azure.ai.contentunderstanding.models.ContentFieldType;
import com.azure.ai.contentunderstanding.models.DocumentContent;
import com.azure.ai.contentunderstanding.models.ContentField;
import com.azure.ai.contentunderstanding.models.ContentSpan;
import com.azure.ai.contentunderstanding.models.GenerationMethod;
import com.azure.ai.contentunderstanding.models.NumberField;
import com.azure.ai.contentunderstanding.models.StringField;
import com.azure.core.util.polling.PollerFlux;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.Test;

import static org.junit.jupiter.api.Assertions.*;

import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * Async sample demonstrating how to create a custom analyzer with field schema.
 * This sample shows:
 * 1. Defining a field schema with custom fields
 * 2. Demonstrating three extraction methods: Extract, Generate, Classify
 * 3. Creating a custom analyzer with configuration asynchronously
 * 4. Using the custom analyzer to analyze documents
 */
public class Sample04_CreateAnalyzerAsync extends ContentUnderstandingClientTestBase {

    private String createdAnalyzerId;

    @AfterEach
    public void cleanup() {
        if (createdAnalyzerId != null) {
            try {
                contentUnderstandingAsyncClient.deleteAnalyzer(createdAnalyzerId).block();
                System.out.println("Analyzer '" + createdAnalyzerId + "' deleted successfully.");
            } catch (Exception e) {
                // Ignore cleanup errors
            }
        }
    }

    @Test
    public void testCreateAnalyzerAsync() {

        // BEGIN:ContentUnderstandingCreateAnalyzerAsync
        // Generate a unique analyzer ID
        String analyzerId = testResourceNamer.randomName("my_custom_analyzer_", 50);

        // Define field schema with custom fields
        // This example demonstrates three extraction methods:
        // - extract: Literal text extraction (requires estimateSourceAndConfidence)
        // - generate: AI-generated values based on content interpretation
        // - classify: Classification against predefined categories
        Map<String, ContentFieldDefinition> fields = new HashMap<>();

        ContentFieldDefinition companyNameDef = new ContentFieldDefinition();
        companyNameDef.setType(ContentFieldType.STRING);
        companyNameDef.setMethod(GenerationMethod.EXTRACT);
        companyNameDef.setDescription("Name of the company");
        fields.put("company_name", companyNameDef);

        ContentFieldDefinition totalAmountDef = new ContentFieldDefinition();
        totalAmountDef.setType(ContentFieldType.NUMBER);
        totalAmountDef.setMethod(GenerationMethod.EXTRACT);
        totalAmountDef.setDescription("Total amount on the document");
        fields.put("total_amount", totalAmountDef);

        ContentFieldDefinition summaryDef = new ContentFieldDefinition();
        summaryDef.setType(ContentFieldType.STRING);
        summaryDef.setMethod(GenerationMethod.GENERATE);
        summaryDef.setDescription("A brief summary of the document content");
        fields.put("document_summary", summaryDef);

        ContentFieldDefinition documentTypeDef = new ContentFieldDefinition();
        documentTypeDef.setType(ContentFieldType.STRING);
        documentTypeDef.setMethod(GenerationMethod.CLASSIFY);
        documentTypeDef.setDescription("Type of document");
        documentTypeDef.setEnumProperty(Arrays.asList("invoice", "receipt", "contract", "report", "other"));
        fields.put("document_type", documentTypeDef);

        ContentFieldSchema fieldSchema = new ContentFieldSchema();
        fieldSchema.setName("company_schema");
        fieldSchema.setDescription("Schema for extracting company information");
        fieldSchema.setFields(fields);

        // Create the custom analyzer with configuration
        Map<String, String> models = new HashMap<>();
        models.put("completion", "gpt-4.1");
        models.put("embedding", "text-embedding-3-large");

        ContentAnalyzer customAnalyzer = new ContentAnalyzer().setBaseAnalyzerId("prebuilt-document")
            .setDescription("Custom analyzer for extracting company information")
            .setConfig(new ContentAnalyzerConfig().setEnableOcr(true)
                .setEnableLayout(true)
                .setEnableFormula(true)
                .setEstimateFieldSourceAndConfidence(true)
                .setReturnDetails(true))
            .setFieldSchema(fieldSchema)
            .setModels(models);

        // Create the analyzer
        PollerFlux<ContentAnalyzerOperationStatus, ContentAnalyzer> operation
            = contentUnderstandingAsyncClient.beginCreateAnalyzer(analyzerId, customAnalyzer, true);

        ContentAnalyzer result = operation.getSyncPoller().getFinalResult();
        System.out.println("Analyzer '" + analyzerId + "' created successfully!");
        if (result.getDescription() != null && !result.getDescription().trim().isEmpty()) {
            System.out.println("  Description: " + result.getDescription());
        }

        if (result.getFieldSchema() != null && result.getFieldSchema().getFields() != null) {
            System.out.println("  Fields (" + result.getFieldSchema().getFields().size() + "):");
            result.getFieldSchema().getFields().forEach((fieldName, fieldDef) -> {
                String method = fieldDef.getMethod() != null ? fieldDef.getMethod().toString() : "auto";
                String type = fieldDef.getType() != null ? fieldDef.getType().toString() : "unknown";
                System.out.println("    - " + fieldName + ": " + type + " (" + method + ")");
            });
        }
        // END:ContentUnderstandingCreateAnalyzerAsync

        createdAnalyzerId = analyzerId; // Track for cleanup

        // BEGIN:Assertion_ContentUnderstandingCreateAnalyzerAsync
        assertNotNull(analyzerId, "Analyzer ID should not be null");
        assertFalse(analyzerId.trim().isEmpty(), "Analyzer ID should not be empty");
        assertNotNull(fieldSchema, "Field schema should not be null");
        assertNotNull(customAnalyzer, "Custom analyzer should not be null");
        assertNotNull(operation, "Create analyzer operation should not be null");
        assertTrue(operation.getSyncPoller().waitForCompletion().getStatus().isComplete(),
            "Operation should be completed");
        System.out.println("Create analyzer operation properties verified");

        assertNotNull(result, "Analyzer result should not be null");
        System.out.println("Analyzer '" + analyzerId + "' created successfully");

        // Verify base analyzer
        assertNotNull(result.getBaseAnalyzerId(), "Base analyzer ID should not be null");
        assertEquals("prebuilt-document", result.getBaseAnalyzerId(), "Base analyzer ID should match");
        System.out.println("Base analyzer ID verified: " + result.getBaseAnalyzerId());

        // Verify analyzer config
        assertNotNull(result.getConfig(), "Analyzer config should not be null");
        assertTrue(result.getConfig().isEnableFormula(), "EnableFormula should be true");
        assertTrue(result.getConfig().isEnableLayout(), "EnableLayout should be true");
        assertTrue(result.getConfig().isEnableOcr(), "EnableOcr should be true");
        assertTrue(result.getConfig().isEstimateFieldSourceAndConfidence(),
            "EstimateFieldSourceAndConfidence should be true");
        assertTrue(result.getConfig().isReturnDetails(), "ReturnDetails should be true");
        System.out.println("Analyzer config verified");

        // Verify field schema
        assertNotNull(result.getFieldSchema(), "Field schema should not be null");
        assertFalse(result.getFieldSchema().getName().trim().isEmpty(), "Field schema name should not be empty");
        assertEquals("company_schema", result.getFieldSchema().getName(), "Field schema name should match");
        assertFalse(result.getFieldSchema().getDescription().trim().isEmpty(),
            "Field schema description should not be empty");
        System.out.println("Field schema verified: " + result.getFieldSchema().getName());

        // Verify field schema fields
        assertNotNull(result.getFieldSchema().getFields(), "Field schema fields should not be null");
        assertEquals(4, result.getFieldSchema().getFields().size(), "Should have 4 custom fields");
        System.out.println("Field schema contains " + result.getFieldSchema().getFields().size() + " fields");

        // Verify company_name field
        assertTrue(result.getFieldSchema().getFields().containsKey("company_name"),
            "Should contain company_name field");
        ContentFieldDefinition companyNameDefResult = result.getFieldSchema().getFields().get("company_name");
        assertEquals(ContentFieldType.STRING, companyNameDefResult.getType(), "company_name should be String type");
        assertEquals(GenerationMethod.EXTRACT, companyNameDefResult.getMethod(),
            "company_name should use Extract method");
        assertFalse(companyNameDefResult.getDescription().trim().isEmpty(), "company_name should have description");
        System.out.println("  company_name field verified (String, Extract)");

        // Verify total_amount field
        assertTrue(result.getFieldSchema().getFields().containsKey("total_amount"),
            "Should contain total_amount field");
        ContentFieldDefinition totalAmountDefResult = result.getFieldSchema().getFields().get("total_amount");
        assertEquals(ContentFieldType.NUMBER, totalAmountDefResult.getType(), "total_amount should be Number type");
        assertEquals(GenerationMethod.EXTRACT, totalAmountDefResult.getMethod(),
            "total_amount should use Extract method");
        assertFalse(totalAmountDefResult.getDescription().trim().isEmpty(), "total_amount should have description");
        System.out.println("  total_amount field verified (Number, Extract)");

        // Verify document_summary field
        assertTrue(result.getFieldSchema().getFields().containsKey("document_summary"),
            "Should contain document_summary field");
        ContentFieldDefinition summaryDefResult = result.getFieldSchema().getFields().get("document_summary");
        assertEquals(ContentFieldType.STRING, summaryDefResult.getType(), "document_summary should be String type");
        assertEquals(GenerationMethod.GENERATE, summaryDefResult.getMethod(),
            "document_summary should use Generate method");
        assertFalse(summaryDefResult.getDescription().trim().isEmpty(), "document_summary should have description");
        System.out.println("  document_summary field verified (String, Generate)");

        // Verify document_type field
        assertTrue(result.getFieldSchema().getFields().containsKey("document_type"),
            "Should contain document_type field");
        ContentFieldDefinition documentTypeDefResult = result.getFieldSchema().getFields().get("document_type");
        assertEquals(ContentFieldType.STRING, documentTypeDefResult.getType(), "document_type should be String type");
        assertEquals(GenerationMethod.CLASSIFY, documentTypeDefResult.getMethod(),
            "document_type should use Classify method");
        assertFalse(documentTypeDefResult.getDescription().trim().isEmpty(), "document_type should have description");
        assertNotNull(documentTypeDefResult.getEnumProperty(), "document_type should have enum values");
        assertEquals(5, documentTypeDefResult.getEnumProperty().size(), "document_type should have 5 enum values");
        assertTrue(documentTypeDefResult.getEnumProperty().contains("invoice"),
            "document_type enum should contain 'invoice'");
        assertTrue(documentTypeDefResult.getEnumProperty().contains("receipt"),
            "document_type enum should contain 'receipt'");
        assertTrue(documentTypeDefResult.getEnumProperty().contains("contract"),
            "document_type enum should contain 'contract'");
        assertTrue(documentTypeDefResult.getEnumProperty().contains("report"),
            "document_type enum should contain 'report'");
        assertTrue(documentTypeDefResult.getEnumProperty().contains("other"),
            "document_type enum should contain 'other'");
        System.out.println("  document_type field verified (String, Classify, 5 enum values)");

        // Verify models
        assertNotNull(result.getModels(), "Models should not be null");
        assertTrue(result.getModels().size() >= 2, "Should have at least 2 model mappings");
        assertTrue(result.getModels().containsKey("completion"), "Should contain 'completion' model mapping");
        assertTrue(result.getModels().containsKey("embedding"), "Should contain 'embedding' model mapping");
        assertEquals("gpt-4.1", result.getModels().get("completion"), "Completion model should be 'gpt-4.1'");
        assertEquals("text-embedding-3-large", result.getModels().get("embedding"),
            "Embedding model should be 'text-embedding-3-large'");
        System.out.println("Model mappings verified: " + result.getModels().size() + " model(s)");

        // Verify description
        if (result.getDescription() != null && !result.getDescription().trim().isEmpty()) {
            System.out.println("Analyzer description: " + result.getDescription());
        }

        System.out.println("All analyzer creation properties validated successfully");
        // END:Assertion_ContentUnderstandingCreateAnalyzerAsync
    }

    @Test
    public void testUseCustomAnalyzerAsync() {
        // First create an analyzer
        String analyzerId = testResourceNamer.randomName("test_analyzer_", 50);

        Map<String, ContentFieldDefinition> fields = new HashMap<>();

        ContentFieldDefinition companyNameDef = new ContentFieldDefinition();
        companyNameDef.setType(ContentFieldType.STRING);
        companyNameDef.setMethod(GenerationMethod.EXTRACT);
        companyNameDef.setDescription("Name of the company");
        fields.put("company_name", companyNameDef);

        ContentFieldDefinition totalAmountDef = new ContentFieldDefinition();
        totalAmountDef.setType(ContentFieldType.NUMBER);
        totalAmountDef.setMethod(GenerationMethod.EXTRACT);
        totalAmountDef.setDescription("Total amount on the document");
        fields.put("total_amount", totalAmountDef);

        ContentFieldDefinition summaryDef = new ContentFieldDefinition();
        summaryDef.setType(ContentFieldType.STRING);
        summaryDef.setMethod(GenerationMethod.GENERATE);
        summaryDef.setDescription("A brief summary of the document content");
        fields.put("document_summary", summaryDef);

        ContentFieldDefinition documentTypeDef = new ContentFieldDefinition();
        documentTypeDef.setType(ContentFieldType.STRING);
        documentTypeDef.setMethod(GenerationMethod.CLASSIFY);
        documentTypeDef.setDescription("Type of document");
        documentTypeDef.setEnumProperty(Arrays.asList("invoice", "receipt", "contract", "report", "other"));
        fields.put("document_type", documentTypeDef);

        ContentFieldSchema fieldSchema = new ContentFieldSchema();
        fieldSchema.setName("company_schema");
        fieldSchema.setDescription("Schema for extracting company information");
        fieldSchema.setFields(fields);

        ContentAnalyzerConfig config = new ContentAnalyzerConfig();
        config.setEnableFormula(true);
        config.setEnableLayout(true);
        config.setEnableOcr(true);

        ContentAnalyzer customAnalyzer = new ContentAnalyzer();
        customAnalyzer.setBaseAnalyzerId("prebuilt-document");
        customAnalyzer.setDescription("Custom analyzer for extracting company information");
        customAnalyzer.setConfig(config);
        customAnalyzer.setFieldSchema(fieldSchema);

        Map<String, String> models = new HashMap<>();
        models.put("completion", "gpt-4.1");
        models.put("embedding", "text-embedding-3-large");
        customAnalyzer.setModels(models);

        contentUnderstandingAsyncClient.beginCreateAnalyzer(analyzerId, customAnalyzer)
            .getSyncPoller()
            .getFinalResult();
        createdAnalyzerId = analyzerId; // Track for cleanup

        try {
            // BEGIN:ContentUnderstandingUseCustomAnalyzerAsync
            // Using a publicly accessible sample file from Azure-Samples GitHub repository
            String documentUrl
                = "https://raw.githubusercontent.com/Azure-Samples/azure-ai-content-understanding-dotnet/main/ContentUnderstanding.Common/data/invoice.pdf";

            AnalyzeInput input = new AnalyzeInput();
            input.setUrl(documentUrl);

            // Analyze a document using the custom analyzer
            PollerFlux<ContentAnalyzerAnalyzeOperationStatus, AnalyzeResult> analyzeOperation
                = contentUnderstandingAsyncClient.beginAnalyze(analyzerId, Arrays.asList(input));

            AnalyzeResult analyzeResult = analyzeOperation.getSyncPoller().getFinalResult();

            // Extract custom fields from the result
            // Since EstimateFieldSourceAndConfidence is enabled, we can access confidence scores and source information
            if (analyzeResult.getContents() != null
                && !analyzeResult.getContents().isEmpty()
                && analyzeResult.getContents().get(0) instanceof DocumentContent) {
                DocumentContent content = (DocumentContent) analyzeResult.getContents().get(0);

                // Extract field (literal text extraction)
                ContentField companyNameField
                    = content.getFields() != null ? content.getFields().get("company_name") : null;
                if (companyNameField instanceof StringField) {
                    StringField sf = (StringField) companyNameField;
                    String companyName = sf.getValueString();
                    System.out
                        .println("Company Name (extract): " + (companyName != null ? companyName : "(not found)"));
                    System.out.println("  Confidence: " + (companyNameField.getConfidence() != null
                        ? String.format("%.2f", companyNameField.getConfidence())
                        : "N/A"));
                    System.out.println(
                        "  Source: " + (companyNameField.getSource() != null ? companyNameField.getSource() : "N/A"));
                    List<ContentSpan> spans = companyNameField.getSpans();
                    if (spans != null && !spans.isEmpty()) {
                        ContentSpan span = spans.get(0);
                        System.out.println(
                            "  Position in markdown: offset=" + span.getOffset() + ", length=" + span.getLength());
                    }
                }

                // Extract field (literal text extraction)
                ContentField totalAmountField
                    = content.getFields() != null ? content.getFields().get("total_amount") : null;
                if (totalAmountField instanceof NumberField) {
                    NumberField nf = (NumberField) totalAmountField;
                    Double totalAmount = nf.getValueNumber();
                    System.out.println("Total Amount (extract): "
                        + (totalAmount != null ? String.format("%.2f", totalAmount) : "(not found)"));
                    System.out.println("  Confidence: " + (totalAmountField.getConfidence() != null
                        ? String.format("%.2f", totalAmountField.getConfidence())
                        : "N/A"));
                    System.out.println(
                        "  Source: " + (totalAmountField.getSource() != null ? totalAmountField.getSource() : "N/A"));
                    List<ContentSpan> spans = totalAmountField.getSpans();
                    if (spans != null && !spans.isEmpty()) {
                        ContentSpan span = spans.get(0);
                        System.out.println(
                            "  Position in markdown: offset=" + span.getOffset() + ", length=" + span.getLength());
                    }
                }

                // Generate field (AI-generated value)
                ContentField summaryField
                    = content.getFields() != null ? content.getFields().get("document_summary") : null;
                if (summaryField instanceof StringField) {
                    StringField sf = (StringField) summaryField;
                    String summary = sf.getValueString();
                    System.out.println("Document Summary (generate): " + (summary != null ? summary : "(not found)"));
                    System.out.println("  Confidence: " + (summaryField.getConfidence() != null
                        ? String.format("%.2f", summaryField.getConfidence())
                        : "N/A"));
                    // Note: Generated fields may not have source information
                    if (summaryField.getSource() != null && !summaryField.getSource().isEmpty()) {
                        System.out.println("  Source: " + summaryField.getSource());
                    }
                }

                // Classify field (classification against predefined categories)
                ContentField documentTypeField
                    = content.getFields() != null ? content.getFields().get("document_type") : null;
                if (documentTypeField instanceof StringField) {
                    StringField sf = (StringField) documentTypeField;
                    String documentType = sf.getValueString();
                    System.out
                        .println("Document Type (classify): " + (documentType != null ? documentType : "(not found)"));
                    System.out.println("  Confidence: " + (documentTypeField.getConfidence() != null
                        ? String.format("%.2f", documentTypeField.getConfidence())
                        : "N/A"));
                    // Note: Classified fields may not have source information
                    if (documentTypeField.getSource() != null && !documentTypeField.getSource().isEmpty()) {
                        System.out.println("  Source: " + documentTypeField.getSource());
                    }
                }
            }
            // END:ContentUnderstandingUseCustomAnalyzerAsync

            // BEGIN:Assertion_ContentUnderstandingUseCustomAnalyzerAsync
            assertNotNull(documentUrl, "Document URL should not be null");
            assertNotNull(analyzeOperation, "Analyze operation should not be null");
            assertTrue(analyzeOperation.getSyncPoller().waitForCompletion().getStatus().isComplete(),
                "Operation should be completed");
            System.out.println("Analyze operation properties verified");

            assertNotNull(analyzeResult, "Analyze result should not be null");
            assertNotNull(analyzeResult.getContents(), "Result should contain contents");
            assertTrue(analyzeResult.getContents().size() > 0, "Result should have at least one content");
            assertEquals(1, analyzeResult.getContents().size(), "Result should have exactly one content element");
            System.out.println("Analysis result contains " + analyzeResult.getContents().size() + " content(s)");

            DocumentContent documentContent = analyzeResult.getContents().get(0) instanceof DocumentContent
                ? (DocumentContent) analyzeResult.getContents().get(0)
                : null;
            assertNotNull(documentContent, "Content should be DocumentContent");
            assertNotNull(documentContent.getFields(), "Document content should have fields");
            System.out.println("Document content has custom fields");

            // Verify company_name field (Extract method)
            ContentField companyNameFieldAssert
                = documentContent.getFields() != null ? documentContent.getFields().get("company_name") : null;
            if (companyNameFieldAssert != null) {
                System.out.println("company_name field found");
                assertTrue(companyNameFieldAssert instanceof StringField, "company_name should be a StringField");

                if (companyNameFieldAssert instanceof StringField) {
                    StringField cnf = (StringField) companyNameFieldAssert;
                    if (cnf.getValueString() != null && !cnf.getValueString().trim().isEmpty()) {
                        System.out.println("  Value: " + cnf.getValueString());
                    }
                }

                if (companyNameFieldAssert.getConfidence() != null) {
                    assertTrue(
                        companyNameFieldAssert.getConfidence() >= 0 && companyNameFieldAssert.getConfidence() <= 1,
                        "company_name confidence should be between 0 and 1, but was "
                            + companyNameFieldAssert.getConfidence());
                    System.out
                        .println("  Confidence: " + String.format("%.2f", companyNameFieldAssert.getConfidence()));
                }

                if (companyNameFieldAssert.getSource() != null
                    && !companyNameFieldAssert.getSource().trim().isEmpty()) {
                    assertTrue(companyNameFieldAssert.getSource().startsWith("D("),
                        "Source should start with 'D(' for extracted fields");
                    System.out.println("  Source: " + companyNameFieldAssert.getSource());
                }

                List<ContentSpan> spans = companyNameFieldAssert.getSpans();
                if (spans != null && !spans.isEmpty()) {
                    assertTrue(spans.size() > 0, "Spans should not be empty when not null");
                    for (ContentSpan span : spans) {
                        assertTrue(span.getOffset() >= 0, "Span offset should be >= 0, but was " + span.getOffset());
                        assertTrue(span.getLength() > 0, "Span length should be > 0, but was " + span.getLength());
                    }
                    System.out.println("  Spans: " + spans.size() + " span(s)");
                }
            } else {
                System.out.println("⚠️ company_name field not found");
            }

            System.out.println("All custom analyzer usage properties validated successfully");
            // END:Assertion_ContentUnderstandingUseCustomAnalyzerAsync
        } finally {
            // Cleanup is handled by @AfterEach
        }
    }
}
