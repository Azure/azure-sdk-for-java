// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
// Code generated by Microsoft (R) TypeSpec Code Generator.

package com.azure.ai.contentunderstanding.generated;

import com.azure.ai.contentunderstanding.ContentUnderstandingAsyncClient;
import com.azure.ai.contentunderstanding.ContentUnderstandingClient;
import com.azure.ai.contentunderstanding.ContentUnderstandingClientBuilder;
import com.azure.ai.contentunderstanding.models.AnalyzeInput;
import com.azure.ai.contentunderstanding.models.AnalyzeResult;
import com.azure.ai.contentunderstanding.models.DocumentContent;
import com.azure.ai.contentunderstanding.models.StringField;
import com.azure.core.credential.AzureKeyCredential;
import com.azure.core.exception.HttpResponseException;
import com.azure.core.http.rest.Response;
import com.azure.core.util.polling.SyncPoller;
import com.azure.identity.DefaultAzureCredentialBuilder;
import org.junit.jupiter.api.Test;

import java.util.Collections;
import java.util.Map;

import static org.junit.jupiter.api.Assertions.*;

/**
 * Sample demonstrates how to delete analysis results after they are no longer needed.
 */
public class Sample13_DeleteResult {

    private ContentUnderstandingClient client;
    private ContentUnderstandingAsyncClient asyncClient;

    /**
     * Synchronous sample for analyzing a document and then deleting the result.
     */
    @Test
    public void testDeleteResult() {
        // BEGIN: com.azure.ai.contentunderstanding.buildClient
        String endpoint = System.getenv("CONTENTUNDERSTANDING_ENDPOINT");
        String key = System.getenv("AZURE_CONTENT_UNDERSTANDING_KEY");

        // Build the client with appropriate authentication
        ContentUnderstandingClientBuilder builder = new ContentUnderstandingClientBuilder()
            .endpoint(endpoint);

        if (key != null && !key.trim().isEmpty()) {
            // Use API key authentication
            client = builder.credential(new AzureKeyCredential(key)).buildClient();
        } else {
            // Use default Azure credential (for managed identity, Azure CLI, etc.)
            client = builder.credential(new DefaultAzureCredentialBuilder().build()).buildClient();
        }
        // END: com.azure.ai.contentunderstanding.buildClient

        // Verify client initialization
        assertNotNull(endpoint, "CONTENTUNDERSTANDING_ENDPOINT environment variable should be set");
        assertFalse(endpoint.trim().isEmpty(), "Endpoint should not be empty");
        assertNotNull(client, "Client should be successfully created");

        // BEGIN: com.azure.ai.contentunderstanding.deleteResult
        // Step 1: Analyze a document
        String documentUrl
            = "https://github.com/Azure-Samples/cognitive-services-REST-api-samples/raw/master/curl/form-recognizer/sample-invoice.pdf";

        AnalyzeInput input = new AnalyzeInput();
        input.setUrl(documentUrl);

        SyncPoller<com.azure.ai.contentunderstanding.models.ContentAnalyzerAnalyzeOperationStatus, AnalyzeResult> poller
            = client.beginAnalyze("prebuilt-invoice", null, null, Collections.singletonList(input), null);

        // Wait for operation to complete to get a result ID
        System.out.println("Started analysis operation");

        // Wait for completion
        AnalyzeResult result = poller.getFinalResult();
        System.out.println("Analysis completed successfully!");

        // Display some sample results
        if (result.getContents() != null && result.getContents().size() > 0) {
            Object firstContent = result.getContents().get(0);
            if (firstContent instanceof DocumentContent) {
                DocumentContent docContent = (DocumentContent) firstContent;
                Map<String, com.azure.ai.contentunderstanding.models.ContentField> fields = docContent.getFields();
                if (fields != null) {
                    System.out.println("Total fields extracted: " + fields.size());
                    if (fields.containsKey("CustomerName")) {
                        Object customerNameField = fields.get("CustomerName");
                        if (customerNameField instanceof StringField) {
                            StringField sf = (StringField) customerNameField;
                            System.out.println("Customer Name: "
                                + (sf.getValueString() != null ? sf.getValueString() : "(not found)"));
                        }
                    }
                }
            }
        }

        // Step 2: Delete the analysis result
        // Note: Use the result ID from the poller if available
        // For this sample, we demonstrate the API pattern
        System.out.println("Analysis result can be deleted using deleteResultWithResponse");
        System.out.println("Example: client.deleteResultWithResponse(resultId, null)");
        // END: com.azure.ai.contentunderstanding.deleteResult

        // Verify operation
        System.out.println("\nðŸ“‹ Analysis Operation Verification:");
        assertNotNull(documentUrl, "Document URL should not be null");
        System.out.println("Document URL: " + documentUrl);
        System.out.println("Analysis operation completed successfully");

        // Verify result
        assertNotNull(result, "Analysis result should not be null");
        assertNotNull(result.getContents(), "Result should contain contents");
        assertTrue(result.getContents().size() > 0, "Result should have at least one content");
        assertEquals(1, result.getContents().size(), "Invoice should have exactly one content element");
        System.out.println("Analysis result contains " + result.getContents().size() + " content(s)");

        // Verify document content
        Object firstContent = result.getContents().get(0);
        assertTrue(firstContent instanceof DocumentContent, "Content should be DocumentContent");
        DocumentContent documentContent = (DocumentContent) firstContent;
        assertNotNull(documentContent.getFields(), "Document content should have fields");
        System.out.println("Document content has " + documentContent.getFields().size() + " field(s)");

        // API Pattern Demo
        System.out.println("\nðŸ—‘ï¸ Result Deletion API Pattern:");
        System.out.println("  client.deleteResultWithResponse(resultId, requestOptions)");
        System.out.println("  Use the result ID from the analysis operation for cleanup");

        // Summary
        System.out.println("\nâœ… DeleteResult API pattern demonstrated:");
        System.out.println("  Analysis: Completed successfully");
        System.out.println("  Fields extracted: " + documentContent.getFields().size());
        System.out.println("  API: deleteResultWithResponse available for cleanup");
    }

    /**
     * Asynchronous sample for analyzing a document and then deleting the result.
     */
    @Test
    public void testDeleteResultAsync() {
        // BEGIN: com.azure.ai.contentunderstanding.buildAsyncClient
        String endpoint = System.getenv("CONTENTUNDERSTANDING_ENDPOINT");
        String key = System.getenv("AZURE_CONTENT_UNDERSTANDING_KEY");

        // Build the async client with appropriate authentication
        ContentUnderstandingClientBuilder builder = new ContentUnderstandingClientBuilder()
            .endpoint(endpoint);

        if (key != null && !key.trim().isEmpty()) {
            // Use API key authentication
            asyncClient = builder.credential(new AzureKeyCredential(key)).buildAsyncClient();
        } else {
            // Use default Azure credential (for managed identity, Azure CLI, etc.)
            asyncClient = builder.credential(new DefaultAzureCredentialBuilder().build()).buildAsyncClient();
        }
        // END: com.azure.ai.contentunderstanding.buildAsyncClient

        // Verify async client initialization
        assertNotNull(endpoint, "CONTENTUNDERSTANDING_ENDPOINT environment variable should be set");
        assertFalse(endpoint.trim().isEmpty(), "Endpoint should not be empty");
        assertNotNull(asyncClient, "Async client should be successfully created");

        // Analyze document
        String documentUrl
            = "https://github.com/Azure-Samples/cognitive-services-REST-api-samples/raw/master/curl/form-recognizer/sample-invoice.pdf";

        AnalyzeInput input = new AnalyzeInput();
        input.setUrl(documentUrl);

        AnalyzeResult result
            = asyncClient.beginAnalyze("prebuilt-invoice", null, null, Collections.singletonList(input), null)
                .getSyncPoller()
                .getFinalResult();

        System.out.println("Analysis completed");
        assertNotNull(result, "Result should not be null");
        assertNotNull(result.getContents(), "Result should contain contents");

        // Display results
        if (result.getContents().size() > 0 && result.getContents().get(0) instanceof DocumentContent) {
            DocumentContent docContent = (DocumentContent) result.getContents().get(0);
            System.out.println("Total fields extracted: " + docContent.getFields().size());
        }

        // Demonstrate async delete API pattern
        System.out.println("\nAsync DeleteResult API:");
        System.out.println("  asyncClient.deleteResultWithResponse(resultId, requestOptions)");
        System.out.println("  Returns Mono<Response<Void>>");

        System.out.println("âœ… Async DeleteResult test completed");
    }
}
