// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
// Code generated by Microsoft (R) TypeSpec Code Generator.

package com.azure.ai.contentunderstanding.generated;

import com.azure.ai.contentunderstanding.ContentUnderstandingAsyncClient;
import com.azure.ai.contentunderstanding.ContentUnderstandingClient;
import com.azure.ai.contentunderstanding.ContentUnderstandingClientBuilder;
import com.azure.ai.contentunderstanding.models.AnalyzeInput;
import com.azure.ai.contentunderstanding.models.AnalyzeResult;
import com.azure.ai.contentunderstanding.models.DocumentContent;
import com.azure.ai.contentunderstanding.models.StringField;
import com.azure.core.credential.AzureKeyCredential;
import com.azure.core.exception.HttpResponseException;
import com.azure.core.http.rest.Response;
import com.azure.core.util.polling.SyncPoller;
import org.junit.jupiter.api.Test;

import java.util.Collections;
import java.util.Map;

import static org.junit.jupiter.api.Assertions.*;

/**
 * Sample demonstrates how to delete analysis results after they are no longer needed.
 */
public class Sample13_DeleteResult {

    private ContentUnderstandingClient client;
    private ContentUnderstandingAsyncClient asyncClient;

    /**
     * Synchronous sample for analyzing a document and then deleting the result.
     */
    @Test
    public void testDeleteResult() {
        String endpoint = System.getenv("CONTENTUNDERSTANDING_ENDPOINT");
        String key = System.getenv("CONTENTUNDERSTANDING_API_KEY");

        client = new ContentUnderstandingClientBuilder()
            .endpoint(endpoint)
            .credential(new AzureKeyCredential(key))
            .buildClient();

        // BEGIN: com.azure.ai.contentunderstanding.deleteResult
        // Step 1: Analyze a document
        String documentUrl = "https://github.com/Azure-Samples/cognitive-services-REST-api-samples/raw/master/curl/form-recognizer/sample-invoice.pdf";

        AnalyzeInput input = new AnalyzeInput();
        input.setUrl(documentUrl);

        SyncPoller<AnalyzeResult, AnalyzeResult> poller = client.beginAnalyze(
            "prebuilt-invoice",
            Collections.singletonList(input)
        );

        // Get the operation ID (available immediately after starting)
        String operationId = poller.poll().getValue().getOperationId();
        System.out.println("Operation ID: " + operationId);

        // Wait for completion
        AnalyzeResult result = poller.getFinalResult();
        System.out.println("Analysis completed successfully!");

        // Display some sample results
        if (result.getContents() != null && result.getContents().size() > 0) {
            Object firstContent = result.getContents().get(0);
            if (firstContent instanceof DocumentContent) {
                DocumentContent docContent = (DocumentContent) firstContent;
                Map<String, Object> fields = docContent.getFields();
                if (fields != null) {
                    System.out.println("Total fields extracted: " + fields.size());
                    if (fields.containsKey("CustomerName")) {
                        Object customerNameField = fields.get("CustomerName");
                        if (customerNameField instanceof StringField) {
                            StringField sf = (StringField) customerNameField;
                            System.out.println("Customer Name: " + (sf.getValueString() != null ? sf.getValueString() : "(not found)"));
                        }
                    }
                }
            }
        }

        // Step 2: Delete the analysis result
        System.out.println("Deleting analysis result (Operation ID: " + operationId + ")...");
        client.deleteResult(operationId);
        System.out.println("Analysis result deleted successfully!");
        // END: com.azure.ai.contentunderstanding.deleteResult

        // Verify operation
        System.out.println("\nüìã Analysis Operation Verification:");
        assertNotNull(documentUrl, "Document URL should not be null");
        System.out.println("Document URL: " + documentUrl);

        assertNotNull(operationId, "Operation ID should not be null");
        assertFalse(operationId.trim().isEmpty(), "Operation ID should not be empty");
        assertTrue(operationId.length() > 0, "Operation ID should have length > 0");
        assertFalse(operationId.contains(" "), "Operation ID should not contain spaces");
        System.out.println("Operation ID obtained: " + operationId);
        System.out.println("  Length: " + operationId.length() + " characters");

        // Verify result
        assertNotNull(result, "Analysis result should not be null");
        assertNotNull(result.getContents(), "Result should contain contents");
        assertTrue(result.getContents().size() > 0, "Result should have at least one content");
        assertEquals(1, result.getContents().size(), "Invoice should have exactly one content element");
        System.out.println("Analysis result contains " + result.getContents().size() + " content(s)");

        // Verify document content
        Object firstContent = result.getContents().get(0);
        assertTrue(firstContent instanceof DocumentContent, "Content should be DocumentContent");
        DocumentContent documentContent = (DocumentContent) firstContent;
        assertNotNull(documentContent.getFields(), "Document content should have fields");
        System.out.println("Document content has " + documentContent.getFields().size() + " field(s)");

        // Verify deletion
        System.out.println("\nüóëÔ∏è Result Deletion Verification:");
        System.out.println("DeleteResult succeeded for operation ID: " + operationId);

        // Try to delete again to verify behavior
        System.out.println("\nVerifying result is deleted...");
        try {
            client.deleteResult(operationId);
            System.out.println("Second delete succeeded (service allows idempotent deletion)");
            System.out.println("   Result is either deleted or deletion is idempotent");
        } catch (HttpResponseException ex) {
            System.out.println("Second delete failed as expected");
            System.out.println("  Status code: " + ex.getResponse().getStatusCode());
            System.out.println("  Message: " + ex.getMessage());

            // Verify status code is 404 (Not Found) or 400 (Bad Request) or 409 (Conflict)
            int statusCode = ex.getResponse().getStatusCode();
            assertTrue(statusCode == 404 || statusCode == 400 || statusCode == 409,
                "Expected 404, 400, or 409 for already deleted result, but got " + statusCode);

            if (statusCode == 404) {
                System.out.println("Status 404 (Not Found) confirms result was deleted");
            } else if (statusCode == 400) {
                System.out.println("Status 400 (Bad Request) confirms result does not exist");
            } else if (statusCode == 409) {
                System.out.println("Status 409 (Conflict) indicates result is already deleted");
            }
        }

        // Try to access deleted result
        System.out.println("\nüîé Testing access to deleted result...");
        try {
            Response<com.azure.core.util.BinaryData> fileResponse = client.getResultFileWithResponse(operationId, "test_file", null);
            System.out.println("‚ö†Ô∏è GetResultFileWithResponse succeeded with status " + fileResponse.getStatusCode());
            System.out.println("   This may indicate the service still has some data, or handles deletion differently");
        } catch (HttpResponseException ex) {
            System.out.println("GetResultFileWithResponse failed as expected");
            System.out.println("  Status code: " + ex.getResponse().getStatusCode());

            int statusCode = ex.getResponse().getStatusCode();
            assertTrue(statusCode == 404 || statusCode == 400,
                "Expected 404 or 400 for accessing deleted result files, but got " + statusCode);

            if (statusCode == 404) {
                System.out.println("Status 404 confirms result files are not accessible");
            } else if (statusCode == 400) {
                System.out.println("Status 400 confirms operation does not exist");
            }
        }

        // Summary
        System.out.println("\n‚úÖ DeleteResult verification completed successfully:");
        System.out.println("  Operation ID: " + operationId);
        System.out.println("  Analysis: Completed successfully");
        System.out.println("  Fields extracted: " + documentContent.getFields().size());
        System.out.println("  Deletion: Successful");
        System.out.println("  Verification: Result is deleted or no longer accessible");
    }

    /**
     * Asynchronous sample for analyzing a document and then deleting the result.
     */
    @Test
    public void testDeleteResultAsync() {
        String endpoint = System.getenv("CONTENTUNDERSTANDING_ENDPOINT");
        String key = System.getenv("CONTENTUNDERSTANDING_API_KEY");

        asyncClient = new ContentUnderstandingClientBuilder()
            .endpoint(endpoint)
            .credential(new AzureKeyCredential(key))
            .buildAsyncClient();

        // Analyze document
        String documentUrl = "https://github.com/Azure-Samples/cognitive-services-REST-api-samples/raw/master/curl/form-recognizer/sample-invoice.pdf";

        AnalyzeInput input = new AnalyzeInput();
        input.setUrl(documentUrl);

        AnalyzeResult result = asyncClient.beginAnalyze("prebuilt-invoice", Collections.singletonList(input))
            .getSyncPoller()
            .getFinalResult();

        String operationId = result.getOperationId();
        System.out.println("Operation ID: " + operationId);

        assertNotNull(operationId, "Operation ID should not be null");
        assertNotNull(result.getContents(), "Result should contain contents");

        // Display results
        if (result.getContents().size() > 0 && result.getContents().get(0) instanceof DocumentContent) {
            DocumentContent docContent = (DocumentContent) result.getContents().get(0);
            System.out.println("Total fields extracted: " + docContent.getFields().size());
        }

        // Delete result asynchronously
        System.out.println("Deleting analysis result (Operation ID: " + operationId + ")...");
        asyncClient.deleteResultWithResponse(operationId, null)
            .doOnSuccess(response -> {
                System.out.println("Analysis result deleted successfully!");
                System.out.println("Response status: " + response.getStatusCode());
            })
            .block();

        // Verify deletion
        try {
            asyncClient.deleteResult(operationId).block();
            System.out.println("Second delete succeeded (idempotent deletion)");
        } catch (HttpResponseException ex) {
            System.out.println("Second delete failed as expected (status: " + ex.getResponse().getStatusCode() + ")");
            assertTrue(ex.getResponse().getStatusCode() == 404 || ex.getResponse().getStatusCode() == 400 || ex.getResponse().getStatusCode() == 409,
                "Expected 404, 400, or 409 for already deleted result");
        }

        System.out.println("‚úÖ Async DeleteResult test completed");
    }
}
