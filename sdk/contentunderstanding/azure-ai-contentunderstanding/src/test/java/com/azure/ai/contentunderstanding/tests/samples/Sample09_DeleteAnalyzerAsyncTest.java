// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
// Code generated by Microsoft (R) TypeSpec Code Generator.

package com.azure.ai.contentunderstanding.tests.samples;

import com.azure.ai.contentunderstanding.models.ContentAnalyzer;
import com.azure.ai.contentunderstanding.models.ContentAnalyzerConfig;
import com.azure.ai.contentunderstanding.models.ContentFieldDefinition;
import com.azure.ai.contentunderstanding.models.ContentFieldSchema;
import com.azure.ai.contentunderstanding.models.ContentFieldType;
import com.azure.ai.contentunderstanding.models.GenerationMethod;
import com.azure.core.exception.ResourceNotFoundException;
import org.junit.jupiter.api.Test;
import reactor.core.publisher.Mono;

import static org.junit.jupiter.api.Assertions.*;

import java.util.HashMap;
import java.util.Map;

/**
 * Async sample demonstrating how to delete an analyzer.
 * This sample shows:
 * 1. Creating a temporary analyzer
 * 2. Verifying the analyzer exists
 * 3. Deleting the analyzer
 * 4. Verifying the analyzer no longer exists
 */
public class Sample09_DeleteAnalyzerAsyncTest extends ContentUnderstandingClientTestBase {

    @Test
    public void testDeleteAnalyzerAsync() {

        // BEGIN:ContentUnderstandingDeleteAnalyzerAsync
        // First, create a temporary analyzer to delete
        String analyzerId = testResourceNamer.randomName("analyzer_to_delete_", 50);

        Map<String, ContentFieldDefinition> fields = new HashMap<>();
        ContentFieldDefinition titleDef = new ContentFieldDefinition();
        titleDef.setType(ContentFieldType.STRING);
        titleDef.setMethod(GenerationMethod.EXTRACT);
        titleDef.setDescription("Document title");
        fields.put("title", titleDef);

        ContentFieldSchema fieldSchema = new ContentFieldSchema();
        fieldSchema.setName("temp_schema");
        fieldSchema.setDescription("Temporary schema for deletion demo");
        fieldSchema.setFields(fields);

        Map<String, String> models = new HashMap<>();
        models.put("completion", "gpt-4.1");
        models.put("embedding", "text-embedding-3-large");

        ContentAnalyzer analyzer = new ContentAnalyzer().setBaseAnalyzerId("prebuilt-document")
            .setDescription("Temporary analyzer for deletion demo")
            .setConfig(new ContentAnalyzerConfig().setEnableOcr(true).setEnableLayout(true))
            .setFieldSchema(fieldSchema)
            .setModels(models);

        contentUnderstandingAsyncClient.beginCreateAnalyzer(analyzerId, analyzer).last().flatMap(pollResponse -> {
            if (pollResponse.getStatus().isComplete()) {
                return pollResponse.getFinalResult();
            } else {
                return Mono.error(
                    new RuntimeException("Polling completed unsuccessfully with status: " + pollResponse.getStatus()));
            }
        }).block();
        System.out.println("Temporary analyzer created: " + analyzerId);

        // Verify the analyzer exists
        ContentAnalyzer retrievedAnalyzer = contentUnderstandingAsyncClient.getAnalyzer(analyzerId).block();
        System.out.println("Verified analyzer exists with ID: " + retrievedAnalyzer.getAnalyzerId());

        // Delete the analyzer
        contentUnderstandingAsyncClient.deleteAnalyzer(analyzerId).block();
        System.out.println("Analyzer deleted successfully: " + analyzerId);

        // Verify the analyzer no longer exists
        boolean analyzerDeleted = false;
        try {
            contentUnderstandingAsyncClient.getAnalyzer(analyzerId).block();
        } catch (ResourceNotFoundException e) {
            analyzerDeleted = true;
            System.out.println("Confirmed: Analyzer no longer exists");
        }
        // END:ContentUnderstandingDeleteAnalyzerAsync

        // BEGIN:Assertion_ContentUnderstandingDeleteAnalyzerAsync
        assertNotNull(analyzerId, "Analyzer ID should not be null");
        assertFalse(analyzerId.trim().isEmpty(), "Analyzer ID should not be empty");
        System.out.println("Analyzer ID verified: " + analyzerId);

        assertNotNull(retrievedAnalyzer, "Retrieved analyzer should not be null before deletion");
        assertEquals(analyzerId, retrievedAnalyzer.getAnalyzerId(), "Retrieved analyzer ID should match");
        System.out.println("Analyzer existence verified before deletion");

        assertTrue(analyzerDeleted, "Analyzer should be deleted and not retrievable");
        System.out.println("Analyzer deletion verified");

        System.out.println("All analyzer deletion properties validated successfully");
        // END:Assertion_ContentUnderstandingDeleteAnalyzerAsync
    }

    @Test
    public void testDeleteNonexistentAnalyzerAsync() {
        // Try to delete a non-existent analyzer
        String nonExistentId = testResourceNamer.randomName("non_existent_analyzer_", 50);

        System.out.println("\nAttempting to delete non-existent analyzer: " + nonExistentId);

        // Note: The SDK allows deleting non-existent analyzers without throwing an exception
        // This is a valid behavior (idempotent delete operation)
        try {
            contentUnderstandingAsyncClient.deleteAnalyzer(nonExistentId).block();
            System.out.println("Delete operation completed (idempotent - no error for non-existent resource)");
        } catch (ResourceNotFoundException e) {
            System.out.println("ResourceNotFoundException caught (alternative behavior): " + e.getMessage());
        }

        System.out.println("Non-existent analyzer deletion behavior verified (SDK allows idempotent deletes)");
    }
}
