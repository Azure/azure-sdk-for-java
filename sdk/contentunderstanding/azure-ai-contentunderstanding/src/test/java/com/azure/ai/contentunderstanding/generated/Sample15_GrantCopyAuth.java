// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
// Code generated by Microsoft (R) TypeSpec Code Generator.

package com.azure.ai.contentunderstanding.generated;

import com.azure.ai.contentunderstanding.ContentUnderstandingClient;
import com.azure.ai.contentunderstanding.ContentUnderstandingClientBuilder;
import com.azure.ai.contentunderstanding.models.ContentAnalyzer;
import com.azure.ai.contentunderstanding.models.ContentAnalyzerConfig;
import com.azure.ai.contentunderstanding.models.ContentFieldDefinition;
import com.azure.ai.contentunderstanding.models.ContentFieldSchema;
import com.azure.ai.contentunderstanding.models.ContentFieldType;
import com.azure.ai.contentunderstanding.models.GenerationMethod;
import com.azure.core.credential.AzureKeyCredential;
import com.azure.core.http.rest.RequestOptions;
import com.azure.core.util.BinaryData;
import com.azure.core.util.polling.SyncPoller;
import org.junit.jupiter.api.Test;

import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

import static org.junit.jupiter.api.Assertions.*;

/**
 * Sample demonstrates how to grant copy authorization for cross-resource analyzer copying.
 * 
 * Note: This sample demonstrates the API pattern for cross-resource copying.
 * For same-resource copying, see Sample14_CopyAnalyzer.
 * 
 * Required environment variables for cross-resource copying:
 * - SOURCE_RESOURCE_ID: Azure resource ID of the source resource
 * - SOURCE_REGION: Region of the source resource
 * - TARGET_ENDPOINT: Endpoint of the target resource
 * - TARGET_RESOURCE_ID: Azure resource ID of the target resource
 * - TARGET_REGION: Region of the target resource
 * - TARGET_KEY (optional): API key for the target resource
 */
public class Sample15_GrantCopyAuth {

    private ContentUnderstandingClient sourceClient;
    private ContentUnderstandingClient targetClient;

    /**
     * Demonstrates the grant copy authorization pattern.
     * 
     * This test is simplified to demonstrate the API without requiring cross-resource setup.
     */
    @Test
    public void testGrantCopyAuthPattern() {
        String endpoint = System.getenv("CONTENTUNDERSTANDING_ENDPOINT");
        String key = System.getenv("CONTENTUNDERSTANDING_API_KEY");

        sourceClient = new ContentUnderstandingClientBuilder()
            .endpoint(endpoint)
            .credential(new AzureKeyCredential(key))
            .buildClient();

        String sourceAnalyzerId = "test_grant_copy_source_" + UUID.randomUUID().toString().replace("-", "");

        try {
            // BEGIN: com.azure.ai.contentunderstanding.grantCopyAuth
            // Step 1: Create the source analyzer
            ContentAnalyzerConfig config = new ContentAnalyzerConfig();
            config.setEnableLayout(true);
            config.setEnableOcr(true);

            Map<String, ContentFieldDefinition> fields = new HashMap<>();
            ContentFieldDefinition companyNameField = new ContentFieldDefinition();
            companyNameField.setType(ContentFieldType.STRING);
            companyNameField.setMethod(GenerationMethod.EXTRACT);
            companyNameField.setDescription("Name of the company");
            fields.put("company_name", companyNameField);

            ContentFieldDefinition totalAmountField = new ContentFieldDefinition();
            totalAmountField.setType(ContentFieldType.NUMBER);
            totalAmountField.setMethod(GenerationMethod.EXTRACT);
            totalAmountField.setDescription("Total amount");
            fields.put("total_amount", totalAmountField);

            ContentFieldSchema fieldSchema = new ContentFieldSchema();
            fieldSchema.setName("company_schema");
            fieldSchema.setDescription("Schema for extracting company information");
            fieldSchema.setFields(fields);

            ContentAnalyzer sourceAnalyzer = new ContentAnalyzer();
            sourceAnalyzer.setBaseAnalyzerId("prebuilt-document");
            sourceAnalyzer.setDescription("Source analyzer for cross-resource copying");
            sourceAnalyzer.setConfig(config);
            sourceAnalyzer.setFieldSchema(fieldSchema);

            Map<String, String> models = new HashMap<>();
            models.put("completion", "gpt-4.1");
            sourceAnalyzer.setModels(models);

            SyncPoller<ContentAnalyzer, ContentAnalyzer> createPoller =
                sourceClient.beginCreateAnalyzer(sourceAnalyzerId, sourceAnalyzer);
            ContentAnalyzer sourceResult = createPoller.getFinalResult();
            System.out.println("Source analyzer '" + sourceAnalyzerId + "' created successfully!");

            // Step 2: Grant copy authorization (requires target resource information)
            // For cross-resource copying, you would use:
            //
            // String targetResourceId = "/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.CognitiveServices/accounts/{name}";
            // String targetRegion = "westus";
            //
            // BinaryData requestBody = BinaryData.fromString(String.format(
            //     "{\"targetAzureResourceId\":\"%s\",\"targetRegion\":\"%s\"}",
            //     targetResourceId, targetRegion));
            //
            // RequestOptions requestOptions = new RequestOptions();
            // Response<BinaryData> authResponse = sourceClient.grantCopyAuthorizationWithResponse(
            //     sourceAnalyzerId, requestBody, requestOptions);
            //
            // // Parse the authorization response
            // String authJson = authResponse.getValue().toString();
            // System.out.println("Copy authorization granted!");
            // System.out.println("  Target Resource ID: " + targetResourceId);
            // System.out.println("  Target Region: " + targetRegion);
            //
            // Step 3: Copy to target resource (from target client)
            // ContentUnderstandingClient targetClient = new ContentUnderstandingClientBuilder()
            //     .endpoint(targetEndpoint)
            //     .credential(new AzureKeyCredential(targetKey))
            //     .buildClient();
            //
            // String sourceResourceId = "/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.CognitiveServices/accounts/{name}";
            // String sourceRegion = "eastus";
            //
            // BinaryData copyRequestBody = BinaryData.fromString(String.format(
            //     "{\"sourceAnalyzerId\":\"%s\",\"sourceAzureResourceId\":\"%s\",\"sourceRegion\":\"%s\"}",
            //     sourceAnalyzerId, sourceResourceId, sourceRegion));
            //
            // SyncPoller<BinaryData, BinaryData> copyPoller = targetClient.beginCopyAnalyzer(
            //     targetAnalyzerId, copyRequestBody, requestOptions);
            // BinaryData copyResult = copyPoller.getFinalResult();
            // System.out.println("Analyzer copied to target resource successfully!");
            // END: com.azure.ai.contentunderstanding.grantCopyAuth

            // Verify source analyzer creation
            System.out.println("\nüìã Source Analyzer Creation Verification:");
            assertNotNull(sourceResult, "Source analyzer should not be null");
            assertEquals("prebuilt-document", sourceResult.getBaseAnalyzerId());
            assertEquals("Source analyzer for cross-resource copying", sourceResult.getDescription());
            assertNotNull(sourceResult.getFieldSchema());
            assertEquals(2, sourceResult.getFieldSchema().getFields().size());
            System.out.println("Source analyzer created successfully");
            System.out.println("  ID: " + sourceAnalyzerId);
            System.out.println("  Base: " + sourceResult.getBaseAnalyzerId());
            System.out.println("  Fields: " + sourceResult.getFieldSchema().getFields().size());

            // Display API pattern information
            System.out.println("\nüìö GrantCopyAuthorization API Pattern:");
            System.out.println("   For cross-resource copying:");
            System.out.println("   1. Create source analyzer in source resource");
            System.out.println("   2. Call grantCopyAuthorizationWithResponse on source client:");
            System.out.println("      Request body: {\"targetAzureResourceId\":\"...\",\"targetRegion\":\"...\"}");
            System.out.println("   3. Use target client to call beginCopyAnalyzer:");
            System.out.println("      Request body: {\"sourceAnalyzerId\":\"...\",\"sourceAzureResourceId\":\"...\",\"sourceRegion\":\"...\"}");
            System.out.println("   4. Wait for copy operation to complete");

            System.out.println("\n‚úÖ GrantCopyAuth pattern demonstration completed");
            System.out.println("   Note: This sample demonstrates the API pattern.");
            System.out.println("   For actual cross-resource copying, provide resource IDs and regions.");

        } finally {
            // Cleanup
            try {
                sourceClient.deleteAnalyzer(sourceAnalyzerId);
                System.out.println("\nSource analyzer deleted: " + sourceAnalyzerId);
            } catch (Exception e) {
                System.out.println("Note: Failed to delete source analyzer: " + e.getMessage());
            }
        }
    }

    /**
     * Demonstrates cross-resource copying with actual resource information.
     * 
     * This test requires environment variables to be set:
     * - SOURCE_RESOURCE_ID
     * - SOURCE_REGION
     * - TARGET_ENDPOINT
     * - TARGET_RESOURCE_ID
     * - TARGET_REGION
     * - TARGET_KEY (optional)
     */
    @Test
    public void testCrossResourceCopy() {
        String endpoint = System.getenv("CONTENTUNDERSTANDING_ENDPOINT");
        String key = System.getenv("CONTENTUNDERSTANDING_API_KEY");

        // Check for required environment variables
        String sourceResourceId = System.getenv("SOURCE_RESOURCE_ID");
        String sourceRegion = System.getenv("SOURCE_REGION");
        String targetEndpoint = System.getenv("TARGET_ENDPOINT");
        String targetResourceId = System.getenv("TARGET_RESOURCE_ID");
        String targetRegion = System.getenv("TARGET_REGION");
        String targetKey = System.getenv("TARGET_KEY");

        if (sourceResourceId == null || sourceRegion == null ||
            targetEndpoint == null || targetResourceId == null || targetRegion == null) {
            System.out.println("‚ö†Ô∏è Cross-resource copying requires environment variables:");
            System.out.println("   SOURCE_RESOURCE_ID, SOURCE_REGION");
            System.out.println("   TARGET_ENDPOINT, TARGET_RESOURCE_ID, TARGET_REGION, TARGET_KEY (optional)");
            System.out.println("   Skipping cross-resource copy test.");
            return;
        }

        sourceClient = new ContentUnderstandingClientBuilder()
            .endpoint(endpoint)
            .credential(new AzureKeyCredential(key))
            .buildClient();

        targetClient = new ContentUnderstandingClientBuilder()
            .endpoint(targetEndpoint)
            .credential(new AzureKeyCredential(targetKey != null ? targetKey : key))
            .buildClient();

        String sourceAnalyzerId = "test_cross_resource_source_" + UUID.randomUUID().toString().replace("-", "");
        String targetAnalyzerId = "test_cross_resource_target_" + UUID.randomUUID().toString().replace("-", "");

        try {
            // Create source analyzer
            ContentAnalyzer sourceAnalyzer = new ContentAnalyzer();
            sourceAnalyzer.setBaseAnalyzerId("prebuilt-document");
            sourceAnalyzer.setDescription("Test analyzer for cross-resource copying");

            ContentAnalyzer sourceResult = sourceClient.beginCreateAnalyzer(sourceAnalyzerId, sourceAnalyzer)
                .getFinalResult();
            System.out.println("Source analyzer created: " + sourceAnalyzerId);

            // Grant copy authorization
            String authRequestJson = String.format(
                "{\"targetAzureResourceId\":\"%s\",\"targetRegion\":\"%s\"}",
                targetResourceId, targetRegion);
            BinaryData authRequest = BinaryData.fromString(authRequestJson);

            RequestOptions requestOptions = new RequestOptions();
            com.azure.core.http.rest.Response<BinaryData> authResponse =
                sourceClient.grantCopyAuthorizationWithResponse(sourceAnalyzerId, authRequest, requestOptions);

            System.out.println("Copy authorization granted!");
            System.out.println("  Response status: " + authResponse.getStatusCode());

            // Copy to target resource
            String copyRequestJson = String.format(
                "{\"sourceAnalyzerId\":\"%s\",\"sourceAzureResourceId\":\"%s\",\"sourceRegion\":\"%s\"}",
                sourceAnalyzerId, sourceResourceId, sourceRegion);
            BinaryData copyRequest = BinaryData.fromString(copyRequestJson);

            SyncPoller<BinaryData, BinaryData> copyPoller =
                targetClient.beginCopyAnalyzer(targetAnalyzerId, copyRequest, requestOptions);
            BinaryData copyResult = copyPoller.getFinalResult();

            System.out.println("Analyzer copied to target resource successfully!");
            System.out.println("  Target analyzer ID: " + targetAnalyzerId);

            // Verify copied analyzer
            ContentAnalyzer copiedAnalyzer = targetClient.getAnalyzer(targetAnalyzerId);
            assertNotNull(copiedAnalyzer);
            assertEquals(sourceResult.getBaseAnalyzerId(), copiedAnalyzer.getBaseAnalyzerId());
            System.out.println("‚úÖ Cross-resource copy verification completed");

        } finally {
            // Cleanup
            try {
                sourceClient.deleteAnalyzer(sourceAnalyzerId);
                System.out.println("Source analyzer deleted");
            } catch (Exception e) {
                // Ignore
            }

            try {
                targetClient.deleteAnalyzer(targetAnalyzerId);
                System.out.println("Target analyzer deleted");
            } catch (Exception e) {
                // Ignore
            }
        }
    }
}
