// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
// Code generated by Microsoft (R) TypeSpec Code Generator.

package com.azure.ai.contentunderstanding.tests.samples;

// The Java test files under 'generated' package are generated for your reference.
// If you wish to modify these files, please copy them out of the 'generated' package, and modify there.
// See https://aka.ms/azsdk/dpg/java/tests for guide on adding a test.

import com.azure.ai.contentunderstanding.ContentUnderstandingAsyncClient;
import com.azure.ai.contentunderstanding.ContentUnderstandingClient;
import com.azure.ai.contentunderstanding.ContentUnderstandingClientBuilder;
import com.azure.core.credential.TokenCredential;
import com.azure.core.http.policy.HttpLogDetailLevel;
import com.azure.core.http.policy.HttpLogOptions;
import com.azure.core.test.TestMode;
import com.azure.core.test.TestProxyTestBase;
import com.azure.core.test.utils.MockTokenCredential;
import com.azure.core.util.Configuration;
import com.azure.identity.DefaultAzureCredentialBuilder;
import com.azure.storage.blob.BlobClient;
import com.azure.storage.blob.BlobContainerClient;
import com.azure.storage.blob.BlobServiceClient;
import com.azure.storage.blob.BlobServiceClientBuilder;
import com.azure.storage.blob.models.UserDelegationKey;
import com.azure.storage.blob.sas.BlobContainerSasPermission;
import com.azure.storage.blob.sas.BlobServiceSasSignatureValues;

import java.io.File;
import java.time.OffsetDateTime;

class ContentUnderstandingClientTestBase extends TestProxyTestBase {
    protected ContentUnderstandingClient contentUnderstandingClient;
    protected ContentUnderstandingAsyncClient contentUnderstandingAsyncClient;

    // Sanitizer IDs to remove:
    // - AZSDK2003, AZSDK2030: Replace Location/Operation-Location headers with "https://example.com"
    //   which breaks LRO polling that relies on Operation-Location header URLs
    // - AZSDK3423: Replaces $..source field with "Sanitized", breaking field source validation
    // - AZSDK3430: Replaces $..id field with "Sanitized"
    // - AZSDK3493: Replaces $..name field with "Sanitized", breaking fieldSchema.name validation
    private static final String[] REMOVE_SANITIZER_ID
        = { "AZSDK2003", "AZSDK2030", "AZSDK3423", "AZSDK3430", "AZSDK3493" };

    @Override
    protected void beforeTest() {
        String endpoint = Configuration.getGlobalConfiguration().get("CONTENTUNDERSTANDING_ENDPOINT");
        if (endpoint == null || endpoint.isEmpty()) {
            if (getTestMode() == TestMode.PLAYBACK) {
                // In PLAYBACK, requests go through the test proxy; endpoint is only used for URL construction.
                endpoint = "https://localhost";
            } else {
                throw new IllegalStateException(
                    "Content Understanding endpoint is required. Set CONTENTUNDERSTANDING_ENDPOINT as an environment variable "
                        + "or system property (e.g. export CONTENTUNDERSTANDING_ENDPOINT=... or mvn test -DCONTENTUNDERSTANDING_ENDPOINT=...).");
            }
        }
        // Strip trailing slash to prevent double-slash in URLs
        if (endpoint.endsWith("/")) {
            endpoint = endpoint.substring(0, endpoint.length() - 1);
        }

        ContentUnderstandingClientBuilder contentUnderstandingClientbuilder
            = new ContentUnderstandingClientBuilder().endpoint(endpoint)
                .httpClient(getHttpClientOrUsePlayback(getHttpClients().findFirst().orElse(null)))
                .httpLogOptions(new HttpLogOptions().setLogLevel(HttpLogDetailLevel.BASIC));
        if (getTestMode() == TestMode.PLAYBACK) {
            contentUnderstandingClientbuilder.credential(new MockTokenCredential());
        } else if (getTestMode() == TestMode.RECORD) {
            contentUnderstandingClientbuilder.addPolicy(interceptorManager.getRecordPolicy())
                .credential(new DefaultAzureCredentialBuilder().build());
        } else if (getTestMode() == TestMode.LIVE) {
            contentUnderstandingClientbuilder.credential(new DefaultAzureCredentialBuilder().build());
        }
        contentUnderstandingClient = contentUnderstandingClientbuilder.buildClient();
        contentUnderstandingAsyncClient = contentUnderstandingClientbuilder.buildAsyncClient();

        // Remove sanitizers that break LRO polling by replacing entire URLs
        if (getTestMode() != TestMode.LIVE) {
            interceptorManager.removeSanitizers(REMOVE_SANITIZER_ID);
        }
    }

    /**
     * Uploads local training data files (images, .labels.json, .result.json) to an
     * Azure Blob container. Existing blobs with the same name are overwritten.
     *
     * @param storageAccountName Storage account name.
     * @param containerName      Container name (created if it does not exist).
     * @param credential         Credential with write access to the container.
     * @param localDirectory     Local folder containing the label files.
     * @param prefix             Optional blob prefix (virtual folder) to prepend, e.g. "receipt_labels/".
     */
    protected static void uploadTrainingData(String storageAccountName, String containerName,
        TokenCredential credential, String localDirectory, String prefix) {
        BlobContainerClient containerClient
            = new BlobServiceClientBuilder().endpoint("https://" + storageAccountName + ".blob.core.windows.net")
                .credential(credential)
                .buildClient()
                .getBlobContainerClient(containerName);

        containerClient.createIfNotExists();

        File dir = new File(localDirectory);
        File[] files = dir.listFiles();
        if (files == null) {
            return;
        }
        for (File file : files) {
            if (!file.isFile()) {
                continue;
            }
            String blobName = (prefix == null || prefix.trim().isEmpty())
                ? file.getName()
                : prefix.replaceAll("/+$", "") + "/" + file.getName();

            System.out.println("Uploading " + file.getName() + " -> " + blobName);
            BlobClient blobClient = containerClient.getBlobClient(blobName);
            blobClient.uploadFromFile(file.getAbsolutePath(), true);
        }
    }

    /**
     * Generates a User Delegation SAS URL (Read + List) for an Azure Blob container.
     * Uses {@link TokenCredential} so no storage account key is needed.
     *
     * @param storageAccountName Storage account name.
     * @param containerName      Container name.
     * @param credential         Credential with permissions to generate user delegation key.
     * @return SAS URL for the container.
     */
    protected static String generateUserDelegationSasUrl(String storageAccountName, String containerName,
        TokenCredential credential) {
        BlobServiceClient blobServiceClient
            = new BlobServiceClientBuilder().endpoint("https://" + storageAccountName + ".blob.core.windows.net")
                .credential(credential)
                .buildClient();

        UserDelegationKey userDelegationKey
            = blobServiceClient.getUserDelegationKey(OffsetDateTime.now(), OffsetDateTime.now().plusHours(1));

        BlobContainerSasPermission permissions
            = new BlobContainerSasPermission().setReadPermission(true).setListPermission(true);

        BlobServiceSasSignatureValues sasValues
            = new BlobServiceSasSignatureValues(OffsetDateTime.now().plusHours(1), permissions);

        String sasToken = blobServiceClient.getBlobContainerClient(containerName)
            .generateUserDelegationSas(sasValues, userDelegationKey);

        return "https://" + storageAccountName + ".blob.core.windows.net/" + containerName + "?" + sasToken;
    }
}
