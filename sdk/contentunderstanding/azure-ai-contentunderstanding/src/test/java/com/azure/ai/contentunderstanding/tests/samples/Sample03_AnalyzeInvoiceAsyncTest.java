// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
// Code generated by Microsoft (R) TypeSpec Code Generator.

package com.azure.ai.contentunderstanding.tests.samples;

import com.azure.ai.contentunderstanding.models.AnalyzeInput;
import com.azure.ai.contentunderstanding.models.AnalyzeResult;
import com.azure.ai.contentunderstanding.models.ArrayField;
import com.azure.ai.contentunderstanding.models.ContentAnalyzerAnalyzeOperationStatus;
import com.azure.ai.contentunderstanding.models.DocumentContent;
import com.azure.ai.contentunderstanding.models.ContentField;
import com.azure.ai.contentunderstanding.models.ContentSpan;
import com.azure.ai.contentunderstanding.models.MediaContent;
import com.azure.ai.contentunderstanding.models.ObjectField;
import com.azure.core.util.polling.PollerFlux;
import org.junit.jupiter.api.Test;
import reactor.core.publisher.Mono;

import static org.junit.jupiter.api.Assertions.*;

import java.util.Arrays;
import java.util.List;

/**
 * Async sample demonstrating how to analyze invoices using Content Understanding service.
 * This sample shows:
 * 1. Analyzing an invoice document asynchronously
 * 2. Extracting structured invoice fields
 * 3. Accessing nested object fields (TotalAmount)
 * 4. Accessing array fields (LineItems)
 * 5. Working with field confidence and source information
 */
public class Sample03_AnalyzeInvoiceAsyncTest extends ContentUnderstandingClientTestBase {

    @Test
    public void testAnalyzeInvoiceAsync() {

        // BEGIN:ContentUnderstandingAnalyzeInvoiceAsync
        // Using a publicly accessible sample file from Azure-Samples GitHub repository
        String invoiceUrl
            = "https://raw.githubusercontent.com/Azure-Samples/azure-ai-content-understanding-dotnet/main/ContentUnderstanding.Common/data/invoice.pdf";

        AnalyzeInput input = new AnalyzeInput();
        input.setUrl(invoiceUrl);

        PollerFlux<ContentAnalyzerAnalyzeOperationStatus, AnalyzeResult> operation
            = contentUnderstandingAsyncClient.beginAnalyze("prebuilt-invoice", Arrays.asList(input));

        // Use reactive pattern: chain operations using flatMap
        // In a real application, you would use subscribe() instead of block()
        AnalyzeResult result = operation.last().flatMap(pollResponse -> {
            if (pollResponse.getStatus().isComplete()) {
                return pollResponse.getFinalResult();
            } else {
                return Mono.error(
                    new RuntimeException("Polling completed unsuccessfully with status: " + pollResponse.getStatus()));
            }
        }).block(); // block() is used here for testing; in production, use subscribe()
        // END:ContentUnderstandingAnalyzeInvoiceAsync

        // BEGIN:Assertion_ContentUnderstandingAnalyzeInvoiceAsync
        assertNotNull(invoiceUrl, "Invoice URL should not be null");
        assertNotNull(operation, "Analysis operation should not be null");
        assertNotNull(result, "Analysis result should not be null");
        assertNotNull(result.getContents(), "Result should contain contents");
        assertTrue(result.getContents().size() > 0, "Result should have at least one content");
        assertEquals(1, result.getContents().size(), "Invoice should have exactly one content element");
        System.out.println("Analysis operation properties verified");
        System.out.println("Analysis result contains " + result.getContents().size() + " content(s)");
        // END:Assertion_ContentUnderstandingAnalyzeInvoiceAsync

        // BEGIN:ContentUnderstandingExtractInvoiceFieldsAsync
        // Get the document content (invoices are documents)
        MediaContent firstContent = result.getContents().get(0);
        if (firstContent instanceof DocumentContent) {
            DocumentContent documentContent = (DocumentContent) firstContent;

            // Print document unit information
            // The unit indicates the measurement system used for coordinates in the source field
            System.out.println("Document unit: "
                + (documentContent.getUnit() != null ? documentContent.getUnit().toString() : "unknown"));
            System.out.println(
                "Pages: " + documentContent.getStartPageNumber() + " to " + documentContent.getEndPageNumber());
            System.out.println();

            // Extract simple string fields using getValue() convenience method
            // getValue() returns the typed value regardless of field type (StringField, NumberField, DateField, etc.)
            ContentField customerNameField
                = documentContent.getFields() != null ? documentContent.getFields().get("CustomerName") : null;
            ContentField invoiceDateField
                = documentContent.getFields() != null ? documentContent.getFields().get("InvoiceDate") : null;

            // Use getValue() instead of casting to specific types
            // Note: getValue() returns the actual typed value - String, Number, LocalDate, etc.
            String customerName = customerNameField != null ? (String) customerNameField.getValue() : null;
            // InvoiceDate is a DateField, so getValue() returns LocalDate - convert to String for display
            Object invoiceDateValue = invoiceDateField != null ? invoiceDateField.getValue() : null;
            String invoiceDate = invoiceDateValue != null ? invoiceDateValue.toString() : null;

            System.out.println("Customer Name: " + (customerName != null ? customerName : "(None)"));
            if (customerNameField != null) {
                System.out.println("  Confidence: " + (customerNameField.getConfidence() != null
                    ? String.format("%.2f", customerNameField.getConfidence())
                    : "N/A"));
                System.out.println(
                    "  Source: " + (customerNameField.getSource() != null ? customerNameField.getSource() : "N/A"));
                List<ContentSpan> spans = customerNameField.getSpans();
                if (spans != null && !spans.isEmpty()) {
                    ContentSpan span = spans.get(0);
                    System.out
                        .println("  Position in markdown: offset=" + span.getOffset() + ", length=" + span.getLength());
                }
            }

            System.out.println("Invoice Date: " + (invoiceDate != null ? invoiceDate : "(None)"));
            if (invoiceDateField != null) {
                System.out.println("  Confidence: " + (invoiceDateField.getConfidence() != null
                    ? String.format("%.2f", invoiceDateField.getConfidence())
                    : "N/A"));
                System.out.println(
                    "  Source: " + (invoiceDateField.getSource() != null ? invoiceDateField.getSource() : "N/A"));
                List<ContentSpan> spans = invoiceDateField.getSpans();
                if (spans != null && !spans.isEmpty()) {
                    ContentSpan span = spans.get(0);
                    System.out
                        .println("  Position in markdown: offset=" + span.getOffset() + ", length=" + span.getLength());
                }
            }

            // Extract object fields (nested structures) using getFieldOrDefault() convenience method
            // getFieldOrDefault() returns null if the field doesn't exist (safe access pattern)
            ContentField totalAmountField
                = documentContent.getFields() != null ? documentContent.getFields().get("TotalAmount") : null;
            if (totalAmountField instanceof ObjectField) {
                ObjectField totalAmountObj = (ObjectField) totalAmountField;

                // Use getFieldOrDefault() for safe nested field access
                ContentField amountField = totalAmountObj.getFieldOrDefault("Amount");
                ContentField currencyField = totalAmountObj.getFieldOrDefault("CurrencyCode");

                // Use getValue() instead of type-specific getters
                Double amount = amountField != null ? (Double) amountField.getValue() : null;
                String currency = currencyField != null ? (String) currencyField.getValue() : null;

                System.out.println("Total: " + (currency != null ? currency : "$")
                    + (amount != null ? String.format("%.2f", amount) : "(None)"));
                if (totalAmountObj.getConfidence() != null) {
                    System.out.println("  Confidence: " + String.format("%.2f", totalAmountObj.getConfidence()));
                }
                if (totalAmountObj.getSource() != null && !totalAmountObj.getSource().isEmpty()) {
                    System.out.println("  Source: " + totalAmountObj.getSource());
                }
            }

            // Extract array fields (collections like line items) using size() and get() convenience methods
            ContentField lineItemsField
                = documentContent.getFields() != null ? documentContent.getFields().get("LineItems") : null;
            if (lineItemsField instanceof ArrayField) {
                ArrayField lineItems = (ArrayField) lineItemsField;
                // Use size() convenience method instead of getValueArray().size()
                System.out.println("Line Items (" + lineItems.size() + "):");
                for (int i = 0; i < lineItems.size(); i++) {
                    // Use get(index) convenience method instead of getValueArray().get(i)
                    ContentField itemField = lineItems.get(i);
                    if (itemField instanceof ObjectField) {
                        ObjectField item = (ObjectField) itemField;
                        // Use getFieldOrDefault() for safe nested access
                        ContentField descField = item.getFieldOrDefault("Description");
                        ContentField qtyField = item.getFieldOrDefault("Quantity");

                        // Use getValue() instead of type-specific getters
                        String description = descField != null ? (String) descField.getValue() : null;
                        Double quantity = qtyField != null ? (Double) qtyField.getValue() : null;

                        System.out.println("  Item " + (i + 1) + ": " + (description != null ? description : "N/A")
                            + " (Qty: " + (quantity != null ? String.valueOf(quantity) : "N/A") + ")");
                        if (item.getConfidence() != null) {
                            System.out.println("    Confidence: " + String.format("%.2f", item.getConfidence()));
                        }
                    }
                }
            }
        }
        // END:ContentUnderstandingExtractInvoiceFieldsAsync

        // BEGIN:Assertion_ContentUnderstandingExtractInvoiceFieldsAsync
        MediaContent content = result.getContents().get(0);
        assertNotNull(content, "Content should not be null");
        assertTrue(content instanceof DocumentContent, "Content should be of type DocumentContent");

        if (content instanceof DocumentContent) {
            DocumentContent docContent = (DocumentContent) content;

            // Verify basic document properties
            assertTrue(docContent.getStartPageNumber() >= 1, "Start page should be >= 1");
            assertTrue(docContent.getEndPageNumber() >= docContent.getStartPageNumber(),
                "End page should be >= start page");
            int totalPages = docContent.getEndPageNumber() - docContent.getStartPageNumber() + 1;
            assertTrue(totalPages > 0, "Total pages should be positive");
            System.out.println("Document has " + totalPages + " page(s) from " + docContent.getStartPageNumber()
                + " to " + docContent.getEndPageNumber());

            System.out.println("All invoice fields validated successfully");
        } else {
            // This should not happen given the assertTrue above, but handle it for completeness
            fail("Content type validation failed: expected DocumentContent but got "
                + (content != null ? content.getClass().getSimpleName() : "null"));
        }
        // END:Assertion_ContentUnderstandingExtractInvoiceFieldsAsync
    }
}
