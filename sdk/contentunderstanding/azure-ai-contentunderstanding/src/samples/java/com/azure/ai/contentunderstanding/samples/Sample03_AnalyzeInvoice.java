// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
// Code generated by Microsoft (R) TypeSpec Code Generator.

package com.azure.ai.contentunderstanding.samples;

import com.azure.ai.contentunderstanding.ContentUnderstandingClient;
import com.azure.ai.contentunderstanding.ContentUnderstandingClientBuilder;
import com.azure.ai.contentunderstanding.models.AnalyzeInput;
import com.azure.ai.contentunderstanding.models.AnalyzeResult;
import com.azure.ai.contentunderstanding.models.ArrayField;
import com.azure.ai.contentunderstanding.models.ContentAnalyzerAnalyzeOperationStatus;
import com.azure.ai.contentunderstanding.models.DocumentContent;
import com.azure.ai.contentunderstanding.models.ContentField;
import com.azure.ai.contentunderstanding.models.ContentSpan;
import com.azure.ai.contentunderstanding.models.MediaContent;
import com.azure.ai.contentunderstanding.models.NumberField;
import com.azure.ai.contentunderstanding.models.ObjectField;
import com.azure.ai.contentunderstanding.models.StringField;
import com.azure.core.credential.AzureKeyCredential;
import com.azure.core.util.Configuration;
import com.azure.core.util.polling.SyncPoller;
import com.azure.identity.DefaultAzureCredentialBuilder;

import java.util.Arrays;
import java.util.List;

/**
 * Sample demonstrating how to analyze invoices using Content Understanding service.
 * This sample shows:
 * 1. Analyzing an invoice document
 * 2. Extracting structured invoice fields
 * 3. Accessing nested object fields (TotalAmount)
 * 4. Accessing array fields (LineItems)
 * 5. Working with field confidence and source information
 */
public class Sample03_AnalyzeInvoice {

    public static void main(String[] args) {
        // BEGIN: com.azure.ai.contentunderstanding.sample03.buildClient
        String endpoint = Configuration.getGlobalConfiguration().get("CONTENTUNDERSTANDING_ENDPOINT");
        String key = System.getenv("AZURE_CONTENT_UNDERSTANDING_KEY");

        // Build the client with appropriate authentication
        ContentUnderstandingClientBuilder builder = new ContentUnderstandingClientBuilder().endpoint(endpoint);

        ContentUnderstandingClient client;
        if (key != null && !key.trim().isEmpty()) {
            // Use API key authentication
            client = builder.credential(new AzureKeyCredential(key)).buildClient();
        } else {
            // Use default Azure credential (for managed identity, Azure CLI, etc.)
            client = builder.credential(new DefaultAzureCredentialBuilder().build()).buildClient();
        }
        // END: com.azure.ai.contentunderstanding.sample03.buildClient

        // BEGIN:ContentUnderstandingAnalyzeInvoice
        // Using a publicly accessible sample file from Azure-Samples GitHub repository
        String invoiceUrl
            = "https://raw.githubusercontent.com/Azure-Samples/azure-ai-content-understanding-dotnet/main/ContentUnderstanding.Common/data/invoice.pdf";

        AnalyzeInput input = new AnalyzeInput();
        input.setUrl(invoiceUrl);

        SyncPoller<ContentAnalyzerAnalyzeOperationStatus, AnalyzeResult> operation
            = client.beginAnalyze("prebuilt-invoice", null, null, Arrays.asList(input), null);

        AnalyzeResult result = operation.getFinalResult();
        // END:ContentUnderstandingAnalyzeInvoice

        System.out.println("Analysis operation completed");
        System.out.println("Analysis result contains " + result.getContents().size() + " content(s)");

        // BEGIN:ContentUnderstandingExtractInvoiceFields
        // Get the document content (invoices are documents)
        MediaContent firstContent = result.getContents().get(0);
        if (firstContent instanceof DocumentContent) {
            DocumentContent documentContent = (DocumentContent) firstContent;

            // Print document unit information
            System.out.println("Document unit: "
                + (documentContent.getUnit() != null ? documentContent.getUnit().toString() : "unknown"));
            System.out.println(
                "Pages: " + documentContent.getStartPageNumber() + " to " + documentContent.getEndPageNumber());
            System.out.println();

            // Extract simple string fields
            ContentField customerNameField
                = documentContent.getFields() != null ? documentContent.getFields().get("CustomerName") : null;
            ContentField invoiceDateField
                = documentContent.getFields() != null ? documentContent.getFields().get("InvoiceDate") : null;

            String customerName = null;
            if (customerNameField instanceof StringField) {
                customerName = ((StringField) customerNameField).getValueString();
            }

            String invoiceDate = null;
            if (invoiceDateField instanceof StringField) {
                invoiceDate = ((StringField) invoiceDateField).getValueString();
            }

            System.out.println("Customer Name: " + (customerName != null ? customerName : "(None)"));
            if (customerNameField != null) {
                System.out.println("  Confidence: " + (customerNameField.getConfidence() != null
                    ? String.format("%.2f", customerNameField.getConfidence())
                    : "N/A"));
                System.out.println(
                    "  Source: " + (customerNameField.getSource() != null ? customerNameField.getSource() : "N/A"));
                List<ContentSpan> spans = customerNameField.getSpans();
                if (spans != null && !spans.isEmpty()) {
                    ContentSpan span = spans.get(0);
                    System.out
                        .println("  Position in markdown: offset=" + span.getOffset() + ", length=" + span.getLength());
                }
            }

            System.out.println("Invoice Date: " + (invoiceDate != null ? invoiceDate : "(None)"));
            if (invoiceDateField != null) {
                System.out.println("  Confidence: " + (invoiceDateField.getConfidence() != null
                    ? String.format("%.2f", invoiceDateField.getConfidence())
                    : "N/A"));
                System.out.println(
                    "  Source: " + (invoiceDateField.getSource() != null ? invoiceDateField.getSource() : "N/A"));
                List<ContentSpan> spans = invoiceDateField.getSpans();
                if (spans != null && !spans.isEmpty()) {
                    ContentSpan span = spans.get(0);
                    System.out
                        .println("  Position in markdown: offset=" + span.getOffset() + ", length=" + span.getLength());
                }
            }

            // Extract object fields (nested structures)
            ContentField totalAmountField
                = documentContent.getFields() != null ? documentContent.getFields().get("TotalAmount") : null;
            if (totalAmountField instanceof ObjectField) {
                ObjectField totalAmountObj = (ObjectField) totalAmountField;
                ContentField amountField
                    = totalAmountObj.getValueObject() != null ? totalAmountObj.getValueObject().get("Amount") : null;
                ContentField currencyField = totalAmountObj.getValueObject() != null
                    ? totalAmountObj.getValueObject().get("CurrencyCode")
                    : null;

                Double amount = null;
                if (amountField instanceof NumberField) {
                    amount = ((NumberField) amountField).getValueNumber();
                }

                String currency = null;
                if (currencyField instanceof StringField) {
                    currency = ((StringField) currencyField).getValueString();
                }

                System.out.println("Total: " + (currency != null ? currency : "$")
                    + (amount != null ? String.format("%.2f", amount) : "(None)"));
                if (totalAmountObj.getConfidence() != null) {
                    System.out.println("  Confidence: " + String.format("%.2f", totalAmountObj.getConfidence()));
                }
                if (totalAmountObj.getSource() != null && !totalAmountObj.getSource().isEmpty()) {
                    System.out.println("  Source: " + totalAmountObj.getSource());
                }
            }

            // Extract array fields (collections like line items)
            ContentField lineItemsField
                = documentContent.getFields() != null ? documentContent.getFields().get("LineItems") : null;
            if (lineItemsField instanceof ArrayField) {
                ArrayField lineItems = (ArrayField) lineItemsField;
                System.out.println("Line Items (" + lineItems.getValueArray().size() + "):");
                for (int i = 0; i < lineItems.getValueArray().size(); i++) {
                    ContentField itemField = lineItems.getValueArray().get(i);
                    if (itemField instanceof ObjectField) {
                        ObjectField item = (ObjectField) itemField;
                        ContentField descField
                            = item.getValueObject() != null ? item.getValueObject().get("Description") : null;
                        ContentField qtyField
                            = item.getValueObject() != null ? item.getValueObject().get("Quantity") : null;

                        String description = null;
                        if (descField instanceof StringField) {
                            description = ((StringField) descField).getValueString();
                        }

                        String quantity = null;
                        if (qtyField instanceof NumberField) {
                            quantity = String.valueOf(((NumberField) qtyField).getValueNumber());
                        }

                        System.out.println("  Item " + (i + 1) + ": " + (description != null ? description : "N/A")
                            + " (Qty: " + (quantity != null ? quantity : "N/A") + ")");
                        if (item.getConfidence() != null) {
                            System.out.println("    Confidence: " + String.format("%.2f", item.getConfidence()));
                        }
                    }
                }
            }
        }
        // END:ContentUnderstandingExtractInvoiceFields

        System.out.println("\nInvoice analysis completed successfully");
    }
}
