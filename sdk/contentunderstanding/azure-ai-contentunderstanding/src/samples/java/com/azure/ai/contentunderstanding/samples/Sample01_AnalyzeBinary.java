// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
// Code generated by Microsoft (R) TypeSpec Code Generator.

package com.azure.ai.contentunderstanding.samples;

import com.azure.ai.contentunderstanding.ContentUnderstandingClient;
import com.azure.ai.contentunderstanding.ContentUnderstandingClientBuilder;
import com.azure.ai.contentunderstanding.models.AnalyzeResult;
import com.azure.ai.contentunderstanding.models.ContentAnalyzerAnalyzeOperationStatus;
import com.azure.ai.contentunderstanding.models.DocumentContent;
import com.azure.ai.contentunderstanding.models.DocumentPage;
import com.azure.ai.contentunderstanding.models.DocumentTable;
import com.azure.ai.contentunderstanding.models.MediaContent;
import com.azure.core.credential.AzureKeyCredential;
import com.azure.core.util.BinaryData;
import com.azure.core.util.Configuration;
import com.azure.core.util.polling.SyncPoller;
import com.azure.identity.DefaultAzureCredentialBuilder;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;

/**
 * Sample demonstrating how to analyze binary documents using Content Understanding service.
 * This sample shows:
 * 1. Loading a binary file (PDF)
 * 2. Analyzing the document
 * 3. Extracting markdown content
 * 4. Accessing document properties (pages, tables, etc.)
 */
public class Sample01_AnalyzeBinary {

    public static void main(String[] args) throws IOException {
        // BEGIN: com.azure.ai.contentunderstanding.sample01.buildClient
        String endpoint = Configuration.getGlobalConfiguration().get("CONTENTUNDERSTANDING_ENDPOINT");
        String key = System.getenv("AZURE_CONTENT_UNDERSTANDING_KEY");

        // Build the client with appropriate authentication
        ContentUnderstandingClientBuilder builder = new ContentUnderstandingClientBuilder().endpoint(endpoint);

        ContentUnderstandingClient client;
        if (key != null && !key.trim().isEmpty()) {
            // Use API key authentication
            client = builder.credential(new AzureKeyCredential(key)).buildClient();
        } else {
            // Use default Azure credential (for managed identity, Azure CLI, etc.)
            client = builder.credential(new DefaultAzureCredentialBuilder().build()).buildClient();
        }
        // END: com.azure.ai.contentunderstanding.sample01.buildClient

        // Load the sample file
        String filePath = "src/test/resources/sample_invoice.pdf";
        Path path = Paths.get(filePath);

        byte[] fileBytes;
        BinaryData binaryData;
        boolean hasRealFile = Files.exists(path);

        // Check if sample file exists
        if (!hasRealFile) {
            System.out.println("⚠️ Sample file not found at " + filePath);
            System.out.println("Creating a minimal test PDF for demonstration...");
            // Create a minimal valid PDF for testing
            String pdfContent
                = "%PDF-1.4\n1 0 obj<</Type/Catalog/Pages 2 0 R>>endobj 2 0 obj<</Type/Pages/Kids[3 0 R]/Count 1>>endobj 3 0 obj<</Type/Page/MediaBox[0 0 612 792]/Parent 2 0 R/Resources<<>>>>endobj\nxref\n0 4\n0000000000 65535 f\n0000000009 00000 n\n0000000056 00000 n\n0000000115 00000 n\ntrailer<</Size 4/Root 1 0 R>>\nstartxref\n203\n%%EOF";
            fileBytes = pdfContent.getBytes();
        } else {
            fileBytes = Files.readAllBytes(path);
        }

        binaryData = BinaryData.fromBytes(fileBytes);

        // BEGIN:ContentUnderstandingAnalyzeBinaryAsync
        SyncPoller<ContentAnalyzerAnalyzeOperationStatus, AnalyzeResult> operation
            = client.beginAnalyzeBinary("prebuilt-documentSearch", "application/pdf", binaryData, null, null, null);

        AnalyzeResult result = operation.getFinalResult();
        // END:ContentUnderstandingAnalyzeBinaryAsync

        System.out.println("Analysis operation completed");
        System.out.println("Analysis result contains "
            + (result.getContents() != null ? result.getContents().size() : 0) + " content(s)");

        // BEGIN:ContentUnderstandingExtractMarkdown
        // A PDF file has only one content element even if it contains multiple pages
        MediaContent content = null;
        if (result.getContents() == null || result.getContents().isEmpty()) {
            System.out.println("(No content returned from analysis)");
        } else {
            content = result.getContents().get(0);
            if (content.getMarkdown() != null && !content.getMarkdown().isEmpty()) {
                System.out.println(content.getMarkdown());
            } else {
                System.out.println("(No markdown content available)");
            }
        }
        // END:ContentUnderstandingExtractMarkdown

        if (hasRealFile && content != null && content.getMarkdown() != null && !content.getMarkdown().isEmpty()) {
            System.out
                .println("Markdown content extracted successfully (" + content.getMarkdown().length() + " characters)");
        } else {
            System.out
                .println("⚠️ Skipping markdown content validation (using minimal test PDF or no markdown available)");
        }

        // BEGIN:ContentUnderstandingAccessDocumentProperties
        // Check if this is document content to access document-specific properties
        if (content instanceof DocumentContent) {
            DocumentContent documentContent = (DocumentContent) content;
            System.out.println("Document type: "
                + (documentContent.getMimeType() != null ? documentContent.getMimeType() : "(unknown)"));
            System.out.println("Start page: " + documentContent.getStartPageNumber());
            System.out.println("End page: " + documentContent.getEndPageNumber());
            System.out.println(
                "Total pages: " + (documentContent.getEndPageNumber() - documentContent.getStartPageNumber() + 1));

            // Check for pages
            if (documentContent.getPages() != null && !documentContent.getPages().isEmpty()) {
                System.out.println("Number of pages: " + documentContent.getPages().size());
                for (DocumentPage page : documentContent.getPages()) {
                    String unit = documentContent.getUnit() != null ? documentContent.getUnit().toString() : "units";
                    System.out.println("  Page " + page.getPageNumber() + ": " + page.getWidth() + " x "
                        + page.getHeight() + " " + unit);
                }
            }

            // Check for tables
            if (documentContent.getTables() != null && !documentContent.getTables().isEmpty()) {
                System.out.println("Number of tables: " + documentContent.getTables().size());
                int tableCounter = 1;
                for (DocumentTable table : documentContent.getTables()) {
                    System.out.println("  Table " + tableCounter + ": " + table.getRowCount() + " rows x "
                        + table.getColumnCount() + " columns");
                    tableCounter++;
                }
            }
        } else {
            System.out.println("Content is MediaContent (not document-specific), skipping document properties");
        }
        // END:ContentUnderstandingAccessDocumentProperties

        System.out.println("\nBinary document analysis completed successfully");
    }
}
