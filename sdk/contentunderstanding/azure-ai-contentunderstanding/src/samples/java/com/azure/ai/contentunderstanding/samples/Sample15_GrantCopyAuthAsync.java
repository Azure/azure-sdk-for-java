// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
// Code generated by Microsoft (R) TypeSpec Code Generator.

package com.azure.ai.contentunderstanding.samples;

import com.azure.ai.contentunderstanding.ContentUnderstandingAsyncClient;
import com.azure.ai.contentunderstanding.ContentUnderstandingClientBuilder;
import com.azure.ai.contentunderstanding.models.ContentAnalyzer;
import com.azure.ai.contentunderstanding.models.ContentAnalyzerConfig;
import com.azure.ai.contentunderstanding.models.ContentAnalyzerOperationStatus;
import com.azure.ai.contentunderstanding.models.ContentFieldDefinition;
import com.azure.ai.contentunderstanding.models.CopyAuthorization;
import com.azure.ai.contentunderstanding.models.ContentFieldSchema;
import com.azure.ai.contentunderstanding.models.ContentFieldType;
import com.azure.ai.contentunderstanding.models.GenerationMethod;
import com.azure.core.credential.AzureKeyCredential;
import com.azure.core.util.polling.PollerFlux;
import com.azure.identity.DefaultAzureCredentialBuilder;
import reactor.core.publisher.Mono;

import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.TimeUnit;

/**
 * Sample demonstrates how to grant copy authorization and copy an analyzer from a source
 * Microsoft Foundry resource to a target Microsoft Foundry resource (cross-resource copying)
 * using the async client.
 *
 * <p>For same-resource copying, see Sample14_CopyAnalyzerAsync.</p>
 *
 * <p>Required environment variables:</p>
 * <ul>
 *   <li>CONTENTUNDERSTANDING_ENDPOINT: Source resource endpoint</li>
 *   <li>CONTENTUNDERSTANDING_KEY (optional): API key for source resource</li>
 *   <li>CONTENTUNDERSTANDING_SOURCE_RESOURCE_ID: Azure resource ID of the source resource</li>
 *   <li>CONTENTUNDERSTANDING_SOURCE_REGION: Region of the source resource</li>
 *   <li>CONTENTUNDERSTANDING_TARGET_ENDPOINT: Endpoint of the target resource</li>
 *   <li>CONTENTUNDERSTANDING_TARGET_KEY (optional): API key for target resource</li>
 *   <li>CONTENTUNDERSTANDING_TARGET_RESOURCE_ID: Azure resource ID of the target resource</li>
 *   <li>CONTENTUNDERSTANDING_TARGET_REGION: Region of the target resource</li>
 * </ul>
 *
 * <p>Note: If API keys are not provided, DefaultAzureCredential will be used.
 * Cross-resource copying with DefaultAzureCredential requires 'Cognitive Services User' role
 * on both source and target resources.</p>
 */
public class Sample15_GrantCopyAuthAsync {

    public static void main(String[] args) throws InterruptedException {
        // Get configuration from environment variables
        String sourceEndpoint = System.getenv("CONTENTUNDERSTANDING_ENDPOINT");
        String sourceKey = System.getenv("CONTENTUNDERSTANDING_KEY");
        String sourceResourceId = System.getenv("CONTENTUNDERSTANDING_SOURCE_RESOURCE_ID");
        String sourceRegion = System.getenv("CONTENTUNDERSTANDING_SOURCE_REGION");
        String targetEndpoint = System.getenv("CONTENTUNDERSTANDING_TARGET_ENDPOINT");
        String targetKey = System.getenv("CONTENTUNDERSTANDING_TARGET_KEY");
        String targetResourceId = System.getenv("CONTENTUNDERSTANDING_TARGET_RESOURCE_ID");
        String targetRegion = System.getenv("CONTENTUNDERSTANDING_TARGET_REGION");

        // Validate required environment variables
        if (sourceEndpoint == null || targetEndpoint == null || sourceResourceId == null
            || targetResourceId == null || sourceRegion == null || targetRegion == null) {
            System.out.println("Cross-resource copying requires the following environment variables:");
            System.out.println("  - CONTENTUNDERSTANDING_ENDPOINT: Source resource endpoint");
            System.out.println("  - CONTENTUNDERSTANDING_KEY (optional): API key for source resource");
            System.out.println("  - CONTENTUNDERSTANDING_SOURCE_RESOURCE_ID: Azure resource ID of the source resource");
            System.out.println("  - CONTENTUNDERSTANDING_SOURCE_REGION: Region of the source resource");
            System.out.println("  - CONTENTUNDERSTANDING_TARGET_ENDPOINT: Endpoint of the target resource");
            System.out.println("  - CONTENTUNDERSTANDING_TARGET_KEY (optional): API key for target resource");
            System.out.println("  - CONTENTUNDERSTANDING_TARGET_RESOURCE_ID: Azure resource ID of the target resource");
            System.out.println("  - CONTENTUNDERSTANDING_TARGET_REGION: Region of the target resource");
            return;
        }

        // BEGIN: com.azure.ai.contentunderstanding.grantCopyAuthAsync
        // Build source async client with appropriate authentication
        ContentUnderstandingClientBuilder sourceBuilder = new ContentUnderstandingClientBuilder()
            .endpoint(sourceEndpoint);
        ContentUnderstandingAsyncClient sourceClient;
        if (sourceKey != null && !sourceKey.trim().isEmpty()) {
            sourceClient = sourceBuilder.credential(new AzureKeyCredential(sourceKey)).buildAsyncClient();
        } else {
            sourceClient = sourceBuilder.credential(new DefaultAzureCredentialBuilder().build()).buildAsyncClient();
        }

        // Build target async client with appropriate authentication
        ContentUnderstandingClientBuilder targetBuilder = new ContentUnderstandingClientBuilder()
            .endpoint(targetEndpoint);
        ContentUnderstandingAsyncClient targetClient;
        if (targetKey != null && !targetKey.trim().isEmpty()) {
            targetClient = targetBuilder.credential(new AzureKeyCredential(targetKey)).buildAsyncClient();
        } else {
            targetClient = targetBuilder.credential(new DefaultAzureCredentialBuilder().build()).buildAsyncClient();
        }

        String sourceAnalyzerId = "my_source_analyzer";
        String targetAnalyzerId = "my_target_analyzer";

        // Step 1: Create the source analyzer
        ContentAnalyzerConfig config = new ContentAnalyzerConfig();
        config.setEnableLayout(true);
        config.setEnableOcr(true);

        Map<String, ContentFieldDefinition> fields = new HashMap<>();
        ContentFieldDefinition companyNameField = new ContentFieldDefinition();
        companyNameField.setType(ContentFieldType.STRING);
        companyNameField.setMethod(GenerationMethod.EXTRACT);
        companyNameField.setDescription("Name of the company");
        fields.put("company_name", companyNameField);

        ContentFieldDefinition totalAmountField = new ContentFieldDefinition();
        totalAmountField.setType(ContentFieldType.NUMBER);
        totalAmountField.setMethod(GenerationMethod.EXTRACT);
        totalAmountField.setDescription("Total amount on the document");
        fields.put("total_amount", totalAmountField);

        ContentFieldSchema fieldSchema = new ContentFieldSchema();
        fieldSchema.setName("company_schema");
        fieldSchema.setDescription("Schema for extracting company information");
        fieldSchema.setFields(fields);

        ContentAnalyzer sourceAnalyzer = new ContentAnalyzer();
        sourceAnalyzer.setBaseAnalyzerId("prebuilt-document");
        sourceAnalyzer.setDescription("Source analyzer for cross-resource copying");
        sourceAnalyzer.setConfig(config);
        sourceAnalyzer.setFieldSchema(fieldSchema);

        Map<String, String> models = new HashMap<>();
        models.put("completion", "gpt-4.1");
        sourceAnalyzer.setModels(models);

        PollerFlux<ContentAnalyzerOperationStatus, ContentAnalyzer> createPoller
            = sourceClient.beginCreateAnalyzer(sourceAnalyzerId, sourceAnalyzer);
        
        String finalSourceAnalyzerId = sourceAnalyzerId; // For use in lambda
        String finalTargetAnalyzerId = targetAnalyzerId; // For use in lambda
        String finalSourceResourceId = sourceResourceId; // For use in lambda
        String finalSourceRegion = sourceRegion; // For use in lambda
        String finalTargetResourceId = targetResourceId; // For use in lambda
        String finalTargetRegion = targetRegion; // For use in lambda

        CountDownLatch latch = new CountDownLatch(1);
        createPoller.last()
            .flatMap(pollResponse -> {
                if (pollResponse.getStatus().isComplete()) {
                    System.out.println("Polling completed successfully");
                    return pollResponse.getFinalResult();
                } else {
                    return Mono.error(new RuntimeException(
                        "Polling completed unsuccessfully with status: " + pollResponse.getStatus()));
                }
            })
            .doOnNext(sourceResult -> {
                System.out.println("Source analyzer '" + finalSourceAnalyzerId + "' created successfully!");
            })
            .then(sourceClient.grantCopyAuthorization(finalSourceAnalyzerId, finalTargetResourceId, finalTargetRegion))
            .doOnNext(copyAuth -> {
                System.out.println("Copy authorization granted successfully!");
                System.out.println("  Target Azure Resource ID: " + copyAuth.getTargetAzureResourceId());
                System.out.println("  Expires at: " + copyAuth.getExpiresAt());
            })
            .flatMap(copyAuth -> {
                // Step 3: Copy analyzer to target resource using target async client
                PollerFlux<ContentAnalyzerOperationStatus, ContentAnalyzer> copyPoller
                    = targetClient.beginCopyAnalyzer(finalTargetAnalyzerId, finalSourceAnalyzerId, false,
                        finalSourceResourceId, finalSourceRegion);

                return copyPoller.last()
                    .flatMap(pollResponse -> {
                        if (pollResponse.getStatus().isComplete()) {
                            System.out.println("Copy polling completed successfully");
                            return pollResponse.getFinalResult();
                        } else {
                            return Mono.error(new RuntimeException(
                                "Copy polling completed unsuccessfully with status: " + pollResponse.getStatus()));
                        }
                    });
            })
            .doOnNext(targetResult -> {
                System.out.println("Target analyzer '" + finalTargetAnalyzerId + "' copied successfully!");
                System.out.println("  Description: " + targetResult.getDescription());
                // END: com.azure.ai.contentunderstanding.grantCopyAuthAsync
            })
            .doFinally(signalType -> {
                // Cleanup: delete both analyzers
                sourceClient.deleteAnalyzer(finalSourceAnalyzerId)
                    .onErrorResume(e -> {
                        System.out.println("Note: Failed to delete source analyzer (may not exist): " + e.getMessage());
                        return Mono.empty();
                    })
                    .doOnSuccess(v -> System.out.println("Source analyzer '" + finalSourceAnalyzerId + "' deleted."))
                    .subscribe();
                
                targetClient.deleteAnalyzer(finalTargetAnalyzerId)
                    .onErrorResume(e -> {
                        System.out.println("Note: Failed to delete target analyzer (may not exist): " + e.getMessage());
                        return Mono.empty();
                    })
                    .doOnSuccess(v -> System.out.println("Target analyzer '" + finalTargetAnalyzerId + "' deleted."))
                    .subscribe();
            })
            .doOnError(error -> {
                System.err.println("Error occurred: " + error.getMessage());
                error.printStackTrace();
            })
            .subscribe(
                result -> {
                    // Success - operations completed
                    latch.countDown();
                },
                error -> {
                    // Error already handled in doOnError
                    latch.countDown();
                }
            );

        // Wait for async operations to complete
        latch.await(3, TimeUnit.MINUTES);
    }
}
