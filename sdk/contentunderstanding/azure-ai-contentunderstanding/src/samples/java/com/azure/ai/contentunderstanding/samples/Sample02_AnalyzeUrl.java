// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
// Code generated by Microsoft (R) TypeSpec Code Generator.

package com.azure.ai.contentunderstanding.samples;

import com.azure.ai.contentunderstanding.ContentUnderstandingClient;
import com.azure.ai.contentunderstanding.ContentUnderstandingClientBuilder;
import com.azure.ai.contentunderstanding.models.AnalyzeInput;
import com.azure.ai.contentunderstanding.models.AnalyzeResult;
import com.azure.ai.contentunderstanding.models.AudioVisualContent;
import com.azure.ai.contentunderstanding.models.ContentAnalyzerAnalyzeOperationStatus;
import com.azure.ai.contentunderstanding.models.DocumentContent;
import com.azure.ai.contentunderstanding.models.DocumentPage;
import com.azure.ai.contentunderstanding.models.DocumentTable;
import com.azure.ai.contentunderstanding.models.MediaContent;
import com.azure.ai.contentunderstanding.models.TranscriptPhrase;
import com.azure.core.credential.AzureKeyCredential;
import com.azure.core.util.polling.SyncPoller;
import com.azure.identity.DefaultAzureCredentialBuilder;

import java.util.Arrays;
import java.util.List;

/**
 * Sample demonstrating how to analyze documents from URL using Content Understanding service.
 * This sample shows:
 * 1. Providing a URL to a document
 * 2. Analyzing the document
 * 3. Extracting markdown content
 * 4. Accessing document properties (pages, tables, etc.)
 *
 * Additional samples demonstrate analyzing different media types:
 * - {@link #analyzeVideoUrl()} - Analyze video files
 * - {@link #analyzeAudioUrl()} - Analyze audio files
 * - {@link #analyzeImageUrl()} - Analyze image files
 */
public class Sample02_AnalyzeUrl {


    public static void main(String[] args) {
        // BEGIN: com.azure.ai.contentunderstanding.sample02.buildClient
        String endpoint = System.getenv("CONTENTUNDERSTANDING_ENDPOINT");
        String key = System.getenv("CONTENTUNDERSTANDING_KEY");

        // Build the client with appropriate authentication
        ContentUnderstandingClientBuilder builder = new ContentUnderstandingClientBuilder().endpoint(endpoint);

        ContentUnderstandingClient client;
        if (key != null && !key.trim().isEmpty()) {
            // Use API key authentication
            client = builder.credential(new AzureKeyCredential(key)).buildClient();
        } else {
            // Use default Azure credential (for managed identity, Azure CLI, etc.)
            client = builder.credential(new DefaultAzureCredentialBuilder().build()).buildClient();
        }
        // END: com.azure.ai.contentunderstanding.sample02.buildClient

        System.out.println("--- Document Analysis Example ---");
        analyzeDocumentUrl(client);

        System.out.println("\n--- Video Analysis Example ---");
        analyzeVideoUrl(client);

        System.out.println("\n--- Audio Analysis Example ---");
        analyzeAudioUrl(client);

        System.out.println("\n--- Image Analysis Example ---");
        analyzeImageUrl(client);
    }

    /**
     * Sample demonstrating how to analyze documents from URL using Content Understanding service.
     * This sample shows:
     * 1. Providing a URL to a document
     * 2. Analyzing the document
     * 3. Extracting markdown content
     * 4. Accessing document properties (pages, tables, etc.)
     */
    public static void analyzeDocumentUrl(ContentUnderstandingClient client) {
        // BEGIN:ContentUnderstandingAnalyzeUrl
        // Using a publicly accessible sample file from Azure-Samples GitHub repository
        String uriSource
            = "https://raw.githubusercontent.com/Azure-Samples/azure-ai-content-understanding-dotnet/main/ContentUnderstanding.Common/data/invoice.pdf";

        AnalyzeInput input = new AnalyzeInput();
        input.setUrl(uriSource);

        SyncPoller<ContentAnalyzerAnalyzeOperationStatus, AnalyzeResult> operation
            = client.beginAnalyze("prebuilt-documentSearch", Arrays.asList(input));

        AnalyzeResult result = operation.getFinalResult();
        // END:ContentUnderstandingAnalyzeUrl

        System.out.println("Analysis operation completed");
        System.out.println("Analysis result contains "
            + (result.getContents() != null ? result.getContents().size() : 0) + " content(s)");

        // A PDF file has only one content element even if it contains multiple pages
        MediaContent content = null;
        if (result.getContents() == null || result.getContents().isEmpty()) {
            System.out.println("(No content returned from analysis)");
        } else {
            content = result.getContents().get(0);
            if (content.getMarkdown() != null && !content.getMarkdown().isEmpty()) {
                System.out.println(content.getMarkdown());
            } else {
                System.out.println("(No markdown content available)");
            }
        }

        if (content != null && content.getMarkdown() != null && !content.getMarkdown().isEmpty()) {
            System.out
                .println("Markdown content extracted successfully (" + content.getMarkdown().length() + " characters)");
        }

        // Check if this is document content to access document-specific properties
        if (content instanceof DocumentContent) {
            DocumentContent documentContent = (DocumentContent) content;
            System.out.println("Document type: "
                + (documentContent.getMimeType() != null ? documentContent.getMimeType() : "(unknown)"));
            System.out.println("Start page: " + documentContent.getStartPageNumber());
            System.out.println("End page: " + documentContent.getEndPageNumber());
            System.out.println(
                "Total pages: " + (documentContent.getEndPageNumber() - documentContent.getStartPageNumber() + 1));

            // Check for pages
            if (documentContent.getPages() != null && !documentContent.getPages().isEmpty()) {
                System.out.println("Number of pages: " + documentContent.getPages().size());
                for (DocumentPage page : documentContent.getPages()) {
                    String unit = documentContent.getUnit() != null ? documentContent.getUnit().toString() : "units";
                    System.out.println("  Page " + page.getPageNumber() + ": " + page.getWidth() + " x "
                        + page.getHeight() + " " + unit);
                }
            }

            // Check for tables
            if (documentContent.getTables() != null && !documentContent.getTables().isEmpty()) {
                System.out.println("Number of tables: " + documentContent.getTables().size());
                int tableCounter = 1;
                for (DocumentTable table : documentContent.getTables()) {
                    System.out.println("  Table " + tableCounter + ": " + table.getRowCount() + " rows x "
                        + table.getColumnCount() + " columns");
                    tableCounter++;
                }
            }
        } else {
            System.out.println("Content is MediaContent (not document-specific), skipping document properties");
        }

        System.out.println("\nURL document analysis completed successfully");
    }

    /**
     * Sample demonstrating how to analyze video from URL using Content Understanding service.
     * This sample shows:
     * 1. Providing a URL to a video file
     * 2. Analyzing the video with prebuilt-videoSearch analyzer
     * 3. Iterating through video segments
     * 4. Accessing audio/visual properties (timing, summary, frame size)
     */
    public static void analyzeVideoUrl(ContentUnderstandingClient client) {
        // BEGIN:ContentUnderstandingAnalyzeVideoUrl
        String uriSource
            = "https://raw.githubusercontent.com/Azure-Samples/azure-ai-content-understanding-assets/main/videos/sdk_samples/FlightSimulator.mp4";

        AnalyzeInput input = new AnalyzeInput();
        input.setUrl(uriSource);

        SyncPoller<ContentAnalyzerAnalyzeOperationStatus, AnalyzeResult> operation
            = client.beginAnalyze("prebuilt-videoSearch", Arrays.asList(input));

        AnalyzeResult result = operation.getFinalResult();

        // prebuilt-videoSearch can detect video segments, so we should iterate through all segments
        int segmentIndex = 1;
        for (MediaContent media : result.getContents()) {
            // Cast MediaContent to AudioVisualContent to access audio/visual-specific properties
            // AudioVisualContent derives from MediaContent and provides additional properties
            // to access full information about audio/video, including timing, transcript phrases, and many others
            AudioVisualContent videoContent = (AudioVisualContent) media;
            System.out.println("--- Segment " + segmentIndex + " ---");
            System.out.println("Markdown:");
            System.out.println(videoContent.getMarkdown());

            String summary = videoContent.getFields() != null && videoContent.getFields().containsKey("Summary")
                ? (videoContent.getFields().get("Summary").getValue() != null
                    ? videoContent.getFields().get("Summary").getValue().toString()
                    : "")
                : "";
            System.out.println("Summary: " + summary);

            System.out.println("Start: " + videoContent.getStartTimeMs() + " ms, End: " + videoContent.getEndTimeMs() + " ms");
            System.out.println("Frame size: " + videoContent.getWidth() + " x " + videoContent.getHeight());

            System.out.println("---------------------");
            segmentIndex++;
        }
        // END:ContentUnderstandingAnalyzeVideoUrl
    }

    /**
     * Sample demonstrating how to analyze audio from URL using Content Understanding service.
     * This sample shows:
     * 1. Providing a URL to an audio file
     * 2. Analyzing the audio with prebuilt-audioSearch analyzer
     * 3. Accessing audio/visual properties (timing, summary, transcript)
     */
    public static void analyzeAudioUrl(ContentUnderstandingClient client) {
        // BEGIN:ContentUnderstandingAnalyzeAudioUrl
        String uriSource
            = "https://raw.githubusercontent.com/Azure-Samples/azure-ai-content-understanding-assets/main/audio/callCenterRecording.mp3";

        AnalyzeInput input = new AnalyzeInput();
        input.setUrl(uriSource);

        SyncPoller<ContentAnalyzerAnalyzeOperationStatus, AnalyzeResult> operation
            = client.beginAnalyze("prebuilt-audioSearch", Arrays.asList(input));

        AnalyzeResult result = operation.getFinalResult();

        // Cast MediaContent to AudioVisualContent to access audio/visual-specific properties
        // AudioVisualContent derives from MediaContent and provides additional properties
        // to access full information about audio/video, including timing, transcript phrases, and many others
        AudioVisualContent audioContent = (AudioVisualContent) result.getContents().get(0);
        System.out.println("Markdown:");
        System.out.println(audioContent.getMarkdown());

        String summary = audioContent.getFields() != null && audioContent.getFields().containsKey("Summary")
            ? (audioContent.getFields().get("Summary").getValue() != null
                ? audioContent.getFields().get("Summary").getValue().toString()
                : "")
            : "";
        System.out.println("Summary: " + summary);

        // Example: Access an additional field in AudioVisualContent (transcript phrases)
        List<TranscriptPhrase> transcriptPhrases = audioContent.getTranscriptPhrases();
        if (transcriptPhrases != null && !transcriptPhrases.isEmpty()) {
            System.out.println("Transcript (first two phrases):");
            int count = 0;
            for (TranscriptPhrase phrase : transcriptPhrases) {
                if (count >= 2) {
                    break;
                }
                System.out.println("  [" + phrase.getSpeaker() + "] " + phrase.getStartTimeMs() + " ms: " + phrase.getText());
                count++;
            }
        }
        // END:ContentUnderstandingAnalyzeAudioUrl
    }

    /**
     * Sample demonstrating how to analyze image from URL using Content Understanding service.
     * This sample shows:
     * 1. Providing a URL to an image file
     * 2. Analyzing the image with prebuilt-imageSearch analyzer
     * 3. Accessing image properties (markdown, summary)
     */
    public static void analyzeImageUrl(ContentUnderstandingClient client) {
        // BEGIN:ContentUnderstandingAnalyzeImageUrl
        String uriSource
            = "https://raw.githubusercontent.com/Azure-Samples/azure-ai-content-understanding-assets/main/image/pieChart.jpg";

        AnalyzeInput input = new AnalyzeInput();
        input.setUrl(uriSource);

        SyncPoller<ContentAnalyzerAnalyzeOperationStatus, AnalyzeResult> operation
            = client.beginAnalyze("prebuilt-imageSearch", Arrays.asList(input));

        AnalyzeResult result = operation.getFinalResult();

        MediaContent content = result.getContents().get(0);
        System.out.println("Markdown:");
        System.out.println(content.getMarkdown());

        String summary = content.getFields() != null && content.getFields().containsKey("Summary")
            ? (content.getFields().get("Summary").getValue() != null
                ? content.getFields().get("Summary").getValue().toString()
                : "")
            : "";
        System.out.println("Summary: " + summary);
        // END:ContentUnderstandingAnalyzeImageUrl
    }
}
