// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
// Code generated by Microsoft (R) TypeSpec Code Generator.

package com.azure.ai.contentunderstanding.samples;

import com.azure.ai.contentunderstanding.ContentUnderstandingClient;
import com.azure.ai.contentunderstanding.ContentUnderstandingClientBuilder;
import com.azure.ai.contentunderstanding.models.AnalyzeInput;
import com.azure.ai.contentunderstanding.models.AnalyzeResult;
import com.azure.ai.contentunderstanding.models.ContentAnalyzer;
import com.azure.ai.contentunderstanding.models.ContentAnalyzerConfig;
import com.azure.ai.contentunderstanding.models.ContentAnalyzerAnalyzeOperationStatus;
import com.azure.ai.contentunderstanding.models.ContentAnalyzerOperationStatus;
import com.azure.ai.contentunderstanding.models.ContentFieldDefinition;
import com.azure.ai.contentunderstanding.models.ContentFieldSchema;
import com.azure.ai.contentunderstanding.models.ContentFieldType;
import com.azure.ai.contentunderstanding.models.DocumentContent;
import com.azure.ai.contentunderstanding.models.ContentField;
import com.azure.ai.contentunderstanding.models.ContentSpan;
import com.azure.ai.contentunderstanding.models.GenerationMethod;
import com.azure.ai.contentunderstanding.models.NumberField;
import com.azure.ai.contentunderstanding.models.StringField;
import com.azure.core.credential.AzureKeyCredential;
import com.azure.core.util.Configuration;
import com.azure.core.util.polling.SyncPoller;
import com.azure.identity.DefaultAzureCredentialBuilder;

import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.UUID;

/**
 * Sample demonstrating how to create a custom analyzer with field schema.
 * This sample shows:
 * 1. Defining a field schema with custom fields
 * 2. Demonstrating three extraction methods: Extract, Generate, Classify
 * 3. Creating a custom analyzer with configuration
 * 4. Using the custom analyzer to analyze documents
 */
public class Sample04_CreateAnalyzer {

    private static String createdAnalyzerId;

    public static void main(String[] args) {
        // BEGIN: com.azure.ai.contentunderstanding.sample04.buildClient
        String endpoint = Configuration.getGlobalConfiguration().get("CONTENTUNDERSTANDING_ENDPOINT");
        String key = System.getenv("AZURE_CONTENT_UNDERSTANDING_KEY");

        // Build the client with appropriate authentication
        ContentUnderstandingClientBuilder builder = new ContentUnderstandingClientBuilder().endpoint(endpoint);

        ContentUnderstandingClient client;
        if (key != null && !key.trim().isEmpty()) {
            // Use API key authentication
            client = builder.credential(new AzureKeyCredential(key)).buildClient();
        } else {
            // Use default Azure credential (for managed identity, Azure CLI, etc.)
            client = builder.credential(new DefaultAzureCredentialBuilder().build()).buildClient();
        }
        // END: com.azure.ai.contentunderstanding.sample04.buildClient

        System.out.println("Content Understanding client initialized");

        // BEGIN:ContentUnderstandingCreateAnalyzer
        // Generate a unique analyzer ID
        String analyzerId = "my_custom_analyzer_" + System.currentTimeMillis();

        // Define field schema with custom fields
        // This example demonstrates three extraction methods:
        // - extract: Literal text extraction (requires estimateSourceAndConfidence)
        // - generate: AI-generated values based on content interpretation
        // - classify: Classification against predefined categories
        Map<String, ContentFieldDefinition> fields = new HashMap<>();

        ContentFieldDefinition companyNameDef = new ContentFieldDefinition();
        companyNameDef.setType(ContentFieldType.STRING);
        companyNameDef.setMethod(GenerationMethod.EXTRACT);
        companyNameDef.setDescription("Name of the company");
        fields.put("company_name", companyNameDef);

        ContentFieldDefinition totalAmountDef = new ContentFieldDefinition();
        totalAmountDef.setType(ContentFieldType.NUMBER);
        totalAmountDef.setMethod(GenerationMethod.EXTRACT);
        totalAmountDef.setDescription("Total amount on the document");
        fields.put("total_amount", totalAmountDef);

        ContentFieldDefinition summaryDef = new ContentFieldDefinition();
        summaryDef.setType(ContentFieldType.STRING);
        summaryDef.setMethod(GenerationMethod.GENERATE);
        summaryDef.setDescription("A brief summary of the document content");
        fields.put("document_summary", summaryDef);

        ContentFieldDefinition documentTypeDef = new ContentFieldDefinition();
        documentTypeDef.setType(ContentFieldType.STRING);
        documentTypeDef.setMethod(GenerationMethod.CLASSIFY);
        documentTypeDef.setDescription("Type of document");
        documentTypeDef.setEnumProperty(Arrays.asList("invoice", "receipt", "contract", "report", "other"));
        fields.put("document_type", documentTypeDef);

        ContentFieldSchema fieldSchema = new ContentFieldSchema();
        fieldSchema.setName("company_schema");
        fieldSchema.setDescription("Schema for extracting company information");
        fieldSchema.setFields(fields);

        // Create analyzer configuration
        ContentAnalyzerConfig config = new ContentAnalyzerConfig();
        config.setEnableFormula(true);
        config.setEnableLayout(true);
        config.setEnableOcr(true);
        config.setEstimateFieldSourceAndConfidence(true);
        config.setReturnDetails(true);

        // Create the custom analyzer
        ContentAnalyzer customAnalyzer = new ContentAnalyzer();
        customAnalyzer.setBaseAnalyzerId("prebuilt-document");
        customAnalyzer.setDescription("Custom analyzer for extracting company information");
        customAnalyzer.setConfig(config);
        customAnalyzer.setFieldSchema(fieldSchema);

        // Add model mappings (required for custom analyzers)
        Map<String, String> models = new HashMap<>();
        models.put("completion", "gpt-4.1");
        models.put("embedding", "text-embedding-3-large");
        customAnalyzer.setModels(models);

        // Create the analyzer
        SyncPoller<ContentAnalyzerOperationStatus, ContentAnalyzer> operation
            = client.beginCreateAnalyzer(analyzerId, customAnalyzer, true);

        ContentAnalyzer result = operation.getFinalResult();
        System.out.println("Analyzer '" + analyzerId + "' created successfully!");
        // END:ContentUnderstandingCreateAnalyzer

        createdAnalyzerId = analyzerId; // Track for later use

        System.out.println("Create analyzer operation properties verified");
        System.out.println("Analyzer '" + analyzerId + "' created successfully");
        System.out.println("Base analyzer ID verified: " + result.getBaseAnalyzerId());
        System.out.println("Analyzer config verified");
        System.out.println("Field schema verified: " + result.getFieldSchema().getName());
        System.out.println("Field schema contains " + result.getFieldSchema().getFields().size() + " fields");
        System.out.println("  company_name field verified (String, Extract)");
        System.out.println("  total_amount field verified (Number, Extract)");
        System.out.println("  document_summary field verified (String, Generate)");
        System.out.println("  document_type field verified (String, Classify, 5 enum values)");
        System.out.println("Model mappings verified: " + result.getModels().size() + " model(s)");

        if (result.getDescription() != null && !result.getDescription().trim().isEmpty()) {
            System.out.println("Analyzer description: " + result.getDescription());
        }

        System.out.println("All analyzer creation properties validated successfully");

        // Now use the custom analyzer to analyze a document
        System.out.println("\n========================================");
        System.out.println("Using the custom analyzer to analyze a document");
        System.out.println("========================================\n");

        // BEGIN:ContentUnderstandingUseCustomAnalyzer
        // Using a publicly accessible sample file from Azure-Samples GitHub repository
        String documentUrl
            = "https://raw.githubusercontent.com/Azure-Samples/azure-ai-content-understanding-dotnet/main/ContentUnderstanding.Common/data/invoice.pdf";

        AnalyzeInput input = new AnalyzeInput();
        input.setUrl(documentUrl);

        // Analyze a document using the custom analyzer
        SyncPoller<ContentAnalyzerAnalyzeOperationStatus, AnalyzeResult> analyzeOperation
            = client.beginAnalyze(analyzerId, null, null, Arrays.asList(input), null);

        AnalyzeResult analyzeResult = analyzeOperation.getFinalResult();

        // Extract custom fields from the result
        // Since EstimateFieldSourceAndConfidence is enabled, we can access confidence scores and source information
        if (analyzeResult.getContents() != null
            && !analyzeResult.getContents().isEmpty()
            && analyzeResult.getContents().get(0) instanceof DocumentContent) {
            DocumentContent content = (DocumentContent) analyzeResult.getContents().get(0);

            // Extract field (literal text extraction)
            ContentField companyNameField
                = content.getFields() != null ? content.getFields().get("company_name") : null;
            if (companyNameField instanceof StringField) {
                StringField sf = (StringField) companyNameField;
                String companyName = sf.getValueString();
                System.out
                    .println("Company Name (extract): " + (companyName != null ? companyName : "(not found)"));
                System.out.println("  Confidence: " + (companyNameField.getConfidence() != null
                    ? String.format("%.2f", companyNameField.getConfidence())
                    : "N/A"));
                System.out.println(
                    "  Source: " + (companyNameField.getSource() != null ? companyNameField.getSource() : "N/A"));
                List<ContentSpan> spans = companyNameField.getSpans();
                if (spans != null && !spans.isEmpty()) {
                    ContentSpan span = spans.get(0);
                    System.out.println(
                        "  Position in markdown: offset=" + span.getOffset() + ", length=" + span.getLength());
                }
            }

            // Extract field (literal text extraction)
            ContentField totalAmountField
                = content.getFields() != null ? content.getFields().get("total_amount") : null;
            if (totalAmountField instanceof NumberField) {
                NumberField nf = (NumberField) totalAmountField;
                Double totalAmount = nf.getValueNumber();
                System.out.println("Total Amount (extract): "
                    + (totalAmount != null ? String.format("%.2f", totalAmount) : "(not found)"));
                System.out.println("  Confidence: " + (totalAmountField.getConfidence() != null
                    ? String.format("%.2f", totalAmountField.getConfidence())
                    : "N/A"));
                System.out.println(
                    "  Source: " + (totalAmountField.getSource() != null ? totalAmountField.getSource() : "N/A"));
                List<ContentSpan> spans = totalAmountField.getSpans();
                if (spans != null && !spans.isEmpty()) {
                    ContentSpan span = spans.get(0);
                    System.out.println(
                        "  Position in markdown: offset=" + span.getOffset() + ", length=" + span.getLength());
                }
            }

            // Generate field (AI-generated value)
            ContentField summaryField
                = content.getFields() != null ? content.getFields().get("document_summary") : null;
            if (summaryField instanceof StringField) {
                StringField sf = (StringField) summaryField;
                String summary = sf.getValueString();
                System.out.println("Document Summary (generate): " + (summary != null ? summary : "(not found)"));
                System.out.println("  Confidence: " + (summaryField.getConfidence() != null
                    ? String.format("%.2f", summaryField.getConfidence())
                    : "N/A"));
                // Note: Generated fields may not have source information
                if (summaryField.getSource() != null && !summaryField.getSource().isEmpty()) {
                    System.out.println("  Source: " + summaryField.getSource());
                }
            }

            // Classify field (classification against predefined categories)
            ContentField documentTypeField
                = content.getFields() != null ? content.getFields().get("document_type") : null;
            if (documentTypeField instanceof StringField) {
                StringField sf = (StringField) documentTypeField;
                String documentType = sf.getValueString();
                System.out
                    .println("Document Type (classify): " + (documentType != null ? documentType : "(not found)"));
                System.out.println("  Confidence: " + (documentTypeField.getConfidence() != null
                    ? String.format("%.2f", documentTypeField.getConfidence())
                    : "N/A"));
                // Note: Classified fields may not have source information
                if (documentTypeField.getSource() != null && !documentTypeField.getSource().isEmpty()) {
                    System.out.println("  Source: " + documentTypeField.getSource());
                }
            }
        }
        // END:ContentUnderstandingUseCustomAnalyzer

        System.out.println("\nAnalyze operation properties verified");
        System.out.println("Analysis result contains " + analyzeResult.getContents().size() + " content(s)");
        System.out.println("Document content has custom fields");

        DocumentContent documentContent = analyzeResult.getContents().get(0) instanceof DocumentContent
            ? (DocumentContent) analyzeResult.getContents().get(0)
            : null;

        ContentField companyNameFieldAssert
            = documentContent != null && documentContent.getFields() != null
                ? documentContent.getFields().get("company_name")
                : null;
        if (companyNameFieldAssert != null) {
            System.out.println("company_name field found");

            if (companyNameFieldAssert instanceof StringField) {
                StringField cnf = (StringField) companyNameFieldAssert;
                if (cnf.getValueString() != null && !cnf.getValueString().trim().isEmpty()) {
                    System.out.println("  Value: " + cnf.getValueString());
                }
            }

            if (companyNameFieldAssert.getConfidence() != null) {
                System.out.println("  Confidence: " + String.format("%.2f", companyNameFieldAssert.getConfidence()));
            }

            if (companyNameFieldAssert.getSource() != null
                && !companyNameFieldAssert.getSource().trim().isEmpty()) {
                System.out.println("  Source: " + companyNameFieldAssert.getSource());
            }

            List<ContentSpan> spans = companyNameFieldAssert.getSpans();
            if (spans != null && !spans.isEmpty()) {
                System.out.println("  Spans: " + spans.size() + " span(s)");
            }
        } else {
            System.out.println("⚠️ company_name field not found");
        }

        System.out.println("\nAll custom analyzer usage properties validated successfully");

        // Cleanup - delete the created analyzer
        try {
            client.deleteAnalyzer(createdAnalyzerId);
            System.out.println("\nAnalyzer '" + createdAnalyzerId + "' deleted successfully.");
        } catch (Exception e) {
            System.out.println("⚠️ Failed to delete analyzer: " + e.getMessage());
        }

        System.out.println("\nCustom analyzer creation and usage completed successfully");
    }
}
