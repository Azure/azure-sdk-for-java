// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
// Code generated by Microsoft (R) TypeSpec Code Generator.

package com.azure.ai.contentunderstanding.samples;

import com.azure.ai.contentunderstanding.ContentUnderstandingAsyncClient;
import com.azure.ai.contentunderstanding.ContentUnderstandingClientBuilder;
import com.azure.ai.contentunderstanding.models.AnalyzeInput;
import com.azure.ai.contentunderstanding.models.AnalyzeResult;
import com.azure.ai.contentunderstanding.models.ArrayField;
import com.azure.ai.contentunderstanding.models.ContentAnalyzerAnalyzeOperationStatus;
import com.azure.ai.contentunderstanding.models.ContentField;
import com.azure.ai.contentunderstanding.models.ContentSpan;
import com.azure.ai.contentunderstanding.models.DocumentContent;
import com.azure.ai.contentunderstanding.models.MediaContent;
import com.azure.ai.contentunderstanding.models.ObjectField;
import com.azure.core.credential.AzureKeyCredential;
import com.azure.core.util.polling.PollerFlux;
import com.azure.identity.DefaultAzureCredentialBuilder;
import reactor.core.publisher.Mono;

import java.util.Arrays;
import java.util.List;
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.TimeUnit;

/**
 * Sample demonstrating how to analyze invoices using Content Understanding service.
 * This sample shows:
 * 1. Analyzing an invoice document
 * 2. Extracting structured invoice fields
 * 3. Accessing nested object fields (TotalAmount)
 * 4. Accessing array fields (LineItems)
 * 5. Working with field confidence and source information
 */
public class Sample03_AnalyzeInvoiceAsync {

    public static void main(String[] args) throws InterruptedException {
        // BEGIN: com.azure.ai.contentunderstanding.sample03Async.buildClient
        String endpoint = System.getenv("CONTENTUNDERSTANDING_ENDPOINT");
        String key = System.getenv("CONTENTUNDERSTANDING_KEY");

        // Build the client with appropriate authentication
        ContentUnderstandingClientBuilder builder = new ContentUnderstandingClientBuilder().endpoint(endpoint);

        ContentUnderstandingAsyncClient client;
        if (key != null && !key.trim().isEmpty()) {
            // Use API key authentication
            client = builder.credential(new AzureKeyCredential(key)).buildAsyncClient();
        } else {
            // Use default Azure credential (for managed identity, Azure CLI, etc.)
            client = builder.credential(new DefaultAzureCredentialBuilder().build()).buildAsyncClient();
        }
        // END: com.azure.ai.contentunderstanding.sample03Async.buildClient

        // BEGIN:ContentUnderstandingAnalyzeInvoiceAsync
        // Using a publicly accessible sample file from Azure-Samples GitHub repository
        String invoiceUrl
            = "https://raw.githubusercontent.com/Azure-Samples/azure-ai-content-understanding-dotnet/main/ContentUnderstanding.Common/data/invoice.pdf";

        AnalyzeInput input = new AnalyzeInput();
        input.setUrl(invoiceUrl);

        PollerFlux<ContentAnalyzerAnalyzeOperationStatus, AnalyzeResult> operation
            = client.beginAnalyze("prebuilt-invoice", Arrays.asList(input));

        CountDownLatch latch = new CountDownLatch(1);

        operation.last()
            .flatMap(pollResponse -> {
                if (pollResponse.getStatus().isComplete()) {
                    System.out.println("Polling completed successfully");
                    return pollResponse.getFinalResult();
                } else {
                    return Mono.error(new RuntimeException(
                        "Polling completed unsuccessfully with status: " + pollResponse.getStatus()));
                }
            })
            .doOnNext(result -> {
                System.out.println("Analysis operation completed");
                System.out.println("Analysis result contains " + result.getContents().size() + " content(s)");

                // BEGIN:ContentUnderstandingExtractInvoiceFieldsAsync
                // Get the document content (invoices are documents)
                MediaContent firstContent = result.getContents().get(0);
                if (firstContent instanceof DocumentContent) {
                    DocumentContent documentContent = (DocumentContent) firstContent;

                    // Print document unit information
                    System.out.println("Document unit: "
                        + (documentContent.getUnit() != null ? documentContent.getUnit().toString() : "unknown"));
                    System.out.println("Pages: " + documentContent.getStartPageNumber() + " to "
                        + documentContent.getEndPageNumber());
                    System.out.println();

                    // Extract simple string fields using getValue() convenience method
                    // getValue() returns the typed value regardless of field type (StringField, NumberField, DateField, etc.)
                    ContentField customerNameField
                        = documentContent.getFields() != null ? documentContent.getFields().get("CustomerName") : null;
                    ContentField invoiceDateField
                        = documentContent.getFields() != null ? documentContent.getFields().get("InvoiceDate") : null;

                    // Use getValue() instead of casting to specific types
                    // Note: getValue() returns the actual typed value - String, Number, LocalDate, etc.
                    String customerName = customerNameField != null ? (String) customerNameField.getValue() : null;
                    // InvoiceDate is a DateField, so getValue() returns LocalDate - convert to String for display
                    Object invoiceDateValue = invoiceDateField != null ? invoiceDateField.getValue() : null;
                    String invoiceDate = invoiceDateValue != null ? invoiceDateValue.toString() : null;

                    System.out.println("Customer Name: " + (customerName != null ? customerName : "(None)"));
                    if (customerNameField != null) {
                        System.out.println("  Confidence: " + (customerNameField.getConfidence() != null
                            ? String.format("%.2f", customerNameField.getConfidence())
                            : "N/A"));
                        System.out.println("  Source: "
                            + (customerNameField.getSource() != null ? customerNameField.getSource() : "N/A"));
                        List<ContentSpan> spans = customerNameField.getSpans();
                        if (spans != null && !spans.isEmpty()) {
                            ContentSpan span = spans.get(0);
                            System.out.println("  Position in markdown: offset=" + span.getOffset() + ", length="
                                + span.getLength());
                        }
                    }

                    System.out.println("Invoice Date: " + (invoiceDate != null ? invoiceDate : "(None)"));
                    if (invoiceDateField != null) {
                        System.out.println("  Confidence: " + (invoiceDateField.getConfidence() != null
                            ? String.format("%.2f", invoiceDateField.getConfidence())
                            : "N/A"));
                        System.out.println("  Source: "
                            + (invoiceDateField.getSource() != null ? invoiceDateField.getSource() : "N/A"));
                        List<ContentSpan> spans = invoiceDateField.getSpans();
                        if (spans != null && !spans.isEmpty()) {
                            ContentSpan span = spans.get(0);
                            System.out.println("  Position in markdown: offset=" + span.getOffset() + ", length="
                                + span.getLength());
                        }
                    }

                    // Extract object fields (nested structures) using getFieldOrDefault() convenience method
                    // getFieldOrDefault() returns null if the field doesn't exist (safe access pattern)
                    ContentField totalAmountField
                        = documentContent.getFields() != null ? documentContent.getFields().get("TotalAmount") : null;
                    if (totalAmountField instanceof ObjectField) {
                        ObjectField totalAmountObj = (ObjectField) totalAmountField;

                        // Use getFieldOrDefault() for safe nested field access
                        ContentField amountField = totalAmountObj.getFieldOrDefault("Amount");
                        ContentField currencyField = totalAmountObj.getFieldOrDefault("CurrencyCode");

                        // Use getValue() instead of type-specific getters
                        Double amount = amountField != null ? (Double) amountField.getValue() : null;
                        String currency = currencyField != null ? (String) currencyField.getValue() : null;

                        System.out.println("Total: " + (currency != null ? currency : "")
                            + (amount != null ? String.format("%.2f", amount) : "(None)"));
                        if (totalAmountObj.getConfidence() != null) {
                            System.out.println("  Confidence: " + String.format("%.2f", totalAmountObj.getConfidence()));
                        }
                        if (totalAmountObj.getSource() != null && !totalAmountObj.getSource().isEmpty()) {
                            System.out.println("  Source: " + totalAmountObj.getSource());
                        }
                    }

                    // Extract array fields using size() and get() convenience methods
                    // size() returns the number of elements, get(index) returns the element at the index
                    ContentField lineItemsField
                        = documentContent.getFields() != null ? documentContent.getFields().get("LineItems") : null;
                    if (lineItemsField instanceof ArrayField) {
                        ArrayField lineItems = (ArrayField) lineItemsField;

                        // Use size() instead of getValueArray().size()
                        System.out.println("Line Items (" + lineItems.size() + "):");

                        // Use get(i) instead of getValueArray().get(i)
                        for (int i = 0; i < lineItems.size(); i++) {
                            ContentField itemField = lineItems.get(i);
                            if (itemField instanceof ObjectField) {
                                ObjectField item = (ObjectField) itemField;

                                // Use getFieldOrDefault() and getValue() for cleaner access
                                ContentField descField = item.getFieldOrDefault("Description");
                                ContentField qtyField = item.getFieldOrDefault("Quantity");

                                String description = descField != null ? (String) descField.getValue() : null;
                                Double quantity = qtyField != null ? (Double) qtyField.getValue() : null;

                                System.out.println("  Item " + (i + 1) + ": " + (description != null ? description : "N/A"));
                                System.out.println("    Quantity: " + (quantity != null ? quantity : "N/A"));
                                if (qtyField != null && qtyField.getConfidence() != null) {
                                    System.out.println("    Quantity Confidence: "
                                        + String.format("%.2f", qtyField.getConfidence()));
                                } else {
                                    System.out.println("    Quantity Confidence: N/A");
                                }
                            }
                        }
                    }
                }
                // END:ContentUnderstandingExtractInvoiceFieldsAsync

                System.out.println("\nInvoice analysis completed successfully");
            })
            .doOnError(error -> {
                System.err.println("Error occurred: " + error.getMessage());
                error.printStackTrace();
            })
            .subscribe(
                result -> {
                    // Success - operations completed
                    latch.countDown();
                },
                error -> {
                    // Error already handled in doOnError
                    latch.countDown();
                }
            );
        // END:ContentUnderstandingAnalyzeInvoiceAsync

        // The .subscribe() creation is not a blocking call. For the purpose of this example,
        // we use a CountDownLatch so the program does not end before the async operations complete.
        if (!latch.await(2, TimeUnit.MINUTES)) {
            System.err.println("Timed out waiting for async operations to complete.");
        }
    }
}
