// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
// Code generated by Microsoft (R) TypeSpec Code Generator.

package com.azure.ai.contentunderstanding.samples;

import com.azure.ai.contentunderstanding.ContentUnderstandingAsyncClient;
import com.azure.ai.contentunderstanding.ContentUnderstandingClientBuilder;
import com.azure.ai.contentunderstanding.models.ContentAnalyzer;
import com.azure.ai.contentunderstanding.models.ContentAnalyzerConfig;
import com.azure.ai.contentunderstanding.models.ContentFieldDefinition;
import com.azure.ai.contentunderstanding.models.ContentFieldSchema;
import com.azure.ai.contentunderstanding.models.ContentFieldType;
import com.azure.ai.contentunderstanding.models.GenerationMethod;
import com.azure.core.credential.AzureKeyCredential;
import com.azure.core.util.polling.PollerFlux;
import com.azure.identity.DefaultAzureCredentialBuilder;
import reactor.core.publisher.Mono;

import java.util.HashMap;
import java.util.Map;
import java.util.UUID;
import java.util.concurrent.TimeUnit;

/**
 * Sample demonstrates how to copy an analyzer within the same resource using the async client.
 * For cross-resource copying, see Sample15_GrantCopyAuthAsync.
 */
public class Sample14_CopyAnalyzerAsync {

    public static void main(String[] args) {
        // BEGIN: com.azure.ai.contentunderstanding.sample14Async.buildClient
        String endpoint = System.getenv("CONTENTUNDERSTANDING_ENDPOINT");
        String key = System.getenv("CONTENTUNDERSTANDING_KEY");

        // Build the async client with appropriate authentication
        ContentUnderstandingClientBuilder builder = new ContentUnderstandingClientBuilder().endpoint(endpoint);

        ContentUnderstandingAsyncClient client;
        if (key != null && !key.trim().isEmpty()) {
            // Use API key authentication
            client = builder.credential(new AzureKeyCredential(key)).buildAsyncClient();
        } else {
            // Use default Azure credential (for managed identity, Azure CLI, etc.)
            client = builder.credential(new DefaultAzureCredentialBuilder().build()).buildAsyncClient();
        }
        // END: com.azure.ai.contentunderstanding.sample14Async.buildClient

        System.out.println("âœ“ Client initialized successfully with endpoint: " + endpoint);

        // Generate unique analyzer IDs for this test
        String sourceAnalyzerId = "test_analyzer_source_" + UUID.randomUUID().toString().replace("-", "");
        String targetAnalyzerId = "test_analyzer_target_" + UUID.randomUUID().toString().replace("-", "");

        String finalSourceAnalyzerId = sourceAnalyzerId; // For use in lambda
        String finalTargetAnalyzerId = targetAnalyzerId; // For use in lambda

        // BEGIN: com.azure.ai.contentunderstanding.copyAnalyzerAsync
        // Step 1: Create the source analyzer
            ContentAnalyzerConfig sourceConfig = new ContentAnalyzerConfig();
            sourceConfig.setEnableFormula(false);
            sourceConfig.setEnableLayout(true);
            sourceConfig.setEnableOcr(true);
            sourceConfig.setEstimateFieldSourceAndConfidence(true);
            sourceConfig.setReturnDetails(true);

            Map<String, ContentFieldDefinition> fields = new HashMap<>();

            ContentFieldDefinition companyNameField = new ContentFieldDefinition();
            companyNameField.setType(ContentFieldType.STRING);
            companyNameField.setMethod(GenerationMethod.EXTRACT);
            companyNameField.setDescription("Name of the company");
            fields.put("company_name", companyNameField);

            ContentFieldDefinition totalAmountField = new ContentFieldDefinition();
            totalAmountField.setType(ContentFieldType.NUMBER);
            totalAmountField.setMethod(GenerationMethod.EXTRACT);
            totalAmountField.setDescription("Total amount on the document");
            fields.put("total_amount", totalAmountField);

            ContentFieldSchema sourceFieldSchema = new ContentFieldSchema();
            sourceFieldSchema.setName("company_schema");
            sourceFieldSchema.setDescription("Schema for extracting company information");
            sourceFieldSchema.setFields(fields);

            ContentAnalyzer sourceAnalyzer = new ContentAnalyzer();
            sourceAnalyzer.setBaseAnalyzerId("prebuilt-document");
            sourceAnalyzer.setDescription("Source analyzer for copying");
            sourceAnalyzer.setConfig(sourceConfig);
            sourceAnalyzer.setFieldSchema(sourceFieldSchema);

            Map<String, String> models = new HashMap<>();
            models.put("completion", "gpt-4.1");
            sourceAnalyzer.setModels(models);

            Map<String, String> tags = new HashMap<>();
            tags.put("modelType", "in_development");
            sourceAnalyzer.setTags(tags);

            // Create source analyzer using reactive pattern
            PollerFlux<com.azure.ai.contentunderstanding.models.ContentAnalyzerOperationStatus, ContentAnalyzer> createPoller
                = client.beginCreateAnalyzer(finalSourceAnalyzerId, sourceAnalyzer, true);
            
            createPoller.last()
                .flatMap(pollResponse -> {
                    if (pollResponse.getStatus().isComplete()) {
                        System.out.println("Polling completed successfully");
                        return pollResponse.getFinalResult();
                    } else {
                        return Mono.error(new RuntimeException(
                            "Polling completed unsuccessfully with status: " + pollResponse.getStatus()));
                    }
                })
                .doOnNext(sourceResult -> {
                    System.out.println("Source analyzer '" + finalSourceAnalyzerId + "' created successfully!");
                })
                .flatMap(sourceResult -> {
                    // Step 2: Copy the source analyzer to target
                    // Note: This copies within the same resource
                    PollerFlux<com.azure.ai.contentunderstanding.models.ContentAnalyzerOperationStatus, ContentAnalyzer> copyPoller
                        = client.beginCopyAnalyzer(finalTargetAnalyzerId, finalSourceAnalyzerId);
                    
                    return copyPoller.last()
                        .flatMap(pollResponse -> {
                            if (pollResponse.getStatus().isComplete()) {
                                System.out.println("Copy polling completed successfully");
                                return pollResponse.getFinalResult();
                            } else {
                                return Mono.error(new RuntimeException(
                                    "Copy polling completed unsuccessfully with status: " + pollResponse.getStatus()));
                            }
                        })
                        .map(copiedAnalyzer -> {
                            System.out.println("Analyzer copied to '" + finalTargetAnalyzerId + "' successfully!");
                            // Store both results for use in doOnNext
                            return new java.util.AbstractMap.SimpleEntry<>(sourceResult, copiedAnalyzer);
                        });
                })
                .doOnNext(entry -> {
                    ContentAnalyzer sourceResult = entry.getKey();
                    ContentAnalyzer copiedAnalyzer = entry.getValue();
                    
                    // ========== VERIFICATION: Source Analyzer Creation ==========
                    System.out.println("\nðŸ“‹ Source Analyzer Creation Verification:");
                    System.out.println("  âœ“ Analyzer IDs validated");
                    System.out.println("    Source: " + finalSourceAnalyzerId);
                    System.out.println("    Target: " + finalTargetAnalyzerId);
                    System.out.println("  âœ“ Source config verified");
                    System.out.println("  âœ“ Source field schema verified: " + sourceFieldSchema.getName());
                    System.out.println("    âœ“ company_name field verified");
                    System.out.println("    âœ“ total_amount field verified");
                    System.out.println("  âœ“ Source analyzer object verified");
                    System.out.println("  âœ“ Source analyzer created: " + finalSourceAnalyzerId);
                    System.out.println("  âœ“ Config preserved in result");
                    System.out.println("  âœ“ Field schema preserved: " + sourceResult.getFieldSchema().getFields().size() + " fields");
                    System.out.println("  âœ“ Tags preserved: " + sourceResult.getTags().size() + " tag(s)");
                    System.out.println("  âœ“ Models preserved: " + sourceResult.getModels().size() + " model(s)");

                    System.out.println("\nâœ… Source analyzer creation completed:");
                    System.out.println("    ID: " + finalSourceAnalyzerId);
                    System.out.println("    Base: " + sourceResult.getBaseAnalyzerId());
                    System.out.println("    Fields: " + sourceResult.getFieldSchema().getFields().size());
                    System.out.println("    Tags: " + sourceResult.getTags().size());
                    System.out.println("    Models: " + sourceResult.getModels().size());

                    // ========== VERIFICATION: Analyzer Copy Operation ==========
                    System.out.println("\nðŸ“‹ Analyzer Copy Verification:");
                    System.out.println("  âœ“ Copy operation completed");
                    System.out.println("  âœ“ Base properties preserved");
                    System.out.println("    Base analyzer ID: " + copiedAnalyzer.getBaseAnalyzerId());
                    System.out.println("    Description: '" + copiedAnalyzer.getDescription() + "'");
                    System.out.println("  âœ“ Field schema structure preserved");
                    System.out.println("    Schema: " + copiedAnalyzer.getFieldSchema().getName());
                    System.out.println("    Fields: " + copiedAnalyzer.getFieldSchema().getFields().size());

                    ContentFieldDefinition copiedCompanyField = copiedAnalyzer.getFieldSchema().getFields().get("company_name");
                    System.out.println("    âœ“ company_name field: " + copiedCompanyField.getType() + " / "
                        + copiedCompanyField.getMethod());

                    ContentFieldDefinition copiedAmountField = copiedAnalyzer.getFieldSchema().getFields().get("total_amount");
                    System.out.println("    âœ“ total_amount field: " + copiedAmountField.getType() + " / "
                        + copiedAmountField.getMethod());

                    System.out.println("  âœ“ Tags preserved: " + copiedAnalyzer.getTags().size() + " tag(s)");
                    System.out.println("    modelType=" + copiedAnalyzer.getTags().get("modelType"));

                    System.out.println("  âœ“ Config preserved");
                    System.out.println("    EnableLayout: " + copiedAnalyzer.getConfig().isEnableLayout());
                    System.out.println("    EnableOcr: " + copiedAnalyzer.getConfig().isEnableOcr());

                    if (copiedAnalyzer.getModels().containsKey("completion")) {
                        System.out.println("  âœ“ Models preserved: " + copiedAnalyzer.getModels().size() + " model(s)");
                        System.out.println("    completion=" + copiedAnalyzer.getModels().get("completion"));
                    }

                    // Summary
                    String separator = new String(new char[60]).replace("\0", "â•");
                    System.out.println("\n" + separator);
                    System.out.println("âœ… ANALYZER COPY VERIFICATION COMPLETED SUCCESSFULLY");
                    System.out.println(separator);
                    System.out.println("Source Analyzer:");
                    System.out.println("  ID:          " + finalSourceAnalyzerId);
                    System.out.println("  Base:        " + sourceResult.getBaseAnalyzerId());
                    System.out.println("  Description: " + sourceResult.getDescription());
                    System.out.println("  Fields:      " + sourceResult.getFieldSchema().getFields().size());
                    System.out.println("  Tags:        " + sourceResult.getTags().size());
                    System.out.println("  Models:      " + sourceResult.getModels().size());
                    System.out.println("\nTarget Analyzer (Copied):");
                    System.out.println("  ID:          " + finalTargetAnalyzerId);
                    System.out.println("  Base:        " + copiedAnalyzer.getBaseAnalyzerId());
                    System.out.println("  Description: " + copiedAnalyzer.getDescription());
                    System.out.println("  Fields:      " + copiedAnalyzer.getFieldSchema().getFields().size());
                    System.out.println("  Tags:        " + copiedAnalyzer.getTags().size());
                    System.out.println("  Models:      " + copiedAnalyzer.getModels().size());
                    System.out.println("\nâœ… All properties successfully copied and verified!");
                    System.out.println(separator);
                })
                .then(client.getAnalyzer(finalSourceAnalyzerId))
                .doOnNext(sourceAnalyzerInfo -> {
                    System.out.println("\nðŸ“‹ Source Analyzer Retrieval Verification:");
                    System.out.println("  âœ“ Source analyzer retrieved successfully");
                    System.out.println("    Description: " + sourceAnalyzerInfo.getDescription());
                    System.out.println("    Tags: " + String.join(", ",
                        sourceAnalyzerInfo.getTags()
                            .entrySet()
                            .stream()
                            .map(e -> e.getKey() + "=" + e.getValue())
                            .toArray(String[]::new)));
                })
                .then(client.getAnalyzer(finalTargetAnalyzerId))
                .doOnNext(verifiedCopy -> {
                    System.out.println("\nðŸ“‹ Copied Analyzer Retrieval Verification:");
                    System.out.println("  âœ“ Copied analyzer verified via retrieval");
                })
                .then(Mono.fromRunnable(() -> {
                    // Cleanup: Delete the analyzers
                    System.out.println("\nCleaning up analyzers...");
                }))
                .then(client.deleteAnalyzer(finalSourceAnalyzerId)
                    .onErrorResume(e -> {
                        System.out.println("Note: Failed to delete source analyzer (may not exist): " + e.getMessage());
                        return Mono.empty();
                    })
                    .doOnSuccess(v -> System.out.println("Source analyzer deleted: " + finalSourceAnalyzerId))
                )
                .then(client.deleteAnalyzer(finalTargetAnalyzerId)
                    .onErrorResume(e -> {
                        System.out.println("Note: Failed to delete target analyzer (may not exist): " + e.getMessage());
                        return Mono.empty();
                    })
                    .doOnSuccess(v -> System.out.println("Target analyzer deleted: " + finalTargetAnalyzerId))
                )
                .doOnError(error -> {
                    System.err.println("Error: " + error.getMessage());
                    error.printStackTrace();
                })
                .subscribe(
                    result -> {
                        // Success - operations completed
                    },
                    error -> {
                        // Error already handled in doOnError
                        // Still try to cleanup
                        client.deleteAnalyzer(finalSourceAnalyzerId)
                            .onErrorResume(e -> Mono.empty())
                            .subscribe();
                        client.deleteAnalyzer(finalTargetAnalyzerId)
                            .onErrorResume(e -> Mono.empty())
                            .subscribe();
                        System.exit(1);
                    }
                );
        // END: com.azure.ai.contentunderstanding.copyAnalyzerAsync

        // The .subscribe() creation is not a blocking call. For the purpose of this example,
        // we sleep the thread so the program does not end before the async operations complete.
        try {
            TimeUnit.SECONDS.sleep(60);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            e.printStackTrace();
        }
    }
}
