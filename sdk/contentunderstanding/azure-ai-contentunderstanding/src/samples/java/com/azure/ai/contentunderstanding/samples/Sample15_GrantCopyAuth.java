// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
// Code generated by Microsoft (R) TypeSpec Code Generator.

package com.azure.ai.contentunderstanding.samples;

import com.azure.ai.contentunderstanding.ContentUnderstandingClient;
import com.azure.ai.contentunderstanding.ContentUnderstandingClientBuilder;
import com.azure.ai.contentunderstanding.models.ContentAnalyzer;
import com.azure.ai.contentunderstanding.models.ContentAnalyzerConfig;
import com.azure.ai.contentunderstanding.models.ContentAnalyzerOperationStatus;
import com.azure.ai.contentunderstanding.models.ContentFieldDefinition;
import com.azure.ai.contentunderstanding.models.CopyAuthorization;
import com.azure.ai.contentunderstanding.models.ContentFieldSchema;
import com.azure.ai.contentunderstanding.models.ContentFieldType;
import com.azure.ai.contentunderstanding.models.GenerationMethod;
import com.azure.core.credential.AzureKeyCredential;
import com.azure.core.util.polling.SyncPoller;
import com.azure.identity.DefaultAzureCredentialBuilder;

import java.util.HashMap;
import java.util.Map;

/**
 * Sample demonstrates how to grant copy authorization and copy an analyzer from a source
 * Microsoft Foundry resource to a target Microsoft Foundry resource (cross-resource copying).
 *
 * <p>For same-resource copying, see Sample14_CopyAnalyzer.</p>
 *
 * <p>Required environment variables:</p>
 * <ul>
 *   <li>CONTENTUNDERSTANDING_ENDPOINT: Source resource endpoint</li>
 *   <li>CONTENTUNDERSTANDING_KEY (optional): API key for source resource</li>
 *   <li>SOURCE_RESOURCE_ID: Azure resource ID of the source resource</li>
 *   <li>SOURCE_REGION: Region of the source resource</li>
 *   <li>TARGET_ENDPOINT: Endpoint of the target resource</li>
 *   <li>TARGET_KEY (optional): API key for target resource</li>
 *   <li>TARGET_RESOURCE_ID: Azure resource ID of the target resource</li>
 *   <li>TARGET_REGION: Region of the target resource</li>
 * </ul>
 *
 * <p>Note: If API keys are not provided, DefaultAzureCredential will be used.
 * Cross-resource copying with DefaultAzureCredential requires 'Cognitive Services User' role
 * on both source and target resources.</p>
 */
public class Sample15_GrantCopyAuth {

    public static void main(String[] args) {
        // Get configuration from environment variables
        String sourceEndpoint = System.getenv("CONTENTUNDERSTANDING_ENDPOINT");
        String sourceKey = System.getenv("CONTENTUNDERSTANDING_KEY");
        String sourceResourceId = System.getenv("SOURCE_RESOURCE_ID");
        String sourceRegion = System.getenv("SOURCE_REGION");
        String targetEndpoint = System.getenv("TARGET_ENDPOINT");
        String targetKey = System.getenv("TARGET_KEY");
        String targetResourceId = System.getenv("TARGET_RESOURCE_ID");
        String targetRegion = System.getenv("TARGET_REGION");

        // Validate required environment variables
        if (sourceEndpoint == null || targetEndpoint == null || sourceResourceId == null
            || targetResourceId == null || sourceRegion == null || targetRegion == null) {
            System.out.println("Cross-resource copying requires the following environment variables:");
            System.out.println("  - CONTENTUNDERSTANDING_ENDPOINT: Source resource endpoint");
            System.out.println("  - CONTENTUNDERSTANDING_KEY (optional): API key for source resource");
            System.out.println("  - SOURCE_RESOURCE_ID: Azure resource ID of the source resource");
            System.out.println("  - SOURCE_REGION: Region of the source resource");
            System.out.println("  - TARGET_ENDPOINT: Endpoint of the target resource");
            System.out.println("  - TARGET_KEY (optional): API key for target resource");
            System.out.println("  - TARGET_RESOURCE_ID: Azure resource ID of the target resource");
            System.out.println("  - TARGET_REGION: Region of the target resource");
            return;
        }

        // BEGIN: com.azure.ai.contentunderstanding.grantCopyAuth
        // Build source client with appropriate authentication
        ContentUnderstandingClientBuilder sourceBuilder = new ContentUnderstandingClientBuilder()
            .endpoint(sourceEndpoint);
        ContentUnderstandingClient sourceClient;
        if (sourceKey != null && !sourceKey.trim().isEmpty()) {
            sourceClient = sourceBuilder.credential(new AzureKeyCredential(sourceKey)).buildClient();
        } else {
            sourceClient = sourceBuilder.credential(new DefaultAzureCredentialBuilder().build()).buildClient();
        }

        // Build target client with appropriate authentication
        ContentUnderstandingClientBuilder targetBuilder = new ContentUnderstandingClientBuilder()
            .endpoint(targetEndpoint);
        ContentUnderstandingClient targetClient;
        if (targetKey != null && !targetKey.trim().isEmpty()) {
            targetClient = targetBuilder.credential(new AzureKeyCredential(targetKey)).buildClient();
        } else {
            targetClient = targetBuilder.credential(new DefaultAzureCredentialBuilder().build()).buildClient();
        }

        String sourceAnalyzerId = "my_source_analyzer";
        String targetAnalyzerId = "my_target_analyzer";

        // Step 1: Create the source analyzer
        ContentAnalyzerConfig config = new ContentAnalyzerConfig();
        config.setEnableLayout(true);
        config.setEnableOcr(true);

        Map<String, ContentFieldDefinition> fields = new HashMap<>();
        ContentFieldDefinition companyNameField = new ContentFieldDefinition();
        companyNameField.setType(ContentFieldType.STRING);
        companyNameField.setMethod(GenerationMethod.EXTRACT);
        companyNameField.setDescription("Name of the company");
        fields.put("company_name", companyNameField);

        ContentFieldDefinition totalAmountField = new ContentFieldDefinition();
        totalAmountField.setType(ContentFieldType.NUMBER);
        totalAmountField.setMethod(GenerationMethod.EXTRACT);
        totalAmountField.setDescription("Total amount on the document");
        fields.put("total_amount", totalAmountField);

        ContentFieldSchema fieldSchema = new ContentFieldSchema();
        fieldSchema.setName("company_schema");
        fieldSchema.setDescription("Schema for extracting company information");
        fieldSchema.setFields(fields);

        ContentAnalyzer sourceAnalyzer = new ContentAnalyzer();
        sourceAnalyzer.setBaseAnalyzerId("prebuilt-document");
        sourceAnalyzer.setDescription("Source analyzer for cross-resource copying");
        sourceAnalyzer.setConfig(config);
        sourceAnalyzer.setFieldSchema(fieldSchema);

        Map<String, String> models = new HashMap<>();
        models.put("completion", "gpt-4.1");
        sourceAnalyzer.setModels(models);

        SyncPoller<ContentAnalyzerOperationStatus, ContentAnalyzer> createPoller
            = sourceClient.beginCreateAnalyzer(sourceAnalyzerId, sourceAnalyzer);
        ContentAnalyzer sourceResult = createPoller.getFinalResult();
        System.out.println("Source analyzer '" + sourceAnalyzerId + "' created successfully!");

        try {
            // Step 2: Grant copy authorization on source client
            CopyAuthorization copyAuth = sourceClient.grantCopyAuthorization(
                sourceAnalyzerId, targetResourceId, targetRegion);

            System.out.println("Copy authorization granted successfully!");
            System.out.println("  Target Azure Resource ID: " + copyAuth.getTargetAzureResourceId());
            System.out.println("  Expires at: " + copyAuth.getExpiresAt());

            // Step 3: Copy analyzer to target resource using target client
            SyncPoller<ContentAnalyzerOperationStatus, ContentAnalyzer> copyPoller
                = targetClient.beginCopyAnalyzer(targetAnalyzerId, sourceAnalyzerId, false,
                    sourceResourceId, sourceRegion);

            ContentAnalyzer targetResult = copyPoller.getFinalResult();
            System.out.println("Target analyzer '" + targetAnalyzerId + "' copied successfully!");
            System.out.println("  Description: " + targetResult.getDescription());
            // END: com.azure.ai.contentunderstanding.grantCopyAuth

        } finally {
            // Cleanup: delete both analyzers
            try {
                sourceClient.deleteAnalyzer(sourceAnalyzerId);
                System.out.println("Source analyzer '" + sourceAnalyzerId + "' deleted.");
            } catch (Exception e) {
                // Ignore cleanup errors
            }

            try {
                targetClient.deleteAnalyzer(targetAnalyzerId);
                System.out.println("Target analyzer '" + targetAnalyzerId + "' deleted.");
            } catch (Exception e) {
                // Ignore cleanup errors
            }
        }
    }
}
