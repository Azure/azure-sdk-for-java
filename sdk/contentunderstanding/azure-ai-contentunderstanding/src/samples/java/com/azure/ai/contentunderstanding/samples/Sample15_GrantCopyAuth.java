// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
// Code generated by Microsoft (R) TypeSpec Code Generator.

package com.azure.ai.contentunderstanding.samples;

import com.azure.ai.contentunderstanding.ContentUnderstandingClient;
import com.azure.ai.contentunderstanding.ContentUnderstandingClientBuilder;
import com.azure.ai.contentunderstanding.models.ContentAnalyzer;
import com.azure.ai.contentunderstanding.models.ContentAnalyzerConfig;
import com.azure.ai.contentunderstanding.models.ContentFieldDefinition;
import com.azure.ai.contentunderstanding.models.ContentFieldSchema;
import com.azure.ai.contentunderstanding.models.ContentFieldType;
import com.azure.ai.contentunderstanding.models.GenerationMethod;
import com.azure.core.credential.AzureKeyCredential;
import com.azure.core.util.polling.SyncPoller;
import com.azure.identity.DefaultAzureCredentialBuilder;

import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

/**
 * Sample demonstrates how to grant copy authorization for cross-resource analyzer copying.
 * 
 * Note: This sample demonstrates the API pattern for cross-resource copying.
 * For same-resource copying, see Sample14_CopyAnalyzer.
 * 
 * Required environment variables for cross-resource copying:
 * - SOURCE_RESOURCE_ID: Azure resource ID of the source resource
 * - SOURCE_REGION: Region of the source resource
 * - TARGET_ENDPOINT: Endpoint of the target resource
 * - TARGET_RESOURCE_ID: Azure resource ID of the target resource
 * - TARGET_REGION: Region of the target resource
 * - TARGET_KEY (optional): API key for the target resource
 */
public class Sample15_GrantCopyAuth {

    public static void main(String[] args) {
        // BEGIN: com.azure.ai.contentunderstanding.sample15.buildClient
        String endpoint = System.getenv("CONTENTUNDERSTANDING_ENDPOINT");
        String key = System.getenv("AZURE_CONTENT_UNDERSTANDING_KEY");

        // Build the client with appropriate authentication
        ContentUnderstandingClientBuilder builder = new ContentUnderstandingClientBuilder().endpoint(endpoint);

        ContentUnderstandingClient sourceClient;
        if (key != null && !key.trim().isEmpty()) {
            // Use API key authentication
            sourceClient = builder.credential(new AzureKeyCredential(key)).buildClient();
        } else {
            // Use default Azure credential (for managed identity, Azure CLI, etc.)
            sourceClient = builder.credential(new DefaultAzureCredentialBuilder().build()).buildClient();
        }
        // END: com.azure.ai.contentunderstanding.sample15.buildClient

        System.out.println("Client initialized successfully");

        String sourceAnalyzerId = "test_grant_copy_source_" + UUID.randomUUID().toString().replace("-", "");

        try {
            // BEGIN: com.azure.ai.contentunderstanding.grantCopyAuth
            // Step 1: Create the source analyzer
            ContentAnalyzerConfig config = new ContentAnalyzerConfig();
            config.setEnableLayout(true);
            config.setEnableOcr(true);

            Map<String, ContentFieldDefinition> fields = new HashMap<>();
            ContentFieldDefinition companyNameField = new ContentFieldDefinition();
            companyNameField.setType(ContentFieldType.STRING);
            companyNameField.setMethod(GenerationMethod.EXTRACT);
            companyNameField.setDescription("Name of the company");
            fields.put("company_name", companyNameField);

            ContentFieldDefinition totalAmountField = new ContentFieldDefinition();
            totalAmountField.setType(ContentFieldType.NUMBER);
            totalAmountField.setMethod(GenerationMethod.EXTRACT);
            totalAmountField.setDescription("Total amount");
            fields.put("total_amount", totalAmountField);

            ContentFieldSchema fieldSchema = new ContentFieldSchema();
            fieldSchema.setName("company_schema");
            fieldSchema.setDescription("Schema for extracting company information");
            fieldSchema.setFields(fields);

            ContentAnalyzer sourceAnalyzer = new ContentAnalyzer();
            sourceAnalyzer.setBaseAnalyzerId("prebuilt-document");
            sourceAnalyzer.setDescription("Source analyzer for cross-resource copying");
            sourceAnalyzer.setConfig(config);
            sourceAnalyzer.setFieldSchema(fieldSchema);

            Map<String, String> models = new HashMap<>();
            models.put("completion", "gpt-4.1");
            sourceAnalyzer.setModels(models);

            SyncPoller<com.azure.ai.contentunderstanding.models.ContentAnalyzerOperationStatus, ContentAnalyzer> createPoller
                = sourceClient.beginCreateAnalyzer(sourceAnalyzerId, sourceAnalyzer);
            ContentAnalyzer sourceResult = createPoller.getFinalResult();
            System.out.println("Source analyzer '" + sourceAnalyzerId + "' created successfully!");

            // Step 2: Grant copy authorization (requires target resource information)
            // For cross-resource copying, you would use:
            //
            // String targetResourceId = "/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.CognitiveServices/accounts/{name}";
            // String targetRegion = "westus";
            //
            // BinaryData requestBody = BinaryData.fromString(String.format(
            //     "{\"targetAzureResourceId\":\"%s\",\"targetRegion\":\"%s\"}",
            //     targetResourceId, targetRegion));
            //
            // RequestOptions requestOptions = new RequestOptions();
            // Response<BinaryData> authResponse = sourceClient.grantCopyAuthorizationWithResponse(
            //     sourceAnalyzerId, requestBody, requestOptions);
            //
            // // Parse the authorization response
            // String authJson = authResponse.getValue().toString();
            // System.out.println("Copy authorization granted!");
            // System.out.println("  Target Resource ID: " + targetResourceId);
            // System.out.println("  Target Region: " + targetRegion);
            //
            // Step 3: Copy to target resource (from target client)
            // ContentUnderstandingClient targetClient = new ContentUnderstandingClientBuilder()
            //     .endpoint(targetEndpoint)
            //     .credential(new AzureKeyCredential(targetKey))
            //     .buildClient();
            //
            // String sourceResourceId = "/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.CognitiveServices/accounts/{name}";
            // String sourceRegion = "eastus";
            //
            // BinaryData copyRequestBody = BinaryData.fromString(String.format(
            //     "{\"sourceAnalyzerId\":\"%s\",\"sourceAzureResourceId\":\"%s\",\"sourceRegion\":\"%s\"}",
            //     sourceAnalyzerId, sourceResourceId, sourceRegion));
            //
            // SyncPoller<BinaryData, BinaryData> copyPoller = targetClient.beginCopyAnalyzer(
            //     targetAnalyzerId, copyRequestBody, requestOptions);
            // BinaryData copyResult = copyPoller.getFinalResult();
            // System.out.println("Analyzer copied to target resource successfully!");
            // END: com.azure.ai.contentunderstanding.grantCopyAuth

            // Verify source analyzer creation
            System.out.println("\nðŸ“‹ Source Analyzer Creation Verification:");
            System.out.println("Source analyzer created successfully");
            System.out.println("  ID: " + sourceAnalyzerId);
            System.out.println("  Base: " + sourceResult.getBaseAnalyzerId());
            System.out.println("  Fields: " + sourceResult.getFieldSchema().getFields().size());

            // Display API pattern information
            System.out.println("\nðŸ“š GrantCopyAuthorization API Pattern:");
            System.out.println("   For cross-resource copying:");
            System.out.println("   1. Create source analyzer in source resource");
            System.out.println("   2. Call grantCopyAuthorizationWithResponse on source client:");
            System.out.println("      Request body: {\"targetAzureResourceId\":\"...\",\"targetRegion\":\"...\"}");
            System.out.println("   3. Use target client to call beginCopyAnalyzer:");
            System.out.println(
                "      Request body: {\"sourceAnalyzerId\":\"...\",\"sourceAzureResourceId\":\"...\",\"sourceRegion\":\"...\"}");
            System.out.println("   4. Wait for copy operation to complete");

            System.out.println("\nâœ… GrantCopyAuth pattern demonstration completed");
            System.out.println("   Note: This sample demonstrates the API pattern.");
            System.out.println("   For actual cross-resource copying, provide resource IDs and regions.");

        } catch (Exception e) {
            System.err.println("Error: " + e.getMessage());
            e.printStackTrace();
        } finally {
            // Cleanup
            try {
                sourceClient.deleteAnalyzer(sourceAnalyzerId);
                System.out.println("\nSource analyzer deleted: " + sourceAnalyzerId);
            } catch (Exception e) {
                System.out.println("Note: Failed to delete source analyzer: " + e.getMessage());
            }
        }
    }
}
