// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
// Code generated by Microsoft (R) TypeSpec Code Generator.

package com.azure.ai.contentunderstanding.samples;

import com.azure.ai.contentunderstanding.ContentUnderstandingClient;
import com.azure.ai.contentunderstanding.ContentUnderstandingClientBuilder;
import com.azure.ai.contentunderstanding.models.ContentAnalyzer;
import com.azure.ai.contentunderstanding.models.ContentAnalyzerConfig;
import com.azure.ai.contentunderstanding.models.ContentFieldDefinition;
import com.azure.ai.contentunderstanding.models.CopyAuthorization;
import com.azure.ai.contentunderstanding.models.ContentFieldSchema;
import com.azure.ai.contentunderstanding.models.ContentFieldType;
import com.azure.ai.contentunderstanding.models.GenerationMethod;
import com.azure.core.credential.AzureKeyCredential;
import com.azure.core.util.polling.SyncPoller;
import com.azure.identity.DefaultAzureCredentialBuilder;

import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

/**
 * Sample demonstrates how to grant copy authorization for cross-resource analyzer copying.
 *
 * Note: This sample demonstrates the API pattern for cross-resource copying.
 * For same-resource copying, see Sample14_CopyAnalyzer.
 *
 * Required environment variables for cross-resource copying:
 * - SOURCE_RESOURCE_ID: Azure resource ID of the source resource
 * - SOURCE_REGION: Region of the source resource
 * - TARGET_ENDPOINT: Endpoint of the target resource
 * - TARGET_RESOURCE_ID: Azure resource ID of the target resource
 * - TARGET_REGION: Region of the target resource
 * - TARGET_KEY (optional): API key for the target resource
 */
public class Sample15_GrantCopyAuth {

    public static void main(String[] args) {
        // BEGIN: com.azure.ai.contentunderstanding.sample15.buildClient
        String endpoint = System.getenv("CONTENTUNDERSTANDING_ENDPOINT");
        String key = System.getenv("AZURE_CONTENT_UNDERSTANDING_KEY");

        // Build the client with appropriate authentication
        ContentUnderstandingClientBuilder builder = new ContentUnderstandingClientBuilder().endpoint(endpoint);

        ContentUnderstandingClient sourceClient;
        if (key != null && !key.trim().isEmpty()) {
            // Use API key authentication
            sourceClient = builder.credential(new AzureKeyCredential(key)).buildClient();
        } else {
            // Use default Azure credential (for managed identity, Azure CLI, etc.)
            sourceClient = builder.credential(new DefaultAzureCredentialBuilder().build()).buildClient();
        }
        // END: com.azure.ai.contentunderstanding.sample15.buildClient

        System.out.println("Client initialized successfully");

        String sourceAnalyzerId = "test_grant_copy_source_" + UUID.randomUUID().toString().replace("-", "");

        try {
            // BEGIN: com.azure.ai.contentunderstanding.grantCopyAuth
            // Step 1: Create the source analyzer
            ContentAnalyzerConfig config = new ContentAnalyzerConfig();
            config.setEnableLayout(true);
            config.setEnableOcr(true);

            Map<String, ContentFieldDefinition> fields = new HashMap<>();
            ContentFieldDefinition companyNameField = new ContentFieldDefinition();
            companyNameField.setType(ContentFieldType.STRING);
            companyNameField.setMethod(GenerationMethod.EXTRACT);
            companyNameField.setDescription("Name of the company");
            fields.put("company_name", companyNameField);

            ContentFieldDefinition totalAmountField = new ContentFieldDefinition();
            totalAmountField.setType(ContentFieldType.NUMBER);
            totalAmountField.setMethod(GenerationMethod.EXTRACT);
            totalAmountField.setDescription("Total amount");
            fields.put("total_amount", totalAmountField);

            ContentFieldSchema fieldSchema = new ContentFieldSchema();
            fieldSchema.setName("company_schema");
            fieldSchema.setDescription("Schema for extracting company information");
            fieldSchema.setFields(fields);

            ContentAnalyzer sourceAnalyzer = new ContentAnalyzer();
            sourceAnalyzer.setBaseAnalyzerId("prebuilt-document");
            sourceAnalyzer.setDescription("Source analyzer for cross-resource copying");
            sourceAnalyzer.setConfig(config);
            sourceAnalyzer.setFieldSchema(fieldSchema);

            Map<String, String> models = new HashMap<>();
            models.put("completion", "gpt-4.1");
            sourceAnalyzer.setModels(models);

            SyncPoller<com.azure.ai.contentunderstanding.models.ContentAnalyzerOperationStatus, ContentAnalyzer> createPoller
                = sourceClient.beginCreateAnalyzer(sourceAnalyzerId, sourceAnalyzer);
            ContentAnalyzer sourceResult = createPoller.getFinalResult();
            System.out.println("Source analyzer '" + sourceAnalyzerId + "' created successfully!");

            // Step 2: Grant copy authorization (requires target resource information)
            // For cross-resource copying, the target resource ID is required
            String targetResourceId = System.getenv("TARGET_RESOURCE_ID");
            String targetRegion = System.getenv("TARGET_REGION");

            if (targetResourceId != null && !targetResourceId.trim().isEmpty()) {
                // Use convenience method to grant copy authorization
                CopyAuthorization copyAuth;
                if (targetRegion != null && !targetRegion.trim().isEmpty()) {
                    copyAuth = sourceClient.grantCopyAuthorization(sourceAnalyzerId, targetResourceId, targetRegion);
                } else {
                    copyAuth = sourceClient.grantCopyAuthorization(sourceAnalyzerId, targetResourceId);
                }

                System.out.println("Copy authorization granted!");
                System.out.println("  Target Resource ID: " + targetResourceId);
                System.out.println("  Target Region: " + (targetRegion != null ? targetRegion : "(default)"));
                System.out.println("  Authorization Expiry: " + copyAuth.getExpiresAt());

                // Step 3: Copy to target resource (from target client)
                // To complete the copy, use the target client with beginCopyAnalyzer convenience method:
                //
                // String targetEndpoint = System.getenv("TARGET_ENDPOINT");
                // String sourceResourceId = System.getenv("SOURCE_RESOURCE_ID");
                // String sourceRegion = System.getenv("SOURCE_REGION");
                // String targetAnalyzerId = "copied_analyzer_id";
                //
                // ContentUnderstandingClient targetClient = new ContentUnderstandingClientBuilder()
                //     .endpoint(targetEndpoint)
                //     .credential(new DefaultAzureCredentialBuilder().build())
                //     .buildClient();
                //
                // // Use convenience method - allowReplace=false, pass source resource info
                // SyncPoller<ContentAnalyzerOperationStatus, ContentAnalyzer> copyPoller =
                //     targetClient.beginCopyAnalyzer(targetAnalyzerId, sourceAnalyzerId, false, sourceResourceId, sourceRegion);
                // ContentAnalyzer copiedAnalyzer = copyPoller.getFinalResult();
                // System.out.println("Analyzer copied to target resource successfully!");
            } else {
                System.out.println("\nNote: TARGET_RESOURCE_ID not set. Skipping grantCopyAuthorization call.");
                System.out.println("To test cross-resource copying, set these environment variables:");
                System.out.println("  - TARGET_RESOURCE_ID: Azure resource ID of the target resource");
                System.out.println("  - TARGET_REGION (optional): Azure region of the target resource");
            }
            // END: com.azure.ai.contentunderstanding.grantCopyAuth

            // Verify source analyzer creation
            System.out.println("\nðŸ“‹ Source Analyzer Creation Verification:");
            System.out.println("Source analyzer created successfully");
            System.out.println("  ID: " + sourceAnalyzerId);
            System.out.println("  Base: " + sourceResult.getBaseAnalyzerId());
            System.out.println("  Fields: " + sourceResult.getFieldSchema().getFields().size());

            // Display API pattern information
            System.out.println("\nðŸ“š GrantCopyAuthorization API Usage:");
            System.out.println("   For cross-resource copying:");
            System.out.println("   1. Create source analyzer in source resource");
            System.out.println("   2. Call grantCopyAuthorization on source client:");
            System.out.println("      CopyAuthorization auth = sourceClient.grantCopyAuthorization(analyzerId, targetResourceId);");
            System.out.println("      // Or with region: grantCopyAuthorization(analyzerId, targetResourceId, targetRegion)");
            System.out.println("   3. Use target client to call beginCopyAnalyzer with the authorization");
            System.out.println("   4. Wait for copy operation to complete");

            System.out.println("\nâœ… GrantCopyAuth demonstration completed");

        } catch (Exception e) {
            System.err.println("Error: " + e.getMessage());
            e.printStackTrace();
        } finally {
            // Cleanup
            try {
                sourceClient.deleteAnalyzer(sourceAnalyzerId);
                System.out.println("\nSource analyzer deleted: " + sourceAnalyzerId);
            } catch (Exception e) {
                System.out.println("Note: Failed to delete source analyzer: " + e.getMessage());
            }
        }
    }
}
