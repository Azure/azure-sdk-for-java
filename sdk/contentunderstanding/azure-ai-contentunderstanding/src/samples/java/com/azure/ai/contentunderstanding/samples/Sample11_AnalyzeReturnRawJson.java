// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
// Code generated by Microsoft (R) TypeSpec Code Generator.

package com.azure.ai.contentunderstanding.samples;

import com.azure.ai.contentunderstanding.ContentUnderstandingClient;
import com.azure.ai.contentunderstanding.ContentUnderstandingClientBuilder;
import com.azure.core.credential.AzureKeyCredential;
import com.azure.core.http.rest.RequestOptions;
import com.azure.core.util.BinaryData;
import com.azure.core.util.Configuration;
import com.azure.core.util.polling.SyncPoller;
import com.azure.identity.DefaultAzureCredentialBuilder;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;

/**
 * Sample demonstrating how to analyze documents and get raw JSON response using protocol methods.
 * This sample shows:
 * 1. Using protocol method to get raw JSON response instead of strongly-typed objects
 * 2. Parsing raw JSON response
 * 3. Pretty-printing and saving JSON to file
 * 
 * Note: For production use, prefer the object model approach (beginAnalyzeBinary with typed parameters)
 * which returns AnalyzeResult objects that are easier to work with.
 */
public class Sample11_AnalyzeReturnRawJson {

    public static void main(String[] args) throws IOException {
        // BEGIN: com.azure.ai.contentunderstanding.sample11.buildClient
        String endpoint = Configuration.getGlobalConfiguration().get("CONTENTUNDERSTANDING_ENDPOINT");
        String key = System.getenv("AZURE_CONTENT_UNDERSTANDING_KEY");

        // Build the client with appropriate authentication
        ContentUnderstandingClientBuilder builder = new ContentUnderstandingClientBuilder().endpoint(endpoint);

        ContentUnderstandingClient client;
        if (key != null && !key.trim().isEmpty()) {
            // Use API key authentication
            client = builder.credential(new AzureKeyCredential(key)).buildClient();
        } else {
            // Use default Azure credential (for managed identity, Azure CLI, etc.)
            client = builder.credential(new DefaultAzureCredentialBuilder().build()).buildClient();
        }
        // END: com.azure.ai.contentunderstanding.sample11.buildClient

        System.out.println("Client initialized successfully");

        // BEGIN:ContentUnderstandingAnalyzeReturnRawJson
        // Load local test file
        Path filePath = Paths.get("src/test/resources/sample_invoice.pdf");
        byte[] fileBytes = Files.readAllBytes(filePath);

        // Prepare request body with binary data using JSON format
        // Note: The API expects a JSON request with "inputs" array containing document data
        String base64Data = java.util.Base64.getEncoder().encodeToString(fileBytes);
        String requestJson = String.format("{\"inputs\": [{\"data\": \"%s\"}]}", base64Data);
        BinaryData requestBody = BinaryData.fromString(requestJson);

        // Use protocol method to get raw JSON response
        // Note: For production use, prefer the object model approach (beginAnalyze with typed parameters)
        // which returns AnalyzeResult objects that are easier to work with
        SyncPoller<BinaryData, BinaryData> operation
            = client.beginAnalyze("prebuilt-documentSearch", requestBody, new RequestOptions());

        BinaryData responseData = operation.getFinalResult();
        // END:ContentUnderstandingAnalyzeReturnRawJson

        System.out.println("File loaded: " + filePath + " (" + String.format("%,d", fileBytes.length) + " bytes)");
        System.out.println("Analysis operation completed with status: " + operation.poll().getStatus());
        System.out.println("Response data size: " + String.format("%,d", responseData.toBytes().length) + " bytes");

        // Verify response data can be converted to string
        String responseString = responseData.toString();
        System.out.println("Response string length: " + String.format("%,d", responseString.length()) + " characters");

        // Verify response is valid JSON format
        try {
            ObjectMapper mapper = new ObjectMapper();
            JsonNode jsonNode = mapper.readTree(responseData.toBytes());
            System.out.println("Response is valid JSON format");
        } catch (Exception ex) {
            System.err.println("Response data is not valid JSON: " + ex.getMessage());
        }

        System.out.println("Raw JSON analysis operation completed successfully");

        // BEGIN:ContentUnderstandingParseRawJson
        // Parse the raw JSON response
        ObjectMapper mapper = new ObjectMapper();
        JsonNode jsonNode = mapper.readTree(responseData.toBytes());

        // Pretty-print the JSON
        String prettyJson = mapper.writerWithDefaultPrettyPrinter().writeValueAsString(jsonNode);

        // Create output directory if it doesn't exist
        Path outputDir = Paths.get("target/sample_output");
        Files.createDirectories(outputDir);

        // Save to file
        String timestamp = LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyyMMdd_HHmmss"));
        String outputFileName = "analyze_result_" + timestamp + ".json";
        Path outputPath = outputDir.resolve(outputFileName);
        Files.write(outputPath, prettyJson.getBytes(java.nio.charset.StandardCharsets.UTF_8));

        System.out.println("Raw JSON response saved to: " + outputPath);
        System.out.println("File size: " + String.format("%,d", prettyJson.length()) + " characters");
        // END:ContentUnderstandingParseRawJson

        System.out.println("JSON document parsed successfully");
        System.out.println("Pretty JSON generated: " + String.format("%,d", prettyJson.length()) + " characters");
        System.out.println("JSON is properly formatted with indentation");
        System.out.println("Output directory verified: " + outputDir);
        System.out.println("Output file name: " + outputFileName);
        System.out.println("Output file created: " + outputPath);
        long fileSize = Files.size(outputPath);
        System.out.println("Output file size verified: " + String.format("%,d", fileSize) + " bytes");
        System.out.println("Raw JSON parsing and saving completed successfully");
    }
}
