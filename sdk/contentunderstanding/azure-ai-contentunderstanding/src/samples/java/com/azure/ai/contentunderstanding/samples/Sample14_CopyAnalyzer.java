// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
// Code generated by Microsoft (R) TypeSpec Code Generator.

package com.azure.ai.contentunderstanding.samples;

import com.azure.ai.contentunderstanding.ContentUnderstandingClient;
import com.azure.ai.contentunderstanding.ContentUnderstandingClientBuilder;
import com.azure.ai.contentunderstanding.models.ContentAnalyzer;
import com.azure.ai.contentunderstanding.models.ContentAnalyzerConfig;
import com.azure.ai.contentunderstanding.models.ContentFieldDefinition;
import com.azure.ai.contentunderstanding.models.ContentFieldSchema;
import com.azure.ai.contentunderstanding.models.ContentFieldType;
import com.azure.ai.contentunderstanding.models.GenerationMethod;
import com.azure.core.credential.AzureKeyCredential;
import com.azure.core.util.polling.SyncPoller;
import com.azure.identity.DefaultAzureCredentialBuilder;

import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

/**
 * Sample demonstrates how to copy an analyzer within the same resource.
 * For cross-resource copying, see Sample15_GrantCopyAuth.
 */
public class Sample14_CopyAnalyzer {

    public static void main(String[] args) {
        // BEGIN: com.azure.ai.contentunderstanding.sample14.buildClient
        String endpoint = System.getenv("CONTENTUNDERSTANDING_ENDPOINT");
        String key = System.getenv("AZURE_CONTENT_UNDERSTANDING_KEY");

        // Build the client with appropriate authentication
        ContentUnderstandingClientBuilder builder = new ContentUnderstandingClientBuilder().endpoint(endpoint);

        ContentUnderstandingClient client;
        if (key != null && !key.trim().isEmpty()) {
            // Use API key authentication
            client = builder.credential(new AzureKeyCredential(key)).buildClient();
        } else {
            // Use default Azure credential (for managed identity, Azure CLI, etc.)
            client = builder.credential(new DefaultAzureCredentialBuilder().build()).buildClient();
        }
        // END: com.azure.ai.contentunderstanding.sample14.buildClient

        System.out.println("‚úì Client initialized successfully with endpoint: " + endpoint);

        // Generate unique analyzer IDs for this test
        String sourceAnalyzerId = "test_analyzer_source_" + UUID.randomUUID().toString().replace("-", "");
        String targetAnalyzerId = "test_analyzer_target_" + UUID.randomUUID().toString().replace("-", "");

        try {
            // BEGIN: com.azure.ai.contentunderstanding.copyAnalyzer
            // Step 1: Create the source analyzer
            ContentAnalyzerConfig sourceConfig = new ContentAnalyzerConfig();
            sourceConfig.setEnableFormula(false);
            sourceConfig.setEnableLayout(true);
            sourceConfig.setEnableOcr(true);
            sourceConfig.setEstimateFieldSourceAndConfidence(true);
            sourceConfig.setReturnDetails(true);

            Map<String, ContentFieldDefinition> fields = new HashMap<>();

            ContentFieldDefinition companyNameField = new ContentFieldDefinition();
            companyNameField.setType(ContentFieldType.STRING);
            companyNameField.setMethod(GenerationMethod.EXTRACT);
            companyNameField.setDescription("Name of the company");
            fields.put("company_name", companyNameField);

            ContentFieldDefinition totalAmountField = new ContentFieldDefinition();
            totalAmountField.setType(ContentFieldType.NUMBER);
            totalAmountField.setMethod(GenerationMethod.EXTRACT);
            totalAmountField.setDescription("Total amount on the document");
            fields.put("total_amount", totalAmountField);

            ContentFieldSchema sourceFieldSchema = new ContentFieldSchema();
            sourceFieldSchema.setName("company_schema");
            sourceFieldSchema.setDescription("Schema for extracting company information");
            sourceFieldSchema.setFields(fields);

            ContentAnalyzer sourceAnalyzer = new ContentAnalyzer();
            sourceAnalyzer.setBaseAnalyzerId("prebuilt-document");
            sourceAnalyzer.setDescription("Source analyzer for copying");
            sourceAnalyzer.setConfig(sourceConfig);
            sourceAnalyzer.setFieldSchema(sourceFieldSchema);

            Map<String, String> models = new HashMap<>();
            models.put("completion", "gpt-4.1");
            sourceAnalyzer.setModels(models);

            Map<String, String> tags = new HashMap<>();
            tags.put("modelType", "in_development");
            sourceAnalyzer.setTags(tags);

            // Create source analyzer
            SyncPoller<com.azure.ai.contentunderstanding.models.ContentAnalyzerOperationStatus, ContentAnalyzer> createPoller
                = client.beginCreateAnalyzer(sourceAnalyzerId, sourceAnalyzer, true);
            ContentAnalyzer sourceResult = createPoller.getFinalResult();
            System.out.println("Source analyzer '" + sourceAnalyzerId + "' created successfully!");

            // Step 2: Copy the source analyzer to target
            // Note: This copies within the same resource
            SyncPoller<com.azure.ai.contentunderstanding.models.ContentAnalyzerOperationStatus, ContentAnalyzer> copyPoller
                = client.beginCopyAnalyzer(targetAnalyzerId, sourceAnalyzerId);
            ContentAnalyzer copiedAnalyzer = copyPoller.getFinalResult();
            System.out.println("Analyzer copied to '" + targetAnalyzerId + "' successfully!");
            // END: com.azure.ai.contentunderstanding.copyAnalyzer

            // ========== VERIFICATION: Source Analyzer Creation ==========
            System.out.println("\nüìã Source Analyzer Creation Verification:");
            System.out.println("  ‚úì Analyzer IDs validated");
            System.out.println("    Source: " + sourceAnalyzerId);
            System.out.println("    Target: " + targetAnalyzerId);
            System.out.println("  ‚úì Source config verified");
            System.out.println("  ‚úì Source field schema verified: " + sourceFieldSchema.getName());
            System.out.println("    ‚úì company_name field verified");
            System.out.println("    ‚úì total_amount field verified");
            System.out.println("  ‚úì Source analyzer object verified");
            System.out.println("  ‚úì Source analyzer created: " + sourceAnalyzerId);
            System.out.println("  ‚úì Config preserved in result");
            System.out.println("  ‚úì Field schema preserved: " + sourceResult.getFieldSchema().getFields().size() + " fields");
            System.out.println("  ‚úì Tags preserved: " + sourceResult.getTags().size() + " tag(s)");
            System.out.println("  ‚úì Models preserved: " + sourceResult.getModels().size() + " model(s)");

            System.out.println("\n‚úÖ Source analyzer creation completed:");
            System.out.println("    ID: " + sourceAnalyzerId);
            System.out.println("    Base: " + sourceResult.getBaseAnalyzerId());
            System.out.println("    Fields: " + sourceResult.getFieldSchema().getFields().size());
            System.out.println("    Tags: " + sourceResult.getTags().size());
            System.out.println("    Models: " + sourceResult.getModels().size());

            // Get the source analyzer to verify retrieval
            ContentAnalyzer sourceAnalyzerInfo = client.getAnalyzer(sourceAnalyzerId);

            System.out.println("\nüìã Source Analyzer Retrieval Verification:");
            System.out.println("  ‚úì Source analyzer retrieved successfully");
            System.out.println("    Description: " + sourceAnalyzerInfo.getDescription());
            System.out.println("    Tags: " + String.join(", ",
                sourceAnalyzerInfo.getTags()
                    .entrySet()
                    .stream()
                    .map(e -> e.getKey() + "=" + e.getValue())
                    .toArray(String[]::new)));

            // ========== VERIFICATION: Analyzer Copy Operation ==========
            System.out.println("\nüìã Analyzer Copy Verification:");
            System.out.println("  ‚úì Copy operation completed");
            System.out.println("  ‚úì Base properties preserved");
            System.out.println("    Base analyzer ID: " + copiedAnalyzer.getBaseAnalyzerId());
            System.out.println("    Description: '" + copiedAnalyzer.getDescription() + "'");
            System.out.println("  ‚úì Field schema structure preserved");
            System.out.println("    Schema: " + copiedAnalyzer.getFieldSchema().getName());
            System.out.println("    Fields: " + copiedAnalyzer.getFieldSchema().getFields().size());

            ContentFieldDefinition copiedCompanyField = copiedAnalyzer.getFieldSchema().getFields().get("company_name");
            System.out.println(
                "    ‚úì company_name field: " + copiedCompanyField.getType() + " / " + copiedCompanyField.getMethod());

            ContentFieldDefinition copiedAmountField = copiedAnalyzer.getFieldSchema().getFields().get("total_amount");
            System.out.println(
                "    ‚úì total_amount field: " + copiedAmountField.getType() + " / " + copiedAmountField.getMethod());

            System.out.println("  ‚úì Tags preserved: " + copiedAnalyzer.getTags().size() + " tag(s)");
            System.out.println("    modelType=" + copiedAnalyzer.getTags().get("modelType"));

            System.out.println("  ‚úì Config preserved");
            System.out.println("    EnableLayout: " + copiedAnalyzer.getConfig().isEnableLayout());
            System.out.println("    EnableOcr: " + copiedAnalyzer.getConfig().isEnableOcr());

            if (copiedAnalyzer.getModels().containsKey("completion")) {
                System.out.println("  ‚úì Models preserved: " + copiedAnalyzer.getModels().size() + " model(s)");
                System.out.println("    completion=" + copiedAnalyzer.getModels().get("completion"));
            }

            // Verify the copied analyzer via Get operation
            ContentAnalyzer verifiedCopy = client.getAnalyzer(targetAnalyzerId);

            System.out.println("\nüìã Copied Analyzer Retrieval Verification:");
            System.out.println("  ‚úì Copied analyzer verified via retrieval");

            // Summary
            String separator = new String(new char[60]).replace("\0", "‚ïê");
            System.out.println("\n" + separator);
            System.out.println("‚úÖ ANALYZER COPY VERIFICATION COMPLETED SUCCESSFULLY");
            System.out.println(separator);
            System.out.println("Source Analyzer:");
            System.out.println("  ID:          " + sourceAnalyzerId);
            System.out.println("  Base:        " + sourceResult.getBaseAnalyzerId());
            System.out.println("  Description: " + sourceResult.getDescription());
            System.out.println("  Fields:      " + sourceResult.getFieldSchema().getFields().size());
            System.out.println("  Tags:        " + sourceResult.getTags().size());
            System.out.println("  Models:      " + sourceResult.getModels().size());
            System.out.println("\nTarget Analyzer (Copied):");
            System.out.println("  ID:          " + targetAnalyzerId);
            System.out.println("  Base:        " + copiedAnalyzer.getBaseAnalyzerId());
            System.out.println("  Description: " + copiedAnalyzer.getDescription());
            System.out.println("  Fields:      " + copiedAnalyzer.getFieldSchema().getFields().size());
            System.out.println("  Tags:        " + copiedAnalyzer.getTags().size());
            System.out.println("  Models:      " + copiedAnalyzer.getModels().size());
            System.out.println("\n‚úÖ All properties successfully copied and verified!");
            System.out.println(separator);

        } catch (Exception e) {
            System.err.println("Error: " + e.getMessage());
            e.printStackTrace();
        } finally {
            // Cleanup: Delete the analyzers
            try {
                client.deleteAnalyzer(sourceAnalyzerId);
                System.out.println("\nSource analyzer deleted: " + sourceAnalyzerId);
            } catch (Exception e) {
                System.out.println("Note: Failed to delete source analyzer (may not exist): " + e.getMessage());
            }

            try {
                client.deleteAnalyzer(targetAnalyzerId);
                System.out.println("Target analyzer deleted: " + targetAnalyzerId);
            } catch (Exception e) {
                System.out.println("Note: Failed to delete target analyzer (may not exist): " + e.getMessage());
            }
        }
    }
}
