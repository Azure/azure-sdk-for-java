// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
// Code generated by Microsoft (R) TypeSpec Code Generator.

package com.azure.ai.contentunderstanding.samples;

import com.azure.ai.contentunderstanding.ContentUnderstandingAsyncClient;
import com.azure.ai.contentunderstanding.ContentUnderstandingClientBuilder;
import com.azure.ai.contentunderstanding.models.ContentAnalyzer;
import com.azure.ai.contentunderstanding.models.ContentAnalyzerConfig;
import com.azure.ai.contentunderstanding.models.ContentFieldDefinition;
import com.azure.ai.contentunderstanding.models.ContentFieldSchema;
import com.azure.ai.contentunderstanding.models.ContentFieldType;
import com.azure.ai.contentunderstanding.models.GenerationMethod;
import com.azure.core.credential.AzureKeyCredential;
import com.azure.core.util.polling.PollerFlux;
import com.azure.identity.DefaultAzureCredentialBuilder;

import java.util.HashMap;
import java.util.Map;

/**
 * Sample demonstrating how to update an existing analyzer asynchronously.
 * This sample shows:
 * 1. Creating an analyzer
 * 2. Updating analyzer description
 * 3. Updating analyzer configuration
 * 4. Updating field schema
 */
public class Sample08_UpdateAnalyzerAsync {

    private static String analyzerId;

    public static void main(String[] args) {
        // BEGIN: com.azure.ai.contentunderstanding.sample08Async.buildClient
        String endpoint = System.getenv("CONTENTUNDERSTANDING_ENDPOINT");
        String key = System.getenv("CONTENTUNDERSTANDING_KEY");

        // Build the client with appropriate authentication
        ContentUnderstandingClientBuilder builder = new ContentUnderstandingClientBuilder().endpoint(endpoint);

        ContentUnderstandingAsyncClient client;
        if (key != null && !key.trim().isEmpty()) {
            // Use API key authentication
            client = builder.credential(new AzureKeyCredential(key)).buildAsyncClient();
        } else {
            // Use default Azure credential (for managed identity, Azure CLI, etc.)
            client = builder.credential(new DefaultAzureCredentialBuilder().build()).buildAsyncClient();
        }
        // END: com.azure.ai.contentunderstanding.sample08Async.buildClient

        // Create an analyzer for testing
        analyzerId = "update_test_analyzer_" + System.currentTimeMillis();
        System.out.println("Creating test analyzer '" + analyzerId + "'...");

        Map<String, ContentFieldDefinition> fields = new HashMap<>();
        ContentFieldDefinition titleDef = new ContentFieldDefinition();
        titleDef.setType(ContentFieldType.STRING);
        titleDef.setMethod(GenerationMethod.EXTRACT);
        titleDef.setDescription("Document title");
        fields.put("title", titleDef);

        ContentFieldSchema fieldSchema = new ContentFieldSchema();
        fieldSchema.setName("basic_schema");
        fieldSchema.setDescription("Basic document schema");
        fieldSchema.setFields(fields);

        Map<String, String> models = new HashMap<>();
        models.put("completion", "gpt-4.1");
        models.put("embedding", "text-embedding-3-large");

        ContentAnalyzer analyzer = new ContentAnalyzer()
            .setBaseAnalyzerId("prebuilt-document")
            .setDescription("Original analyzer for update testing")
            .setConfig(new ContentAnalyzerConfig()
                .setEnableOcr(true)
                .setEnableLayout(true))
            .setFieldSchema(fieldSchema)
            .setModels(models);

        PollerFlux<?, ContentAnalyzer> createPoller = client.beginCreateAnalyzer(analyzerId, analyzer, true);
        createPoller.getSyncPoller().getFinalResult();
        System.out.println("Test analyzer created: " + analyzerId);

        // BEGIN:ContentUnderstandingUpdateAnalyzerAsync
        // Get the current analyzer
        ContentAnalyzer currentAnalyzer = client.getAnalyzer(analyzerId).block();
        System.out.println("\nCurrent description: " + currentAnalyzer.getDescription());

        // Update the analyzer with new configuration
        Map<String, ContentFieldDefinition> updatedFields = new HashMap<>();

        // Keep the original field
        ContentFieldDefinition titleDefUpdate = new ContentFieldDefinition();
        titleDefUpdate.setType(ContentFieldType.STRING);
        titleDefUpdate.setMethod(GenerationMethod.EXTRACT);
        titleDefUpdate.setDescription("Document title");
        updatedFields.put("title", titleDefUpdate);

        // Add a new field
        ContentFieldDefinition authorDef = new ContentFieldDefinition();
        authorDef.setType(ContentFieldType.STRING);
        authorDef.setMethod(GenerationMethod.EXTRACT);
        authorDef.setDescription("Document author");
        updatedFields.put("author", authorDef);

        ContentFieldSchema updatedFieldSchema = new ContentFieldSchema();
        updatedFieldSchema.setName("enhanced_schema");
        updatedFieldSchema.setDescription("Enhanced document schema with author");
        updatedFieldSchema.setFields(updatedFields);

        Map<String, String> updatedModels = new HashMap<>();
        updatedModels.put("completion", "gpt-4.1");
        updatedModels.put("embedding", "text-embedding-3-large");

        ContentAnalyzer updatedAnalyzer = new ContentAnalyzer()
            .setBaseAnalyzerId("prebuilt-document")
            .setDescription("Updated analyzer with enhanced schema")
            .setConfig(new ContentAnalyzerConfig()
                .setEnableOcr(true)
                .setEnableLayout(true)
                .setEnableFormula(true)) // Enable formula extraction
            .setFieldSchema(updatedFieldSchema)
            .setModels(updatedModels);

        // Update the analyzer using the convenience method
        // This method accepts a ContentAnalyzer object directly instead of BinaryData
        ContentAnalyzer result = client.updateAnalyzer(analyzerId, updatedAnalyzer).block();

        System.out.println("Analyzer updated successfully!");
        System.out.println("New description: " + result.getDescription());
        if (result.getFieldSchema() != null && result.getFieldSchema().getFields() != null) {
            System.out.println("Field schema now has " + result.getFieldSchema().getFields().size() + " fields");
        }
        // END:ContentUnderstandingUpdateAnalyzerAsync

        // Cleanup
        System.out.println("\nCleaning up: deleting test analyzer '" + analyzerId + "'...");
        client.deleteAnalyzer(analyzerId).block();
        System.out.println("Test analyzer deleted successfully.");
    }
}
