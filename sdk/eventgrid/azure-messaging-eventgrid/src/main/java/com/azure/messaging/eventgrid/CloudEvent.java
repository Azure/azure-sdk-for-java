// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License. See License.txt in the project root for
// license information.
//
// Code generated by Microsoft (R) AutoRest Code Generator.

package com.azure.messaging.eventgrid;

import com.azure.core.annotation.Fluent;
import com.azure.core.experimental.serializer.ObjectSerializer;
import com.azure.core.util.CoreUtils;

import java.io.ByteArrayOutputStream;
import java.time.OffsetDateTime;
import java.util.*;

/**
 * The CloudEvent model. This represents a cloud event as specified by the CNCF, for sending event based data.
 * @see EventGridPublisherAsyncClient
 * @see EventGridPublisherClient
 **/
@Fluent
public class CloudEvent {

    private static final String SPEC_VERSION = "1.0";

    private static final String JSON_TYPE = "application/json";

    private final com.azure.messaging.eventgrid.implementation.models.CloudEvent cloudEvent;

    CloudEvent(com.azure.messaging.eventgrid.implementation.models.CloudEvent cloudEvent) {
        this.cloudEvent = cloudEvent;
    }

    com.azure.messaging.eventgrid.implementation.models.CloudEvent toImpl() {
        return this.cloudEvent;
    }

    /**
     * Create an instance of a CloudEvent. The source and type are required fields to publish.
     * @param source a URI identifying the origin of the event.
     * @param type   the type of event, e.g. "Contoso.Items.ItemReceived".
     */
    public CloudEvent(String source, String type) {
        if (CoreUtils.isNullOrEmpty(source)) {
            throw new IllegalArgumentException("Source cannot be null or empty");
        } else if (CoreUtils.isNullOrEmpty(type)) {
            throw new IllegalArgumentException("type cannot be null or empty");
        }

        this.cloudEvent = new com.azure.messaging.eventgrid.implementation.models.CloudEvent()
            .setId(UUID.randomUUID().toString())
            .setSource(source)
            .setType(type)
            .setSpecversion(SPEC_VERSION);
    }

    /**
     * Get the id of the cloud event.
     * @return the id.
     */
    public String getId() {
        return this.cloudEvent.getId();
    }

    /**
     * Set a custom id. Note that a random id is already set by default.
     * @param id the id to set.
     *
     * @return the cloud event itself.
     */
    public CloudEvent setId(String id) {
        if (CoreUtils.isNullOrEmpty(id)) {
            throw new IllegalArgumentException("id cannot be null or empty");
        }
        this.cloudEvent.setId(id);
        return this;
    }

    /**
     * Get the URI source of the event.
     * @return the source.
     */
    public String getSource() {
        return this.cloudEvent.getSource();
    }

    /**
     * Get the object data encapsulated within this event.
     * @return the data associated with this event, or null if this event type does not contain object data.
     */
    public Object getData() {
        return cloudEvent.getData();
    }

    /**
     * Gets the data if it was set as binary data, using the {@link CloudEvent#setData(byte[], String)} overload.
     * @return return the binary data that was set, or null if there was no binary data set.
     */
    public byte[] getBinaryData() {
        if (this.cloudEvent.getDataBase64() != null) {
            return Base64.getDecoder().decode(this.cloudEvent.getDataBase64());
        }
        return null;
    }

    /**
     * Set the data associated with this event, to be serialized in Json format.
     * @param data the data to set.
     *
     * @return the cloud event itself.
     */
    public CloudEvent setData(Object data) {
        return setData(data, null, JSON_TYPE);
    }

    /**
     * Set data using a custom serializer. This can be used for non-JSON data fields, and the dataContentType should
     * indicate the format of the data, such as "text/xml" for XML data.
     * @param data            the data to serialize and set.
     * @param serializer      the {@link ObjectSerializer} to serialize the data. If this is not given, the data will be
     *                        serialized as a json using the default serializer that all other fields use.
     * @param dataContentType the content type of the data, indicating the format it is in. If not given, this will
     *                        default to an "application/json" type.
     *
     * @return the cloud event itself.
     */
    public CloudEvent setData(Object data, ObjectSerializer serializer, String dataContentType) {
        if (serializer == null) {
            // expect the data to already be serialized as a string or similar type
            this.cloudEvent.setData(data);
        } else {
            serializer.serialize(new ByteArrayOutputStream(), data)
                .map(Objects::toString)
                .subscribe(this.cloudEvent::setData);
        }
        this.cloudEvent
            .setDatacontenttype(dataContentType)
            .setDataBase64(null);
        return this;
    }

    /**
     * Set binary data associated with this event, as well as the content type of the binary data.
     * @param data            the data to set.
     * @param dataContentType the format that the data is written in, since the data is no longer in json format.
     *
     * @return the cloud event itself.
     */
    public CloudEvent setData(byte[] data, String dataContentType) {
        this.cloudEvent
            .setDataBase64(Base64.getEncoder().encodeToString(data))
            .setData(null)
            .setDatacontenttype(dataContentType);
        return this;
    }

    /**
     * Get the type of event, e.g. "Contoso.Items.ItemReceived".
     * @return the type of the event.
     */
    public String getType() {
        return this.cloudEvent.getType();
    }

    /**
     * Get the time associated with the occurrence of the event.
     * @return the event time, or null if the time is not set.
     */
    public OffsetDateTime getTime() {
        return this.cloudEvent.getTime();
    }

    /**
     * Set the time associated with the occurrence of the event.
     * @param time the time to set.
     *
     * @return the cloud event itself.
     */
    public CloudEvent setTime(OffsetDateTime time) {
        this.cloudEvent.setTime(time);
        return this;
    }

    /**
     * Get the content type that the data is in. A null value indicates that the data is either nonexistent or in the
     * "application/json" type. Note that "application/json" is still a possible value for this field.
     * @return the content type the data is in, or null if the data is nonexistent or in "application/json" format.
     */
    public String getDataContentType() {
        return this.cloudEvent.getDatacontenttype();
    }

    /**
     * Get the schema that the data adheres to.
     * @return a URI of the data schema, or null if it is not set.
     */
    public String getDataSchema() {
        return this.cloudEvent.getDataschema();
    }

    /**
     * Set the schema that the data adheres to.
     * @param dataSchema a URI identifying the schema of the data.
     *
     * @return the cloud event itself.
     */
    public CloudEvent setDataSchema(String dataSchema) {
        this.cloudEvent.setDataschema(dataSchema);
        return this;
    }

    /**
     * Get the subject associated with this event.
     * @return the subject, or null if the subject was not set.
     */
    public String getSubject() {
        return this.cloudEvent.getSubject();
    }

    /**
     * Set the subject of the event.
     * @param subject the subject to set.
     *
     * @return the cloud event itself.
     */
    public CloudEvent setSubject(String subject) {
        this.cloudEvent.setSubject(subject);
        return this;
    }

    /**
     * Get a map of the additional user-defined properties associated with this event.
     * @return the additional properties as an unmodifiable map.
     */
    public Map<String, Object> getAdditionalProperties() {
        return Collections.unmodifiableMap(this.cloudEvent.getAdditionalProperties());
    }

    /**
     * Add/Overwrite a single additional property to the cloud event envelope. The property name will be transformed to lowercase
     * and must not share a name with any reserved cloud event properties.
     * @param name  the name of the property.
     * @param value the value to associate with the name.
     *
     * @return the cloud event itself.
     */
    public CloudEvent addAdditionalProperty(String name, Object value) {
        this.cloudEvent.getAdditionalProperties().put(name.toLowerCase(Locale.ENGLISH), value);
        return this;
    }

    /**
     * Add/overwrite multiple additional properties to the cloud event envelope. The property names will be transformed
     * to lowercase and must not share a name with any reserved cloud event properties.
     * @param additionalProperties the map of properties to set.
     *
     * @return the cloud event itself.
     */
    public CloudEvent addAdditionalProperties(Map<String, Object> additionalProperties) {
        for (Map.Entry<String, Object> entry : additionalProperties.entrySet()) {
            addAdditionalProperty(entry.getKey(), entry.getValue());
        }
        return this;
    }

    /**
     * Get the version of the CloudEvents specification to which this event follows. Note that this SDK currently only
     * supports the CloudEvents 1.0 spec version.
     * @return the version of the CloudEvents specification this event follows.
     */
    public String getSpecVersion() {
        return this.cloudEvent.getSpecversion();
    }
}
