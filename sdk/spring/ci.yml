# NOTE: Please refer to https://aka.ms/azsdk/engsys/ci-yaml before editing this file.

trigger:
  branches:
    include:
      - main
      - feature/*
      - hotfix/*
      - release/*
  paths:
    include:
      - sdk/spring/
    exclude:
      - sdk/spring/pom.xml
      - sdk/spring/azure-spring-boot-test-application/pom.xml
      - sdk/spring/azure-spring-boot-test-core/pom.xml
      - sdk/spring/azure-spring-boot-test-cosmos/pom.xml
      - sdk/spring/azure-spring-boot-test-keyvault-certificate/pom.xml
      - sdk/spring/azure-spring-boot-test-keyvault/pom.xml
      - sdk/spring/azure-spring-boot-test-parent/pom.xml
      - sdk/spring/azure-spring-boot-test-servicebus-jms/pom.xml
      - sdk/spring/azure-spring-boot-test-storage/pom.xml
      - sdk/spring/spring-messaging-azure/pom.xml
      - sdk/spring/spring-messaging-azure-eventhubs/pom.xml
      - sdk/spring/spring-messaging-azure-servicebus/pom.xml
      - sdk/spring/spring-messaging-azure-storage-queue/pom.xml
      - sdk/spring/spring-integration-azure-core/pom.xml
      - sdk/spring/spring-integration-azure-eventhubs/pom.xml
      - sdk/spring/spring-integration-azure-servicebus/pom.xml
      - sdk/spring/spring-integration-azure-storage-queue/pom.xml
      - sdk/spring/spring-cloud-azure-core/pom.xml
      - sdk/spring/spring-cloud-azure-resourcemanager/pom.xml
      - sdk/spring/spring-cloud-azure-actuator/pom.xml
      - sdk/spring/spring-cloud-azure-actuator-autoconfigure/pom.xml
      - sdk/spring/spring-cloud-azure-autoconfigure/pom.xml
      - sdk/spring/spring-cloud-azure-starter-actuator/pom.xml
      - sdk/spring/spring-cloud-azure-starter-appconfiguration/pom.xml
      - sdk/spring/spring-cloud-azure-starter-cosmos/pom.xml
      - sdk/spring/spring-cloud-azure-starter-data-cosmos/pom.xml
      - sdk/spring/spring-cloud-azure-starter-eventhubs/pom.xml
      - sdk/spring/spring-cloud-azure-starter-keyvault-certificates/pom.xml
      - sdk/spring/spring-cloud-azure-starter-keyvault-secrets/pom.xml
      - sdk/spring/spring-cloud-azure-starter-servicebus-jms/pom.xml
      - sdk/spring/spring-cloud-azure-starter-servicebus/pom.xml
      - sdk/spring/spring-cloud-azure-starter-storage-blob/pom.xml
      - sdk/spring/spring-cloud-azure-starter-storage-file-share/pom.xml
      - sdk/spring/spring-cloud-azure-starter-storage-queue/pom.xml
      - sdk/spring/spring-cloud-azure-starter-integration-eventhubs/pom.xml
      - sdk/spring/spring-cloud-azure-starter-integration-servicebus/pom.xml
      - sdk/spring/spring-cloud-azure-starter-integration-storage-queue/pom.xml
      - sdk/spring/spring-cloud-azure-starter-stream-eventhubs/pom.xml
      - sdk/spring/spring-cloud-azure-starter-stream-servicebus/pom.xml
      - sdk/spring/spring-cloud-azure-starter/pom.xml
      - sdk/spring/spring-cloud-azure-stream-binder-eventhubs-core/pom.xml
      - sdk/spring/spring-cloud-azure-stream-binder-eventhubs/pom.xml
      - sdk/spring/spring-cloud-azure-stream-binder-servicebus-core/pom.xml
      - sdk/spring/spring-cloud-azure-stream-binder-servicebus/pom.xml
      - sdk/spring/spring-cloud-azure-test-servicebus-binder/pom.xml

pr:
  branches:
    include:
      - main
      - feature/*
      - hotfix/*
      - release/*
  paths:
    include:
      - sdk/spring/
    exclude:
      - sdk/spring/pom.xml
      - sdk/spring/azure-spring-boot-test-application/pom.xml
      - sdk/spring/azure-spring-boot-test-core/pom.xml
      - sdk/spring/azure-spring-boot-test-cosmos/pom.xml
      - sdk/spring/azure-spring-boot-test-keyvault-certificate/pom.xml
      - sdk/spring/azure-spring-boot-test-keyvault/pom.xml
      - sdk/spring/azure-spring-boot-test-parent/pom.xml
      - sdk/spring/azure-spring-boot-test-servicebus-jms/pom.xml
      - sdk/spring/azure-spring-boot-test-storage/pom.xml
      - sdk/spring/spring-messaging-azure/pom.xml
      - sdk/spring/spring-messaging-azure-eventhubs/pom.xml
      - sdk/spring/spring-messaging-azure-servicebus/pom.xml
      - sdk/spring/spring-messaging-azure-storage-queue/pom.xml
      - sdk/spring/spring-integration-azure-core/pom.xml
      - sdk/spring/spring-integration-azure-eventhubs/pom.xml
      - sdk/spring/spring-integration-azure-servicebus/pom.xml
      - sdk/spring/spring-integration-azure-storage-queue/pom.xml
      - sdk/spring/spring-cloud-azure-core/pom.xml
      - sdk/spring/spring-cloud-azure-resourcemanager/pom.xml
      - sdk/spring/spring-cloud-azure-actuator/pom.xml
      - sdk/spring/spring-cloud-azure-actuator-autoconfigure/pom.xml
      - sdk/spring/spring-cloud-azure-autoconfigure/pom.xml
      - sdk/spring/spring-cloud-azure-starter-actuator/pom.xml
      - sdk/spring/spring-cloud-azure-starter-appconfiguration/pom.xml
      - sdk/spring/spring-cloud-azure-starter-cosmos/pom.xml
      - sdk/spring/spring-cloud-azure-starter-data-cosmos/pom.xml
      - sdk/spring/spring-cloud-azure-starter-eventhubs/pom.xml
      - sdk/spring/spring-cloud-azure-starter-keyvault-certificates/pom.xml
      - sdk/spring/spring-cloud-azure-starter-keyvault-secrets/pom.xml
      - sdk/spring/spring-cloud-azure-starter-servicebus-jms/pom.xml
      - sdk/spring/spring-cloud-azure-starter-servicebus/pom.xml
      - sdk/spring/spring-cloud-azure-starter-storage-blob/pom.xml
      - sdk/spring/spring-cloud-azure-starter-storage-file-share/pom.xml
      - sdk/spring/spring-cloud-azure-starter-storage-queue/pom.xml
      - sdk/spring/spring-cloud-azure-starter-integration-eventhubs/pom.xml
      - sdk/spring/spring-cloud-azure-starter-integration-servicebus/pom.xml
      - sdk/spring/spring-cloud-azure-starter-integration-storage-queue/pom.xml
      - sdk/spring/spring-cloud-azure-starter-stream-eventhubs/pom.xml
      - sdk/spring/spring-cloud-azure-starter-stream-servicebus/pom.xml
      - sdk/spring/spring-cloud-azure-starter/pom.xml
      - sdk/spring/spring-cloud-azure-stream-binder-eventhubs-core/pom.xml
      - sdk/spring/spring-cloud-azure-stream-binder-eventhubs/pom.xml
      - sdk/spring/spring-cloud-azure-stream-binder-servicebus-core/pom.xml
      - sdk/spring/spring-cloud-azure-stream-binder-servicebus/pom.xml
      - sdk/spring/spring-cloud-azure-test-servicebus-binder/pom.xml

resources:
  repositories:
    - repository: azure-sdk-build-tools
      type: git
      name: internal/azure-sdk-build-tools
      ref: refs/tags/azure-sdk-build-tools_20211019.1

parameters:
  - name: Artifacts
    type: object
    default:
      - name: spring-cloud-azure-core
        groupId: com.azure.spring
        safeName: springcloudazurecore
        skipPublishDocMs: true
        skipVerifyChangelog: true
      - name: spring-cloud-azure-service
        groupId: com.azure.spring
        safeName: springcloudazureservice
        skipPublishDocMs: true
        skipVerifyChangelog: true
      - name: spring-cloud-azure-resourcemanager
        groupId: com.azure.spring
        safeName: springcloudazureresourcemanager
        skipPublishDocMs: true
        skipVerifyChangelog: true
      - name: spring-cloud-azure-trace-sleuth
        groupId: com.azure.spring
        safeName: springcloudazuretracesleuth
        skipPublishDocMs: true
        skipVerifyChangelog: true
      - name: spring-messaging-azure
        groupId: com.azure.spring
        safeName: springmessagingazure
        skipPublishDocMs: true
        skipVerifyChangelog: true
      - name: spring-messaging-azure-eventhubs
        groupId: com.azure.spring
        safeName: springmessagingazureeventhubs
        skipPublishDocMs: true
        skipVerifyChangelog: true
      - name: spring-messaging-azure-servicebus
        groupId: com.azure.spring
        safeName: springmessagingazureservicebus
        skipPublishDocMs: true
        skipVerifyChangelog: true
      - name: spring-messaging-azure-storage-queue
        groupId: com.azure.spring
        safeName: springmessagingazurestoragequeue
        skipPublishDocMs: true
        skipVerifyChangelog: true
      - name: spring-integration-azure-core
        groupId: com.azure.spring
        safeName: springintegrationazurecore
        skipPublishDocMs: true
        skipVerifyChangelog: true
      - name: spring-integration-azure-eventhubs
        groupId: com.azure.spring
        safeName: springintegrationazureeventhubs
        skipPublishDocMs: true
        skipVerifyChangelog: true
      - name: spring-integration-azure-servicebus
        groupId: com.azure.spring
        safeName: springintegrationazureservicebus
        skipPublishDocMs: true
        skipVerifyChangelog: true
      - name: spring-integration-azure-storage-queue
        groupId: com.azure.spring
        safeName: springintegrationazurestoragequeue
        skipPublishDocMs: true
        skipVerifyChangelog: true
      - name: spring-cloud-azure-autoconfigure
        groupId: com.azure.spring
        safeName: springcloudazureautoconfigure
        skipPublishDocMs: true
        skipVerifyChangelog: true
      - name: spring-cloud-azure-actuator
        groupId: com.azure.spring
        safeName: springcloudazureactuator
        skipPublishDocMs: true
        skipVerifyChangelog: true
      - name: spring-cloud-azure-actuator-autoconfigure
        groupId: com.azure.spring
        safeName: springcloudazureactuatorautoconfigure
        skipPublishDocMs: true
        skipVerifyChangelog: true
      - name: spring-cloud-azure-starter
        groupId: com.azure.spring
        safeName: springcloudazurestarter
        skipPublishDocMs: true
        skipUpdatePackageJson: true
        skipVerifyChangelog: true
      - name: spring-cloud-azure-starter-actuator
        groupId: com.azure.spring
        safeName: springcloudazurestarteractuator
        skipPublishDocMs: true
        skipUpdatePackageJson: true
        skipVerifyChangelog: true
      - name: spring-cloud-azure-starter-appconfiguration
        groupId: com.azure.spring
        safeName: springcloudazurestarterappconfiguration
        skipPublishDocMs: true
        skipUpdatePackageJson: true
        skipVerifyChangelog: true
      - name: spring-cloud-azure-starter-cosmos
        groupId: com.azure.spring
        safeName: springcloudazurestartercosmos
        skipPublishDocMs: true
        skipUpdatePackageJson: true
        skipVerifyChangelog: true
      - name: spring-cloud-azure-starter-data-cosmos
        groupId: com.azure.spring
        safeName: springcloudazurestarterdatacosmos
        skipPublishDocMs: true
        skipUpdatePackageJson: true
        skipVerifyChangelog: true
      - name: spring-cloud-azure-starter-eventhubs
        groupId: com.azure.spring
        safeName: springcloudazurestartereventhubs
        skipPublishDocMs: true
        skipUpdatePackageJson: true
        skipVerifyChangelog: true
      - name: spring-cloud-azure-starter-keyvault-certificates
        groupId: com.azure.spring
        safeName: springcloudazurestarterkeyvaultcertificates
        skipPublishDocMs: true
        skipUpdatePackageJson: true
        skipVerifyChangelog: true
      - name: spring-cloud-azure-starter-keyvault-secrets
        groupId: com.azure.spring
        safeName: springcloudazurestarterkeyvaultsecrets
        skipPublishDocMs: true
        skipUpdatePackageJson: true
        skipVerifyChangelog: true
      - name: spring-cloud-azure-starter-servicebus
        groupId: com.azure.spring
        safeName: springcloudazurestarterservicebus
        skipPublishDocMs: true
        skipUpdatePackageJson: true
        skipVerifyChangelog: true
      - name: spring-cloud-azure-starter-servicebus-jms
        groupId: com.azure.spring
        safeName: springcloudazurestarterservicebusjms
        skipPublishDocMs: true
        skipUpdatePackageJson: true
        skipVerifyChangelog: true
      - name: spring-cloud-azure-starter-storage-blob
        groupId: com.azure.spring
        safeName: springcloudazurestarterstorageblob
        skipPublishDocMs: true
        skipUpdatePackageJson: true
        skipVerifyChangelog: true
      - name: spring-cloud-azure-starter-storage-file-share
        groupId: com.azure.spring
        safeName: springcloudazurestarterstoragefileshare
        skipPublishDocMs: true
        skipUpdatePackageJson: true
        skipVerifyChangelog: true
      - name: spring-cloud-azure-starter-storage-queue
        groupId: com.azure.spring
        safeName: springcloudazurestarterstoragequeue
        skipPublishDocMs: true
        skipUpdatePackageJson: true
        skipVerifyChangelog: true
      - name: spring-cloud-azure-starter-integration-eventhubs
        groupId: com.azure.spring
        safeName: springcloudazurestarterintegrationeventhubs
        skipPublishDocMs: true
        skipUpdatePackageJson: true
        skipVerifyChangelog: true
      - name: spring-cloud-azure-starter-integration-servicebus
        groupId: com.azure.spring
        safeName: springcloudazurestarterintegrationservicebus
        skipPublishDocMs: true
        skipUpdatePackageJson: true
        skipVerifyChangelog: true
      - name: spring-cloud-azure-starter-integration-storage-queue
        groupId: com.azure.spring
        safeName: springcloudazurestarterintegrationstoragequeue
        skipPublishDocMs: true
        skipUpdatePackageJson: true
        skipVerifyChangelog: true
      - name: spring-cloud-azure-stream-binder-servicebus-core
        groupId: com.azure.spring
        safeName: springcloudazurestreambinderservicebuscore
        skipPublishDocMs: true
        skipVerifyChangelog: true
      - name: spring-cloud-azure-stream-binder-servicebus
        groupId: com.azure.spring
        safeName: springcloudazurestreambinderservicebus
        skipPublishDocMs: true
        skipVerifyChangelog: true
      - name: spring-cloud-azure-stream-binder-eventhubs
        groupId: com.azure.spring
        safeName: springcloudazurestreambindereventhubs
        skipPublishDocMs: true
        skipVerifyChangelog: true
      - name: spring-cloud-azure-stream-binder-eventhubs-core
        groupId: com.azure.spring
        safeName: springcloudazurestreambindereventhubscore
        skipPublishDocMs: true
        skipVerifyChangelog: true
      - name: spring-cloud-azure-starter-stream-eventhubs
        groupId: com.azure.spring
        safeName: springcloudazurestarterstreameventhubs
        skipPublishDocMs: true
        skipUpdatePackageJson: true
        skipVerifyChangelog: true
      - name: spring-cloud-azure-starter-stream-servicebus
        groupId: com.azure.spring
        safeName: springcloudazurestarterstreamservicebus
        skipPublishDocMs: true
        skipUpdatePackageJson: true
        skipVerifyChangelog: true
      - name: spring-cloud-azure-starter-storage-queue
        groupId: com.azure.spring
        safeName: springcloudazurestarterstoragequeue
        skipPublishDocMs: true
        skipUpdatePackageJson: true
        skipVerifyChangelog: true
  - name: TestPipeline
    type: boolean
    default: false
  - name: AdditionalModules
    type: object
    default: [ ]
  - name: SDKType
    type: string
    default: client
  - name: ServiceDirectory
    type: string
    default: spring
  - name: TargetDocRepoOwner
    type: string
    default: Azure
  - name: TargetDocRepoName
    type: string
    default: azure-docs-sdk-java
  - name: MatrixConfigs
    type: object
    default:
      - Name: Java_ci_test_base
        Path: eng/pipelines/templates/stages/platform-matrix.json
        Selection: sparse
        NonSparseParameters: Agent
        GenerateVMJobs: true
  - name: AdditionalMatrixConfigs
    type: object
    default: [ ]
  - name: MatrixFilters
    type: object
    default: [ ]
  - name: MatrixReplace
    type: object
    default: [ ]
  - name: SkipAggregateReports
    type: boolean
    default: false
  - name: PreBuildSteps
    type: object
    default: [ ]
  - name: SpringBootVersion
    type: string
    default: 2.6.1

stages:
  - stage: Build
    jobs:
      - template: /eng/pipelines/templates/jobs/ci.yml
        parameters:
          ServiceDirectory: ${{ parameters.ServiceDirectory }}
          ${{ if eq(parameters.ServiceDirectory, 'template') }}:
            TestPipeline: true
          SDKType: ${{ parameters.SDKType }}
          Artifacts: ${{ parameters.Artifacts }}
          AdditionalModules: ${{ parameters.AdditionalModules }}
          SkipAggregateReports: ${{ parameters.SkipAggregateReports }}
          MatrixConfigs:
            - ${{ each config in parameters.MatrixConfigs }}:
                - ${{ config }}
            - ${{ each config in parameters.AdditionalMatrixConfigs }}:
                - ${{ config }}
          MatrixFilters:
            - ${{ each filter in parameters.MatrixFilters }}:
                - ${{ filter }}
            # Skip TestFromSource jobs for SDKType data
            - ${{ if eq(parameters.SDKType, 'data') }}:
                - TestFromSource=^(?!true).*
          MatrixReplace:
            - ${{ each replacement in parameters.MatrixReplace }}:
                - ${{ replacement }}
            - ${{ if eq(parameters.SDKType, 'data') }}:
                - TestGoals=.*/verify
                - TestOptions=.*/-am
            - AZURE_TEST.*=.*/
          PreBuildSteps: ${{ parameters.PreBuildSteps }}


  - stage: TestNewSpringBootVersion
    jobs:
      - template: /eng/common/pipelines/templates/jobs/archetype-sdk-tests-generate.yml
        parameters:
          JobTemplatePath: /eng/pipelines/templates/jobs/ci.tests.yml
          CloudConfig:
            Cloud: Public
          MatrixConfigs:
            - ${{ each config in parameters.MatrixConfigs }}:
                - ${{ config }}
            - ${{ each config in parameters.AdditionalMatrixConfigs }}:
                - ${{ config }}
          MatrixFilters:
            - ${{ each filter in parameters.MatrixFilters }}:
                - ${{ filter }}
            # Skip TestFromSource jobs for SDKType data
            - ${{ if eq(parameters.SDKType, 'data') }}:
                - TestFromSource=^(?!true).*
          MatrixReplace:
            - ${{ each replacement in parameters.MatrixReplace }}:
                - ${{ replacement }}
            - ${{ if eq(parameters.SDKType, 'data') }}:
                - TestGoals=.*/verify
                - TestOptions=.*/-am
            - AZURE_TEST.*=.*/
          AdditionalParameters:
            SDKType: ${{ parameters.SDKType }}
            ServiceDirectory: ${{ parameters.ServiceDirectory }}
            TestPipeline: ${{ parameters.TestPipeline }}
            Artifacts: ${{ parameters.Artifacts }}
            AdditionalModules: ${{ parameters.AdditionalModules }}
            SkipAggregateReports: ${{ parameters.SkipAggregateReports }}
            PreBuildSteps:
              - script: |
                  pip install in-place & pip install termcolor
                displayName: 'python module install'
              - script: |
                  python ./sdk/spring/scripts/ci_update_versions.py --sbv 2.6.1
                displayName: 'update spring boot versions'
              - script: |
                  python ./sdk/spring/scripts/ci_insert_dependency_management_in_pom_files.py -b 2.6.1 -c 2021.0.0
                displayName: 'insert dependency management'
      - job: 'maven_dependency_${parameters.SpringBootVersion}'
        variables:
          - template: ../../eng/pipelines/templates/variables/globals.yml
        pool:
          name: azsdk-pool-mms-ubuntu-2004-general
          vmImage: MMSUbuntu20.04
        steps:
          - script: |
              pip install in-place & pip install termcolor
            displayName: 'python module install'
          - script: |
              python ./sdk/spring/scripts/ci_update_versions.py --sbv ${parameters.SpringBootVersion}
            displayName: 'update spring boot versions'
          - script: |
              python ./sdk/spring/scripts/ci_insert_dependency_management_in_pom_files.py -b ${parameters.SpringBootVersion} -c 2021.0.0
            displayName: 'insert dependency management'
          - template: /eng/common/pipelines/templates/steps/sparse-checkout.yml
            parameters:
              Paths:
                - 'sdk/${{ parameters.ServiceDirectory }}'
                - '**/*.xml'
                - '**/*.md'
                - '.vscode/cspell.json'
                - '!sdk/**/test-recordings'
                - '!sdk/**/session-records'
          - template: ../../eng/pipelines/templates/steps/generate-project-list.yml
            parameters:
              Artifacts: ${{ parameters.Artifacts }}
              AdditionalModules: ${{ parameters.AdditionalModules }}
              JobType: 'maven_dependency'
              SDKType: ${{parameters.SDKType}}
          - task: PythonScript@0
            displayName: 'Generate directories variable for sparse checkout'
            inputs:
              scriptPath: 'eng/scripts/generate_from_source_pom.py'
              arguments: '--set-pipeline-variable CheckoutDirectories --project-list $(ProjectList)'
              workingDirectory: '$(System.DefaultWorkingDirectory)'

          - template: /eng/common/pipelines/templates/steps/sparse-checkout.yml
            parameters:
              Paths: $(CheckoutDirectories)
              SkipDefaultCheckout: true
          - template: ../../eng/pipelines/templates/steps/install-reporting-tools.yml
          - script: |
              mvn -f sdk/spring/pom.xml -P dev --batch-mode --fail-at-end $(WagonOptions) -T 2C -DskipTests -Dgpg.skip -DtrimStackTrace=false -Dmaven.javadoc.skip=true -Dcodesnippet.skip=true -Dspotbugs.skip=true -Dcheckstyle.skip=true -Drevapi.skip=true -Djacoco.skip=true -pl $(ProjectList) -am install
            displayName: 'maven_install'
          - script: |
              cd ./sdk/spring && mvn dependency:tree>tree.txt
            displayName: 'maven_dependency'
          - script: |
              python ./sdk/spring/scripts/ci_read_dptree.py
            displayName: 'dependencyTree_output'


  - stage: TestLastSpringBootVersion
    jobs:
      - template: /eng/common/pipelines/templates/jobs/archetype-sdk-tests-generate.yml
        parameters:
          JobTemplatePath: /eng/pipelines/templates/jobs/ci.tests.yml
          CloudConfig:
            Cloud: Public
          MatrixConfigs:
            - ${{ each config in parameters.MatrixConfigs }}:
                - ${{ config }}
            - ${{ each config in parameters.AdditionalMatrixConfigs }}:
                - ${{ config }}
          MatrixFilters:
            - ${{ each filter in parameters.MatrixFilters }}:
                - ${{ filter }}
            # Skip TestFromSource jobs for SDKType data
            - ${{ if eq(parameters.SDKType, 'data') }}:
                - TestFromSource=^(?!true).*
          MatrixReplace:
            - ${{ each replacement in parameters.MatrixReplace }}:
                - ${{ replacement }}
            - ${{ if eq(parameters.SDKType, 'data') }}:
                - TestGoals=.*/verify
                - TestOptions=.*/-am
            - AZURE_TEST.*=.*/
          AdditionalParameters:
            SDKType: ${{ parameters.SDKType }}
            ServiceDirectory: ${{ parameters.ServiceDirectory }}
            TestPipeline: ${{ parameters.TestPipeline }}
            Artifacts: ${{ parameters.Artifacts }}
            AdditionalModules: ${{ parameters.AdditionalModules }}
            SkipAggregateReports: ${{ parameters.SkipAggregateReports }}
            PreBuildSteps:
              - script: |
                  pip install in-place & pip install termcolor
                displayName: 'python module install'
              - script: |
                  python ./sdk/spring/scripts/ci_update_versions.py --sbv 2.5.7
                displayName: 'update spring boot versions'
              - script: |
                  python ./sdk/spring/scripts/ci_insert_dependency_management_in_pom_files.py -b 2.5.7 -c 2020.0.4
                displayName: 'insert dependency management'
      - job: 'maven_dependency'
        variables:
          - template: ../../eng/pipelines/templates/variables/globals.yml
        pool:
          name: azsdk-pool-mms-ubuntu-2004-general
          vmImage: MMSUbuntu20.04
        steps:
          - script: |
              pip install in-place & pip install termcolor
            displayName: 'python module install'
          - script: |
              python ./sdk/spring/scripts/ci_update_versions.py --sbv 2.5.7
            displayName: 'update spring boot versions'
          - script: |
              python ./sdk/spring/scripts/ci_insert_dependency_management_in_pom_files.py -b 2.5.7 -c 2020.0.4
            displayName: 'insert dependency management'
          - template: /eng/common/pipelines/templates/steps/sparse-checkout.yml
            parameters:
              Paths:
                - 'sdk/${{ parameters.ServiceDirectory }}'
                - '**/*.xml'
                - '**/*.md'
                - '.vscode/cspell.json'
                - '!sdk/**/test-recordings'
                - '!sdk/**/session-records'
          - template: ../../eng/pipelines/templates/steps/generate-project-list.yml
            parameters:
              Artifacts: ${{ parameters.Artifacts }}
              AdditionalModules: ${{ parameters.AdditionalModules }}
              JobType: 'maven_dependency'
              SDKType: ${{parameters.SDKType}}
          - task: PythonScript@0
            displayName: 'Generate directories variable for sparse checkout'
            inputs:
              scriptPath: 'eng/scripts/generate_from_source_pom.py'
              arguments: '--set-pipeline-variable CheckoutDirectories --project-list $(ProjectList)'
              workingDirectory: '$(System.DefaultWorkingDirectory)'

          - template: /eng/common/pipelines/templates/steps/sparse-checkout.yml
            parameters:
              Paths: $(CheckoutDirectories)
              SkipDefaultCheckout: true
          - template: ../../eng/pipelines/templates/steps/install-reporting-tools.yml
          - script: |
              mvn -f sdk/spring/pom.xml -P dev --batch-mode --fail-at-end -Dmaven.wagon.httpconnectionManager.ttlSeconds=60 -T 2C -DskipTests -Dgpg.skip -DtrimStackTrace=false -Dmaven.javadoc.skip=true -Dcodesnippet.skip=true -Dspotbugs.skip=true -Dcheckstyle.skip=true -Drevapi.skip=true -Djacoco.skip=true -pl $(ProjectList) -am install
            displayName: 'maven_install'
          - script: |
              cd ./sdk/spring && mvn dependency:tree>tree.txt
            displayName: 'maven_dependency'
          - script: |
              python ./sdk/spring/scripts/ci_read_dptree.py
            displayName: 'dependencyTree_output'

  # The Prerelease and Release stages are conditioned on whether we are building a pull request and the branch.
  - ${{if and(ne(variables['Build.Reason'], 'PullRequest'), eq(variables['System.TeamProject'], 'internal'))}}:
      - template: archetype-java-release.yml
        parameters:
          DependsOn:
            - Build
          ServiceDirectory: ${{ parameters.ServiceDirectory }}
          SDKType: ${{ parameters.SDKType }}
          Artifacts: ${{ parameters.Artifacts }}
          ${{ if eq(parameters.ServiceDirectory, 'template') }}:
            TestPipeline: true
          ArtifactName: packages
          TargetDocRepoOwner: ${{ parameters.TargetDocRepoOwner }}
          TargetDocRepoName: ${{ parameters.TargetDocRepoName }}