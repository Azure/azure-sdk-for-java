parameters:
  EnvVars: {}
  TestName: ''
  Artifacts: []
  AadOnDemandUserName: ''
  AadOnDemandUserDisplayName: ''

stages:
    - template: ../../eng/pipelines/templates/stages/archetype-sdk-tests.yml
      parameters:
        TimeoutInMinutes: 240
        ServiceDirectory: spring
        EnvVars: ${{ parameters.EnvVars }}
        TestName: ${{ parameters.TestName }}
        TestResourceDirectories:
          - spring/azure-spring-boot-test-cosmos
          - spring/azure-spring-boot-test-servicebus-jms
          - spring/azure-spring-cloud-test-eventhubs
          - spring/azure-spring-boot-test-keyvault
          - spring/azure-spring-boot-test-storage
        Artifacts: ${{ parameters.Artifacts }}
        TestStepMavenInputs:
          options: '-Dmaven.wagon.http.pool=false $(DefaultOptions) -Dmaven.javadoc.skip=true -Drevapi.skip=true -DskipSpringITs=false -pl $(ProjectList)'
          goals: "verify"
        PreSteps:
            - powershell: |
                  az login --allow-no-subscriptions --tenant $(java-spring-aad-tenant-id-1) --service-principal -u $(java-spring-aad-service-principal-client-id) -p $(java-spring-aad-service-principal-client-secret)
                  az ad user create --user-principal-name "${{ parameters.AadOnDemandUserName }}" --display-name "${{ parameters.AadOnDemandUserDisplayName }}" --password "$(java-spring-aad-user-password-1)" --force-change-password-next-login false
                  az logout
              displayName: 'Create On-demand test user'

        PostSteps:
          - script: |
              python --version
              python -m pip install setuptools termcolor in_place
              python sdk/spring/scripts/replace_util.py --module spring --log debug --color false
            displayName: 'Run replace_util.py'

          - task: Maven@3
            displayName: 'Build and Install again, JDK Version: $(JavaBuildVersion)'
            inputs:
              mavenPomFile: pom.xml
              goals: 'install'
              options: '$(DefaultOptions) -DskipTests -Dgpg.skip -Dmaven.javadoc.skip=true -Dcheckstyle.skip=true -Dspotbugs.skip=true -Drevapi.skip=true -pl $(ProjectList) -am'
              mavenOptions: '$(MemoryOptions) $(LoggingOptions)'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: $(JavaBuildVersion)
              jdkArchitectureOption: 'x64'
              publishJUnitResults: false

          - task: Maven@3
            displayName: 'Run tests again, JDK Version: $(JavaBuildVersion)'
            inputs:
              mavenPomFile: pom.xml
              goals: verify
              options: '-Dmaven.wagon.http.pool=false $(DefaultOptions) -Dmaven.javadoc.skip=true -Drevapi.skip=true -DskipSpringITs=false -pl $(ProjectList)'
            env: ${{ parameters.EnvVars }}

          - powershell: |
                az login --allow-no-subscriptions --tenant $(java-spring-aad-tenant-id-1) --service-principal -u $(java-spring-aad-service-principal-client-id) -p $(java-spring-aad-service-principal-client-secret)
                az ad user delete --id "${{ parameters.AadOnDemandUserName }}"
                az logout
            condition: always()
            displayName: 'Delete On-demand test user'
