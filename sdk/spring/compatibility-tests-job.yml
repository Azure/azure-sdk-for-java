parameters:
  Matrix: ''
  MaxParallel: 10
  SkipOptions: "-Dcheckstyle.skip=true -Dcodesnippet.skip -Denforcer.skip -Djacoco.skip=true
  -Dmaven.javadoc.skip=true -Drevapi.skip=true -Dspotbugs.skip=true"
  BuildParallelization: '2C'

jobs:
  - job: 'compatibility_test'
    dependsOn: ${{ parameters.DependsOn }}
    condition: and(succeededOrFailed(), ne(${{ parameters.Matrix }}, '{}'))
    strategy:
      maxParallel: ${{ parameters.MaxParallel }}
      matrix: $[ ${{ parameters.Matrix }} ]
    variables:
      - template: ../../eng/pipelines/templates/variables/globals.yml
    steps:
#      - bash: |
#          echo "##vso[task.setVariable variable=SpringCloudVersion;]2021.0.2"
#          echo "$(SpringCloudVersion)"
#      - bash: |
#          echo "$(SpringCloudVersion)"
#      - bash: |
#          echo "##vso[task.setVariable variable=SpringCloudVersion2;isOutput=true]2021.0.2"
#          echo "$(SpringCloudVersion2)"
#      - bash: |
#          echo "$(SpringCloudVersion2)"
#      - bash: |
#          echo "##vso[task.setVariable variable=SPRING_CLOUD_AZURE_TEST_SUPPORTED_SPRING_CLOUD_VERSION;isOutput=true]2021.0.1"
#          echo "$(SPRING_CLOUD_AZURE_TEST_SUPPORTED_SPRING_CLOUD_VERSION)"
#      - bash: |
#          echo "$(SPRING_CLOUD_AZURE_TEST_SUPPORTED_SPRING_CLOUD_VERSION)"
#      - bash: |
#          echo "##vso[task.setVariable variable=SPRING_CLOUD_AZURE_TEST_SUPPORTED_SPRING_CLOUD_VERSION1]2021.0.1"
#          echo "$(SPRING_CLOUD_AZURE_TEST_SUPPORTED_SPRING_CLOUD_VERSION1)"
#      - bash: |
#          echo "$(SPRING_CLOUD_AZURE_TEST_SUPPORTED_SPRING_CLOUD_VERSION1)"
      - template: /eng/common/pipelines/templates/steps/sparse-checkout.yml
        parameters:
          Paths:
            - 'sdk/spring'
            - 'sdk/boms/spring-cloud-azure-dependencies'
      - script: |
          pip install termcolor
        displayName: 'python module install'
#      - script: |
##          eval $(python ./sdk/spring/scripts/compatibility_get_spring_cloud_version_and_set_env.py)
#          python ./sdk/spring/scripts/compatibility_get_spring_cloud_version_and_set_env.py
#        displayName: 'set spring cloud version'
      - bash: |
          echo "##vso[task.setVariable variable=SPRING_CLOUD_AZURE_TEST_SUPPORTED_SPRING_CLOUD_VERSION]$(python ./sdk/spring/scripts/compatibility_get_spring_cloud_version_and_set_env.py)"
          echo "$(SPRING_CLOUD_AZURE_TEST_SUPPORTED_SPRING_CLOUD_VERSION)"
      - script: |
          python ./sdk/spring/scripts/compatibility_insert_dependencymanagement.py
        displayName: 'insert dependency management'
      - script: |
          python ./sdk/spring/scripts/compatibility_delete_version.py
        displayName: 'remove unused version'
      - bash: |
          echo "$(SPRING_CLOUD_AZURE_TEST_SUPPORTED_SPRING_CLOUD_VERSION)"
      - task: Maven@3
        displayName: 'Run tests'
        inputs:
          options: '$(DefaultOptions) -ntp -T ${{parameters.BuildParallelization}}
          ${{parameters.SkipOptions}}'
          mavenPomFile: sdk/spring/pom.xml
          mavenOptions: '$(MemoryOptions)'
          javaHomeOption: 'JDKVersion'
          jdkVersionOption: $(JavaTestVersion)
          jdkArchitectureOption: 'x64'
          goals: 'clean test -Pdev '

