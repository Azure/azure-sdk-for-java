// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.

package com.azure.ai.formrecognizer.documentanalysis;

import com.azure.ai.formrecognizer.documentanalysis.models.AnalyzeResult;
import com.azure.ai.formrecognizer.documentanalysis.models.OperationResult;
import com.azure.core.http.HttpClient;
import com.azure.core.util.BinaryData;
import com.azure.core.util.polling.SyncPoller;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.junit.jupiter.api.AfterAll;
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.MethodSource;
import reactor.test.StepVerifier;

import java.time.Duration;
import java.util.concurrent.atomic.AtomicReference;

import static com.azure.ai.formrecognizer.documentanalysis.TestUtils.DISPLAY_NAME_WITH_ARGUMENTS;
import static com.azure.ai.formrecognizer.documentanalysis.TestUtils.INSURANCE_PNG;
import static org.junit.jupiter.api.Assertions.assertEquals;

public class DocumentFieldSerializationTest extends DocumentAnalysisClientTestBase {
    private DocumentAnalysisClient client;
    private String expectedDeserializedString = "{\"modelId\":\"prebuilt-healthInsuranceCard.us\",\"content\":\"PREMERA\\nMicrosoft\\nBLUE CROSS\\nMember\\nMedical Network HERITAGE\\nANGEL BROWN\\nPremera Dental\\nYES\\nPrefix Identification # Suffix\\nPremera Vision\\nYES\\nABC 123456789\\n01\\nGroup # 1000000\\nHEALTH SAVINGS PLAN\\nRx Group # BCAAXYZ\\nShared In and Out of Network\\n$1,500\\nRx BIN# 987654\\nDeductible\\nCoinsurance Max\\n$1,000\\nBCBS 456\\nNote: Rx and Medical Cost-Shares are Shared\\nRx\\nPPO\",\"pages\":[{\"pageNumber\":1,\"angle\":0.1484333,\"width\":1000.0,\"height\":700.0,\"unit\":\"pixel\",\"spans\":[{\"offset\":0,\"length\":358}],\"words\":[{\"content\":\"PREMERA\",\"boundingPolygon\":[{\"y\":69.0,\"x\":78.0},{\"y\":65.0,\"x\":295.0},{\"y\":110.0,\"x\":299.0},{\"y\":113.0,\"x\":80.0}],\"span\":{\"offset\":0,\"length\":7},\"confidence\":0.993},{\"content\":\"Microsoft\",\"boundingPolygon\":[{\"y\":104.0,\"x\":709.0},{\"y\":105.0,\"x\":859.0},{\"y\":139.0,\"x\":860.0},{\"y\":138.0,\"x\":708.0}],\"span\":{\"offset\":8,\"length\":9},\"confidence\":0.993},{\"content\":\"BLUE\",\"boundingPolygon\":[{\"y\":128.0,\"x\":83.0},{\"y\":128.0,\"x\":127.0},{\"y\":144.0,\"x\":128.0},{\"y\":144.0,\"x\":83.0}],\"span\":{\"offset\":18,\"length\":4},\"confidence\":0.992},{\"content\":\"CROSS\",\"boundingPolygon\":[{\"y\":127.0,\"x\":136.0},{\"y\":127.0,\"x\":198.0},{\"y\":145.0,\"x\":198.0},{\"y\":144.0,\"x\":137.0}],\"span\":{\"offset\":23,\"length\":5},\"confidence\":0.994},{\"content\":\"Member\",\"boundingPolygon\":[{\"y\":198.0,\"x\":74.0},{\"y\":198.0,\"x\":167.0},{\"y\":222.0,\"x\":168.0},{\"y\":221.0,\"x\":74.0}],\"span\":{\"offset\":29,\"length\":6},\"confidence\":0.994},{\"content\":\"Medical\",\"boundingPolygon\":[{\"y\":199.0,\"x\":547.0},{\"y\":199.0,\"x\":622.0},{\"y\":221.0,\"x\":622.0},{\"y\":220.0,\"x\":547.0}],\"span\":{\"offset\":36,\"length\":7},\"confidence\":0.994},{\"content\":\"Network\",\"boundingPolygon\":[{\"y\":199.0,\"x\":626.0},{\"y\":198.0,\"x\":710.0},{\"y\":222.0,\"x\":710.0},{\"y\":222.0,\"x\":626.0}],\"span\":{\"offset\":44,\"length\":7},\"confidence\":0.993},{\"content\":\"HERITAGE\",\"boundingPolygon\":[{\"y\":198.0,\"x\":722.0},{\"y\":198.0,\"x\":840.0},{\"y\":223.0,\"x\":840.0},{\"y\":222.0,\"x\":722.0}],\"span\":{\"offset\":52,\"length\":8},\"confidence\":0.994},{\"content\":\"ANGEL\",\"boundingPolygon\":[{\"y\":228.0,\"x\":76.0},{\"y\":229.0,\"x\":154.0},{\"y\":252.0,\"x\":154.0},{\"y\":252.0,\"x\":75.0}],\"span\":{\"offset\":61,\"length\":5},\"confidence\":0.993},{\"content\":\"BROWN\",\"boundingPolygon\":[{\"y\":229.0,\"x\":162.0},{\"y\":229.0,\"x\":246.0},{\"y\":252.0,\"x\":247.0},{\"y\":252.0,\"x\":162.0}],\"span\":{\"offset\":67,\"length\":5},\"confidence\":0.995},{\"content\":\"Premera\",\"boundingPolygon\":[{\"y\":233.0,\"x\":549.0},{\"y\":234.0,\"x\":644.0},{\"y\":258.0,\"x\":644.0},{\"y\":258.0,\"x\":549.0}],\"span\":{\"offset\":73,\"length\":7},\"confidence\":0.994},{\"content\":\"Dental\",\"boundingPolygon\":[{\"y\":234.0,\"x\":652.0},{\"y\":233.0,\"x\":727.0},{\"y\":258.0,\"x\":727.0},{\"y\":258.0,\"x\":652.0}],\"span\":{\"offset\":81,\"length\":6},\"confidence\":0.994},{\"content\":\"YES\",\"boundingPolygon\":[{\"y\":233.0,\"x\":781.0},{\"y\":234.0,\"x\":825.0},{\"y\":257.0,\"x\":825.0},{\"y\":256.0,\"x\":780.0}],\"span\":{\"offset\":88,\"length\":3},\"confidence\":0.994},{\"content\":\"Prefix\",\"boundingPolygon\":[{\"y\":270.0,\"x\":73.0},{\"y\":270.0,\"x\":139.0},{\"y\":293.0,\"x\":140.0},{\"y\":292.0,\"x\":74.0}],\"span\":{\"offset\":92,\"length\":6},\"confidence\":0.993},{\"content\":\"Identification\",\"boundingPolygon\":[{\"y\":270.0,\"x\":158.0},{\"y\":268.0,\"x\":308.0},{\"y\":293.0,\"x\":309.0},{\"y\":293.0,\"x\":158.0}],\"span\":{\"offset\":99,\"length\":14},\"confidence\":0.95},{\"content\":\"#\",\"boundingPolygon\":[{\"y\":268.0,\"x\":319.0},{\"y\":268.0,\"x\":332.0},{\"y\":293.0,\"x\":332.0},{\"y\":293.0,\"x\":320.0}],\"span\":{\"offset\":114,\"length\":1},\"confidence\":0.993},{\"content\":\"Suffix\",\"boundingPolygon\":[{\"y\":268.0,\"x\":348.0},{\"y\":268.0,\"x\":417.0},{\"y\":294.0,\"x\":417.0},{\"y\":293.0,\"x\":348.0}],\"span\":{\"offset\":116,\"length\":6},\"confidence\":0.992},{\"content\":\"Premera\",\"boundingPolygon\":[{\"y\":269.0,\"x\":548.0},{\"y\":269.0,\"x\":644.0},{\"y\":294.0,\"x\":645.0},{\"y\":295.0,\"x\":549.0}],\"span\":{\"offset\":123,\"length\":7},\"confidence\":0.994},{\"content\":\"Vision\",\"boundingPolygon\":[{\"y\":269.0,\"x\":653.0},{\"y\":270.0,\"x\":721.0},{\"y\":294.0,\"x\":721.0},{\"y\":294.0,\"x\":653.0}],\"span\":{\"offset\":131,\"length\":6},\"confidence\":0.994},{\"content\":\"YES\",\"boundingPolygon\":[{\"y\":268.0,\"x\":782.0},{\"y\":269.0,\"x\":826.0},{\"y\":292.0,\"x\":826.0},{\"y\":291.0,\"x\":781.0}],\"span\":{\"offset\":138,\"length\":3},\"confidence\":0.995},{\"content\":\"ABC\",\"boundingPolygon\":[{\"y\":306.0,\"x\":75.0},{\"y\":305.0,\"x\":124.0},{\"y\":328.0,\"x\":125.0},{\"y\":328.0,\"x\":76.0}],\"span\":{\"offset\":142,\"length\":3},\"confidence\":0.994},{\"content\":\"123456789\",\"boundingPolygon\":[{\"y\":306.0,\"x\":160.0},{\"y\":306.0,\"x\":285.0},{\"y\":329.0,\"x\":285.0},{\"y\":329.0,\"x\":160.0}],\"span\":{\"offset\":146,\"length\":9},\"confidence\":0.993},{\"content\":\"01\",\"boundingPolygon\":[{\"y\":306.0,\"x\":342.0},{\"y\":306.0,\"x\":369.0},{\"y\":328.0,\"x\":368.0},{\"y\":327.0,\"x\":342.0}],\"span\":{\"offset\":156,\"length\":2},\"confidence\":0.995},{\"content\":\"Group\",\"boundingPolygon\":[{\"y\":368.0,\"x\":71.0},{\"y\":368.0,\"x\":140.0},{\"y\":394.0,\"x\":141.0},{\"y\":394.0,\"x\":72.0}],\"span\":{\"offset\":159,\"length\":5},\"confidence\":0.995},{\"content\":\"#\",\"boundingPolygon\":[{\"y\":368.0,\"x\":147.0},{\"y\":368.0,\"x\":162.0},{\"y\":394.0,\"x\":163.0},{\"y\":394.0,\"x\":147.0}],\"span\":{\"offset\":165,\"length\":1},\"confidence\":0.929},{\"content\":\"1000000\",\"boundingPolygon\":[{\"y\":368.0,\"x\":176.0},{\"y\":368.0,\"x\":269.0},{\"y\":393.0,\"x\":269.0},{\"y\":394.0,\"x\":176.0}],\"span\":{\"offset\":167,\"length\":7},\"confidence\":0.995},{\"content\":\"HEALTH\",\"boundingPolygon\":[{\"y\":366.0,\"x\":548.0},{\"y\":366.0,\"x\":640.0},{\"y\":390.0,\"x\":640.0},{\"y\":390.0,\"x\":549.0}],\"span\":{\"offset\":175,\"length\":6},\"confidence\":0.995},{\"content\":\"SAVINGS\",\"boundingPolygon\":[{\"y\":366.0,\"x\":654.0},{\"y\":366.0,\"x\":758.0},{\"y\":390.0,\"x\":757.0},{\"y\":390.0,\"x\":654.0}],\"span\":{\"offset\":182,\"length\":7},\"confidence\":0.968},{\"content\":\"PLAN\",\"boundingPolygon\":[{\"y\":366.0,\"x\":767.0},{\"y\":366.0,\"x\":828.0},{\"y\":389.0,\"x\":827.0},{\"y\":390.0,\"x\":767.0}],\"span\":{\"offset\":190,\"length\":4},\"confidence\":0.983},{\"content\":\"Rx\",\"boundingPolygon\":[{\"y\":404.0,\"x\":68.0},{\"y\":404.0,\"x\":101.0},{\"y\":431.0,\"x\":102.0},{\"y\":430.0,\"x\":69.0}],\"span\":{\"offset\":195,\"length\":2},\"confidence\":0.984},{\"content\":\"Group\",\"boundingPolygon\":[{\"y\":404.0,\"x\":108.0},{\"y\":405.0,\"x\":178.0},{\"y\":431.0,\"x\":178.0},{\"y\":431.0,\"x\":108.0}],\"span\":{\"offset\":198,\"length\":5},\"confidence\":0.995},{\"content\":\"#\",\"boundingPolygon\":[{\"y\":405.0,\"x\":186.0},{\"y\":405.0,\"x\":199.0},{\"y\":431.0,\"x\":200.0},{\"y\":431.0,\"x\":186.0}],\"span\":{\"offset\":204,\"length\":1},\"confidence\":0.995},{\"content\":\"BCAAXYZ\",\"boundingPolygon\":[{\"y\":405.0,\"x\":214.0},{\"y\":405.0,\"x\":330.0},{\"y\":427.0,\"x\":330.0},{\"y\":430.0,\"x\":214.0}],\"span\":{\"offset\":206,\"length\":7},\"confidence\":0.995},{\"content\":\"Shared\",\"boundingPolygon\":[{\"y\":399.0,\"x\":693.0},{\"y\":398.0,\"x\":758.0},{\"y\":417.0,\"x\":758.0},{\"y\":417.0,\"x\":693.0}],\"span\":{\"offset\":214,\"length\":6},\"confidence\":0.993},{\"content\":\"In\",\"boundingPolygon\":[{\"y\":398.0,\"x\":764.0},{\"y\":398.0,\"x\":781.0},{\"y\":417.0,\"x\":781.0},{\"y\":417.0,\"x\":765.0}],\"span\":{\"offset\":221,\"length\":2},\"confidence\":0.912},{\"content\":\"and\",\"boundingPolygon\":[{\"y\":398.0,\"x\":788.0},{\"y\":398.0,\"x\":821.0},{\"y\":417.0,\"x\":821.0},{\"y\":417.0,\"x\":788.0}],\"span\":{\"offset\":224,\"length\":3},\"confidence\":0.996},{\"content\":\"Out\",\"boundingPolygon\":[{\"y\":398.0,\"x\":829.0},{\"y\":398.0,\"x\":864.0},{\"y\":417.0,\"x\":864.0},{\"y\":417.0,\"x\":829.0}],\"span\":{\"offset\":228,\"length\":3},\"confidence\":0.993},{\"content\":\"of\",\"boundingPolygon\":[{\"y\":398.0,\"x\":868.0},{\"y\":398.0,\"x\":887.0},{\"y\":417.0,\"x\":887.0},{\"y\":417.0,\"x\":868.0}],\"span\":{\"offset\":232,\"length\":2},\"confidence\":0.995},{\"content\":\"Network\",\"boundingPolygon\":[{\"y\":398.0,\"x\":890.0},{\"y\":397.0,\"x\":965.0},{\"y\":417.0,\"x\":965.0},{\"y\":417.0,\"x\":890.0}],\"span\":{\"offset\":235,\"length\":7},\"confidence\":0.993},{\"content\":\"$1,500\",\"boundingPolygon\":[{\"y\":420.0,\"x\":761.0},{\"y\":420.0,\"x\":823.0},{\"y\":440.0,\"x\":823.0},{\"y\":439.0,\"x\":762.0}],\"span\":{\"offset\":243,\"length\":6},\"confidence\":0.993},{\"content\":\"Rx\",\"boundingPolygon\":[{\"y\":439.0,\"x\":70.0},{\"y\":439.0,\"x\":101.0},{\"y\":464.0,\"x\":101.0},{\"y\":464.0,\"x\":69.0}],\"span\":{\"offset\":250,\"length\":2},\"confidence\":0.961},{\"content\":\"BIN#\",\"boundingPolygon\":[{\"y\":439.0,\"x\":108.0},{\"y\":439.0,\"x\":163.0},{\"y\":464.0,\"x\":162.0},{\"y\":464.0,\"x\":107.0}],\"span\":{\"offset\":253,\"length\":4},\"confidence\":0.992},{\"content\":\"987654\",\"boundingPolygon\":[{\"y\":439.0,\"x\":179.0},{\"y\":439.0,\"x\":258.0},{\"y\":464.0,\"x\":257.0},{\"y\":464.0,\"x\":178.0}],\"span\":{\"offset\":258,\"length\":6},\"confidence\":0.995},{\"content\":\"Deductible\",\"boundingPolygon\":[{\"y\":419.0,\"x\":548.0},{\"y\":420.0,\"x\":655.0},{\"y\":442.0,\"x\":655.0},{\"y\":441.0,\"x\":548.0}],\"span\":{\"offset\":265,\"length\":10},\"confidence\":0.993},{\"content\":\"Coinsurance\",\"boundingPolygon\":[{\"y\":448.0,\"x\":549.0},{\"y\":449.0,\"x\":676.0},{\"y\":469.0,\"x\":676.0},{\"y\":469.0,\"x\":549.0}],\"span\":{\"offset\":276,\"length\":11},\"confidence\":0.99},{\"content\":\"Max\",\"boundingPolygon\":[{\"y\":449.0,\"x\":681.0},{\"y\":449.0,\"x\":723.0},{\"y\":469.0,\"x\":723.0},{\"y\":469.0,\"x\":681.0}],\"span\":{\"offset\":288,\"length\":3},\"confidence\":0.995},{\"content\":\"$1,000\",\"boundingPolygon\":[{\"y\":449.0,\"x\":763.0},{\"y\":448.0,\"x\":826.0},{\"y\":469.0,\"x\":827.0},{\"y\":469.0,\"x\":764.0}],\"span\":{\"offset\":292,\"length\":6},\"confidence\":0.994},{\"content\":\"BCBS\",\"boundingPolygon\":[{\"y\":475.0,\"x\":69.0},{\"y\":476.0,\"x\":136.0},{\"y\":499.0,\"x\":137.0},{\"y\":499.0,\"x\":70.0}],\"span\":{\"offset\":299,\"length\":4},\"confidence\":0.991},{\"content\":\"456\",\"boundingPolygon\":[{\"y\":476.0,\"x\":152.0},{\"y\":476.0,\"x\":190.0},{\"y\":499.0,\"x\":191.0},{\"y\":499.0,\"x\":152.0}],\"span\":{\"offset\":304,\"length\":3},\"confidence\":0.997},{\"content\":\"Note:\",\"boundingPolygon\":[{\"y\":539.0,\"x\":547.0},{\"y\":539.0,\"x\":588.0},{\"y\":556.0,\"x\":589.0},{\"y\":555.0,\"x\":548.0}],\"span\":{\"offset\":308,\"length\":5},\"confidence\":0.948},{\"content\":\"Rx\",\"boundingPolygon\":[{\"y\":539.0,\"x\":591.0},{\"y\":539.0,\"x\":612.0},{\"y\":556.0,\"x\":612.0},{\"y\":556.0,\"x\":592.0}],\"span\":{\"offset\":314,\"length\":2},\"confidence\":0.995},{\"content\":\"and\",\"boundingPolygon\":[{\"y\":539.0,\"x\":615.0},{\"y\":539.0,\"x\":642.0},{\"y\":556.0,\"x\":642.0},{\"y\":556.0,\"x\":615.0}],\"span\":{\"offset\":317,\"length\":3},\"confidence\":0.995},{\"content\":\"Medical\",\"boundingPolygon\":[{\"y\":539.0,\"x\":645.0},{\"y\":538.0,\"x\":703.0},{\"y\":555.0,\"x\":704.0},{\"y\":556.0,\"x\":646.0}],\"span\":{\"offset\":321,\"length\":7},\"confidence\":0.979},{\"content\":\"Cost-Shares\",\"boundingPolygon\":[{\"y\":538.0,\"x\":706.0},{\"y\":537.0,\"x\":794.0},{\"y\":554.0,\"x\":795.0},{\"y\":555.0,\"x\":707.0}],\"span\":{\"offset\":329,\"length\":11},\"confidence\":0.982},{\"content\":\"are\",\"boundingPolygon\":[{\"y\":537.0,\"x\":798.0},{\"y\":537.0,\"x\":820.0},{\"y\":553.0,\"x\":821.0},{\"y\":554.0,\"x\":798.0}],\"span\":{\"offset\":341,\"length\":3},\"confidence\":0.995},{\"content\":\"Shared\",\"boundingPolygon\":[{\"y\":537.0,\"x\":825.0},{\"y\":536.0,\"x\":873.0},{\"y\":552.0,\"x\":873.0},{\"y\":553.0,\"x\":825.0}],\"span\":{\"offset\":345,\"length\":6},\"confidence\":0.994},{\"content\":\"Rx\",\"boundingPolygon\":[{\"y\":572.0,\"x\":131.0},{\"y\":573.0,\"x\":208.0},{\"y\":623.0,\"x\":208.0},{\"y\":622.0,\"x\":131.0}],\"span\":{\"offset\":352,\"length\":2},\"confidence\":0.993},{\"content\":\"PPO\",\"boundingPolygon\":[{\"y\":592.0,\"x\":902.0},{\"y\":591.0,\"x\":949.0},{\"y\":613.0,\"x\":950.0},{\"y\":614.0,\"x\":903.0}],\"span\":{\"offset\":355,\"length\":3},\"confidence\":0.994}],\"selectionMarks\":null,\"lines\":[{\"content\":\"PREMERA\",\"boundingPolygon\":[{\"y\":67.0,\"x\":77.0},{\"y\":64.0,\"x\":312.0},{\"y\":109.0,\"x\":312.0},{\"y\":112.0,\"x\":78.0}],\"spans\":[{\"offset\":0,\"length\":7}]},{\"content\":\"Microsoft\",\"boundingPolygon\":[{\"y\":104.0,\"x\":708.0},{\"y\":104.0,\"x\":861.0},{\"y\":138.0,\"x\":861.0},{\"y\":137.0,\"x\":708.0}],\"spans\":[{\"offset\":8,\"length\":9}]},{\"content\":\"BLUE CROSS\",\"boundingPolygon\":[{\"y\":126.0,\"x\":82.0},{\"y\":126.0,\"x\":201.0},{\"y\":144.0,\"x\":201.0},{\"y\":145.0,\"x\":82.0}],\"spans\":[{\"offset\":18,\"length\":10}]},{\"content\":\"Member\",\"boundingPolygon\":[{\"y\":197.0,\"x\":73.0},{\"y\":198.0,\"x\":168.0},{\"y\":221.0,\"x\":168.0},{\"y\":221.0,\"x\":73.0}],\"spans\":[{\"offset\":29,\"length\":6}]},{\"content\":\"Medical Network HERITAGE\",\"boundingPolygon\":[{\"y\":198.0,\"x\":546.0},{\"y\":198.0,\"x\":844.0},{\"y\":222.0,\"x\":844.0},{\"y\":221.0,\"x\":546.0}],\"spans\":[{\"offset\":36,\"length\":24}]},{\"content\":\"ANGEL BROWN\",\"boundingPolygon\":[{\"y\":228.0,\"x\":74.0},{\"y\":228.0,\"x\":252.0},{\"y\":251.0,\"x\":252.0},{\"y\":251.0,\"x\":74.0}],\"spans\":[{\"offset\":61,\"length\":11}]},{\"content\":\"Premera Dental\",\"boundingPolygon\":[{\"y\":233.0,\"x\":548.0},{\"y\":233.0,\"x\":728.0},{\"y\":257.0,\"x\":728.0},{\"y\":257.0,\"x\":548.0}],\"spans\":[{\"offset\":73,\"length\":14}]},{\"content\":\"YES\",\"boundingPolygon\":[{\"y\":233.0,\"x\":778.0},{\"y\":234.0,\"x\":827.0},{\"y\":257.0,\"x\":827.0},{\"y\":256.0,\"x\":778.0}],\"spans\":[{\"offset\":88,\"length\":3}]},{\"content\":\"Prefix Identification # Suffix\",\"boundingPolygon\":[{\"y\":268.0,\"x\":73.0},{\"y\":267.0,\"x\":416.0},{\"y\":293.0,\"x\":416.0},{\"y\":293.0,\"x\":73.0}],\"spans\":[{\"offset\":92,\"length\":30}]},{\"content\":\"Premera Vision\",\"boundingPolygon\":[{\"y\":268.0,\"x\":548.0},{\"y\":269.0,\"x\":725.0},{\"y\":294.0,\"x\":725.0},{\"y\":294.0,\"x\":548.0}],\"spans\":[{\"offset\":123,\"length\":14}]},{\"content\":\"YES\",\"boundingPolygon\":[{\"y\":268.0,\"x\":779.0},{\"y\":269.0,\"x\":828.0},{\"y\":292.0,\"x\":828.0},{\"y\":291.0,\"x\":780.0}],\"spans\":[{\"offset\":138,\"length\":3}]},{\"content\":\"ABC 123456789\",\"boundingPolygon\":[{\"y\":305.0,\"x\":74.0},{\"y\":306.0,\"x\":285.0},{\"y\":328.0,\"x\":285.0},{\"y\":327.0,\"x\":74.0}],\"spans\":[{\"offset\":142,\"length\":13}]},{\"content\":\"01\",\"boundingPolygon\":[{\"y\":306.0,\"x\":341.0},{\"y\":306.0,\"x\":369.0},{\"y\":328.0,\"x\":369.0},{\"y\":327.0,\"x\":342.0}],\"spans\":[{\"offset\":156,\"length\":2}]},{\"content\":\"Group # 1000000\",\"boundingPolygon\":[{\"y\":368.0,\"x\":71.0},{\"y\":367.0,\"x\":270.0},{\"y\":392.0,\"x\":270.0},{\"y\":393.0,\"x\":71.0}],\"spans\":[{\"offset\":159,\"length\":15}]},{\"content\":\"HEALTH SAVINGS PLAN\",\"boundingPolygon\":[{\"y\":366.0,\"x\":548.0},{\"y\":366.0,\"x\":833.0},{\"y\":389.0,\"x\":833.0},{\"y\":390.0,\"x\":548.0}],\"spans\":[{\"offset\":175,\"length\":19}]},{\"content\":\"Rx Group # BCAAXYZ\",\"boundingPolygon\":[{\"y\":403.0,\"x\":67.0},{\"y\":403.0,\"x\":331.0},{\"y\":429.0,\"x\":331.0},{\"y\":430.0,\"x\":67.0}],\"spans\":[{\"offset\":195,\"length\":18}]},{\"content\":\"Shared In and Out of Network\",\"boundingPolygon\":[{\"y\":397.0,\"x\":692.0},{\"y\":397.0,\"x\":967.0},{\"y\":416.0,\"x\":967.0},{\"y\":417.0,\"x\":692.0}],\"spans\":[{\"offset\":214,\"length\":28}]},{\"content\":\"$1,500\",\"boundingPolygon\":[{\"y\":420.0,\"x\":760.0},{\"y\":420.0,\"x\":824.0},{\"y\":439.0,\"x\":824.0},{\"y\":439.0,\"x\":760.0}],\"spans\":[{\"offset\":243,\"length\":6}]},{\"content\":\"Rx BIN# 987654\",\"boundingPolygon\":[{\"y\":438.0,\"x\":68.0},{\"y\":439.0,\"x\":261.0},{\"y\":463.0,\"x\":261.0},{\"y\":463.0,\"x\":68.0}],\"spans\":[{\"offset\":250,\"length\":14}]},{\"content\":\"Deductible\",\"boundingPolygon\":[{\"y\":418.0,\"x\":548.0},{\"y\":419.0,\"x\":658.0},{\"y\":441.0,\"x\":658.0},{\"y\":440.0,\"x\":548.0}],\"spans\":[{\"offset\":265,\"length\":10}]},{\"content\":\"Coinsurance Max\",\"boundingPolygon\":[{\"y\":448.0,\"x\":548.0},{\"y\":448.0,\"x\":724.0},{\"y\":469.0,\"x\":724.0},{\"y\":468.0,\"x\":548.0}],\"spans\":[{\"offset\":276,\"length\":15}]},{\"content\":\"$1,000\",\"boundingPolygon\":[{\"y\":448.0,\"x\":763.0},{\"y\":448.0,\"x\":827.0},{\"y\":469.0,\"x\":827.0},{\"y\":468.0,\"x\":763.0}],\"spans\":[{\"offset\":292,\"length\":6}]},{\"content\":\"BCBS 456\",\"boundingPolygon\":[{\"y\":474.0,\"x\":68.0},{\"y\":475.0,\"x\":193.0},{\"y\":499.0,\"x\":193.0},{\"y\":498.0,\"x\":68.0}],\"spans\":[{\"offset\":299,\"length\":8}]},{\"content\":\"Note: Rx and Medical Cost-Shares are Shared\",\"boundingPolygon\":[{\"y\":539.0,\"x\":547.0},{\"y\":535.0,\"x\":875.0},{\"y\":552.0,\"x\":875.0},{\"y\":556.0,\"x\":547.0}],\"spans\":[{\"offset\":308,\"length\":43}]},{\"content\":\"Rx\",\"boundingPolygon\":[{\"y\":572.0,\"x\":129.0},{\"y\":574.0,\"x\":210.0},{\"y\":622.0,\"x\":211.0},{\"y\":622.0,\"x\":129.0}],\"spans\":[{\"offset\":352,\"length\":2}]},{\"content\":\"PPO\",\"boundingPolygon\":[{\"y\":592.0,\"x\":902.0},{\"y\":591.0,\"x\":957.0},{\"y\":612.0,\"x\":958.0},{\"y\":614.0,\"x\":903.0}],\"spans\":[{\"offset\":355,\"length\":3}]}],\"barcodes\":null,\"formulas\":null}],\"tables\":null,\"keyValuePairs\":null,\"styles\":null,\"documents\":[{\"docType\":\"healthInsuranceCard.us\",\"boundingRegions\":[{\"pageNumber\":1,\"boundingPolygon\":[{\"y\":0.0,\"x\":0.0},{\"y\":0.0,\"x\":1000.0},{\"y\":700.0,\"x\":1000.0},{\"y\":700.0,\"x\":0.0}]}],\"spans\":[{\"offset\":0,\"length\":358}],\"fields\":{\"Copays\":{\"value\":[{\"value\":{\"Benefit\":{\"value\":\"Deductible\",\"type\":\"string\",\"content\":\"Deductible\",\"boundingRegions\":[{\"pageNumber\":1,\"boundingPolygon\":[{\"y\":419.0,\"x\":548.0},{\"y\":420.0,\"x\":655.0},{\"y\":442.0,\"x\":655.0},{\"y\":441.0,\"x\":548.0}]}],\"spans\":[{\"offset\":265,\"length\":10}],\"confidence\":null},\"Amount\":{\"value\":null,\"type\":\"currency\",\"content\":\"$1,500\",\"boundingRegions\":[{\"pageNumber\":1,\"boundingPolygon\":[{\"y\":420.0,\"x\":761.0},{\"y\":420.0,\"x\":823.0},{\"y\":440.0,\"x\":823.0},{\"y\":439.0,\"x\":762.0}]}],\"spans\":[{\"offset\":243,\"length\":6}],\"confidence\":null}},\"type\":\"object\",\"content\":null,\"boundingRegions\":null,\"spans\":null,\"confidence\":null},{\"value\":{\"Benefit\":{\"value\":\"Coinsurance Max\",\"type\":\"string\",\"content\":\"Coinsurance Max\",\"boundingRegions\":[{\"pageNumber\":1,\"boundingPolygon\":[{\"y\":448.0,\"x\":549.0},{\"y\":449.0,\"x\":723.0},{\"y\":470.0,\"x\":723.0},{\"y\":469.0,\"x\":549.0}]}],\"spans\":[{\"offset\":276,\"length\":15}],\"confidence\":null},\"Amount\":{\"value\":null,\"type\":\"currency\",\"content\":\"$1,000\",\"boundingRegions\":[{\"pageNumber\":1,\"boundingPolygon\":[{\"y\":449.0,\"x\":763.0},{\"y\":448.0,\"x\":826.0},{\"y\":469.0,\"x\":827.0},{\"y\":469.0,\"x\":764.0}]}],\"spans\":[{\"offset\":292,\"length\":6}],\"confidence\":null}},\"type\":\"object\",\"content\":null,\"boundingRegions\":null,\"spans\":null,\"confidence\":null}],\"type\":\"array\",\"content\":null,\"boundingRegions\":null,\"spans\":null,\"confidence\":null},\"IdNumber\":{\"value\":{\"Number\":{\"value\":\"123456789\",\"type\":\"string\",\"content\":\"123456789\",\"boundingRegions\":[{\"pageNumber\":1,\"boundingPolygon\":[{\"y\":306.0,\"x\":160.0},{\"y\":306.0,\"x\":285.0},{\"y\":329.0,\"x\":285.0},{\"y\":329.0,\"x\":160.0}]}],\"spans\":[{\"offset\":146,\"length\":9}],\"confidence\":0.995},\"Prefix\":{\"value\":\"ABC\",\"type\":\"string\",\"content\":\"ABC\",\"boundingRegions\":[{\"pageNumber\":1,\"boundingPolygon\":[{\"y\":306.0,\"x\":75.0},{\"y\":305.0,\"x\":124.0},{\"y\":328.0,\"x\":125.0},{\"y\":328.0,\"x\":76.0}]}],\"spans\":[{\"offset\":142,\"length\":3}],\"confidence\":0.995}},\"type\":\"object\",\"content\":null,\"boundingRegions\":null,\"spans\":null,\"confidence\":null},\"GroupNumber\":{\"value\":\"1000000\",\"type\":\"string\",\"content\":\"1000000\",\"boundingRegions\":[{\"pageNumber\":1,\"boundingPolygon\":[{\"y\":368.0,\"x\":176.0},{\"y\":368.0,\"x\":269.0},{\"y\":393.0,\"x\":269.0},{\"y\":394.0,\"x\":176.0}]}],\"spans\":[{\"offset\":167,\"length\":7}],\"confidence\":0.995},\"PrescriptionInfo\":{\"value\":{\"RxGrp\":{\"value\":\"BCAAXYZ\",\"type\":\"string\",\"content\":\"BCAAXYZ\",\"boundingRegions\":[{\"pageNumber\":1,\"boundingPolygon\":[{\"y\":405.0,\"x\":214.0},{\"y\":405.0,\"x\":330.0},{\"y\":427.0,\"x\":330.0},{\"y\":430.0,\"x\":214.0}]}],\"spans\":[{\"offset\":206,\"length\":7}],\"confidence\":0.995},\"RxBIN\":{\"value\":\"987654\",\"type\":\"string\",\"content\":\"987654\",\"boundingRegions\":[{\"pageNumber\":1,\"boundingPolygon\":[{\"y\":439.0,\"x\":179.0},{\"y\":439.0,\"x\":258.0},{\"y\":464.0,\"x\":257.0},{\"y\":464.0,\"x\":178.0}]}],\"spans\":[{\"offset\":258,\"length\":6}],\"confidence\":0.995}},\"type\":\"object\",\"content\":null,\"boundingRegions\":null,\"spans\":null,\"confidence\":null},\"Plan\":{\"value\":{\"Number\":{\"value\":\"456\",\"type\":\"string\",\"content\":\"456\",\"boundingRegions\":[{\"pageNumber\":1,\"boundingPolygon\":[{\"y\":476.0,\"x\":152.0},{\"y\":476.0,\"x\":190.0},{\"y\":499.0,\"x\":191.0},{\"y\":499.0,\"x\":152.0}]}],\"spans\":[{\"offset\":304,\"length\":3}],\"confidence\":0.995},\"Name\":{\"value\":\"HEALTH SAVINGS PLAN\",\"type\":\"string\",\"content\":\"HEALTH SAVINGS PLAN\",\"boundingRegions\":[{\"pageNumber\":1,\"boundingPolygon\":[{\"y\":366.0,\"x\":548.0},{\"y\":366.0,\"x\":828.0},{\"y\":390.0,\"x\":828.0},{\"y\":390.0,\"x\":548.0}]}],\"spans\":[{\"offset\":175,\"length\":19}],\"confidence\":0.995}},\"type\":\"object\",\"content\":null,\"boundingRegions\":null,\"spans\":null,\"confidence\":null},\"Member\":{\"value\":{\"Employer\":{\"value\":\"Microsoft\",\"type\":\"string\",\"content\":\"Microsoft\",\"boundingRegions\":[{\"pageNumber\":1,\"boundingPolygon\":[{\"y\":104.0,\"x\":709.0},{\"y\":105.0,\"x\":859.0},{\"y\":139.0,\"x\":860.0},{\"y\":138.0,\"x\":708.0}]}],\"spans\":[{\"offset\":8,\"length\":9}],\"confidence\":0.995},\"IdNumberSuffix\":{\"value\":\"01\",\"type\":\"string\",\"content\":\"01\",\"boundingRegions\":[{\"pageNumber\":1,\"boundingPolygon\":[{\"y\":306.0,\"x\":342.0},{\"y\":306.0,\"x\":369.0},{\"y\":328.0,\"x\":368.0},{\"y\":327.0,\"x\":342.0}]}],\"spans\":[{\"offset\":156,\"length\":2}],\"confidence\":0.995},\"Name\":{\"value\":\"ANGEL BROWN\",\"type\":\"string\",\"content\":\"ANGEL BROWN\",\"boundingRegions\":[{\"pageNumber\":1,\"boundingPolygon\":[{\"y\":228.0,\"x\":75.0},{\"y\":229.0,\"x\":247.0},{\"y\":253.0,\"x\":247.0},{\"y\":252.0,\"x\":75.0}]}],\"spans\":[{\"offset\":61,\"length\":11}],\"confidence\":0.995}},\"type\":\"object\",\"content\":null,\"boundingRegions\":null,\"spans\":null,\"confidence\":null},\"Insurer\":{\"value\":\"PREMERA BLUE CROSS\",\"type\":\"string\",\"content\":\"PREMERA\\nBLUE CROSS\",\"boundingRegions\":[{\"pageNumber\":1,\"boundingPolygon\":[{\"y\":65.0,\"x\":78.0},{\"y\":65.0,\"x\":299.0},{\"y\":145.0,\"x\":299.0},{\"y\":145.0,\"x\":78.0}]}],\"spans\":[{\"offset\":0,\"length\":7},{\"offset\":18,\"length\":10}],\"confidence\":0.995}},\"confidence\":1.0}],\"languages\":null,\"paragraphs\":null}";

    @BeforeAll
    static void beforeAll() {
        StepVerifier.setDefaultTimeout(Duration.ofSeconds(30));
    }

    @AfterAll
    static void afterAll() {
        StepVerifier.resetDefaultTimeout();
    }

    private DocumentAnalysisClient getDocumentAnalysisClient(HttpClient httpClient,
                                                             DocumentAnalysisServiceVersion serviceVersion) {
        return getDocumentAnalysisBuilder(httpClient, serviceVersion, false).buildClient();
    }

    /**
     * Verifies that the analyzed result of an insurance card data deserializes accurately.
     */
    @ParameterizedTest(name = DISPLAY_NAME_WITH_ARGUMENTS)
    @MethodSource("com.azure.ai.formrecognizer.documentanalysis.TestUtils#getTestParameters")
    public void deserializeAnalyzeResult(HttpClient httpClient, DocumentAnalysisServiceVersion serviceVersion)
        throws JsonProcessingException {
        client = getDocumentAnalysisClient(httpClient, serviceVersion);
        AtomicReference<AnalyzeResult> analyzeResult = new AtomicReference<>();
        dataRunner((data, dataLength) -> {
            SyncPoller<OperationResult, AnalyzeResult> syncPoller
                = client.beginAnalyzeDocument("prebuilt-healthInsuranceCard.us",
                    BinaryData.fromStream(data, dataLength))
                .setPollInterval(durationTestMode);
            analyzeResult.set(syncPoller.getFinalResult());
        }, INSURANCE_PNG);

        ObjectMapper obj = new ObjectMapper();
        JsonNode actualResult = obj.readTree(obj.writeValueAsString(analyzeResult.get()));

        assertEquals(obj.readTree(expectedDeserializedString), actualResult);
    }
}
