extends:
  template: /eng/pipelines/templates/stages/archetype-sdk-tests.yml
  parameters:
    ServiceDirectory: openai
    DisableAzureResourceCreation: true
    UseFederatedAuth: false
    PreSteps:
      - template: ./../../../../../sdk/openai/openai-build.yml
    PreTestRunSteps:
      - script: |
          java -version
          echo "JavaTestVersion (before): $JavaTestVersion"
          export JavaTestVersion=1.8 
          echo "JavaTestVersion (after): $JavaTestVersion"
          
          echo "maven -version"  
          mvn -version
          
          echo "JAVA_HOME: $JAVA_HOME"
          echo "PATH: $PATH"
          export JAVA_HOME=/usr/lib/jvm/temurin-8-jdk-amd64
          echo "JAVA_HOME (after): $JAVA_HOME"

        displayName: "Override JavaTestVersion to 1.8"
    Artifacts:
      - name: azure-ai-openai
        groupId: com.azure
        safeName: azureaiopenai
    CloudConfig:
      Public:
        ServiceConnection: azure-sdk-tests-openai
    EnvVars:
      AZURE_OPENAI_ENDPOINT: $(AOAI-ENDPOINT-SWEDENCENTRAL)
      AZURE_OPENAI_KEY: $(AOAI-API-KEY-SWEDENCENTRAL)
      NON_AZURE_OPENAI_KEY: $(OPENAI-API-KEY)
      AZURE_TEST_RUN_LIVE: 'true'
      API_VERSION_GA: '2024-06-01'
    MatrixFilters:
      - JavaTestVersion=^(?!1.8).*
      - TestFromSource=^$|false
      - AZURE_TEST_HTTP_CLIENTS=netty
      - pool=^(?!.*(win)).*
    MatrixReplace:
      - AZURE_TEST.*=.*/ # A replacement pattern for any string that matches AZURE_TEST.*=.*/.
      - JavaTestVersion=(.*1)\.\d{2}(.*)/$1.8$2 # It matches JavaTestVersion values that start with 1. followed by two digits and replaces them with 1.8.
