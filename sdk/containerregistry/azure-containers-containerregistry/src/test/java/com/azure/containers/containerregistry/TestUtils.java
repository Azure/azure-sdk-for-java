// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
// Code generated by Microsoft (R) AutoRest Code Generator.

package com.azure.containers.containerregistry;

import com.azure.containers.containerregistry.models.ManifestMediaType;
import com.azure.containers.containerregistry.models.OciAnnotations;
import com.azure.containers.containerregistry.models.OciDescriptor;
import com.azure.containers.containerregistry.models.OciImageManifest;
import com.azure.core.credential.TokenCredential;
import com.azure.core.management.AzureEnvironment;
import com.azure.core.management.profile.AzureProfile;
import com.azure.core.test.TestMode;
import com.azure.core.test.utils.MockTokenCredential;
import com.azure.core.util.BinaryData;
import com.azure.core.util.Configuration;
import com.azure.core.util.logging.ClientLogger;
import com.azure.identity.AzureAuthorityHosts;
import com.azure.identity.AzurePowerShellCredentialBuilder;
import com.azure.identity.DefaultAzureCredentialBuilder;
import com.azure.resourcemanager.containerregistry.ContainerRegistryManager;
import com.azure.resourcemanager.containerregistry.models.ImportImageParameters;
import com.azure.resourcemanager.containerregistry.models.ImportMode;
import com.azure.resourcemanager.containerregistry.models.ImportSource;

import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.Locale;
import java.util.stream.Collectors;

import static com.azure.containers.containerregistry.implementation.UtilsImpl.computeDigest;

public class TestUtils {
    public static final BinaryData CONFIG_DATA = BinaryData.fromString("{}");
    public static final String CONFIG_DIGEST = computeDigest(CONFIG_DATA.toByteBuffer());
    public static final BinaryData LAYER_DATA = BinaryData.fromString("hello world");
    public static final String LAYER_DIGEST = computeDigest(LAYER_DATA.toByteBuffer());
    public static final OciImageManifest MANIFEST = createManifest();
    public static final String MANIFEST_DIGEST
        = "sha256:492bc88863bdf51159c4efe84e851c48d7034881159b56c4338003e50e801598";
    public static final String DISPLAY_NAME_WITH_ARGUMENTS = "{displayName} with [{arguments}]";
    private static final Configuration CONFIGURATION = Configuration.getGlobalConfiguration();
    public static final String ALPINE_REPOSITORY_NAME = "library/alpine";
    public static final String HELLO_WORLD_REPOSITORY_NAME = "library/hello-world";
    public static final String HELLO_WORLD_SEATTLE_REPOSITORY_NAME = "library/hello-seattle";
    public static final String LATEST_TAG_NAME = "latest";
    public static final String V1_TAG_NAME = "v1";
    public static final String V2_TAG_NAME = "v2";
    public static final String V4_TAG_NAME = "v4";
    public static final String V3_TAG_NAME = "v3";
    public static final String TAG_UNKNOWN = "unknowntag";
    public static final String DIGEST_UNKNOWN
        = "sha256:ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff";
    public static final int PAGESIZE_2 = 2;
    public static final int PAGESIZE_1 = 1;
    public static final String REGISTRY_NAME = CONFIGURATION.get("CONTAINERREGISTRY_REGISTRY_NAME");
    public static final String RESOURCE_GROUP = CONFIGURATION.get("CONTAINERREGISTRY_RESOURCE_GROUP");
    public static final String SUBSCRIPTION_ID = CONFIGURATION.get("CONTAINERREGISTRY_SUBSCRIPTION_ID");
    public static final String TENANT_ID = CONFIGURATION.get("CONTAINERREGISTRY_TENANT_ID");
    public static final String REGISTRY_URI = "registry.hub.docker.com";
    public static final String REGISTRY_ENDPOINT = CONFIGURATION.get("CONTAINERREGISTRY_ENDPOINT");
    public static final String ANONYMOUS_REGISTRY_ENDPOINT
        = CONFIGURATION.get("CONTAINERREGISTRY_ANONREGISTRY_ENDPOINT");
    public static final long SLEEP_TIME_IN_MILLISECONDS = 5000;
    public static final String ANONYMOUS_REGISTRY_NAME = CONFIGURATION.get("CONTAINERREGISTRY_ANONREGISTRY_NAME");
    public static final String REGISTRY_ENDPOINT_PLAYBACK = "https://REDACTED";
    public static final String REGISTRY_NAME_PLAYBACK = "REDACTED";
    public static final int HTTP_STATUS_CODE_202 = 202;
    public static final TestMode TEST_MODE = initializeTestMode();

    public static final ManifestMediaType OCI_INDEX_MEDIA_TYPE
        = ManifestMediaType.fromString("application/vnd.oci.image.index.v1+json");
    public static final ManifestMediaType DOCKER_MANIFEST_LIST_TYPE
        = ManifestMediaType.fromString("application/vnd.docker.distribution.manifest.list.v2+json");

    static <T extends Comparable<? super T>> boolean isSorted(Iterable<T> iterable) {
        Iterator<T> iter = iterable.iterator();
        if (!iter.hasNext()) {
            return true;
        }
        T t = iter.next();
        while (iter.hasNext()) {
            T t2 = iter.next();
            if (t.compareTo(t2) > 0) {
                return false;
            }
            t = t2;
        }
        return true;
    }

    static TokenCredential getCredentialByAuthority(String authority) {
        switch (TestUtils.TEST_MODE) {
            case LIVE:
                return new AzurePowerShellCredentialBuilder().build();

            case RECORD:
                return new DefaultAzureCredentialBuilder().authorityHost(authority).build();

            default:
                return new MockTokenCredential();
        }
    }

    public static String getAuthority(String endpoint) {
        if (endpoint == null) {
            return AzureAuthorityHosts.AZURE_PUBLIC_CLOUD;
        }

        if (endpoint.contains(".azurecr.io")) {
            return AzureAuthorityHosts.AZURE_PUBLIC_CLOUD;
        }

        if (endpoint.contains(".azurecr.cn")) {
            return AzureAuthorityHosts.AZURE_CHINA;
        }

        if (endpoint.contains(".azurecr.us")) {
            return AzureAuthorityHosts.AZURE_GOVERNMENT;
        }

        // by default we will assume that the authority is public
        return AzureAuthorityHosts.AZURE_PUBLIC_CLOUD;
    }

    static AzureProfile getAzureProfile(String authority) {
        switch (authority) {
            case AzureAuthorityHosts.AZURE_PUBLIC_CLOUD:
                return new AzureProfile(TENANT_ID, SUBSCRIPTION_ID, AzureEnvironment.AZURE);

            case AzureAuthorityHosts.AZURE_CHINA:
                return new AzureProfile(TENANT_ID, SUBSCRIPTION_ID, AzureEnvironment.AZURE_CHINA);

            case AzureAuthorityHosts.AZURE_GOVERNMENT:
                return new AzureProfile(TENANT_ID, SUBSCRIPTION_ID, AzureEnvironment.AZURE_US_GOVERNMENT);

            default:
                return null;
        }
    }

    static void importImage(String registryName, String repository, List<String> tags, String endpoint) {
        if (TestUtils.TEST_MODE == TestMode.PLAYBACK) {
            return;
        }

        String authority = getAuthority(endpoint);

        TokenCredential credential = getCredentialByAuthority(authority);
        tags = tags.stream().map(tag -> repository + ":" + tag).collect(Collectors.toList());
        AzureProfile profile = getAzureProfile(authority);

        ContainerRegistryManager manager = ContainerRegistryManager.authenticate(credential, profile);

        int index = 0;
        do {
            try {
                manager.serviceClient()
                    .getRegistries()
                    .importImage(RESOURCE_GROUP, registryName,
                        new ImportImageParameters().withMode(ImportMode.FORCE)
                            .withSource(new ImportSource().withSourceImage(repository).withRegistryUri(REGISTRY_URI))
                            .withTargetTags(tags));
                return;
            } catch (Exception ex) {
                sleep();
            }
        } while (++index < 3);

        sleep();
    }

    private static void sleep() {
        try {
            Thread.sleep(SLEEP_TIME_IN_MILLISECONDS);
        } catch (InterruptedException ex) {
            throw new RuntimeException(ex);
        }
    }

    private static OciImageManifest createManifest() {
        OciImageManifest manifest = new OciImageManifest().setSchemaVersion(2)
            .setConfiguration(new OciDescriptor().setMediaType("application/vnd.acme.rocket.config.v1+json")
                .setDigest(CONFIG_DIGEST)
                .setSizeInBytes(171L));

        List<OciDescriptor> layers = new ArrayList<>();

        layers.add(new OciDescriptor().setMediaType("application/vnd.oci.image.layer.v1.tar")
            .setSizeInBytes(28L)
            .setDigest(LAYER_DIGEST)
            .setAnnotations(
                new OciAnnotations().setName("654b93f61054e4ce90ed203bb8d556a6200d5f906cf3eca0620738d6dc18cbed")));

        manifest.setLayers(layers);
        return manifest;
    }

    private static TestMode initializeTestMode() {
        ClientLogger logger = new ClientLogger(TestUtils.class);
        String azureTestMode = Configuration.getGlobalConfiguration().get("AZURE_TEST_MODE");
        if (azureTestMode != null) {
            try {
                return TestMode.valueOf(azureTestMode.toUpperCase(Locale.US));
            } catch (IllegalArgumentException var3) {
                logger.error("Could not parse '{}' into TestEnum. Using 'Playback' mode.", azureTestMode);
                return TestMode.PLAYBACK;
            }
        } else {
            logger.info("Environment variable '{}' has not been set yet. Using 'Playback' mode.", "AZURE_TEST_MODE");
            return TestMode.PLAYBACK;
        }
    }
}
