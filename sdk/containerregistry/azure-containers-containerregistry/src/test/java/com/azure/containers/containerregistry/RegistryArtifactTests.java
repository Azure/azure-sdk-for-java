// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
// Code generated by Microsoft (R) AutoRest Code Generator.

package com.azure.containers.containerregistry;

import com.azure.core.http.HttpClient;
import com.azure.core.http.netty.NettyAsyncHttpClientBuilder;
import com.azure.core.test.TestMode;
import com.azure.core.util.Context;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.MethodSource;
import reactor.core.publisher.Mono;
import reactor.test.StepVerifier;

import java.util.Arrays;

import static com.azure.containers.containerregistry.TestUtils.ALPINE_REPOSITORY_NAME;
import static com.azure.containers.containerregistry.TestUtils.DISPLAY_NAME_WITH_ARGUMENTS;
import static com.azure.containers.containerregistry.TestUtils.LATEST_TAG_NAME;
import static com.azure.containers.containerregistry.TestUtils.V1_TAG_NAME;
import static com.azure.containers.containerregistry.TestUtils.V2_TAG_NAME;
import static com.azure.containers.containerregistry.TestUtils.V3_TAG_NAME;
import static com.azure.containers.containerregistry.TestUtils.V4_TAG_NAME;
import static com.azure.containers.containerregistry.TestUtils.monoDelay;
import static org.junit.jupiter.api.Assertions.assertNull;
import static org.junit.jupiter.api.Assertions.assertTrue;

public class RegistryArtifactTests extends ContainerRegistryClientsTestBase {
    private RegistryArtifactAsync asyncClient;
    private RegistryArtifact client;
    private String recordFileName;
    private String tagOrDigest;
    private boolean resetManifestProperties;
    private boolean resetTagProperties;

    @BeforeEach
    void beforeEach() {
        TestUtils.importImage(
            getTestMode(),
            ALPINE_REPOSITORY_NAME,
            Arrays.asList(
                LATEST_TAG_NAME,
                V1_TAG_NAME,
                V2_TAG_NAME,
                V3_TAG_NAME,
                V4_TAG_NAME));
    }

    @AfterEach
    void afterEach() {
        if (getTestMode() == TestMode.PLAYBACK) {
            return;
        }

        if (resetManifestProperties) {
            client = getRegistryArtifactClient(new NettyAsyncHttpClientBuilder().build(), tagOrDigest);
            client.setManifestProperties(defaultManifestProperties);
        }

        if (resetTagProperties) {
            client = getRegistryArtifactClient(new NettyAsyncHttpClientBuilder().build(), tagOrDigest);
            client.setTagProperties(tagOrDigest, defaultTagProperties);
        }
    }

    private RegistryArtifactAsync getRegistryArtifactAsyncClient(String tagOrDigest) {
        return getRegistryArtifactAsyncClient(new LocalHttpClient(recordFileName), tagOrDigest);
    }

    private RegistryArtifactAsync getRegistryArtifactAsyncClient(HttpClient httpClient, String tagOrDigest) {
        return getContainerRegistryBuilder(httpClient)
            .buildAsyncClient()
            .getArtifact(ALPINE_REPOSITORY_NAME, tagOrDigest);
    }

    private RegistryArtifact getRegistryArtifactClient(HttpClient httpClient, String tagOrDigest) {
        return getContainerRegistryBuilder(httpClient)
            .buildClient()
            .getArtifact(ALPINE_REPOSITORY_NAME, tagOrDigest);
    }

    private RegistryArtifact getRegistryArtifactClient(String tagOrDigest) {
        return getRegistryArtifactClient(new LocalHttpClient(recordFileName), tagOrDigest);
    }

    @ParameterizedTest(name = DISPLAY_NAME_WITH_ARGUMENTS)
    @MethodSource("getHttpClients")
    public void delete(HttpClient httpClient) {
        client = getRegistryArtifactClient(httpClient, V4_TAG_NAME);
        String digest = getChildArtifactDigest(client.getManifestProperties().getManifestReferences());

        asyncClient = getRegistryArtifactAsyncClient(httpClient, digest);

        Mono<Boolean> delete = asyncClient.delete()
            .then(monoDelay())
            .then(asyncClient.getManifestProperties()
                .flatMap(res -> Mono.just(false))
                .onErrorResume(res -> Mono.just(true)));

        StepVerifier.create(delete)
            .assertNext(res -> assertTrue(res))
            .verifyComplete();
    }

    @ParameterizedTest(name = DISPLAY_NAME_WITH_ARGUMENTS)
    @MethodSource("getHttpClients")
    public void deleteTag(HttpClient httpClient) {
        client = getRegistryArtifactClient(httpClient, LATEST_TAG_NAME);
        asyncClient = getRegistryArtifactAsyncClient(httpClient, LATEST_TAG_NAME);

        Mono<Boolean> delete = asyncClient.deleteTag(V3_TAG_NAME)
            .then(monoDelay())
            .then(asyncClient.getTagProperties(V3_TAG_NAME)
                .flatMap(res -> Mono.just(false))
                .onErrorResume(res -> Mono.just(true)));

        StepVerifier.create(delete)
            .assertNext(res -> assertTrue(res))
            .verifyComplete();
    }

    @ParameterizedTest(name = DISPLAY_NAME_WITH_ARGUMENTS)
    @MethodSource("getHttpClients")
    public void setManifestProperties(HttpClient httpClient) {
        client = getRegistryArtifactClient(httpClient, V1_TAG_NAME);
        asyncClient = getRegistryArtifactAsyncClient(httpClient, V1_TAG_NAME);

        resetManifestProperties = true;
        tagOrDigest = V1_TAG_NAME;

        StepVerifier.create(asyncClient.setManifestProperties(manifestWriteableProperties))
            .assertNext(res -> validateManifestContentProperties(res))
            .verifyComplete();

        StepVerifier.create(asyncClient.setManifestPropertiesWithResponse(manifestWriteableProperties))
            .assertNext(res -> validateManifestContentProperties(res.getValue()))
            .verifyComplete();

        validateManifestContentProperties(client.setManifestProperties(manifestWriteableProperties));

        validateManifestContentProperties(client.setManifestPropertiesWithResponse(manifestWriteableProperties, Context.NONE)
            .getValue());
    }

    @ParameterizedTest(name = DISPLAY_NAME_WITH_ARGUMENTS)
    @MethodSource("getHttpClients")
    public void setTagProperties(HttpClient httpClient) {
        client = getRegistryArtifactClient(httpClient, V2_TAG_NAME);
        asyncClient = getRegistryArtifactAsyncClient(httpClient, V2_TAG_NAME);

        tagOrDigest = V2_TAG_NAME;
        resetTagProperties = true;

        StepVerifier.create(asyncClient.setTagProperties(V2_TAG_NAME, tagWriteableProperties))
            .assertNext(res -> validateTagContentProperties(res))
            .verifyComplete();

        StepVerifier.create(asyncClient.setTagPropertiesWithResponse(V2_TAG_NAME, tagWriteableProperties))
            .assertNext(res -> validateTagContentProperties(res.getValue()))
            .verifyComplete();

        validateTagContentProperties(client.setTagProperties(V2_TAG_NAME, tagWriteableProperties));

        validateTagContentProperties(client.setTagPropertiesWithResponse(V2_TAG_NAME, tagWriteableProperties, Context.NONE)
            .getValue());
    }

    @Test
    public void deleteFromRecordFile() {
        recordFileName = "RegistryArtifactTests.delete[1].json";
        client = getRegistryArtifactClient(V4_TAG_NAME);
        String digest = getChildArtifactDigest(client.getManifestProperties().getManifestReferences());

        asyncClient = getRegistryArtifactAsyncClient(digest);
        client = getRegistryArtifactClient(digest);

        StepVerifier.create(asyncClient.delete())
            .verifyComplete();

        StepVerifier.create(asyncClient.deleteWithResponse())
            .assertNext(res -> assertNull(res.getValue()))
            .verifyComplete();

        client.delete();
        assertNull(client.deleteWithResponse(Context.NONE).getValue());
    }

    @Test
    public void deleteTagFromRecordFile() {
        recordFileName = "RegistryArtifactTests.deleteTag[1].json";
        client = getRegistryArtifactClient(LATEST_TAG_NAME);
        asyncClient = getRegistryArtifactAsyncClient(LATEST_TAG_NAME);

        StepVerifier.create(asyncClient.deleteTag(V3_TAG_NAME))
            .verifyComplete();

        StepVerifier.create(asyncClient.deleteTagWithResponse(V3_TAG_NAME))
            .assertNext(res -> assertNull(res.getValue()))
            .verifyComplete();

        client.deleteTag(V3_TAG_NAME);
        assertNull(client.deleteTagWithResponse(V3_TAG_NAME, Context.NONE).getValue());
    }
}
