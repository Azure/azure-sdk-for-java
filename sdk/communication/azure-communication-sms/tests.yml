trigger: none

stages:
- template: /eng/pipelines/templates/stages/archetype-sdk-tests.yml
  parameters:
    CloudConfig:
      Public:
        SubscriptionConfigurations:
          - $(sub-config-azure-cloud-test-resources)
          - $(sub-config-communication-services-cloud-test-resources-common)
          - $(sub-config-communication-services-cloud-test-resources-java)
      Int:
        SubscriptionConfigurations:
          - $(sub-config-communication-int-test-resources-common)
          - $(sub-config-communication-int-test-resources-java)
    Clouds: Public, Int
    Artifacts:
      - name: azure-communication-sms
        groupId: com.azure
        safeName: azurecommunicationsms
    ServiceDirectory: communication
    PostSteps:
      - task: Maven@3
        displayName: 'Generate code coverage report'
        # The OSName variable gets set by the verify-agent-os.yml template
        condition: and(eq(variables['Agent.OS'], 'Windows_NT'), eq(variables['JavaTestVersion'], '1.11'))
        inputs:
          mavenPomFile: sdk/communication/azure-communication-sms/pom.xml
          options: -Psms-coverage
          mavenOptions: '$(MemoryOptions) $(LoggingOptions)'
          javaHomeOption: 'JDKVersion'
          jdkVersionOption: $(JavaTestVersion)
          jdkArchitectureOption: 'x64'
          goals: jacoco:report

      - task: PublishCodeCoverageResults@1
        condition: and(eq(variables['Agent.OS'], 'Windows_NT'), eq(variables['JavaTestVersion'], '1.11'))
        inputs:
          codeCoverageTool: JaCoCo
          summaryFileLocation: ${project.build.directory}/site/jacoco/jacoco.xml
          reportDirectory: sdk/communication/azure-communication-sms/target/site/jacoco-coverage/
          failIfCoverageEmpty: true
    EnvVars:
      SKIP_LIVE_TEST: TRUE
