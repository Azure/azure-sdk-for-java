trigger: none

stages:
    - template: /eng/pipelines/templates/stages/archetype-sdk-tests.yml
      parameters:
          PackageName: azure-communication-identity
          SafeName: azurecommunicationidentity
          BuildTargetingString: 'azure-communication-identity'
          JobName: identity
          Clouds: 'Public,Int'
          TestMode: 'LIVE'
          ServiceDirectory: communication
          MatrixReplace:
              - TestSamples=.*/true
          CloudConfig:
              Public:
                  SubscriptionConfigurations:
                      - $(sub-config-azure-cloud-test-resources)
                      - $(sub-config-communication-services-cloud-test-resources-common)
                      - $(sub-config-communication-services-cloud-test-resources-java)
              Int:
                  SubscriptionConfigurations:
                      - $(sub-config-communication-ppe-test-resources-common)
                      - $(sub-config-communication-ppe-test-resources-java)
          Artifacts:
              -   name: ${{ parameters.PackageName }}
                  groupId: com.azure
                  safeName: ${{ parameters.SafeName }}
          PreSteps:
              -   bash: echo "##vso[task.setvariable variable=DefaultTestOptions]-Djacoco.skip=true $(DefaultTestOptions)"
                  condition: not(startsWith(variables['System.StageName'], 'Public'))
          PostSteps:
              -   task: PublishCodeCoverageResults@1
                  condition: and(eq(variables['Agent.OS'], 'Windows_NT'), eq(variables['JavaTestVersion'], '1.11'), startsWith(variables['System.StageName'], 'Public'))
                  inputs:
                      codeCoverageTool: JaCoCo
                      summaryFileLocation: sdk/communication/${{ parameters.PackageName }}/target/site/jacoco/jacoco.xml
                      reportDirectory: sdk/communication/${{ parameters.PackageName }}/target/site/jacoco/
                      failIfCoverageEmpty: true
          EnvVars:
              SKIP_LIVE_TEST: TRUE
              ${{ each var in parameters.EnVars }}:
                  ${{ var.key }}: ${{ var.value }}
          MatrixConfigs:
              -   Name: Java_live_test_base
                  Path: eng/pipelines/templates/stages/platform-matrix.json
                  Selection: sparse
                  GenerateVMJobs: true
