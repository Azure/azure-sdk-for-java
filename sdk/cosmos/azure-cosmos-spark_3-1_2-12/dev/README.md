# Dev Azure Cosmos DB OLTP Spark connector client library for Java

### How to run validation

To run the tests of Spark connector without running the SDK tests you need to install azure-cosmos first
```bash
mvn -e -DskipTests  -Dgpg.skip -Dmaven.javadoc.skip=true -Dspotbugs.skip=true -Dcheckstyle.skip=true -Drevapi.skip=true -pl ,azure-cosmos -am clean install
```

To run unit tests:
```
mvn -e -Dgpg.skip -Dmaven.javadoc.skip=true -Dspotbugs.skip=true -Dcheckstyle.skip=true -Drevapi.skip=true -pl ,azure-cosmos-spark_3-1_2-12 test package -Punit
```

To run integration tests (requires Cosmos DB endpoint)

Create the file ~/cosmos-v4.properties with the following content (modify to match your cosmos endpoint):

```
ACCOUNT_HOST=https://localhost:8081
ACCOUNT_KEY=C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw==
```

Integration tests are expected to have ITest suffix.
run the following command to run all tests including end to end integration tests:

```bash
mvn -e -Dgpg.skip -Dmaven.javadoc.skip=true -Dspotbugs.skip=true -Dcheckstyle.skip=true -Drevapi.skip=true -pl ,azure-cosmos-spark_3-1_2-12 test package -PsparkE2E
```

How to run style check:
```bash
mvn -e -Dgpg.skip -DskipTests -Dmaven.javadoc.skip=true -Dspotbugs.skip=false -Dcheckstyle.skip=false -Drevapi.skip=true -pl ,azure-cosmos-spark_3-1_2-12 -am clean package
```


### How to do a Release

First make sure all the newly added third party libraries are tracked see OSS compliance section.

The release process is currently manual.

Download the spark artifacts or build locally:
```bash
mvn -e -DskipTests -Dgpg.skip -Dmaven.javadoc.skip=true -Dspotbugs.skip=true -Dcheckstyle.skip=true -Drevapi.skip=true -pl ,azure-cosmos -am clean install
mvn -e -DskipTests -Dgpg.skip -Dmaven.javadoc.skip=true -Dspotbugs.skip=true -Dcheckstyle.skip=true -Drevapi.skip=true -pl ,azure-cosmos-spark_3-1_2-12 clean install
```

Take these files:
```
mkdir ~/Deskop/spark-release
cp azure-sdk-for-java/sdk/cosmos/azure-cosmos-spark_3-1_2-12/target/azure-cosmos-spark_3-1_2-12-4.2.0-beta.1-javadoc.jar ~/Deskop/spark-release/
cp azure-sdk-for-java/sdk/cosmos/azure-cosmos-spark_3-1_2-12/target/azure-cosmos-spark_3-1_2-12-4.2.0-beta.1-sources.jar ~/Deskop/spark-release/
cp azure-sdk-for-java/sdk/cosmos/azure-cosmos-spark_3-1_2-12/target/azure-cosmos-spark_3-1_2-12-4.2.0-beta.1.jar ~/Deskop/spark-release/
cp azure-sdk-for-java/sdk/cosmos/azure-cosmos-spark_3-1_2-12/dependency-reduced-pom.xml ~/Deskop/spark-release/
```

NOTE: to make sure the maven dependency resolver works correctly you need to take the `dependency-reduced-pom.xml` as the pom file instead of the original pom file.
Use the partner release pipeline to release.

Tag the release on github.

### OSS compliance

[Component Governance](https://dev.azure.com/azure-sdk/internal/_componentGovernance/106501?_a=components&typeId=6129920&alerts-view-option=active)
automatically tracks master branch.

For each release we need to go over the OSS compliance steps:

1) To add OSS components (or 3rd party source code) missed by CG, create a cgmanifest.json file. This typically happens if you manually copy code 
   without adding maven dependency. howto https://docs.opensource.microsoft.com/tools/cg/cgmanifest.html.
2) Check for "legal alerts" and "security alerts". If you do not see a "legal alert" 
   nor "unsupported component" banner for OSS in your “Components” list in CG,
   that means those components are "auto-approved" and do not need CELA review.
3) As we are shipping an uber jar, we need to keep https://github.com/Azure/azure-sdk-for-java/blob/main/NOTICE.txt is up to date with all the new dependencies repackaged in the spark connector.

#### Tracking third party library used in the uber jar.

The spark uber jar is generated by maven-shade-plugin which repackages the third-party dependencies (including transitive dependencies) defined in the pom file.
To generate a list of third-party libraries with their licenses used in the spark connector uber jar run:

```bash
cd sdk/cosmos/azure-cosmos-spark_3-1_2-12
mvn clean license:add-third-party -Dlicense.excludedScopes=test,provided
cat target/generated-sources/license/THIRD-PARTY.txt
```

It generates a file containing the list of third party libraries with their licenses in `target/generated-sources/license/THIRD-PARTY.txt`

compare target/generated-sources/license/THIRD-PARTY.txt with sdk/cosmos/azure-cosmos-spark_3-1_2-12/dev/THIRD-PARTY.txt if there is no difference nothing else needs to be done.

If there are new entries you need to update sdk/cosmos/azure-cosmos-spark_3-1_2-12/dev/THIRD-PARTY.txt and also add new entries in 
https://github.com/Azure/azure-sdk-for-java/blob/main/NOTICE.txt.
