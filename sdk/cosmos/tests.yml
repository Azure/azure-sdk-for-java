trigger: none

variables:
  pomFile: './sdk/cosmos/pom.service.xml'
  DefaultOptions: '--batch-mode -Dmaven.wagon.http.pool=false'
  LoggingOptions: '-Dorg.slf4j.simpleLogger.defaultLogLevel=error -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn'


jobs:
  - template: ../../eng/pipelines/templates/jobs/archetype-sdk-tests.yml
    parameters:
      TestName: Test
      ServiceDirectory: cosmos
      TimeoutInMinutes: 240
      MaxParallel: 1
      Matrix:
        Session_Single_Region_ReadMyWrites:
          OSVmImage: 'vs2017-win2016'
          DisplayName: 'ReadMyWrites Integration Tests'
          ProfileFlag: '-Pe2e'
          DirectModeProtocol: 'Https'
          DESIRED_CONSISTENCY: 'Session'
          COSMOS_ACCOUNT_HOST: $(java-cosmos-session-singleregion-host)
          COSMOS_ACCOUNT_KEY: $(java-cosmos-session-singleregion-key)
        Strong_Single_Region_ReadMyWrites:
          OSVmImage: 'vs2017-win2016'
          DisplayName: 'ReadMyWrites Integration Tests'
          ProfileFlag: '-Pe2e'
          DirectModeProtocol: 'Https'
          DESIRED_CONSISTENCY: 'Strong'
          COSMOS_ACCOUNT_HOST: $(java-cosmos-session-singleregion-host)
          COSMOS_ACCOUNT_KEY: $(java-cosmos-session-singleregion-key)
        # Temporarily Disabled as V3 code lacks the support to run this pipeline. Will be enabled later by cosmos team.
        # Strong_Multi_Region_ReadMyWrites:
        #   OSVmImage: 'macOS-10.13'
        #   CosmosAccountHost: $(MULTI_STRONG_ACCOUNT_HOST)
        #   CosmosAccountKey: $(MULTI_STRONG_ACCOUNT_KEY)
        #   Consistency: 'Strong'
        #   DisplayName: 'ReadMyWrites Integration Tests'
        #   ProfileFlag: '-Pe2e'
        #   cosmos.directModeProtocol: 'Https'

      PreRunSteps:
        - task: Maven@3
          displayName: 'Install reporting tools'
          inputs:
            mavenPomFile: ./eng/code-quality-reports/pom.xml
            options: '$(DefaultOptions) -DskipTests -Dgpg.skip'
            mavenOptions: '$(LoggingOptions)'
            javaHomeOption: 'JDKVersion'
            jdkVersionOption: '1.11'
            jdkArchitectureOption: 'x64'
            publishJUnitResults: false
            goals: 'install'

      TestStepMavenInputs:
        goals: verify
        options: '$(ProfileFlag) -Dgpg.skip -DargLine="-Dcosmos.directModeProtocol=$(DirectModeProtocol)" -DDESIRED_CONSISTENCY=$(Consistency)'
        testResultsFiles: '**/junitreports/TEST-*.xml'