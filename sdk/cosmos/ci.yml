trigger:
  branches:
    include:
    - master
  paths:
    include:
    - sdk/cosmos/

pr:
  branches:
    include:
      - master
  paths:
    include:
      - sdk/cosmos/

variables:
  EmulatorMsiUrl: 'https://acpedaily1.blob.core.windows.net/emulator/azure-cosmos-emulator.msi'
  pomFile: './sdk/cosmos/pom.xml'
  DefaultOptions: '--batch-mode -Dmaven.wagon.http.pool=false'
  LoggingOptions: '-Dorg.slf4j.simpleLogger.defaultLogLevel=error -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn'

jobs:

  - job: 'Emulator'

    timeoutInMinutes: 120
    continueOnError: false
    strategy:
      matrix:
        Tcp_Integration_Tests_Java8:
          OSVmImage: 'vs2017-win2016'
          JavaVersion: '1.8'
          ProfileFlag: '-Pemulator'
          TestDisplayName: 'Emulator only Integration Tests'
          ProtocolFlag: '["Tcp"]'
          Consistency: '["Strong", "Session"]'

        Https_Integration_Tests_Java8:
          OSVmImage: 'vs2017-win2016'
          JavaVersion: '1.8'
          ProfileFlag: '-Pemulator'
          TestDisplayName: 'Emulator only Integration Tests'
          ProtocolFlag: '["Https"]'
          Consistency: '["Strong", "Session"]'


        Examples_Integration_Tests_Java8:
          OSVmImage: 'vs2017-win2016'
          JavaVersion: '1.8'
          ProfileFlag: '-Pexamples'
          TestDisplayName: 'Examples Integration Tests'
          ProtocolFlag: '["Https", "Tcp"]'
          Consistency: '["Strong", "Session"]'

    pool:
      vmImage: $(OSVmImage)

    steps:
      - task: azure-cosmosdb.emulator-public-preview.run-cosmosdbemulatorcontainer.CosmosDbEmulator@2
        inputs:
          defaultPartitionCount: 25
        displayName: "Run Azure Cosmos DB Emulator container (public)"

      # We `install` separately from running `site:site site:stage` so that the `install` brings in the non-shipping-modules,
      # but we don't include them in the Maven site commands (so that we don't generate reports for the non-shipping modules).
      - task: Maven@3
        displayName: 'Install reporting tools'
        inputs:
          mavenPomFile: ./eng/code-quality-reports/pom.xml
          options: '$(DefaultOptions) -DskipTests -Dgpg.skip'
          mavenOptions: '$(LoggingOptions)'
          javaHomeOption: 'JDKVersion'
          jdkVersionOption: '1.11'
          jdkArchitectureOption: 'x64'
          publishJUnitResults: false
          goals: 'install'

      - task: Maven@3
        displayName: Build
        inputs:
          mavenPomFile: $(pomFile)
          goals: 'clean package'
          options: '-DskipTests -Dgpg.skip -Dmaven.javadoc.skip=true'
          testResultsFiles: '**/junitreports/TEST-*.xml'
          mavenAuthenticateFeed: true
        condition: succeededOrFailed()

      - task: Maven@3
        displayName: $(TestDisplayName)
        inputs:
         mavenPomFile: $(pomFile)
         goals: 'package verify'
         options: '$(ProfileFlag) -Dgpg.skip -DargLine="-DACCOUNT_HOST=$(CosmosDbEmulator.Endpoint)"'
         testResultsFiles: '**/junitreports/TEST-*.xml'
         mavenAuthenticateFeed: true
         jdkVersionOption: $(JavaVersion)
        env:
          PROTOCOLS: $(ProtocolFlag)
          DESIRED_CONSISTENCIES: $(Consistency)
        condition: succeededOrFailed()

      - task: CopyFiles@2
        displayName: 'Copy Files to: $(build.artifactstagingdirectory)'
        inputs:
          SourceFolder: '$(build.sourcesdirectory)'
          Contents: |
           **/target/**
           **/collectedArtifactsForRelease/**
          TargetFolder: '$(build.artifactstagingdirectory)'

      - task: PublishBuildArtifacts@1
        displayName: 'Publish Artifact: drop'
        inputs:
         PathtoPublish: '$(build.artifactstagingdirectory)'

  - job: 'Unit_Tests'

    strategy:
      matrix:
        Windows - java8:
          OSVmImage: 'vs2017-win2016'
          JavaVersion: '1.8'

        MacOS - java8:
          OSVmImage: 'macOS-10.13'
          JavaVersion: '1.8'

    pool:
      vmImage: $(OSVmImage)

    steps:
      # We `install` separately from running `site:site site:stage` so that the `install` brings in the non-shipping-modules,
      # but we don't include them in the Maven site commands (so that we don't generate reports for the non-shipping modules).
    - task: Maven@3
      displayName: 'Install reporting tools'
      inputs:
        mavenPomFile: ./eng/code-quality-reports/pom.xml
        options: '$(DefaultOptions) -DskipTests -Dgpg.skip'
        mavenOptions: '$(LoggingOptions)'
        javaHomeOption: 'JDKVersion'
        jdkVersionOption: '1.11'
        jdkArchitectureOption: 'x64'
        publishJUnitResults: false
        goals: 'install'

    - task: Maven@1
      displayName: 'Unit Tests'
      inputs:
        mavenPomFile: $(pomFile)
        goals: 'package test'
        options: '-Punit'
        testResultsFiles: '**/junitreports/TEST-*.xml'
        checkStyleRunAnalysis: true
        pmdRunAnalysis: true
        findBugsRunAnalysis: true
        jdkVersionOption: $(JavaVersion)
      condition: succeededOrFailed()

    - task: CopyFiles@2
      displayName: 'Copy Files to: $(build.artifactstagingdirectory)'
      inputs:
        SourceFolder: '$(build.sourcesdirectory)'
        Contents: |
         **/target/**
         **/collectedArtifactsForRelease/**
        TargetFolder: '$(build.artifactstagingdirectory)'
      continueOnError: true
      condition: succeededOrFailed()

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact: drop'
      inputs:
        PathtoPublish: '$(build.artifactstagingdirectory)'
      continueOnError: true
      condition: succeededOrFailed()

