trigger:
  branches:
    include:
    - master
  paths:
    include:
    - sdk/cosmos/

pr:
  branches:
    include:
      - master
  paths:
    include:
      - sdk/cosmos/

variables:
  pomFile: './sdk/cosmos/pom.xml'
  DefaultOptions: '--batch-mode -Dmaven.wagon.http.pool=false'
  LoggingOptions: '-Dorg.slf4j.simpleLogger.defaultLogLevel=error -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn'
  ProfileFlag: -e

jobs:
  - template: ../../eng/pipelines/templates/jobs/archetype-sdk-client.yml
    parameters:
      ServiceDirectory: cosmos
      TestMatrix:
        Windows - java8:
          OSVmImage: 'vs2017-win2016'
          JavaVersion: '1.8'
          OSName: Windows
        MacOS - java8:
          OSVmImage: 'macOS-10.13'
          JavaVersion: '1.8'
          OSName: macOS
      PreTestSteps:
        - template: ../steps/install-reporting-tools.yml

  - job: 'Emulator'

    timeoutInMinutes: 120
    continueOnError: false
    strategy:
      matrix:
        Tcp_Integration_Tests_Java8:
          OSVmImage: 'vs2017-win2016'
          JavaVersion: '1.8'
          ProfileFlag: '-Pemulator'
          TestDisplayName: 'Emulator only Integration Tests'
          PROTOCOLS: '["Tcp"]'
          DESIRED_CONSISTENCIES: '["Strong", "Session"]'

        Https_Integration_Tests_Java8:
          OSVmImage: 'vs2017-win2016'
          JavaVersion: '1.8'
          ProfileFlag: '-Pemulator'
          TestDisplayName: 'Emulator only Integration Tests'
          PROTOCOLS: '["Https"]'
          DESIRED_CONSISTENCIES: '["Strong", "Session"]'


        Examples_Integration_Tests_Java8:
          OSVmImage: 'vs2017-win2016'
          JavaVersion: '1.8'
          ProfileFlag: '-Pexamples'
          TestDisplayName: 'Examples Integration Tests'
          PROTOCOLS: '["Https", "Tcp"]'
          DESIRED_CONSISTENCIES: '["Strong", "Session"]'

    pool:
      vmImage: $(OSVmImage)

    steps:
      - task: azure-cosmosdb.emulator-public-preview.run-cosmosdbemulatorcontainer.CosmosDbEmulator@2
        inputs:
          defaultPartitionCount: 25
        displayName: "Run Azure Cosmos DB Emulator container (public)"

      # We `install` separately from running `site:site site:stage` so that the `install` brings in the non-shipping-modules,
      # but we don't include them in the Maven site commands (so that we don't generate reports for the non-shipping modules).
      - template: ../../eng/pipelines/templates/steps/install-reporting-tools.yml

      - task: Maven@3
        displayName: $(TestDisplayName)
        inputs:
          mavenPomFile: $(pomFile)
          goals: 'verify'
          options: '$(ProfileFlag) -Dgpg.skip -DargLine="-DACCOUNT_HOST=$(CosmosDbEmulator.Endpoint)"'
          mavenAuthenticateFeed: true
          jdkVersionOption: $(JavaVersion)
        condition: succeededOrFailed()

      - task: PublishTestResults@2
        condition: succeededOrFailed()
        inputs:
          mergeTestResults: true
          testRunTitle: $(TestDisplayName))
