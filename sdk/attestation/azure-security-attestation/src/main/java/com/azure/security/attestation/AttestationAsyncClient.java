// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
// Code generated by Microsoft (R) AutoRest Code Generator.

package com.azure.security.attestation;

import com.azure.core.annotation.ReturnType;
import com.azure.core.annotation.ServiceClient;
import com.azure.core.annotation.ServiceMethod;
import com.azure.core.http.rest.Response;
import com.azure.core.util.Context;
import com.azure.core.util.FluxUtil;
import com.azure.security.attestation.implementation.AttestationClientImpl;
import com.azure.security.attestation.implementation.AttestationsImpl;
import com.azure.security.attestation.implementation.MetadataConfigurationsImpl;
import com.azure.security.attestation.implementation.SigningCertificatesImpl;
import com.azure.security.attestation.implementation.models.DataType;
import com.azure.security.attestation.implementation.models.InitTimeData;
import com.azure.security.attestation.implementation.models.RuntimeData;
import com.azure.security.attestation.models.AttestOpenEnclaveRequest;
import com.azure.security.attestation.models.AttestSgxEnclaveRequest;
import com.azure.security.attestation.models.AttestationResult;
import com.azure.security.attestation.models.AttestationSigner;
import com.azure.security.attestation.models.AttestationToken;
import com.azure.security.attestation.models.CloudErrorException;
import reactor.core.publisher.Mono;

import java.nio.charset.StandardCharsets;
import java.util.Objects;

import static com.azure.core.util.FluxUtil.withContext;

/** Initializes a new instance of the asynchronous AzureAttestationRestClient type. */
@ServiceClient(builder = AttestationClientBuilder.class, isAsync = true)
public final class AttestationAsyncClient {
    private final AttestationsImpl attestImpl;
    private final MetadataConfigurationsImpl metadataImpl;
    private final SigningCertificatesImpl signerImpl;

    /**
     * Initializes an instance of Attestations client.
     *
     * @param clientImpl the service client implementation.
     */
    AttestationAsyncClient(AttestationClientImpl clientImpl) {
        this.attestImpl = clientImpl.getAttestations();
        this.metadataImpl = clientImpl.getMetadataConfigurations();
        this.signerImpl = clientImpl.getSigningCertificates();
    }

    /**
     * Retrieves metadata about the attestation signing keys in use by the attestation service.
     *
     * @throws CloudErrorException thrown if the request is rejected by server.
     * @throws RuntimeException all other wrapped checked exceptions if the request fails to be sent.
     * @return any object.
     */
    @ServiceMethod(returns = ReturnType.SINGLE)
    public Mono<Response<Object>> getOpenIdMetadataWithResponse() {
        return withContext(context -> this.getOpenIdMetadataWithResponse(context));
    }

    /**
     * Retrieves metadata about the attestation signing keys in use by the attestation service.
     *
     * @param context - Context for the operation
     * @throws CloudErrorException thrown if the request is rejected by server.
     * @throws RuntimeException all other wrapped checked exceptions if the request fails to be sent.
     * @return any object.
     */
    public Mono<Response<Object>> getOpenIdMetadataWithResponse(Context context) {
        return this.metadataImpl.getWithResponseAsync(context);
    }

    /**
     * Retrieves metadata about the attestation signing keys in use by the attestation service.
     *
     * @throws CloudErrorException thrown if the request is rejected by server.
     * @throws RuntimeException all other wrapped checked exceptions if the request fails to be sent.
     * @return any object.
     */
    @ServiceMethod(returns = ReturnType.SINGLE)
    public Mono<Object> getOpenIdMetadata() {
        // Forward the getOpenIdMetadata to the getOpenIdMetadataWithResponse API implementation.
        return withContext(context -> this.getOpenIdMetadataWithResponse(context))
            .flatMap(FluxUtil::toMono);
    }

    /**
     * Retrieves the list of {@link AttestationSigner} objects associated with this attestation instance.
     * An {@link AttestationSigner} represents an X.509 certificate chain and KeyId which can be used
     * to validate an attestation token returned by the service.
     *
     * @return Returns an array of {@link AttestationSigner} objects.
     */

    @ServiceMethod(returns = ReturnType.SINGLE)
    public Mono<AttestationSigner[]> getAttestationSigners() {
        return withContext(context -> this.getAttestationSignersWithResponse(context))
            .flatMap(FluxUtil::toMono);
    }

    /**
     * Retrieves the list of {@link AttestationSigner} objects associated with this attestation instance.
     *
     * An {@link AttestationSigner} represents an X.509 certificate chain and KeyId which can be used
     * to validate an attestation token returned by the service.
     *
     * @return Returns an array of {@link AttestationSigner} objects.
     */
    public Mono<Response<AttestationSigner[]>> getAttestationSignersWithResponse() {
        return withContext(context -> this.getAttestationSignersWithResponse(context));
    }

    /**
     * Retrieves the list of {@link AttestationSigner} objects associated with this attestation instance.
     *
     * An {@link AttestationSigner} represents an X.509 certificate chain and KeyId which can be used
     * to validate an attestation token returned by the service.
     *
     * @param context Context for the operation.
     * @return Returns an array of {@link AttestationSigner} objects.
     */
    public Mono<Response<AttestationSigner[]>> getAttestationSignersWithResponse(Context context) {
        return this.signerImpl.getWithResponseAsync(context)
            .map(response -> Utilities.generateResponseFromModelType(response, Utilities.attestationSignersFromJwks(response.getValue())));
    }

    /**
     * Processes an OpenEnclave report , producing an artifact. The type of artifact produced is dependent upon
     * attestation policy.
     *
     * @param request Attestation request for Intel SGX enclaves.
     * @throws IllegalArgumentException thrown if parameters fail the validation.
     * @throws CloudErrorException thrown if the request is rejected by server.
     * @throws RuntimeException all other wrapped checked exceptions if the request fails to be sent.
     * @return the result of an attestation operation.
     */
    @ServiceMethod(returns = ReturnType.SINGLE)
    public Mono<Response<AttestationResult>> attestOpenEnclaveWithResponse(AttestOpenEnclaveRequest request) {
        return withContext(context -> this.attestOpenEnclaveWithResponse(request, context));
    }


    /**
     * Processes an OpenEnclave report , producing an artifact. The type of artifact produced is dependent upon
     * attestation policy.
     *
     * @param request Attestation request for Intel SGX enclaves.
     * @param context - Context for the operation
     * @throws IllegalArgumentException thrown if parameters fail the validation.
     * @throws CloudErrorException thrown if the request is rejected by server.
     * @throws RuntimeException all other wrapped checked exceptions if the request fails to be sent.
     * @return the result of an attestation operation.
     */
    public Mono<Response<AttestationResult>> attestOpenEnclaveWithResponse(AttestOpenEnclaveRequest request, Context context) {
        // Ensure that the incoming request makes sense.
        request.validate();

        return this.attestImpl.attestOpenEnclaveWithResponseAsync(openEnclaveRequestToInternal(request), context)
            // Create an AttestationToken from the raw response from the service.
            .map(response -> Utilities.generateResponseFromModelType(response, new AttestationToken(response.getValue().getToken())))
            // Extract the AttestationResult from the AttestationToken.
            .map(response -> Utilities.generateAttestationResponseFromModelType(response, response.getValue(), response.getValue().getBody(AttestationResult.class)));
    }

    /**
     * Returns an internal type from a public type.
     * @return implementation type.
     */
    private com.azure.security.attestation.implementation.models.AttestOpenEnclaveRequest openEnclaveRequestToInternal(AttestOpenEnclaveRequest request) {

        return new com.azure.security.attestation.implementation.models.AttestOpenEnclaveRequest()
            .setDraftPolicyForAttestation(request.getDraftPolicyForAttestation())
            .setRuntimeData(request.getInitTimeData() != null ? new RuntimeData()
                .setData(request.getRuntimeData())
                .setDataType(DataType.fromString(request.getRunTimeDataType())) : null)
            .setInitTimeData(request.getInitTimeData() != null ? new InitTimeData()
                .setData(request.getInitTimeData())
                .setDataType(DataType.fromString(request.getInitTimeDataType())) : null)
            .setReport(request.getReport());
    }

    /**
     * Processes an OpenEnclave report , producing an artifact. The type of artifact produced is dependent upon
     * attestation policy.
     *
     * @param request Attestation request for Intel SGX enclaves.
     * @throws IllegalArgumentException thrown if parameters fail the validation.
     * @throws CloudErrorException thrown if the request is rejected by server.
     * @throws RuntimeException all other wrapped checked exceptions if the request fails to be sent.
     * @return the result of an attestation operation.
     */
    @ServiceMethod(returns = ReturnType.SINGLE)
    public Mono<AttestationResult> attestOpenEnclave(AttestOpenEnclaveRequest request) {
        return withContext(context -> attestOpenEnclaveWithResponse(request, context))
            .flatMap(FluxUtil::toMono);
    }

    /**
     * Processes an SGX enclave quote, producing an artifact. The type of artifact produced is dependent upon
     * attestation policy.
     *
     * @param request Attestation request for Intel SGX enclaves.
     * @throws IllegalArgumentException thrown if parameters fail the validation.
     * @throws CloudErrorException thrown if the request is rejected by server.
     * @throws RuntimeException all other wrapped checked exceptions if the request fails to be sent.
     * @return the result of an attestation operation.
     */
    @ServiceMethod(returns = ReturnType.SINGLE)
    public Mono<Response<AttestationResult>> attestSgxEnclaveWithResponse(AttestSgxEnclaveRequest request) {
        return withContext(context -> attestSgxEnclaveWithResponse(request, context));
    }

    /**
     * Processes an SGX enclave quote, producing an artifact. The type of artifact produced is dependent upon
     * attestation policy.
     *
     * @param request Attestation request for Intel SGX enclaves.
     * @param context - Context for the operation
     * @throws IllegalArgumentException thrown if parameters fail the validation.
     * @throws CloudErrorException thrown if the request is rejected by server.
     * @throws RuntimeException all other wrapped checked exceptions if the request fails to be sent.
     * @return the result of an attestation operation.
     */
    public Mono<Response<AttestationResult>> attestSgxEnclaveWithResponse(AttestSgxEnclaveRequest request, Context context) {
        return this.attestImpl.attestSgxEnclaveWithResponseAsync(sgxEnclaveRequestToInternal(request), context)
            .map(response -> {
                AttestationToken token = new AttestationToken(response.getValue().getToken());
                return Utilities.generateAttestationResponseFromModelType(response, token, token.getBody(AttestationResult.class));
            });
    }

    /**
     * Processes an SGX enclave quote, producing an artifact. The type of artifact produced is dependent upon
     * attestation policy.
     *
     * @param request Attestation request for Intel SGX enclaves.
     * @throws IllegalArgumentException thrown if parameters fail the validation.
     * @throws CloudErrorException thrown if the request is rejected by server.
     * @throws RuntimeException all other wrapped checked exceptions if the request fails to be sent.
     * @return the result of an attestation operation.
     */
    @ServiceMethod(returns = ReturnType.SINGLE)
    public Mono<AttestationResult> attestSgxEnclave(AttestSgxEnclaveRequest request) {
        return withContext(context -> attestSgxEnclaveWithResponse(request, context))
            .flatMap(FluxUtil::toMono);
    }

    /**
     * Returns an internal type from a public type.
     * @return implementation type.
     */
    private com.azure.security.attestation.implementation.models.AttestSgxEnclaveRequest sgxEnclaveRequestToInternal(AttestSgxEnclaveRequest request) {
        return new com.azure.security.attestation.implementation.models.AttestSgxEnclaveRequest()
            .setDraftPolicyForAttestation(request.getDraftPolicyForAttestation())
            .setRuntimeData(request.getRuntimeData() != null ? new RuntimeData()
                .setData(request.getRuntimeData())
                .setDataType(DataType.fromString(request.getRuntimeDataType())) : null)
            .setInitTimeData(request.getInitTimeData() != null ? new InitTimeData()
                .setData(request.getInitTimeData())
                .setDataType(DataType.fromString(request.getInitTimeDataType())) : null)
            .setQuote(request.getQuote());
    }


    /**
     * Processes attestation evidence from a VBS enclave, producing an attestation result. The attestation result
     * produced is dependent upon the attestation policy.
     *
     * @param request Attestation request for Trusted Platform Module (TPM) attestation.
     * @throws IllegalArgumentException thrown if parameters fail the validation.
     * @throws CloudErrorException thrown if the request is rejected by server.
     * @throws RuntimeException all other wrapped checked exceptions if the request fails to be sent.
     * @return attestation response for Trusted Platform Module (TPM) attestation.
     */
    @ServiceMethod(returns = ReturnType.SINGLE)
    public Mono<Response<String>> attestTpmWithResponse(String request) {
        return withContext(context -> attestTpmWithResponse(request, context));
    }

    /**
     * Processes attestation evidence from a VBS enclave, producing an attestation result. The attestation result
     * produced is dependent upon the attestation policy.
     *
     * @param request Attestation request for Trusted Platform Module (TPM) attestation.
     * @param context - Context for the operation
     * @throws IllegalArgumentException thrown if parameters fail the validation.
     * @throws CloudErrorException thrown if the request is rejected by server.
     * @throws RuntimeException all other wrapped checked exceptions if the request fails to be sent.
     * @return attestation response for Trusted Platform Module (TPM) attestation.
     */
    public Mono<Response<String>> attestTpmWithResponse(String request, Context context) {
        Objects.requireNonNull(request);
        return this.attestImpl.attestTpmWithResponseAsync(new com.azure.security.attestation.implementation.models.TpmAttestationRequest().setData(request.getBytes(StandardCharsets.UTF_8)), context)
            .map(response -> Utilities.generateResponseFromModelType(response, new String(Objects.requireNonNull(response.getValue().getData()), StandardCharsets.UTF_8)));
    }

    /**
     * Processes attestation evidence from a VBS enclave, producing an attestation result. The attestation result
     * produced is dependent upon the attestation policy.
     *
     * @param request Attestation request for Trusted Platform Module (TPM) attestation.
     * @throws IllegalArgumentException thrown if parameters fail the validation.
     * @throws CloudErrorException thrown if the request is rejected by server.
     * @throws RuntimeException all other wrapped checked exceptions if the request fails to be sent.
     * @return attestation response for Trusted Platform Module (TPM) attestation.
     */
    @ServiceMethod(returns = ReturnType.SINGLE)
    public Mono<String> attestTpm(String request) {
        return withContext(context -> attestTpmWithResponse(request, context))
            .flatMap(FluxUtil::toMono);
    }
}
