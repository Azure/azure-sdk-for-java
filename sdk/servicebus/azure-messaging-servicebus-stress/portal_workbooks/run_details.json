{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "## ServiceBus for Java stress testing\n\nEnter the test runId - it matches ServiceBus resource name and is a suffix in AppInsights role instance."
      },
      "name": "text - 2"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "e775120a-7d69-4054-b032-1c841a866f34",
            "version": "KqlParameterItem/1.0",
            "name": "runId",
            "type": 1,
            "isRequired": true,
            "timeContext": {
              "durationMs": 86400000
            },
            "value": "sdbded"
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "customWidth": "50",
      "name": "parameters - 2",
      "styleSettings": {
        "maxWidth": "50"
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "customMetrics \r\n| where sdkVersion startswith \"java\" \r\n| extend runId = tostring(split(cloud_RoleInstance, \"-\")[1])\r\n| summarize start=min(timestamp), end=max(timestamp), measurements=count() by runId \r\n| order by start desc\r\n",
        "size": 0,
        "title": "Runs in last 24 hours",
        "noDataMessageStyle": 5,
        "timeContext": {
          "durationMs": 86400000
        },
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "gridSettings": {
          "sortBy": [
            {
              "itemKey": "start",
              "sortOrder": 1
            }
          ]
        },
        "sortBy": [
          {
            "itemKey": "start",
            "sortOrder": 1
          }
        ]
      },
      "customWidth": "50",
      "name": "query - 8",
      "styleSettings": {
        "maxWidth": "50"
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// counts\r\nlet runId = \"{runId}\";\r\nlet sender_name=strcat(\"sender-\", runId);\r\nlet receiver_name=strcat(\"receiver-\", runId);\r\nlet sent = customMetrics\r\n| where name == \"messaging.servicebus.messages.sent\"\r\n| where cloud_RoleInstance == sender_name\r\n| extend status = tostring(customDimensions[\"otel.status_code\"])\r\n| summarize sent = sum(valueSum) by status;\r\nlet received = customMetrics\r\n| where name == \"messaging.servicebus.receiver.lag\"\r\n| where cloud_RoleInstance == receiver_name\r\n| extend status = \"ok\"\r\n| summarize received = sum(valueCount) by status;\r\nlet settled = customMetrics\r\n| where name == \"messaging.servicebus.settlement.request.duration\"\r\n| where cloud_RoleInstance == receiver_name\r\n| extend status = tostring(customDimensions[\"otel.status_code\"])\r\n| extend run = runId\r\n| summarize settled = sum(valueCount) by status;\r\nsent \r\n| join kind = fullouter (received) on status\r\n| join kind = fullouter (settled) on status\r\n| project-away status1, status2",
        "size": 0,
        "title": "Message count#",
        "noDataMessageStyle": 5,
        "timeContext": {
          "durationMs": 86400000
        },
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "customWidth": "50",
      "name": "query - 2",
      "styleSettings": {
        "maxWidth": "50",
        "showBorder": true
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let runId = \"{runId}\";\r\nlet sender_name=strcat(\"sender-\", runId);\r\nlet receiver_name=strcat(\"receiver-\", runId);\r\nlet amqp_send = customMetrics\r\n| where name == \"messaging.az.amqp.producer.send.duration\"\r\n| where cloud_RoleInstance == sender_name\r\n| extend status = tostring(customDimensions[\"amqp.delivery_state\"])\r\n| where status != \"accepted\"\r\n| union (print valueCount = toint(0), status = \"_unknown\")\r\n| summarize amqp_send = sum(valueCount) by status;\r\nlet send = customMetrics\r\n| where name == \"messaging.servicebus.messages.sent\"\r\n| where cloud_RoleInstance == sender_name\r\n| extend status = tostring(customDimensions[\"otel.status_code\"])\r\n| where status != \"ok\"\r\n| union (print valueSum = toreal(0), status = \"_unknown\")\r\n| summarize message_send = sum(valueSum) by status;\r\nlet settle = customMetrics\r\n| where name == \"messaging.servicebus.settlement.request.duration\"\r\n| where cloud_RoleInstance == receiver_name\r\n| extend status = tostring(customDimensions[\"otel.status_code\"])\r\n| where status != \"ok\"\r\n| union (print valueCount = toint(0), status = \"_unknown\")\r\n| summarize settle = sum(valueCount) by status;\r\nlet management = customMetrics\r\n| where name == \"messaging.az.amqp.management.request.duration\"\r\n| where cloud_RoleInstance == receiver_name or cloud_RoleInstance == sender_name \r\n| extend status = tostring(customDimensions[\"amqp.status_code\"])\r\n| where status != \"ok\"\r\n| union (print valueCount = toint(0), status = \"_unknown\")\r\n| summarize management = sum(valueCount) by status;\r\nlet connection = customMetrics\r\n| where name == \"messaging.az.amqp.client.connections.closed\"\r\n| where cloud_RoleInstance == receiver_name or cloud_RoleInstance == sender_name\r\n| where customDimensions[\"amqp.error_condition\"] != \"ok\" \r\n| union (print valueSum = toreal(0), status = \"_unknown\")\r\n| summarize connection = sum(valueSum) by status;\r\nlet transport = customMetrics\r\n| where name == \"messaging.az.amqp.client.transport.errors\"\r\n| where cloud_RoleInstance == receiver_name or cloud_RoleInstance == sender_name\r\n| extend status = tostring(customDimensions[\"amqp.error_condition\"])\r\n| where status != \"ok\" \r\n| union (print valueSum = toreal(0), status = \"_unknown\")\r\n| summarize transport = sum(valueSum) by status;\r\namqp_send\r\n| join kind = fullouter (send) on status\r\n| join kind = fullouter (settle) on status\r\n| join kind = fullouter (management) on status\r\n| join kind = fullouter (connection) on status\r\n| join kind = fullouter (transport) on status\r\n| extend status = coalesce(status, status1, status2, status3, status4, status5)\r\n| project-away status1, status2, status3, status4, status5\r\n| where status != \"_unknown\"",
        "size": 0,
        "title": "Errors #",
        "timeContext": {
          "durationMs": 86400000
        },
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "customWidth": "50",
      "name": "query - 4",
      "styleSettings": {
        "maxWidth": "50",
        "showBorder": true
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// rate\r\nlet runId = \"{runId}\";\r\nlet sender_name=strcat(\"sender-\", runId);\r\nlet receiver_name=strcat(\"receiver-\", runId);\r\nlet send = customMetrics\r\n| where name == \"messaging.servicebus.messages.sent\"\r\n| where cloud_RoleInstance == sender_name\r\n| where customDimensions[\"otel.status_code\"] == \"ok\"\r\n| summarize message_send=sum(valueSum) by bin(timestamp, 1m);\r\nlet receive = customMetrics\r\n| where name == \"messaging.servicebus.receiver.lag\"\r\n| where cloud_RoleInstance == receiver_name\r\n| summarize receive = sum(valueCount) by bin(timestamp, 1m);\r\nlet settle = customMetrics\r\n| where name == \"messaging.servicebus.settlement.request.duration\"\r\n| where cloud_RoleInstance == receiver_name\r\n| where customDimensions[\"otel.status_code\"] == \"ok\" \r\n| summarize settle = sum(valueCount) by bin(timestamp, 1m);\r\nsend \r\n| join kind = fullouter (receive) on timestamp\r\n| join kind = fullouter (settle) on timestamp\r\n| project-away timestamp1, timestamp2\r\n| render timechart",
        "size": 0,
        "title": "Send/receive/settle success rate (per minute)",
        "noDataMessageStyle": 5,
        "timeContext": {
          "durationMs": 86400000
        },
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "customWidth": "50",
      "name": "query - 3",
      "styleSettings": {
        "maxWidth": "50",
        "showBorder": true
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// duration\r\nlet runId = \"{runId}\";\r\nlet sender_name=strcat(\"sender-\", runId);\r\nlet receiver_name=strcat(\"receiver-\", runId);\r\nlet amqp_send = customMetrics\r\n| where name == \"messaging.az.amqp.producer.send.duration\"\r\n| where cloud_RoleInstance == sender_name\r\n| where customDimensions[\"amqp.delivery_state\"] == \"accepted\"\r\n| summarize amqp_send_avg = avg(valueSum/valueCount), amqp_send_max = max(valueMax) by bin(timestamp, 1m);\r\nlet settle = customMetrics\r\n| where name == \"messaging.servicebus.settlement.request.duration\"\r\n| where cloud_RoleInstance == receiver_name\r\n| where customDimensions[\"otel.status_code\"] == \"ok\"\r\n| summarize settle_avg = avg(valueSum/valueCount), settle_max = max(valueMax) by bin(timestamp, 1m);\r\nlet management = customMetrics\r\n| where name == \"messaging.az.amqp.management.request.duration\"\r\n| where cloud_RoleInstance == receiver_name or cloud_RoleInstance == sender_name\r\n| where customDimensions[\"amqp.status_code\"] == \"accepted\"\r\n| summarize management_avg = avg(valueSum/valueCount), management_max = max(valueMax) by bin(timestamp, 1m);\r\namqp_send\r\n| join kind = fullouter (settle) on timestamp\r\n| join kind = fullouter (management) on timestamp\r\n| project-away timestamp1, timestamp2\r\n| render linechart",
        "size": 0,
        "title": "Duration (ms), average and max per minute",
        "noDataMessageStyle": 5,
        "timeContext": {
          "durationMs": 86400000
        },
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "customWidth": "50",
      "name": "query - 5",
      "styleSettings": {
        "maxWidth": "50"
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "traces \r\n| where cloud_RoleInstance endswith \"{runId}\" and severityLevel > 1\r\n| extend category = tostring(customDimensions[\"LoggerName\"])\r\n| summarize warnings = countif(severityLevel == 2), errors = countif(severityLevel == 3) by category\r\n",
        "size": 0,
        "title": "Warning and errors in logs, #",
        "timeContext": {
          "durationMs": 86400000
        },
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "customWidth": "30",
      "name": "query - 6",
      "styleSettings": {
        "maxWidth": "30",
        "showBorder": true
      }
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "exceptions | where cloud_RoleInstance endswith \"{runId}\" | summarize count() by problemId | order by count_ desc",
        "size": 0,
        "title": "Exceptions, #per minute",
        "timeContext": {
          "durationMs": 86400000
        },
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "gridSettings": {
          "sortBy": [
            {
              "itemKey": "count_",
              "sortOrder": 2
            }
          ]
        },
        "sortBy": [
          {
            "itemKey": "count_",
            "sortOrder": 2
          }
        ]
      },
      "customWidth": "65",
      "name": "query - 7",
      "styleSettings": {
        "maxWidth": "65",
        "showBorder": true
      }
    }
  ],
  "fallbackResourceIds": [
    "/subscriptions/faa080af-c1d8-40ad-9cce-e1a450ca5b57/resourceGroups/rg-stress-cluster-pg/providers/Microsoft.Insights/components/stress-pg-ai-s7b6dif73rup6"
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
