parameters:
- name: Artifacts
  type: object
  default: []
- name: ReleaseDependsOnLiveTests
  type: boolean
  default: true
- name: ServiceDirectory
  type: string
  default: not-specified

extends:
  template: ../../eng/pipelines/templates/stages/archetype-sdk-client.yml
  parameters:
    ServiceDirectory: ${{ parameters.ServiceDirectory }}
    EnableBatchRelease: true
    Artifacts: ${{ parameters.Artifacts }}
    MatrixReplace:
      - TestGoals=(surefire:test)/$1 failsafe:integration-test failsafe:verify
    LiveTestStages:
    - template: /eng/pipelines/templates/stages/archetype-sdk-tests.yml
      parameters:
        ServiceDirectory: ${{ parameters.ServiceDirectory }}
        Artifacts:
        - ${{ each artifact in parameters.Artifacts }}:
          - ${{ if ne(artifact.releaseInBatch, 'false') }}:
            - ${{ artifact }}
        MatrixReplace:
          - TestGoals=(surefire:test)/$1 failsafe:integration-test failsafe:verify
    - template: /eng/pipelines/templates/stages/archetype-sdk-tests.yml
      parameters:
        ServiceDirectory: ${{ parameters.ServiceDirectory }}
        TestName: 'jackson_supported_versions'
        MatrixConfigs:
          - Name: jackson_supported_version_tests
            Path: sdk/core/supported-version-matrix.json
            Selection: sparse
            NonSparseParameters:
              - AZURE_CORE_TEST_SUPPORTED_JACKSON_VERSION
            GenerateVMJobs: true
        Artifacts:
          - name: azure-core-jackson-tests
            groupId: com.azure
            safeName: azurecorejacksontests
    - template: /eng/pipelines/templates/stages/archetype-sdk-tests.yml
      parameters:
        ServiceDirectory: ${{ parameters.ServiceDirectory }}
        TestName: 'jackson_unsupported_versions'
        MatrixConfigs:
          - Name: jackson_unsupported_version_tests
            Path: sdk/core/unsupported-version-matrix.json
            Selection: sparse
            NonSparseParameters:
              - AZURE_CORE_TEST_UNSUPPORTED_JACKSON_VERSION
            GenerateVMJobs: true
        Artifacts:
          - name: azure-core-jackson-tests
            groupId: com.azure
            safeName: azurecorejacksontests
    - template: /sdk/storage/tests-template.yml
      parameters:
        AdditionalMatrixReplace:
          - TestFromSource=(.*)/true
    ReleaseDependsOnLiveTests: ${{ parameters.ReleaseDependsOnLiveTests }}
