// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
// Code generated by Microsoft (R) AutoRest Code Generator.

package com.azure.resourcemanager.appplatform;

import com.azure.core.management.Region;
import com.azure.resourcemanager.appplatform.fluent.models.BuildServiceInner;
import com.azure.resourcemanager.appplatform.models.SpringApp;
import com.azure.resourcemanager.appplatform.models.SpringService;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;

import java.util.ArrayList;
import java.util.List;

public class EnterpriseTierTest extends AppPlatformTest {

    private static final String GIT_CONFIG_URI = "https://github.com/Azure-Samples/spring-petclinic-microservices-config";

    @Test
    public void canCRUDService() {
        String serviceName = generateRandomResourceName("springsvc", 15);
        Region region = Region.US_EAST;
        // define spring cloud service for enterprise tier
        List<String> filePatterns = new ArrayList<>();
        filePatterns.add("api-gateway");
        SpringService springService = appPlatformManager.springServices()
            .define(serviceName)
            .withRegion(region)
            .withNewResourceGroup(rgName)
            .withEnterpriseTierSku()
            .withGitConfig(GIT_CONFIG_URI, "master", filePatterns)
            .create();

        // tanzu components
        Assertions.assertEquals(springService.getDefaultConfigurationService().gitUri(), GIT_CONFIG_URI);
        Assertions.assertEquals(springService.getDefaultConfigurationService().filePatterns(), filePatterns);
        BuildServiceInner buildServiceInner = appPlatformManager.serviceClient().getBuildServices().getBuildService(rgName, serviceName, "default");
        Assertions.assertNotNull(buildServiceInner);

        springService.update()
            .withoutGitConfig()
            .apply();

        Assertions.assertNull(springService.getDefaultConfigurationService().gitUri());
    }

    @Test
    public void canCRUDApp() {
        String serviceName = generateRandomResourceName("springsvc", 15);
        Region region = Region.US_EAST;
        // define spring cloud service for enterprise tier
        List<String> filePatterns = new ArrayList<>();
        filePatterns.add("api-gateway");
        SpringService springService = appPlatformManager.springServices()
            .define(serviceName)
            .withRegion(region)
            .withNewResourceGroup(rgName)
            .withEnterpriseTierSku()
            .withGitConfig(GIT_CONFIG_URI, "master", filePatterns)
            .create();

        String appName = generateRandomResourceName("springapp", 15);
        SpringApp app = springService.apps()
            .define(appName)
            .withDefaultActiveDeployment()
            .withHttpsOnly()
            .withDefaultPublicEndpoint()
            .create();

        Assertions.assertNotNull(app.url());
        Assertions.assertTrue(app.isHttpsOnly());
        Assertions.assertTrue(app.isPublic());

        app.update()
            .withoutHttpsOnly()
            .withoutDefaultPublicEndpoint()
            .apply();

        Assertions.assertFalse(app.isHttpsOnly());
        Assertions.assertFalse(app.isPublic());
    }
}
