// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
// Code generated by Microsoft (R) TypeSpec Code Generator.
package com.azure.ai.translation.document;

import com.azure.core.credential.AzureKeyCredential;
import com.azure.core.util.Configuration;
import java.time.OffsetDateTime;

import com.azure.storage.blob.BlobContainerClient;
import com.azure.storage.blob.BlobContainerClientBuilder;
import com.azure.storage.blob.BlobClientBuilder;
import com.azure.storage.blob.sas.BlobContainerSasPermission;
import com.azure.storage.blob.sas.BlobServiceSasSignatureValues;
import com.azure.storage.blob.BlobClient;

import java.util.ArrayList;
import java.util.List;
import java.util.UUID;
import java.io.ByteArrayInputStream;
import java.io.InputStream;
import java.util.Map;
import java.util.HashMap;

import com.azure.core.credential.AzureKeyCredential;
import com.azure.core.http.policy.HttpLogDetailLevel;
import com.azure.core.http.policy.HttpLogOptions;
import com.azure.core.test.TestProxyTestBase;
import com.azure.core.util.Configuration;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;

class DocumentTranslationClientTestBase extends TestProxyTestBase {

    private final String defaultEndpoint = "https://fakeendpoint.cognitiveservices.azure.com";
    private final String defaultApiKey = "fakeZmFrZV9hY29jdW50X2tleQ==";
    private final String defaultStorageName = "redacted";
    private final String defaultStorageKey = "fakeZmFrZV9hY29jdW50X2tleQ==";

    DocumentTranslationClient getDocumentTranslationClient() {
        return getDTClient(getEndpoint(), getKey());
    }

    DocumentTranslationClient getDTClient(String endpoint, String key) {
        DocumentTranslationClientBuilder documentTranslationClientbuilder = new DocumentTranslationClientBuilder()
                .endpoint(endpoint)
                .credential(new AzureKeyCredential(key))
                .httpLogOptions(new HttpLogOptions().setLogLevel(HttpLogDetailLevel.BASIC));

        if (interceptorManager.isPlaybackMode()) {
            documentTranslationClientbuilder.httpClient(interceptorManager.getPlaybackClient());
        } else if (interceptorManager.isRecordMode()) {
            documentTranslationClientbuilder.addPolicy(interceptorManager.getRecordPolicy());
        }
        return documentTranslationClientbuilder.buildClient();
    }

    SingleDocumentTranslationClient getSingleDocumentTranslationClient() {
        return getSDTClient(getEndpoint(), getKey());
    }

    SingleDocumentTranslationClient getSDTClient(String endpoint, String key) {
        SingleDocumentTranslationClientBuilder singleDocumentTranslationClientbuilder = new SingleDocumentTranslationClientBuilder()
                .endpoint(endpoint)
                .credential(new AzureKeyCredential(key))
                .httpLogOptions(new HttpLogOptions().setLogLevel(HttpLogDetailLevel.BASIC));

        if (interceptorManager.isPlaybackMode()) {
            singleDocumentTranslationClientbuilder.httpClient(interceptorManager.getPlaybackClient());
        } else if (interceptorManager.isRecordMode()) {
            singleDocumentTranslationClientbuilder.addPolicy(interceptorManager.getRecordPolicy());
        }
        return singleDocumentTranslationClientbuilder.buildClient();
    }

    String getEndpoint() {
        return interceptorManager.isPlaybackMode()
                ? defaultEndpoint
                : Configuration.getGlobalConfiguration().get("DOCUMENT_TRANSLATION_ENDPOINT");
    }

    private String getKey() {
        return interceptorManager.isPlaybackMode()
                ? defaultApiKey
                : Configuration.getGlobalConfiguration().get("DOCUMENT_TRANSLATION_API_KEY");
    }

    String getStorageName() {
        return interceptorManager.isPlaybackMode()
                ? defaultStorageName
                : Configuration.getGlobalConfiguration().get("DOCUMENT_TRANSLATION_STORAGE_NAME");
    }

    String getStorageKey() {
        return interceptorManager.isPlaybackMode()
                ? defaultStorageKey
                : Configuration.getGlobalConfiguration().get("DOCUMENT_TRANSLATION_STORAGE_KEY");
    }

    String getConnectionString() {
        return "DefaultEndpointsProtocol=https;AccountName=" + getStorageName() + ";AccountKey=" + getStorageKey() + ";EndpointSuffix=core.windows.net";
    }

    BlobContainerClient getBlobContainerClient(String containerName) {
        return new BlobContainerClientBuilder()
                .containerName(containerName)
                .connectionString(getConnectionString())
                .buildClient();
    }

    protected static final List<TestDocument> ONE_TEST_DOCUMENTS = new ArrayList<TestDocument>() {
        {
            add(new TestDocument("Document1.txt", "First english test document"));
        }
    };

    protected static final List<TestDocument> TWO_TEST_DOCUMENTS = new ArrayList<TestDocument>() {
        {
            add(new TestDocument("Document1.txt", "First english test file"));
            add(new TestDocument("File2.txt", "Second english test file"));
        }
    };

    public List<TestDocument> createDummyTestDocuments(int count) {
        List<TestDocument> result = new ArrayList<>();
        for (int i = 0; i < count; i++) {
            String fileName = "File_" + i + ".txt";
            String text = "some random text";
            result.add(new TestDocument(fileName, text));
        }
        return result;
    }

    String createSourceContainer(List<TestDocument> documents) {
        String containerName = "source" + generateRandomName("");
        BlobContainerClient blobContainerClient = createContainer(containerName, documents);
        OffsetDateTime expiresOn = OffsetDateTime.now().plusHours(1);

        BlobContainerSasPermission containerSasPermission = new BlobContainerSasPermission()
                .setReadPermission(true)
                .setListPermission(true);

        BlobServiceSasSignatureValues serviceSasValues
                = new BlobServiceSasSignatureValues(expiresOn, containerSasPermission);

        String sasToken = blobContainerClient.generateSas(serviceSasValues);
        String containerUrl = blobContainerClient.getBlobContainerUrl();
        String sasUri = containerUrl + "?" + sasToken;
        return sasUri;
    }

    String createTargetContainer(List<TestDocument> documents) {
        String containerName = "target" + generateRandomName("");
        BlobContainerClient blobContainerClient = createContainer(containerName, documents);
        OffsetDateTime expiresOn = OffsetDateTime.now().plusHours(1);

        BlobContainerSasPermission containerSasPermission = new BlobContainerSasPermission()
                .setWritePermission(true)
                .setListPermission(true);

        BlobServiceSasSignatureValues serviceSasValues
                = new BlobServiceSasSignatureValues(expiresOn, containerSasPermission);

        String sasToken = blobContainerClient.generateSas(serviceSasValues);
        String containerUrl = blobContainerClient.getBlobContainerUrl();
        String sasUri = containerUrl + "?" + sasToken;
        return sasUri;
    }

    Map<String, String> createTargetContainerWithClient(List<TestDocument> documents) {

        String containerName = "target" + generateRandomName("");
        BlobContainerClient blobContainerClient = createContainer(containerName, documents);
        OffsetDateTime expiresOn = OffsetDateTime.now().plusHours(1);

        BlobContainerSasPermission containerSasPermission = new BlobContainerSasPermission()
                .setWritePermission(true)
                .setListPermission(true);

        BlobServiceSasSignatureValues serviceSasValues
                = new BlobServiceSasSignatureValues(expiresOn, containerSasPermission);

        String sasToken = blobContainerClient.generateSas(serviceSasValues);
        String containerUrl = blobContainerClient.getBlobContainerUrl();
        String sasUri = containerUrl + "?" + sasToken;

        Map<String, String> containerValues = new HashMap<>();
        containerValues.put("sasUri", sasUri);
        containerValues.put("containerName", containerName);

        return containerValues;
    }

    String createGlossary(TestDocument document) {
        String containerName = "glossary" + generateRandomName("");
        List<TestDocument> documents = new ArrayList<>();
        documents.add(document);
        BlobContainerClient blobContainerClient = createContainer(containerName, documents);
        OffsetDateTime expiresOn = OffsetDateTime.now().plusHours(1);

        BlobContainerSasPermission containerSasPermission = new BlobContainerSasPermission()
                .setReadPermission(true)
                .setListPermission(true);

        BlobServiceSasSignatureValues serviceSasValues
                = new BlobServiceSasSignatureValues(expiresOn, containerSasPermission);

        String sasToken = blobContainerClient.generateSas(serviceSasValues);
        String containerUrl = blobContainerClient.getBlobContainerUrl();
        String sasUri = containerUrl + "/" + document.getName() + "?" + sasToken;
        return sasUri;
    }

    BlobContainerClient createContainer(String containerName, List<TestDocument> documents) {
        BlobContainerClient containerClient = getBlobContainerClient(containerName);

        if (!containerClient.exists()) {
            containerClient.create();
        }

        if (documents != null && !documents.isEmpty()) {
            uploadDocuments(containerClient, documents);
        }

        return containerClient;
    }

    private void uploadDocuments(BlobContainerClient blobContainerClient, List<TestDocument> documents) {
        for (TestDocument document : documents) {
            InputStream stream = new ByteArrayInputStream(document.getContent().getBytes());
            BlobClient blobClient = blobContainerClient.getBlobClient(document.getName());
            blobClient.upload(stream);
        }
    }

    String downloadDocumentStream(String targetContainerName, String blobName) {
        BlobClient blobClient = new BlobClientBuilder()
                .containerName(targetContainerName)
                .connectionString(getConnectionString())
                .blobName(blobName)
                .buildClient();

        InputStream blobIS = blobClient.openInputStream();
        try {
            String content = readInputStreamToString(blobIS);
            System.out.println(content);
            return content;
        } catch (IOException e) {
            e.printStackTrace();
        }
        return "";
    }

    String generateRandomName(String baseName) {
        return baseName + UUID.randomUUID().toString();
    }

    public static String readInputStreamToString(InputStream inputStream) throws IOException {
        StringBuilder stringBuilder = new StringBuilder();
        try (BufferedReader reader = new BufferedReader(new InputStreamReader(inputStream))) {
            String line;
            while ((line = reader.readLine()) != null) {
                stringBuilder.append(line);
                stringBuilder.append(System.lineSeparator()); // Add line separator if needed
            }
        }
        return stringBuilder.toString();
    }
}
