# NOTE: Please refer to https://aka.ms/azsdk/engsys/ci-yaml before editing this file.

trigger:
  branches:
    include:
      - master
      - main
      - hotfix/*
      - release/*
  paths:
    include:
      - sdk/appconfiguration/ci.yml
      - sdk/appconfiguration/pom.xml
      - sdk/appconfiguration/azure-data-appconfiguration
      - sdk/appconfiguration/spring-cloud-azure-appconfiguration-config
      - sdk/appconfiguration/spring-cloud-azure-appconfiguration-config-web
      - sdk/appconfiguration/spring-cloud-azure-feature-management
      - sdk/appconfiguration/spring-cloud-azure-feature-management-web
      - sdk/appconfiguration/spring-cloud-starter-azure-appconfiguration-config
      - sdk/appconfiguration/azure-spring-cloud-test-appconfiguration-config
      - sdk/appconfiguration/azure-spring-cloud-appconfiguration-config
      - sdk/appconfiguration/azure-spring-cloud-appconfiguration-config-web
      - sdk/appconfiguration/azure-spring-cloud-feature-management
      - sdk/appconfiguration/azure-spring-cloud-feature-management-web
      - sdk/appconfiguration/azure-spring-cloud-starter-appconfiguration-config
      - sdk/appconfiguration/azure-resourcemanager-appconfiguration

pr:
  branches:
    include:
      - master
      - main
      - feature/*
      - hotfix/*
      - release/*
  paths:
    include:
      - sdk/appconfiguration/ci.yml
      - sdk/appconfiguration/pom.xml
      - sdk/appconfiguration/test-resources.json
      - sdk/appconfiguration/tests.yml
      - sdk/appconfiguration/azure-data-appconfiguration
      - sdk/appconfiguration/spring-cloud-azure-appconfiguration-config
      - sdk/appconfiguration/spring-cloud-azure-appconfiguration-config-web
      - sdk/appconfiguration/spring-cloud-azure-feature-management
      - sdk/appconfiguration/spring-cloud-azure-feature-management-web
      - sdk/appconfiguration/spring-cloud-starter-azure-appconfiguration-config
      - sdk/appconfiguration/azure-spring-cloud-test-appconfiguration-config
      - sdk/appconfiguration/azure-spring-cloud-test-appconfiguration-config
      - sdk/appconfiguration/azure-spring-cloud-appconfiguration-config
      - sdk/appconfiguration/azure-spring-cloud-appconfiguration-config-web
      - sdk/appconfiguration/azure-spring-cloud-feature-management
      - sdk/appconfiguration/azure-spring-cloud-feature-management-web
      - sdk/appconfiguration/azure-spring-cloud-starter-appconfiguration-config
      - sdk/appconfiguration/azure-resourcemanager-appconfiguration

extends:
  template: ../../eng/pipelines/templates/stages/archetype-sdk-client.yml
  parameters:
    ServiceDirectory: appconfiguration
    Artifacts:
      - name: azure-data-appconfiguration
        groupId: com.azure
        safeName: azuredataappconfiguration
      - name: spring-cloud-azure-appconfiguration-config
        groupId: com.microsoft.azure
        safeName: springcloudazureappconfigurationconfig
      - name: spring-cloud-azure-appconfiguration-config-web
        groupId: com.microsoft.azure
        safeName: springcloudazureappconfigurationconfigweb
      - name: spring-cloud-azure-feature-management
        groupId: com.microsoft.azure
        safeName: springcloudazurefeaturemanagement
      - name: spring-cloud-azure-feature-management-web
        groupId: com.microsoft.azure
        safeName: springcloudazurefeaturemanagementweb
      - name: spring-cloud-starter-azure-appconfiguration-config
        groupId: com.microsoft.azure
        safeName: springcloudstarterazureappconfigurationconfig
      - name: azure-spring-cloud-appconfiguration-config
        groupId: com.azure.spring
        safeName: azurespringcloudappconfigurationconfig
      - name: azure-spring-cloud-appconfiguration-config-web
        groupId: com.azure.spring
        safeName: azurespringcloudappconfigurationconfigweb
      - name: azure-spring-cloud-feature-management
        groupId: com.azure.spring
        safeName: azurespringcloudfeaturemanagement
      - name: azure-spring-cloud-feature-management-web
        groupId: com.azure.spring
        safeName: azurespringcloudfeaturemanagementweb
      - name: azure-spring-cloud-starter-appconfiguration-config
        groupId: com.azure.spring
        safeName: azurespringcloudstarterappconfigurationconfig
      - name: azure-resourcemanager-appconfiguration
        groupId: com.azure.resourcemanager
        safeName: azureresourcemanagerappconfiguration
    AdditionalModules:
      - name: azure-spring-cloud-test-appconfiguration-config
        groupId: com.azure.spring
        safeName: azurespringcloudtestappconfigurationconfig
stages:
    - template: ../../eng/pipelines/templates/stages/archetype-sdk-tests.yml
      parameters:
        TimeoutInMinutes: 240
        ServiceDirectory: spring
        EnvVars: ${{ parameters.EnvVars }}
        TestName: ${{ parameters.TestName }}
        Clouds: ${{ parameters.Clouds }}
        TestResourceDirectories: ${{ parameters.TestResourceDirectories }}
        Artifacts: ${{ parameters.Artifacts }}
        TestStepMavenInputs:
          options: '-Dmaven.wagon.http.pool=false $(DefaultOptions) -Dmaven.javadoc.skip=true -Drevapi.skip=true -DskipSpringITs=false -pl $(ProjectList)'
          goals: "verify"
        PreSteps:
            - script: |
                  az cloud set --name AzureChinaCloud
              condition: endsWith('${{ parameters.EnvVars.AAD_USER_NAME_ON_DEMAND }}', 'cn')
              displayName: 'Switch to Azure China Cloud'
            - powershell: |
                  az login --allow-no-subscriptions --tenant ${{ parameters.EnvVars.AAD_TENANT_ID_1 }} --service-principal -u ${{ parameters.EnvVars.AAD_SERVICE_PRICIPAL_CLIENT_ID }} -p ${{ parameters.EnvVars.AAD_SERVICE_PRICIPAL_CLIENT_SECRET }}
                  az ad user create --user-principal-name "${{ parameters.EnvVars.AAD_USER_NAME_ON_DEMAND }}" --display-name "${{ parameters.AadOnDemandUserDisplayName }}" --password "${{ parameters.EnvVars.AAD_USER_PASSWORD_ON_DEMAND }}" --force-change-password-next-login false
              displayName: 'Create On-demand test user'
        PostSteps:
          - powershell: |
                az ad user delete --id "${{ parameters.EnvVars.AAD_USER_NAME_ON_DEMAND }}"
                az logout
            condition: always()
            displayName: 'Delete On-demand test user'
          - script: |
              python --version
              python -m pip install setuptools termcolor in_place
              python sdk/spring/scripts/replace_util.py --module spring --log debug --color false
            displayName: 'Run replace_util.py'
          - task: Maven@3
            displayName: 'Build and Install again, JDK Version: $(JavaBuildVersion)'
            inputs:
              mavenPomFile: pom.xml
              goals: 'install'
              options: '$(DefaultOptions) -DskipTests -Dgpg.skip -Dmaven.javadoc.skip=true -Dcheckstyle.skip=true -Dspotbugs.skip=true -Drevapi.skip=true -pl $(ProjectList) -am'
              mavenOptions: '$(MemoryOptions) $(LoggingOptions)'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: $(JavaBuildVersion)
              jdkArchitectureOption: 'x64'
              publishJUnitResults: false

          - script: |
                az cloud set --name AzureChinaCloud
            condition: endsWith('${{ parameters.EnvVars.AAD_USER_NAME_ON_DEMAND }}', 'cn')
            displayName: 'Switch to Azure China Cloud'
          - powershell: |
                az login --allow-no-subscriptions --tenant ${{ parameters.EnvVars.AAD_TENANT_ID_1 }} --service-principal -u ${{ parameters.EnvVars.AAD_SERVICE_PRICIPAL_CLIENT_ID }} -p ${{ parameters.EnvVars.AAD_SERVICE_PRICIPAL_CLIENT_SECRET }}
                az ad user create --user-principal-name "${{ parameters.EnvVars.AAD_USER_NAME_ON_DEMAND }}" --display-name "${{ parameters.AadOnDemandUserDisplayName }}" --password "${{ parameters.EnvVars.AAD_USER_PASSWORD_ON_DEMAND }}" --force-change-password-next-login false
            displayName: 'Create On-demand test user'
          - task: Maven@3
            displayName: 'Run tests again, JDK Version: $(JavaBuildVersion)'
            inputs:
              mavenPomFile: pom.xml
              goals: verify
              options: '-Dmaven.wagon.http.pool=false $(DefaultOptions) -Dmaven.javadoc.skip=true -Drevapi.skip=true -DskipSpringITs=false -pl $(ProjectList)'
            env:
              ${{ parameters.EnvVars }}

          - powershell: |
                az ad user delete --id "${{ parameters.EnvVars.AAD_USER_NAME_ON_DEMAND }}"
                az logout
            condition: always()
            displayName: 'Delete On-demand test user'