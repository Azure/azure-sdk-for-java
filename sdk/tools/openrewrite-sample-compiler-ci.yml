trigger:
  branches:
    include:
      - main
  paths:
    include:
      - /sdk/tools/

extends:
  template: /eng/pipelines/templates/stages/1es-redirect.yml
  parameters:
    stages: 
      - stage: CompileSamples
        variables: 
          - template: /eng/pipelines/templates/variables/globals.yml
          - template: /eng/pipelines/templates/variables/image.yml

        jobs:
          - job: OpenRewriteCompilerPlugin
            pool: 
              name: $(LINUXPOOL)
              image: $(LINUXVMIMAGE)
              os: linux
            displayName: Build and Run OpenRewrite Compiler Plugin
            timeoutInMinutes: 60
            steps:
              - template: /eng/common/pipelines/templates/steps/sparse-checkout.yml
                parameters:
                  Paths:
                    - /sdk/tools/azure-openrewrite-compiler-maven-plugin/
                    - /sdk/tools/azure-openrewrite/
                    - sdk/core-v2/
                    - sdk/clientcore/
                    - sdk/parents/
                    - eng/
                    - common/perf-test-core/

              - task: PowerShell@2
                displayName: 'Install Required Dependencies'
                inputs:
                  targetType: 'inline'
                  script: |
                    mvn -f sdk/parents/pom.xml clean install
                    mvn -f eng/code-quality-reports/pom.xml clean install
                    mvn -f common/perf-test-core/pom.xml clean install

              - task: Maven@3
                displayName: 'Build and Install Clientcore from Source'
                inputs:
                  mavenPomFile: 'sdk/clientcore/pom.xml'
                  goals: 'clean install'
                  options: '-B -Dcheckstyle.skip -Dgpg.skip -Dmaven.javadoc.skip -Drevapi.skip -DskipSpringITs -DskipTests -Dspotbugs.skip -Djacoco.skip -Dspotless.skip'
                  javaHomeOption: 'JDKVersion'
                  jdkVersionOption: '1.8'
                  mavenOptions: '-Xmx3072m'
                  publishJUnitResults: false

              - task: Maven@3
                displayName: 'Build and Install Azure Azure Core V2 from Source'
                inputs:
                  mavenPomFile: 'sdk/core-v2/pom.xml'
                  goals: 'clean install'
                  options: '-B -Dcheckstyle.skip -Dgpg.skip -Dmaven.javadoc.skip -Drevapi.skip -DskipSpringITs -DskipTests -Dspotbugs.skip -Djacoco.skip -Dspotless.skip'
                  javaHomeOption: 'JDKVersion'
                  jdkVersionOption: '1.8'
                  mavenOptions: '-Xmx3072m'
                  publishJUnitResults: false

              - task: Maven@3
                displayName: 'Build and Install Azure OpenRewrite'
                inputs:
                  mavenPomFile: 'sdk/tools/azure-openrewrite/pom.xml'
                  goals: 'clean install'
                  options: '-B -DskipTests -Dgpg.skip'
                  javaHomeOption: 'JDKVersion'
                  jdkVersionOption: '1.8'
                  mavenOptions: '-Xmx3072m'
                  publishJUnitResults: false

              - task: Maven@3
                displayName: 'Build and Install OpenRewrite Compiler Maven Plugin'
                inputs:
                  mavenPomFile: 'sdk/tools/azure-openrewrite-compiler-maven-plugin/pom.xml'
                  goals: 'clean install'
                  options: '-B -DskipTests -Dgpg.skip'
                  javaHomeOption: 'JDKVersion'
                  jdkVersionOption: '1.8'
                  mavenOptions: '-Xmx3072m'
                  publishJUnitResults: false
              
              - task: Maven@3
                displayName: 'Run Golden Image Compiler on OpenRewrite Samples'
                inputs:
                  mavenPomFile: 'sdk/tools/azure-openrewrite/pom.xml'
                  goals: 'com.azure:azure-openrewrite-compiler-maven-plugin:compile-golden-image'
                  javaHomeOption: 'JDKVersion'
                  jdkVersionOption: '1.8'
                  mavenOptions: '-Xmx3072m'
                  publishJUnitResults: false
