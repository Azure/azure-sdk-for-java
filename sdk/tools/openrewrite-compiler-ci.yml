trigger:
  branches:
    include:
      - main
  paths:
    include:
      - /sdk/tools/azure-openrewrite-compiler-maven-plugin/
      - /sdk/tools/azure-openrewrite/
    exclude:
      - /sdk/tools/azure-openrewrite/pom.xml

extends:
  template: /eng/pipelines/templates/stages/archetype-sdk-pom-only.yml
  parameters:
    ServiceDirectory: tools

    jobs:
      - job: OpenRewriteCompilerPlugin
        displayName: Build and Run OpenRewrite Compiler Plugin
        timeoutInMinutes: 60
        pool:
          vmImage: 'ubuntu-latest'
        
        steps:
          - task: Maven@3
            displayName: 'Build and Install OpenRewrite Compiler Maven Plugin'
            inputs:
              mavenPomFile: 'sdk/tools/azure-openrewrite-compiler-maven-plugin/pom.xml'
              goals: 'clean install'
              options: '-B -DskipTests -Dgpg.skip'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '1.17'
              mavenOptions: '-Xmx3072m'
              publishJUnitResults: false
          
          - task: Maven@3
            displayName: 'Run Golden Image Compiler on OpenRewrite with v1 Profile'
            inputs:
              mavenPomFile: 'sdk/tools/azure-openrewrite/pom.xml'
              goals: 'com.azure:azure-openrewrite-compiler-maven-plugin:compile-golden-image'
              options: '-B -DtargetProfiles=v1'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '1.17'
              mavenOptions: '-Xmx3072m'
              publishJUnitResults: false
          
          - task: Maven@3
            displayName: 'Run Golden Image Compiler on OpenRewrite with v2 Profile'
            inputs:
              mavenPomFile: 'sdk/tools/azure-openrewrite/pom.xml'
              goals: 'com.azure:azure-openrewrite-compiler-maven-plugin:compile-golden-image'
              options: '-B -DtargetProfiles=v2'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '1.17'
              mavenOptions: '-Xmx3072m'
              publishJUnitResults: false
          
          - task: Maven@3
            displayName: 'Verify Azure OpenRewrite Tests'
            inputs:
              mavenPomFile: 'sdk/tools/azure-openrewrite/pom.xml'
              goals: 'verify'
              options: '-B'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '1.17'
              mavenOptions: '-Xmx3072m'
              publishJUnitResults: true
              testResultsFiles: '**/TEST-*.xml'

      # Add a separate job for publishing if required
      - job: PublishArtifacts
        displayName: 'Publish Artifacts'
        dependsOn: OpenRewriteCompilerPlugin
        condition: succeeded()
        pool:
          vmImage: 'ubuntu-latest'
        
        steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              source: 'current'
              artifact: 'OpenRewriteCompilerPlugin'
              path: '$(Pipeline.Workspace)/artifacts'
          
          - task: Maven@3
            displayName: 'Publish Compiler Maven Plugin'
            inputs:
              mavenPomFile: 'sdk/tools/azure-openrewrite-compiler-maven-plugin/pom.xml'
              goals: 'deploy'
              options: '-B -DskipTests -Dgpg.skip'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '1.17'
              mavenOptions: '-Xmx3072m'
              publishJUnitResults: false
