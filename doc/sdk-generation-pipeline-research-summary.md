# Java SDK Generation Pipeline — Research Summary

## 1. How the Generation Pipeline Works (Key Steps)

The pipeline supports **two code generation paths**: **TypeSpec** (modern) and **Swagger/AutoRest** (legacy).

**Entry points:**
- [`eng/automation/generate.py`](../eng/automation/generate.py) — main entry for both management-plane and data-plane generation (Swagger + TypeSpec)
- [`eng/automation/sdk_generate.py`](../eng/automation/sdk_generate.py) — alternative entry used by the `codegen_to_sdk_config.json` CI process
- [`eng/automation/generate_data.py`](../eng/automation/generate_data.py) — data-plane specific generation logic
- [`eng/automation/generation.yml`](../eng/automation/generation.yml) — Azure DevOps pipeline definition

**Common flow for TypeSpec projects:**

1. **Environment setup** ([`init.sh`](../eng/automation/init.sh)): Installs Python, PyYAML, `tsp-client` (via `npm ci` in `eng/common/tsp-client`), and sets `JAVA_HOME`
2. **Detect SDK type**: The pipeline determines whether this is mgmt-plane or data-plane based on the folder structure pattern:
   - v2: `specification/{service}/(data-plane|resource-manager)/{provider}/`
   - v1: `specification/{name}/{Name}.Management` → management-plane
3. **Run `tsp-client init --update-if-exists`** ([`generate_utils.py`](../eng/automation/generate_utils.py)): invokes the `@azure-tools/typespec-client-generator-cli` to generate Java client code. Emitter options (like `customization-class`, `partial-update`, `package-version`, `api-version`) are appended via `--emitter-options`.
4. **Detect output folder**: Uses `git status --porcelain **/tsp-location.yaml` to discover which SDK package folder was created/updated.
5. **For re-generation (self-serve)**: If `remove_before_regen=True`, the pipeline:
   - Drops all uncommitted changes (`git reset --hard`)
   - Calls `remove_generated_source_code()` — which deletes only files containing `"Code generated by Microsoft (R) AutoRest Code Generator"` or `"Code generated by Microsoft (R) TypeSpec Code Generator"` headers, **preserving hand-written customization files**
   - Re-runs `tsp-client init` with versioning emitter options
6. **SDK integration** (for new packages): Updates `ci.yml`, service `pom.xml`, root `pom.xml`, `version_client.txt`, and `CHANGELOG.md`
7. **Maven compile**: Runs `mvn clean verify` (mgmt) or `mvn clean package` (data-plane), with flags: `--no-transfer-progress -Dmaven.javadoc.skip -Dgpg.skip -DskipTestCompile -Djacoco.skip -Drevapi.skip`
8. **Changelog/breaking change detection**: Downloads the previous published JAR from Maven Central, compares it with the newly-built JAR to auto-generate changelog entries

**For Swagger/AutoRest**: Uses `autorest` CLI with plugin `@autorest/java@4.1.62`, targeting namespace `com.azure.resourcemanager.{service}` for mgmt, or `com.{module.replace('-','.')}` for data-plane.

---

## 2. tspconfig.yaml — Usage and Common Misconfigurations

`tspconfig.yaml` lives in the **azure-rest-api-specs** repository (not the Java SDK repo). It defines how TypeSpec emitters should generate SDK code for each language.

**Key Java-relevant fields** (validated by [`typespec_utils.py`](../eng/automation/typespec_utils.py)):

```yaml
options:
  "@azure-tools/typespec-java":
    namespace: "com.azure.resourcemanager.fabric"   # REQUIRED
    # Other emitter options:
    # customization-class: <fully-qualified class name>
    # partial-update: true/false
    # package-version: 1.0.0-beta.1
    # api-version: 2024-01-01
emitter-output-dir: "{project-root}/sdk/{service}/{package-name}"
```

**Validation rules** (from [`typespec_utils.py`](../eng/automation/typespec_utils.py)):
- `options.@azure-tools/typespec-java.namespace` is **REQUIRED**
- Namespace must match regex `com\.azure(\.\w+)+` — it must start with `com.azure.`
- Examples: `com.azure.ai.contentsafety` (data-plane), `com.azure.resourcemanager.fabric` (mgmt)
- There's a TODO to validate that `emitter-output-dir` matches the namespace structure

**Common misconfigurations:**
- Missing `namespace` → hard error: `"options.@azure-tools/typespec-java.namespace is REQUIRED for Java SDK"`
- Wrong namespace prefix → error: `'namespace SHOULD start with "com.azure."'`
- Mismatched `emitter-output-dir` and `namespace` (not yet validated but flagged as a TODO)
- Note: tspconfig validation is currently **commented out** (`# tspconfig_valid = validate_tspconfig(tsp_dir)`) in the pipeline, so these checks don't block generation in CI—yet the code exists for future enforcement

**Emitter package** ([`emitter-package.json`](../eng/emitter-package.json)): Uses `@azure-tools/typespec-java@0.39.1` with dependencies on `@typespec/compiler@1.8.0` and Azure TypeSpec libraries.

---

## 3. tsp-location.yaml — Structure and Purpose

Each generated SDK package contains a `tsp-location.yaml` pointing back to its TypeSpec source:

```yaml
directory: specification/keyvault/Security.KeyVault.Secrets   # path in specs repo
commit: 396ab529763b7195ab089f58e2eefb011e1b290d               # exact commit SHA
repo: Azure/azure-rest-api-specs                                # repo name
cleanup: true                                                   # optional: clean before regen
additionalDirectories:                                          # optional: extra dirs
  - specification/keyvault/Security.KeyVault.Common/
```

The pipeline uses `git status --porcelain **/tsp-location.yaml` to **discover** which SDK folders were affected by generation.

---

## 4. How Customization Is Handled

Customization allows SDK authors to add hand-written code that coexists with generated code.

**Key mechanisms:**

| Mechanism | Details |
|---|---|
| **Generated code headers** | Files with `"Code generated by Microsoft (R) TypeSpec Code Generator"` or `"Code generated by Microsoft (R) AutoRest Code Generator"` are identified as generated. Only these files are deleted during re-generation. |
| **`customization-class` emitter option** | Names a fully-qualified Java class that applies customizations during generation. Passed via `--emitter-options customization-class=<value>`. |
| **`partial-update` emitter option** | When `true`, generated code is merged with existing code rather than replacing it entirely. Passed via `--emitter-options partial-update=true`. |
| **`disable_customization` flag** | When a generation fails, the pipeline can **retry with customization disabled** by setting `customization-class=` (empty) and `partial-update=false`. |

**Fallback flow** (in [`generate_data.py`](../eng/automation/generate_data.py)):
1. First attempt: Generate normally (customization enabled)
2. If generation fails AND this is a spec-PR-validation or batch run: **clean the SDK folder** (`shutil.rmtree`) and retry with `disable_customization=True`
3. If generation succeeds but compile fails: Again clean and retry without customization
4. Warning message: `"Generate a fresh package from TypeSpec. If there was prior customization on the package, please check whether it causes failure, and fix them before apiview."`

**Swagger-to-TypeSpec migration**: If the existing package has a `swagger/` directory, it warns: `"Existing package in SDK was from Swagger. It cannot be automatically converted to package from TypeSpec."`

---

## 5. Common Errors and Error Patterns

### Code Generation Errors

| Error Pattern | Source | Cause |
|---|---|---|
| `[GENERATE] Code generation failed.` | `generate_utils.py` | AutoRest codegen returned non-zero exit code |
| `[GENERATE] Code generation failed. tsp-client init fails: {error}` | `generate_utils.py` | `tsp-client init` subprocess raised `CalledProcessError` |
| `[GENERATE] Code generation failed. No sdk folder found.` | `generate_utils.py` | After `tsp-client init`, no `tsp-location.yaml` was modified (nothing generated) |
| `[GENERATE] Code generation failed. Finding sdk folder fails: {e}` | `generate_utils.py` | Exception while running git commands to locate output |
| `[GENERATE] Code generation failed. Autorest fails.` | `generate_data.py` | AutoRest data-plane codegen failed |
| `[GENERATE] Code generation failed. Unknown exception` | `generate.py` | Unhandled exception in generation |
| `[VALIDATION] Parameter validation failed.` | `generate.py` | `ValueError` from parameter validation |

### Validation Errors

| Error Pattern | Source | Cause |
|---|---|---|
| `Invalid SDK release type [{type}], only support 'stable' or 'beta'.` | `generate.py` | Bad `sdkReleaseType` parameter |
| `SDK release type is [stable], but API version [{ver}] is preview.` | `generate.py` | Mismatch: stable release with preview API |
| `Both [API version] and [SDK release type] parameters are required` | `generate.py` | Partial self-serve config |
| `[VALIDATE] service name truncated from "{name}" to "{truncated}"` | `generate_utils.py` | Service name > 32 chars |
| `[VALIDATE][tspconfig.yaml] namespace is REQUIRED` | `typespec_utils.py` | Missing namespace in tspconfig |
| `[VALIDATE][tspconfig.yaml] namespace SHOULD start with "com.azure."` | `typespec_utils.py` | Wrong namespace format |

### Maven/Compile Errors

| Error Pattern | Source | Cause |
|---|---|---|
| `[COMPILE] Maven build fail.` | `generate_utils.py`, `generate_data.py` | `mvn clean verify` or `mvn clean package` non-zero exit |
| "existing code customization incompatible with generated class" | `generate_data.py` | Compilation fails when hand-written customization code references generated APIs that changed |
| `Cannot found built jar in {path}` | `generate_utils.py` | Changelog tooling can't find built JAR after compile |
| Maven Central download failures (`r.raise_for_status()`) | `generate_utils.py` | Network issue downloading previous JAR for changelog comparison |

### POM/Integration Errors

| Error Pattern | Source | Cause |
|---|---|---|
| `[POM][Skip] Cannot find <modules> in pom` | `utils.py` | Malformed service pom.xml |
| `[POM][Skip] find more than one <modules> in pom` | `utils.py` | Unexpected pom structure |
| `[POM][Skip] cannot find root pom` | `utils.py` | Root pom.xml missing |
| `[CI][Skip] Unexpected ci.yml format` | `utils.py` | ci.yml doesn't have expected `extends.parameters.Artifacts` |
| `[VERSION][Fallback] Unexpected version format` | `utils.py` | Malformed line in `version_client.txt` |

### Intermittent/Network Issues

- **Maven dependency resolution**: The pipeline uses `--no-transfer-progress` to reduce output, but Maven can fail on network issues when downloading dependencies. There is **no retry logic** built into the Python scripts for Maven or network calls.
- **Maven Central JAR download**: `requests.get()` to download previous version JARs can fail with HTTP errors (handled via `raise_for_status()` but no retries).
- **npm/tsp-client**: `subprocess.check_call` for `npx tsp-client init` can fail due to npm registry issues. The `CalledProcessError` is caught and logged but not retried.
- **The only "retry-like" behavior**: The fallback that re-generates with `disable_customization=True` after a failure — not a true network retry, but a workaround for customization-related build failures.

---

## 6. Architecture Diagram

```
azure-rest-api-specs repo                 azure-sdk-for-java repo
┌──────────────────────┐                  ┌──────────────────────────────┐
│ tspconfig.yaml       │──(tsp-client)──▶ │ eng/automation/generate.py   │
│ *.tsp files          │                  │   ├─ generate_utils.py       │
│                      │                  │   │   └─ generate_typespec() │
└──────────────────────┘                  │   ├─ generate_data.py        │
                                          │   └─ typespec_utils.py       │
                                          │                              │
                                          │ sdk/{service}/{module}/      │
                                          │   ├─ tsp-location.yaml       │
                                          │   ├─ src/ (generated+custom) │
                                          │   ├─ pom.xml                 │
                                          │   └─ CHANGELOG.md            │
                                          │                              │
                                          │ eng/versioning/              │
                                          │   └─ version_client.txt      │
                                          └──────────────────────────────┘
```
